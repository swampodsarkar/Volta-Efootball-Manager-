<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>‚öΩ Volta Efootball Manager</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@300;400;500;700;900&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css">
    <style>
        /* New "Green Glow" UI Theme */
        body {
            font-family: 'Roboto', sans-serif;
            background-color: #0d1117;
            color: #ffffff;
            overflow: hidden; 
        }
        
        #game-background {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-image: url('https://c4.wallpaperflare.com/wallpaper/468/371/692/soccer-neymar-brazilian-footballer-hd-wallpaper-preview.jpg'); /* Thematic Background */
            background-size: cover;
            background-position: center;
            z-index: -1;
            filter: brightness(0.4); 
        }

        .nav-card, .stat-card, .player-card, .tournament-card, .mission-card, .reward-item, .pack-card {
            background: linear-gradient(135deg, rgba(14, 51, 26, 0.85), rgba(22, 79, 45, 0.9)); /* Greenish Gradient */
            backdrop-filter: blur(10px);
            border: 1px solid rgba(0, 255, 153, 0.4); /* Greenish Border */
            border-radius: 12px;
            box-shadow: 0 0 15px rgba(50, 255, 150, 0.2); /* Green Glow Effect */
            transition: transform 0.2s ease-in-out, box-shadow 0.2s ease-in-out, border-color 0.2s ease-in-out;
        }

        .nav-card:hover, .stat-card:hover, .player-card:hover, .tournament-card:hover, .mission-card:hover, .pack-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 8px 30px rgba(0, 0, 0, 0.7), 0 0 25px rgba(50, 255, 150, 0.5); /* Enhanced Glow on Hover */
            border-color: #39ff14; /* Neon green accent on hover */
        }
        
        .interactive-button { transition: transform 0.1s ease-out; }
        .interactive-button:active { transform: scale(0.95); }
        
        /* Modal & Loader styles */
        .hidden { display: none; }
        .modal-backdrop { background-color: rgba(0,0,0,0.85); }
        .animate-bounce { animation: bounce 1.5s infinite; }
        @keyframes bounce {
            0%, 100% { transform: translateY(-25%); animation-timing-function: cubic-bezier(0.8, 0, 1, 1); }
            50% { transform: translateY(0); animation-timing-function: cubic-bezier(0, 0, 0.2, 1); }
        }
        #loading-bar { animation: loading-progress 2.5s ease-in-out infinite; }
        @keyframes loading-progress { 0% { width: 0%; } 100% { width: 100%; } }
        
        .btn-primary {
             background-color: #00c5a4;
             color: white;
             font-weight: 700;
             transition: background-color 0.3s, transform 0.1s ease-out;
             border: 1px solid #39ff14;
        }
        .btn-primary:hover { background-color: #00a88e; }
        .btn-primary:active { transform: scale(0.95); }

        .top-bar {
            background: linear-gradient(to right, rgba(15, 20, 28, 0.9), rgba(25, 32, 42, 0.8));
            border-bottom: 1px solid #30363d;
        }
        .left-sidebar {
            background: rgba(15, 20, 28, 0.9);
            border-right: 1px solid #30363d;
        }
        .left-sidebar .nav-link:hover, .left-sidebar .nav-link.active {
            background-color: #00c5a4;
            color: #ffffff;
        }
        .bottom-nav {
            background: linear-gradient(to right, rgba(15, 20, 28, 0.95), rgba(25, 32, 42, 0.9));
            border-top: 1px solid #30363d;
        }
        .bottom-nav .nav-link:hover span {
             color: #39ff14;
        }
        
        .promo-card {
            background-size: cover; background-position: center; border-radius: 16px;
            overflow: hidden; border: 2px solid #30363d;
        }
        .promo-card .overlay { background: linear-gradient(to top, rgba(0,0,0,0.9) 0%, rgba(0,0,0,0.1) 100%); }
        
        .chat-message { max-width: 80%; padding: 8px 12px; border-radius: 15px; word-wrap: break-word; font-size: 0.95rem; }
        .message-me { margin-left: auto; background-color: #00c5a4; color: white; }
        .message-other { margin-right: auto; background-color: #30363d; color: #ffffff; }

        /* XP Bar Styles */
        .xp-bar-container {
            width: 100px;
            height: 8px;
            background-color: #2c3a47;
            border-radius: 4px;
            overflow: hidden;
            border: 1px solid #444;
        }
        #xp-bar-fill {
            height: 100%;
            background: linear-gradient(to right, #39ff14, #2cffa1);
            border-radius: 4px;
            transition: width 0.5s ease-in-out;
        }
        /* Season Pass Progress Bar */
        .season-pass-progress-container {
            background-color: #2c3a47;
            border-radius: 8px;
            overflow: hidden;
            border: 1px solid #444;
            padding: 4px;
        }
        #season-pass-progress-fill {
            height: 1rem;
            background: linear-gradient(to right, #a855f7, #ec4899);
            border-radius: 6px;
            transition: width 0.5s ease-in-out;
        }
        .tab-button.active {
            background-color: #00c5a4;
            color: white;
            border-bottom-color: #39ff14;
        }

        /* In-match emoji reaction */
        #emoji-reaction-container {
            position: absolute;
            bottom: 80px;
            right: 20px;
            z-index: 50;
        }
        #emoji-panel {
            background-color: rgba(13, 17, 23, 0.9);
            border: 1px solid #39ff14;
            border-radius: 10px;
            padding: 8px;
            display: flex;
            gap: 8px;
        }
        .emoji { cursor: pointer; font-size: 24px; transition: transform 0.1s; }
        .emoji:hover { transform: scale(1.2); }
        .reaction-display {
             position: absolute;
             bottom: 150px;
             left: 50%;
             transform: translateX(-50%);
             font-size: 4rem;
             animation: fade-up-out 2s forwards;
             text-shadow: 0 0 10px #000;
        }
        @keyframes fade-up-out {
            0% { transform: translate(-50%, 0); opacity: 1; }
            100% { transform: translate(-50%, -100px); opacity: 0; }
        }
        
        @keyframes pulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.05); }
            100% { transform: scale(1); }
        }
        .animate-pulse {
            animation: pulse 2s infinite;
        }

        /* Player attribute bars */
        .attribute-bar {
            height: 8px;
            background-color: #2c3a47;
            border-radius: 4px;
            overflow: hidden;
            margin-top: 4px;
        }
        .attribute-fill {
            height: 100%;
            border-radius: 4px;
            transition: width 0.5s ease-in-out;
        }
        .pace-fill { background: linear-gradient(to right, #39ff14, #2cffa1); }
        .shooting-fill { background: linear-gradient(to right, #ff6b6b, #ff8e8e); }
        .passing-fill { background: linear-gradient(to right, #4dabf7, #74c0fc); }
        .dribbling-fill { background: linear-gradient(to right, #ffd43b, #ffe066); }
        .defending-fill { background: linear-gradient(to right, #9775fa, #b197fc); }
        .physical-fill { background: linear-gradient(to right, #ff922b, #ffa94d); }

        /* Pack opening animation */
        @keyframes pack-shake {
            0%, 100% { transform: translateX(0); }
            10%, 30%, 50%, 70%, 90% { transform: translateX(-5px); }
            20%, 40%, 60%, 80% { transform: translateX(5px); }
        }
        .pack-shake {
            animation: pack-shake 0.5s;
        }
        @keyframes card-reveal {
            0% { transform: scale(0.5) rotateY(0deg); opacity: 0; }
            50% { transform: scale(1.1) rotateY(180deg); opacity: 1; }
            100% { transform: scale(1) rotateY(360deg); opacity: 1; }
        }
        .card-reveal {
            animation: card-reveal 1s forwards;
        }

        /* Formation selector */
        .formation-option {
            border: 2px solid transparent;
            transition: all 0.2s;
        }
        .formation-option:hover, .formation-option.selected {
            border-color: #39ff14;
            box-shadow: 0 0 10px rgba(57, 255, 20, 0.5);
        }

        /* Player card rarity colors */
        .bronze { border-color: #cd7f32; box-shadow: 0 0 10px rgba(205, 127, 50, 0.5); }
        .silver { border-color: #c0c0c0; box-shadow: 0 0 10px rgba(192, 192, 192, 0.5); }
        .gold { border-color: #ffd700; box-shadow: 0 0 10px rgba(255, 215, 0, 0.5); }
        .special { border-color: #a855f7; box-shadow: 0 0 15px rgba(168, 85, 247, 0.7); }

        /* Stamina bar */
        .stamina-bar {
            height: 6px;
            background-color: #2c3a47;
            border-radius: 3px;
            overflow: hidden;
            margin-top: 2px;
        }
        .stamina-fill {
            height: 100%;
            background: linear-gradient(to right, #ff6b6b, #ffd43b);
            border-radius: 3px;
            transition: width 0.5s ease-in-out;
        }

        /* Injury indicator */
        .injury-indicator {
            position: absolute;
            top: 5px;
            right: 5px;
            background-color: rgba(255, 0, 0, 0.8);
            color: white;
            border-radius: 50%;
            width: 20px;
            height: 20px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 12px;
        }
        
        /* Contract indicator */
        .contract-indicator {
            position: absolute;
            top: 5px;
            left: 5px;
            background-color: rgba(255, 165, 0, 0.8);
            color: white;
            border-radius: 50%;
            width: 20px;
            height: 20px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 12px;
        }
        
        /* Contract expired indicator */
        .contract-expired-indicator {
            position: absolute;
            top: 30px;
            left: 5px;
            background-color: rgba(255, 0, 0, 0.8);
            color: white;
            border-radius: 50%;
            width: 20px;
            height: 20px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 12px;
        }

        /* Kit designer styles */
        .kit-preview {
            width: 100px;
            height: 150px;
            position: relative;
            border: 2px solid #444;
            border-radius: 8px;
            overflow: hidden;
        }
        .kit-jersey {
            width: 100%;
            height: 70px;
            background-color: #1e40af;
            position: relative;
        }
        .kit-shorts {
            width: 100%;
            height: 40px;
            background-color: #1e40af;
            position: absolute;
            top: 70px;
        }
        .kit-socks {
            width: 100%;
            height: 30px;
            background-color: #ffffff;
            position: absolute;
            top: 110px;
        }
        .kit-stripe {
            position: absolute;
            background-color: white;
        }
        .kit-stripe.horizontal {
            width: 100%;
            height: 10px;
        }
        .kit-stripe.vertical {
            width: 10px;
            height: 100%;
        }

        /* Alliance styles */
        .alliance-badge {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            font-size: 14px;
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
        }
        
        /* Player highlighting */
        .player-icon.ring-4 {
            box-shadow: 0 0 10px 4px rgba(255, 255, 0, 0.8);
            z-index: 10;
        }
        
        .player-icon.scale-125 {
            transform: scale(1.25);
        }
        
        .player-icon.scale-150 {
            transform: scale(1.5);
        }
        
        /* Transition effects */
        .transition-transform {
            transition: transform 0.5s ease-out;
        }
        
        .duration-500 {
            transition-duration: 500ms;
        }
        
        /* Shot effect */
        .shot-trail {
            position: absolute;
            background: linear-gradient(to right, yellow, orange, red);
            border-radius: 50%;
            transform: translate(-50%, -50%);
            pointer-events: none;
            z-index: 5;
        }
        
        /* Save effect */
        .ring-2 {
            box-shadow: 0 0 0 2px;
        }
        
        .ring-green-400 {
            --tw-ring-color: #4ade80;
        }
        
        .ring-yellow-400 {
            --tw-ring-color: #facc15;
        }
        
        .ring-red-500 {
            --tw-ring-color: #ef4444;
        }

    </style>
</head>
<body class="overflow-hidden">
    
    <div id="game-background"></div>

    <audio id="main-menu-audio" loop>
        <source src="asset/main menu.mp3" type="audio/mpeg">
    </audio>
    <audio id="match-audio" loop>
        <source src="asset/match.mp3" type="audio/mpeg">
    </audio>
    <audio id="goal-sound">
        <source src="asset/goal.mp3" type="audio/mpeg">
    </audio>
    <audio id="whistle-sound">
        <source src="asset/whistle.mp3" type="audio/mpeg">
    </audio>
    <audio id="button-sound">
        <source src="asset/button.mp3" type="audio/mpeg">
    </audio>
    <audio id="pack-open-sound">
        <source src="asset/pack.mp3" type="audio/mpeg">
    </audio>

    <div id="game-container-wrapper" class="w-full h-screen">

        <div id="full-screen-loader" class="fixed inset-0 bg-[#0d1117] bg-opacity-95 flex flex-col items-center justify-center z-[100]">
            <div class="flex flex-col items-center justify-center">
                <div class="text-6xl mb-6 animate-bounce">‚öΩ</div>
                <h1 class="text-4xl font-extrabold text-green-400 mb-4 tracking-wider">Volta Efootball Manager</h1>
                <div class="w-full max-w-sm bg-gray-700 rounded-full h-2.5">
                    <div id="loading-bar" class="bg-green-400 h-2.5 rounded-full"></div>
                </div>
                <p class="text-lg font-bold text-gray-300 mt-4">Loading by SWAMPOD X MITHUN...</p>
            </div>
        </div>
        <div id="promo-banner-modal" class="hidden fixed inset-0 modal-backdrop flex items-center justify-center z-50">
            <div class="bg-gray-900 rounded-xl shadow-2xl p-6 w-full max-w-lg text-center border-4 border-yellow-500 relative">
                <img id="promo-image" src="" alt="Promotional Banner" class="w-full h-auto rounded-lg mb-4 hidden">
                <a id="promo-link" href="#" target="_blank" class="hidden w-full py-3 btn-primary rounded-lg mb-4 hover:bg-teal-600">Learn More</a>
                <button id="promo-close-btn" class="mt-4 py-2 px-6 bg-gray-700 hover:bg-gray-600 text-white font-bold rounded-lg interactive-button">Close</button>
            </div>
        </div>
        <div id="maintenance-mode" class="hidden fixed inset-0 modal-backdrop flex items-center justify-center z-50">
            <div class="text-center p-8 bg-gray-800 rounded-lg shadow-xl border border-green-500">
                <h2 id="maintenance-title" class="text-3xl font-bold text-yellow-400 mb-4">‚ö†Ô∏è Maintenance in Progress</h2>
                <p id="maintenance-message" class="text-lg text-gray-300">The game is on maintenance, will back shortly.</p>
            </div>
        </div>
        <div id="banned-screen" class="hidden fixed inset-0 modal-backdrop flex items-center justify-center z-50">
            <div class="text-center p-8 bg-gray-800 rounded-lg shadow-xl border border-red-500">
                <h2 class="text-3xl font-bold text-red-400 mb-4">üö´ You are Banned</h2>
                <p class="text-lg text-gray-300">Please contact support for assistance: <a href="mailto:voltaefootball@gmail.com" class="text-green-400 hover:underline">voltaefootball@gmail.com</a></p>
            </div>
        </div>
        <div id="custom-modal" class="hidden fixed inset-0 modal-backdrop flex items-center justify-center z-50">
            <div class="bg-gray-900 rounded-lg shadow-2xl p-6 w-full max-w-sm text-center border border-green-500">
                <p id="modal-message" class="text-lg mb-4"></p>
                <button id="modal-close-btn" class="btn-primary py-2 px-6 rounded">OK</button>
            </div>
        </div>
        <!-- Payment Modal -->
        <div id="payment-modal" class="hidden fixed inset-0 modal-backdrop flex items-center justify-center z-50">
            <div class="bg-gray-900 rounded-lg shadow-2xl p-6 w-full max-w-md text-left border border-purple-500 relative">
                <button id="payment-close-btn" class="absolute top-2 right-3 text-2xl text-gray-400 hover:text-white">&times;</button>
                <h2 class="text-2xl font-bold text-purple-400 mb-4">Purchase Premium Season Pass (99 BDT)</h2>
                <div class="space-y-4 text-gray-300">
                    <p>1. Choose a payment method: <span class="font-bold text-white">bKash, Nagad, or Rocket</span>.</p>
                    <p>2. Use the "Send Money" option to send 99 BDT to the following number:</p>
                    <div class="bg-gray-800 p-3 rounded-lg text-center">
                        <p class="text-xl font-mono tracking-widest text-green-400">01767882562</p>
                    </div>
                    <p>3. After sending the money, copy the Transaction ID (TnxID) from the confirmation message.</p>
                    <p>4. Enter the Transaction ID below and submit for verification.</p>
                </div>
                <form id="payment-form" class="mt-6 space-y-4">
                    <input id="transaction-id-input" type="text" placeholder="Enter Transaction ID (TnxID)" required class="w-full px-4 py-3 bg-gray-700 border border-gray-600 rounded-lg text-white focus:outline-none focus:ring-2 focus:ring-purple-500">
                    <button type="submit" class="w-full py-3 px-4 bg-purple-600 hover:bg-purple-700 text-white font-bold rounded-lg interactive-button">Submit Transaction</button>
                </form>
            </div>
        </div>

        <!-- Pack Opening Modal -->
        <div id="pack-opening-modal" class="hidden fixed inset-0 modal-backdrop flex items-center justify-center z-50">
            <div class="bg-gray-900 rounded-xl shadow-2xl p-6 w-full max-w-2xl text-center border-4 border-yellow-500 relative">
                <button id="pack-close-btn" class="absolute top-2 right-3 text-2xl text-gray-400 hover:text-white">&times;</button>
                <h2 class="text-3xl font-bold text-yellow-400 mb-6">Player Pack Opening</h2>
                <div id="pack-opening-container" class="flex flex-wrap justify-center gap-4">
                    <!-- Pack cards will be dynamically inserted here -->
                </div>
                <button id="pack-open-again-btn" class="mt-6 py-3 px-6 bg-yellow-600 hover:bg-yellow-700 text-white font-bold rounded-lg interactive-button hidden">Open Another Pack</button>
                <button id="pack-done-btn" class="mt-6 py-3 px-6 bg-gray-700 hover:bg-gray-600 text-white font-bold rounded-lg interactive-button">Done</button>
            </div>
        </div>

        <!-- Training Modal -->
        <div id="training-modal" class="hidden fixed inset-0 modal-backdrop flex items-center justify-center z-50">
            <div class="bg-gray-900 rounded-xl shadow-2xl p-6 w-full max-w-2xl text-left border-4 border-blue-500 relative">
                <button id="training-close-btn" class="absolute top-2 right-3 text-2xl text-gray-400 hover:text-white">&times;</button>
                <h2 class="text-3xl font-bold text-blue-400 mb-6">Player Training</h2>
                <div class="flex items-center mb-4">
                    <span class="text-lg font-bold text-gray-300 mr-4">Training Points:</span>
                    <div class="flex items-center bg-gray-800 px-4 py-2 rounded-lg">
                        <i class="fas fa-dumbbell text-yellow-400 mr-2"></i>
                        <span id="training-points" class="font-bold text-white">0</span>
                    </div>
                </div>
                <div id="training-player-list" class="space-y-4 max-h-96 overflow-y-auto">
                    <!-- Player training cards will be dynamically inserted here -->
                </div>
            </div>
        </div>

        <!-- Formation Modal -->
        <div id="formation-modal" class="hidden fixed inset-0 modal-backdrop flex items-center justify-center z-50">
            <div class="bg-gray-900 rounded-xl shadow-2xl p-6 w-full max-w-4xl text-center border-4 border-green-500 relative">
                <button id="formation-close-btn" class="absolute top-2 right-3 text-2xl text-gray-400 hover:text-white">&times;</button>
                <h2 class="text-3xl font-bold text-green-400 mb-6">Team Formation & Tactics</h2>
                
                <div class="mb-6">
                    <h3 class="text-xl font-bold text-gray-300 mb-4">Select Formation</h3>
                    <div class="flex justify-center gap-4 flex-wrap">
                        <div class="formation-option p-4 bg-gray-800 rounded-lg cursor-pointer" data-formation="4-4-2">
                            <div class="text-lg font-bold text-white mb-2">4-4-2</div>
                            <div class="text-sm text-gray-400">Balanced</div>
                        </div>
                        <div class="formation-option p-4 bg-gray-800 rounded-lg cursor-pointer" data-formation="4-3-3">
                            <div class="text-lg font-bold text-white mb-2">4-3-3</div>
                            <div class="text-sm text-gray-400">Attacking</div>
                        </div>
                        <div class="formation-option p-4 bg-gray-800 rounded-lg cursor-pointer" data-formation="3-5-2">
                            <div class="text-lg font-bold text-white mb-2">3-5-2</div>
                            <div class="text-sm text-gray-400">Midfield Control</div>
                        </div>
                        <div class="formation-option p-4 bg-gray-800 rounded-lg cursor-pointer" data-formation="5-3-2">
                            <div class="text-lg font-bold text-white mb-2">5-3-2</div>
                            <div class="text-sm text-gray-400">Defensive</div>
                        </div>
                    </div>
                </div>
                
                <div class="mb-6">
                    <h3 class="text-xl font-bold text-gray-300 mb-4">Team Chemistry</h3>
                    <div class="flex items-center justify-center">
                        <div class="w-full max-w-md bg-gray-800 rounded-full h-4">
                            <div id="chemistry-bar" class="bg-gradient-to-r from-red-500 via-yellow-500 to-green-500 h-4 rounded-full" style="width: 0%"></div>
                        </div>
                        <span id="chemistry-value" class="ml-4 text-xl font-bold text-white">0%</span>
                    </div>
                </div>
                
                <div class="flex justify-center gap-4">
                    <button id="formation-save-btn" class="py-3 px-6 bg-green-600 hover:bg-green-700 text-white font-bold rounded-lg interactive-button">Save Formation</button>
                    <button id="formation-cancel-btn" class="py-3 px-6 bg-gray-700 hover:bg-gray-600 text-white font-bold rounded-lg interactive-button">Cancel</button>
                </div>
            </div>
        </div>

        <!-- Daily Login Modal -->
        <div id="daily-login-modal" class="hidden fixed inset-0 modal-backdrop flex items-center justify-center z-50">
            <div class="bg-gray-900 rounded-xl shadow-2xl p-6 w-full max-w-lg text-center border-4 border-yellow-500 relative">
                <button id="daily-login-close-btn" class="absolute top-2 right-3 text-2xl text-gray-400 hover:text-white">&times;</button>
                <h2 class="text-3xl font-bold text-yellow-400 mb-6">Daily Login Reward</h2>
                <div class="text-xl text-gray-300 mb-4">Day <span id="login-day">1</span> of 7</div>
                <div id="daily-reward" class="bg-gray-800 p-6 rounded-lg mb-6">
                    <div id="daily-reward-content" class="text-2xl font-bold text-yellow-400">
                        <!-- Reward content will be dynamically inserted here -->
                    </div>
                </div>
                <button id="daily-login-claim-btn" class="py-3 px-6 bg-yellow-600 hover:bg-yellow-700 text-white font-bold rounded-lg interactive-button">Claim Reward</button>
            </div>
        </div>

        <!-- Advanced Tactics Modal -->
        <div id="advanced-tactics-modal" class="hidden fixed inset-0 modal-backdrop flex items-center justify-center z-50">
            <div class="bg-gray-900 rounded-xl shadow-2xl p-6 w-full max-w-2xl text-center border-4 border-blue-500 relative">
                <button id="advanced-tactics-close-btn" class="absolute top-2 right-3 text-2xl text-gray-400 hover:text-white">&times;</button>
                <h2 class="text-3xl font-bold text-blue-400 mb-6">Advanced Tactics</h2>
                
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-6">
                    <div class="tactic-option p-4 bg-gray-800 rounded-lg cursor-pointer" data-tactic="High Press">
                        <div class="text-lg font-bold text-white mb-2">High Press</div>
                        <div class="text-sm text-gray-400">Aggressive pressing to win the ball quickly</div>
                    </div>
                    <div class="tactic-option p-4 bg-gray-800 rounded-lg cursor-pointer" data-tactic="Counter Attack">
                        <div class="text-lg font-bold text-white mb-2">Counter Attack</div>
                        <div class="text-sm text-gray-400">Defend deep and attack quickly on transitions</div>
                    </div>
                    <div class="tactic-option p-4 bg-gray-800 rounded-lg cursor-pointer" data-tactic="Possession Play">
                        <div class="text-lg font-bold text-white mb-2">Possession Play</div>
                        <div class="text-sm text-gray-400">Keep possession and control the game tempo</div>
                    </div>
                    <div class="tactic-option p-4 bg-gray-800 rounded-lg cursor-pointer" data-tactic="Wing Play">
                        <div class="text-lg font-bold text-white mb-2">Wing Play</div>
                        <div class="text-sm text-gray-400">Focus attacks through the wings with crosses</div>
                    </div>
                </div>
                
                <div class="flex justify-center gap-4">
                    <button id="advanced-tactics-save-btn" class="py-3 px-6 bg-blue-600 hover:bg-blue-700 text-white font-bold rounded-lg interactive-button">Save Tactics</button>
                    <button id="advanced-tactics-cancel-btn" class="py-3 px-6 bg-gray-700 hover:bg-gray-600 text-white font-bold rounded-lg interactive-button">Cancel</button>
                </div>
            </div>
        </div>

        <!-- Club Facilities Modal -->
        <div id="facilities-modal" class="hidden fixed inset-0 modal-backdrop flex items-center justify-center z-50">
            <div class="bg-gray-900 rounded-xl shadow-2xl p-6 w-full max-w-4xl text-center border-4 border-green-500 relative">
                <button id="facilities-close-btn" class="absolute top-2 right-3 text-2xl text-gray-400 hover:text-white">&times;</button>
                <h2 class="text-3xl font-bold text-green-400 mb-6">Club Facilities</h2>
                
                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6 mb-6">
                    <div class="facility-card p-4 bg-gray-800 rounded-lg">
                        <h3 class="text-xl font-bold text-white mb-2">Stadium</h3>
                        <p class="text-sm text-gray-400 mb-4">Level: <span id="stadium-level" class="font-bold text-yellow-400">1</span></p>
                        <p class="text-sm text-gray-300 mb-4">Increases match revenue and home advantage</p>
                        <button class="upgrade-facility-btn w-full py-2 px-4 bg-green-600 hover:bg-green-700 text-white font-bold rounded-lg interactive-button" data-facility="stadium">Upgrade (5000 Coins)</button>
                    </div>
                    <div class="facility-card p-4 bg-gray-800 rounded-lg">
                        <h3 class="text-xl font-bold text-white mb-2">Training Ground</h3>
                        <p class="text-sm text-gray-400 mb-4">Level: <span id="training-ground-level" class="font-bold text-yellow-400">1</span></p>
                        <p class="text-sm text-gray-300 mb-4">Improves player training efficiency</p>
                        <button class="upgrade-facility-btn w-full py-2 px-4 bg-green-600 hover:bg-green-700 text-white font-bold rounded-lg interactive-button" data-facility="trainingGround">Upgrade (3000 Coins)</button>
                    </div>
                    <div class="facility-card p-4 bg-gray-800 rounded-lg">
                        <h3 class="text-xl font-bold text-white mb-2">Youth Academy</h3>
                        <p class="text-sm text-gray-400 mb-4">Level: <span id="youth-academy-level" class="font-bold text-yellow-400">1</span></p>
                        <p class="text-sm text-gray-300 mb-4">Produces young talents periodically</p>
                        <button class="upgrade-facility-btn w-full py-2 px-4 bg-green-600 hover:bg-green-700 text-white font-bold rounded-lg interactive-button" data-facility="youthAcademy">Upgrade (8000 Coins)</button>
                    </div>
                </div>
                
                <button id="facilities-close-btn-2" class="py-3 px-6 bg-gray-700 hover:bg-gray-600 text-white font-bold rounded-lg interactive-button">Close</button>
            </div>
        </div>

        <!-- Sponsorship Modal -->
        <div id="sponsorship-modal" class="hidden fixed inset-0 modal-backdrop flex items-center justify-center z-50">
            <div class="bg-gray-900 rounded-xl shadow-2xl p-6 w-full max-w-2xl text-center border-4 border-yellow-500 relative">
                <button id="sponsorship-close-btn" class="absolute top-2 right-3 text-2xl text-gray-400 hover:text-white">&times;</button>
                <h2 class="text-3xl font-bold text-yellow-400 mb-6">Sponsorship Deals</h2>
                
                <div id="sponsorship-list" class="space-y-4 mb-6">
                    <!-- Sponsorship deals will be dynamically inserted here -->
                </div>
                
                <button id="sponsorship-close-btn-2" class="py-3 px-6 bg-gray-700 hover:bg-gray-600 text-white font-bold rounded-lg interactive-button">Close</button>
            </div>
        </div>

        <!-- Kit Designer Modal -->
        <div id="kit-designer-modal" class="hidden fixed inset-0 modal-backdrop flex items-center justify-center z-50">
            <div class="bg-gray-900 rounded-xl shadow-2xl p-6 w-full max-w-4xl text-center border-4 border-purple-500 relative">
                <button id="kit-designer-close-btn" class="absolute top-2 right-3 text-2xl text-gray-400 hover:text-white">&times;</button>
                <h2 class="text-3xl font-bold text-purple-400 mb-6">Kit Designer</h2>
                
                <div class="flex flex-col md:flex-row gap-8 mb-6">
                    <div class="flex-1">
                        <h3 class="text-xl font-bold text-white mb-4">Kit Preview</h3>
                        <div class="kit-preview mx-auto">
                            <div id="kit-jersey" class="kit-jersey"></div>
                            <div id="kit-shorts" class="kit-shorts"></div>
                            <div id="kit-socks" class="kit-socks"></div>
                        </div>
                    </div>
                    
                    <div class="flex-1">
                        <h3 class="text-xl font-bold text-white mb-4">Customization</h3>
                        <div class="space-y-4">
                            <div>
                                <label class="block text-left text-gray-300 mb-2">Jersey Color</label>
                                <input type="color" id="jersey-color" value="#1e40af" class="w-full h-10 rounded">
                            </div>
                            <div>
                                <label class="block text-left text-gray-300 mb-2">Shorts Color</label>
                                <input type="color" id="shorts-color" value="#1e40af" class="w-full h-10 rounded">
                            </div>
                            <div>
                                <label class="block text-left text-gray-300 mb-2">Socks Color</label>
                                <input type="color" id="socks-color" value="#ffffff" class="w-full h-10 rounded">
                            </div>
                            <div>
                                <label class="block text-left text-gray-300 mb-2">Kit Style</label>
                                <select id="kit-style" class="w-full px-4 py-2 bg-gray-700 border border-gray-600 rounded-lg text-white">
                                    <option value="plain">Plain</option>
                                    <option value="stripes">Stripes</option>
                                    <option value="hoops">Hoops</option>
                                    <option value="sash">Sash</option>
                                </select>
                            </div>
                            <div>
                                <label class="block text-left text-gray-300 mb-2">Number Style</label>
                                <select id="number-style" class="w-full px-4 py-2 bg-gray-700 border border-gray-600 rounded-lg text-white">
                                    <option value="plain">Plain Numbers</option>
                                    <option value="outlined">Outlined Numbers</option>
                                    <option value="shadowed">Shadowed Numbers</option>
                                    <option value="glow">Glow Numbers</option>
                                </select>
                            </div>
                            <div>
                                <label class="block text-left text-gray-300 mb-2">Font Style</label>
                                <select id="font-style" class="w-full px-4 py-2 bg-gray-700 border border-gray-600 rounded-lg text-white">
                                    <option value="default">Default Font</option>
                                    <option value="bold">Bold Font</option>
                                    <option value="italic">Italic Font</option>
                                    <option value="condensed">Condensed Font</option>
                                </select>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="flex justify-center gap-4">
                    <button id="kit-save-btn" class="py-3 px-6 bg-purple-600 hover:bg-purple-700 text-white font-bold rounded-lg interactive-button">Save Kit</button>
                    <button id="kit-cancel-btn" class="py-3 px-6 bg-gray-700 hover:bg-gray-600 text-white font-bold rounded-lg interactive-button">Cancel</button>
                </div>
            </div>
        </div>

        <!-- Game Settings Modal -->
        <div id="settings-modal" class="hidden fixed inset-0 modal-backdrop flex items-center justify-center z-50">
            <div class="bg-gray-900 rounded-xl shadow-2xl p-6 w-full max-w-2xl text-center border-4 border-green-500 relative">
                <button id="settings-close-btn" class="absolute top-2 right-3 text-2xl text-gray-400 hover:text-white">&times;</button>
                <h2 class="text-3xl font-bold text-green-400 mb-6">Game Settings</h2>
                
                <div class="space-y-6 text-left">
                    <!-- Server Info -->
                    <div class="player-card p-4">
                        <h3 class="text-xl font-bold text-white mb-3">Server Information</h3>
                        <div class="flex items-center justify-between mb-2">
                            <span class="text-gray-300">Current Server:</span>
                            <span id="current-server" class="font-bold text-green-400">-</span>
                        </div>
                        <div class="flex items-center justify-between">
                            <span class="text-gray-300">Simulated Ping:</span>
                            <span id="simulated-ping" class="font-bold text-yellow-400">- ms</span>
                        </div>
                        <p class="text-sm text-gray-400 mt-2">Note: Server cannot be changed after signup</p>
                    </div>
                    
                    <!-- Graphics Settings -->
                    <div class="player-card p-4">
                        <h3 class="text-xl font-bold text-white mb-3">Graphics Quality</h3>
                        <div class="grid grid-cols-3 gap-3">
                            <button id="graphics-low" class="py-3 px-4 bg-gray-700 hover:bg-gray-600 text-white font-bold rounded-lg interactive-button">Low</button>
                            <button id="graphics-medium" class="py-3 px-4 bg-gray-700 hover:bg-gray-600 text-white font-bold rounded-lg interactive-button">Medium</button>
                            <button id="graphics-high" class="py-3 px-4 bg-gray-700 hover:bg-gray-600 text-white font-bold rounded-lg interactive-button">High</button>
                        </div>
                        <div class="mt-3 text-center">
                            <span class="text-gray-300">Current Setting: </span>
                            <span id="current-graphics" class="font-bold text-green-400">Medium</span>
                        </div>
                    </div>
                    
                    <!-- FPS Limit -->
                    <div class="player-card p-4">
                        <h3 class="text-xl font-bold text-white mb-3">FPS Limit</h3>
                        <div class="grid grid-cols-3 gap-3">
                            <button id="fps-30" class="py-3 px-4 bg-gray-700 hover:bg-gray-600 text-white font-bold rounded-lg interactive-button">30 FPS</button>
                            <button id="fps-60" class="py-3 px-4 bg-gray-700 hover:bg-gray-600 text-white font-bold rounded-lg interactive-button">60 FPS</button>
                            <button id="fps-unlimited" class="py-3 px-4 bg-gray-700 hover:bg-gray-600 text-white font-bold rounded-lg interactive-button">Unlimited</button>
                        </div>
                        <div class="mt-3 text-center">
                            <span class="text-gray-300">Current Setting: </span>
                            <span id="current-fps" class="font-bold text-green-400">60 FPS</span>
                        </div>
                    </div>
                    
                    <!-- Audio Volume -->
                    <div class="player-card p-4">
                        <h3 class="text-xl font-bold text-white mb-3">Audio Volume</h3>
                        <input type="range" id="audio-volume" min="0" max="100" value="100" class="w-full h-2 bg-gray-700 rounded-lg appearance-none cursor-pointer">
                        <div class="flex justify-between mt-2">
                            <span class="text-gray-300">0%</span>
                            <span id="volume-value" class="font-bold text-green-400">100%</span>
                            <span class="text-gray-300">100%</span>
                        </div>
                    </div>
                </div>
                
                <button id="settings-close-btn-2" class="mt-6 py-3 px-6 bg-gray-700 hover:bg-gray-600 text-white font-bold rounded-lg interactive-button">Close</button>
            </div>
        </div>

        <!-- Friends & Alliances Modal -->
        <div id="friends-modal" class="hidden fixed inset-0 modal-backdrop flex items-center justify-center z-50">
            <div class="bg-gray-900 rounded-xl shadow-2xl p-6 w-full max-w-4xl text-center border-4 border-blue-500 relative">
                <button id="friends-close-btn" class="absolute top-2 right-3 text-2xl text-gray-400 hover:text-white">&times;</button>
                <h2 class="text-3xl font-bold text-blue-400 mb-6">Friends & Alliances</h2>
                
                <div class="flex border-b-2 border-gray-700 mb-6">
                    <button id="friends-tab" class="tab-button flex-1 py-2 px-4 text-lg font-semibold text-gray-400 border-b-4 border-transparent active">Friends</button>
                    <button id="alliances-tab" class="tab-button flex-1 py-2 px-4 text-lg font-semibold text-gray-400 border-b-4 border-transparent">Alliances</button>
                </div>
                
                <div id="friends-content">
                    <div class="mb-4">
                        <input type="text" id="friend-search" placeholder="Search for friends by club name..." class="w-full px-4 py-2 bg-gray-700 border border-gray-600 rounded-lg text-white mb-4">
                        <button id="search-friend-btn" class="w-full py-2 px-4 bg-blue-600 hover:bg-blue-700 text-white font-bold rounded-lg interactive-button">Search</button>
                    </div>
                    <div id="friends-list" class="space-y-4 max-h-64 overflow-y-auto">
                        <!-- Friends list will be dynamically inserted here -->
                    </div>
                </div>
                
                <div id="alliances-content" class="hidden">
                    <div class="mb-4">
                        <input type="text" id="alliance-search" placeholder="Search for alliances..." class="w-full px-4 py-2 bg-gray-700 border border-gray-600 rounded-lg text-white mb-4">
                        <button id="search-alliance-btn" class="w-full py-2 px-4 bg-purple-600 hover:bg-purple-700 text-white font-bold rounded-lg interactive-button">Search</button>
                    </div>
                    <div id="alliances-list" class="space-y-4 max-h-64 overflow-y-auto">
                        <!-- Alliances list will be dynamically inserted here -->
                    </div>
                    <button id="create-alliance-btn" class="w-full mt-4 py-3 px-4 bg-green-600 hover:bg-green-700 text-white font-bold rounded-lg interactive-button">Create New Alliance</button>
                </div>
                
                <button id="friends-close-btn-2" class="mt-6 py-3 px-6 bg-gray-700 hover:bg-gray-600 text-white font-bold rounded-lg interactive-button">Close</button>
            </div>
        </div>

        <!-- Live Transfer Market Modal -->
        <div id="live-transfer-modal" class="hidden fixed inset-0 modal-backdrop flex items-center justify-center z-50">
            <div class="bg-gray-900 rounded-xl shadow-2xl p-6 w-full max-w-6xl text-center border-4 border-yellow-500 relative">
                <button id="live-transfer-close-btn" class="absolute top-2 right-3 text-2xl text-gray-400 hover:text-white">&times;</button>
                <h2 class="text-3xl font-bold text-yellow-400 mb-6">Live Transfer Market</h2>
                
                <div class="flex border-b-2 border-gray-700 mb-6">
                    <button id="buy-players-tab" class="tab-button flex-1 py-2 px-4 text-lg font-semibold text-gray-400 border-b-4 border-transparent active">Buy Players</button>
                    <button id="sell-players-tab" class="tab-button flex-1 py-2 px-4 text-lg font-semibold text-gray-400 border-b-4 border-transparent">Sell Players</button>
                </div>
                
                <div id="buy-players-content">
                    <div class="mb-4 flex gap-4">
                        <input type="text" id="player-search" placeholder="Search players..." class="flex-1 px-4 py-2 bg-gray-700 border border-gray-600 rounded-lg text-white">
                        <select id="player-position-filter" class="px-4 py-2 bg-gray-700 border border-gray-600 rounded-lg text-white">
                            <option value="">All Positions</option>
                            <option value="GK">Goalkeeper</option>
                            <option value="DEF">Defender</option>
                            <option value="MID">Midfielder</option>
                            <option value="ATT">Attacker</option>
                        </select>
                        <select id="player-rarity-filter" class="px-4 py-2 bg-gray-700 border border-gray-600 rounded-lg text-white">
                            <option value="">All Rarities</option>
                            <option value="bronze">Bronze</option>
                            <option value="silver">Silver</option>
                            <option value="gold">Gold</option>
                            <option value="special">Special</option>
                        </select>
                    </div>
                    <div id="live-transfer-list" class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-4 max-h-96 overflow-y-auto">
                        <!-- Live transfer market players will be dynamically inserted here -->
                    </div>
                </div>
                
                <div id="sell-players-content" class="hidden">
                    <div id="sell-player-list-live" class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-4 max-h-96 overflow-y-auto">
                        <!-- Players to sell will be dynamically inserted here -->
                    </div>
                </div>
                
                <button id="live-transfer-close-btn-2" class="mt-6 py-3 px-6 bg-gray-700 hover:bg-gray-600 text-white font-bold rounded-lg interactive-button">Close</button>
            </div>
        </div>

        <div id="auth-screen" class="w-full h-full flex items-center justify-center bg-gray-900 hidden">
            <div class="w-full max-w-md p-8 space-y-6 bg-gray-800 rounded-xl shadow-2xl border border-green-500">
                <div>
                    <h2 class="text-center text-4xl font-extrabold text-green-400">‚öΩ Volta Efootball Manager</h2>
                    <p id="auth-title" class="mt-2 text-center text-sm text-gray-400">Login to your Club</p>
                </div>
                <form id="login-form" class="space-y-6">
                    <input id="login-email" type="email" placeholder="Email" required class="w-full px-4 py-3 bg-gray-700 border border-gray-600 rounded-lg text-white focus:outline-none focus:ring-2 focus:ring-green-500">
                    <input id="login-password" type="password" placeholder="Password" required class="w-full px-4 py-3 bg-gray-700 border border-gray-600 rounded-lg text-white focus:outline-none focus:ring-2 focus:ring-green-500">
                    <button type="submit" class="w-full py-3 px-4 btn-primary rounded-lg">Login</button>
                </form>
                <form id="signup-form" class="space-y-6 hidden">
                    <input id="signup-email" type="email" placeholder="Email" required class="w-full px-4 py-3 bg-gray-700 border border-gray-600 rounded-lg text-white focus:outline-none focus:ring-2 focus:ring-green-500">
                    <input id="signup-password" type="password" placeholder="Password" required class="w-full px-4 py-3 bg-gray-700 border border-gray-600 rounded-lg text-white focus:outline-none focus:ring-2 focus:ring-green-500">
                    <input id="signup-club-name" type="text" placeholder="Club Name" required class="w-full px-4 py-3 bg-gray-700 border border-gray-600 rounded-lg text-white focus:outline-none focus:ring-2 focus:ring-green-500">
                    <div>
                        <label class="block text-gray-300 mb-2">Select Server</label>
                        <select id="signup-server" required class="w-full px-4 py-3 bg-gray-700 border border-gray-600 rounded-lg text-white focus:outline-none focus:ring-2 focus:ring-green-500">
                            <option value="bangladesh">Bangladesh (0-100ms)</option>
                            <option value="singapore">Singapore (100-150ms)</option>
                            <option value="usa">USA (200-300ms)</option>
                            <option value="brazil">Brazil (200-300ms)</option>
                        </select>
                    </div>
                    <button type="submit" class="w-full py-3 px-4 bg-green-600 hover:bg-green-700 text-white font-bold rounded-lg interactive-button">Sign Up</button>
                </form>
                <p id="auth-toggle" class="text-center text-sm text-green-400 hover:underline cursor-pointer">
                    Don't have an account? Sign Up
                </p>
                <p id="auth-error" class="text-center text-sm text-red-400"></p>
            </div>
        </div>

        <div id="game-content" class="hidden w-full h-full flex relative">
            
            <header class="top-bar fixed top-0 left-0 right-0 h-16 flex items-center justify-between px-4 z-40">
                <div class="flex items-center space-x-3">
                    <div id="user-avatar-container" class="relative group cursor-pointer">
                        <img id="user-avatar" src="https://placehold.co/96x96/161b22/FFFFFF?text=S" alt="Club Logo" class="w-12 h-12 rounded-full border-2 border-green-500 object-cover">
                        <input type="file" id="logo-upload" class="hidden" accept="image/*">
                    </div>
                    <div>
                         <div class="flex items-center">
                            <h1 id="user-club-name" class="text-lg font-bold text-white truncate max-w-[150px]">Club Name</h1>
                             <span id="edit-club-name" class="ml-2 cursor-pointer text-gray-400 hover:text-green-400"><i class="fas fa-edit text-xs"></i></span>
                         </div>
                         <div class="flex items-center space-x-2 mt-1">
                            <p class="text-sm text-gray-400">Lvl: <span id="user-level">1</span></p>
                            <div class="xp-bar-container">
                                <div id="xp-bar-fill" style="width: 0%;"></div>
                            </div>
                         </div>
                    </div>
                </div>
                <div class="flex items-center space-x-4 bg-gray-900 px-4 py-1 rounded-full">
                    <div class="flex items-center space-x-2">
                        <i class="fas fa-coins text-yellow-400"></i>
                        <span id="user-balance" class="font-bold text-white">1000</span>
                    </div>
                    <div class="flex items-center space-x-2">
                         <i class="fas fa-gem text-blue-400"></i>
                         <span id="user-gems" class="font-bold text-white">100</span>
                    </div>
                    <div class="flex items-center space-x-2">
                         <i class="fas fa-dumbbell text-yellow-400"></i>
                         <span id="user-training-points" class="font-bold text-white">0</span>
                    </div>
                </div>
                <div class="flex items-center space-x-4 bg-gray-900 px-4 py-1 rounded-full">
                    <div class="flex items-center space-x-2">
                        <i class="fas fa-server text-green-400"></i>
                        <span id="user-server" class="font-bold text-white">BD</span>
                    </div>
                    <div class="flex items-center space-x-2">
                        <i class="fas fa-signal text-blue-400"></i>
                        <span id="user-ping" class="font-bold text-white">0ms</span>
                    </div>
                </div>
                 <div class="flex items-center space-x-4">
                     <button id="header-settings-btn" class="text-gray-300 hover:text-green-400 text-xl"><i class="fas fa-cog"></i></button>
                     <button id="logout-btn" class="text-gray-300 hover:text-red-500 text-xl"><i class="fas fa-sign-out-alt"></i></button>
                </div>
            </header>

            <aside class="left-sidebar fixed top-16 left-0 w-24 h-[calc(100%-4rem-4rem)] flex flex-col items-center py-4 space-y-4 z-30">
                <a href="#season-pass" class="nav-link flex flex-col items-center text-gray-300 w-full py-2" title="Season Pass"><i class="fas fa-ticket-alt text-2xl"></i><span class="text-xs mt-1 font-semibold">Season Pass</span></a>
                <a href="#events" class="nav-link flex flex-col items-center text-gray-300 w-full py-2" title="Events"><i class="fas fa-star text-2xl"></i><span class="text-xs mt-1 font-semibold">Events</span></a>
                <a href="#esports" class="nav-link flex flex-col items-center text-gray-300 w-full py-2" title="ESPORTS"><i class="fas fa-gamepad text-2xl"></i><span class="text-xs mt-1 font-semibold">ESPORTS</span></a>
                <a href="#leaderboard" class="nav-link flex flex-col items-center text-gray-300 w-full py-2" title="Leaderboard"><i class="fas fa-trophy text-2xl"></i><span class="text-xs mt-1 font-semibold">Ranking</span></a>
                <a href="#chat" class="nav-link flex flex-col items-center text-gray-300 w-full py-2" title="Global Chat"><i class="fas fa-comments text-2xl"></i><span class="text-xs mt-1 font-semibold">Chat</span></a>
                <a href="#about" class="nav-link flex flex-col items-center text-gray-300 w-full py-2" title="About"><i class="fas fa-info-circle text-2xl"></i><span class="text-xs mt-1 font-semibold">About</span></a>
            </aside>

            <main class="w-full h-full pt-16 pb-16 pl-24 overflow-y-auto">
                <div id="home-view" class="view p-6">
                    <div class="grid grid-cols-5 gap-6 h-full">
                        <a href="#events" class="nav-link col-span-3 h-full promo-card interactive-button" style="background-image: url('https://e0.pxfuel.com/wallpapers/36/389/desktop-wallpaper-fifa-23-background-fifa-2023.jpg');">
                            <div class="relative w-full h-full flex flex-col justify-end p-8 overlay">
                                <h2 class="text-4xl font-black text-white tracking-wider">SPECIAL EVENTS</h2>
                                <p class="text-lg text-gray-200 mt-2">Check out limited-time challenges and rewards!</p>
                            </div>
                        </a>
                        <div class="col-span-2 h-full flex flex-col gap-6">
                            <a href="#squad" class="nav-link h-1/2 w-full promo-card interactive-button" style="background-image: url('https://e1.pxfuel.com/desktop-wallpaper/683/288/desktop-wallpaper-fifa-21-ultimate-team-on-behance-fut.jpg'); background-position: top;">
                                 <div class="relative w-full h-full flex flex-col justify-end p-6 overlay">
                                    <h3 class="text-3xl font-bold text-white">CLUB</h3>
                                    <div class="mt-2 text-xl font-semibold bg-black bg-opacity-50 px-3 py-1 rounded-full w-fit text-yellow-400">
                                        OVR: <span id="team-power-stat">0</span>
                                    </div>
                                </div>
                            </a>
                            <a href="#match" class="nav-link h-1/2 w-full promo-card interactive-button" style="background-image: url('https://wallpaper.dog/large/10988167.jpg');">
                                 <div class="relative w-full h-full flex flex-col justify-end p-6 overlay bg-green-800 bg-opacity-30">
                                    <h3 class="text-3xl font-bold text-white">PLAY</h3>
                                    <p class="text-md text-gray-200">Face off against rivals in PvP matches.</p>
                                </div>
                            </a>
                        </div>
                    </div>
                </div>

                <div id="squad-view" class="view hidden p-6">
                    <button class="back-to-home nav-link mb-6 bg-gray-700 hover:bg-gray-600 px-4 py-2 rounded-lg interactive-button">&larr; Back to Home</button>
                    <div class="flex justify-between items-center mb-6">
                        <h1 class="text-3xl font-bold text-green-400">My Squad (5-player team)</h1>
                        <div class="flex space-x-4">
                            <button id="training-btn" class="py-2 px-4 bg-blue-600 hover:bg-blue-700 text-white font-bold rounded-lg interactive-button">
                                <i class="fas fa-dumbbell mr-2"></i>Training
                            </button>
                            <button id="formation-btn" class="py-2 px-4 bg-purple-600 hover:bg-purple-700 text-white font-bold rounded-lg interactive-button">
                                <i class="fas fa-chess-board mr-2"></i>Formation
                            </button>
                            <button id="advanced-tactics-btn" class="py-2 px-4 bg-indigo-600 hover:bg-indigo-700 text-white font-bold rounded-lg interactive-button">
                                <i class="fas fa-cogs mr-2"></i>Advanced Tactics
                            </button>
                        </div>
                    </div>
                    <div id="squad-list" class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-4 xl:grid-cols-5 gap-6"></div>
                </div>
                <div id="match-view" class="view hidden p-6 relative">
                    <button class="back-to-home nav-link mb-6 bg-gray-700 hover:bg-gray-600 px-4 py-2 rounded-lg interactive-button">&larr; Back to Home</button>
                     <h1 class="text-3xl font-bold mb-8 text-green-400">PvP Match</h1>
                    <div id="match-initial-screen">
                        <div class="flex flex-col md:flex-row gap-6 mb-6">
                            <button id="find-match-btn" class="flex-1 py-5 px-6 bg-green-600 hover:bg-green-700 text-white font-bold rounded-xl text-2xl transition duration-300 disabled:bg-gray-500 disabled:cursor-not-allowed interactive-button" disabled>
                                Find PvP Match
                            </button>
                            <button id="single-player-btn" class="flex-1 py-5 px-6 bg-blue-600 hover:bg-blue-700 text-white font-bold rounded-xl text-2xl transition duration-300 interactive-button">
                                Single Player
                            </button>
                            <button id="friendly-match-btn" class="flex-1 py-5 px-6 bg-yellow-600 hover:bg-yellow-700 text-white font-bold rounded-xl text-2xl transition duration-300 interactive-button">
                                Friendly Match
                            </button>
                        </div>
                        <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                            <div class="player-card p-4 text-center">
                                <h3 class="text-xl font-bold text-green-400 mb-2">League</h3>
                                <p class="text-gray-300 mb-4">Play in league matches</p>
                                <button class="w-full py-2 px-4 bg-green-600 hover:bg-green-700 text-white font-bold rounded-lg interactive-button">Join League</button>
                            </div>
                            <div class="player-card p-4 text-center">
                                <h3 class="text-xl font-bold text-yellow-400 mb-2">Tournament</h3>
                                <p class="text-gray-300 mb-4">Knockout competitions</p>
                                <button class="w-full py-2 px-4 bg-yellow-600 hover:bg-yellow-700 text-white font-bold rounded-lg interactive-button">Enter Tournament</button>
                            </div>
                            <div class="player-card p-4 text-center">
                                <h3 class="text-xl font-bold text-blue-400 mb-2">Private League</h3>
                                <p class="text-gray-300 mb-4">Create or join private leagues</p>
                                <button class="w-full py-2 px-4 bg-blue-600 hover:bg-blue-700 text-white font-bold rounded-lg interactive-button">Private League</button>
                            </div>
                        </div>
                    </div>
                     <div id="matchmaking-screen" class="hidden text-center">
                        <p class="text-2xl mb-4 text-yellow-400">Searching for opponent...</p>
                        <div class="animate-spin rounded-full h-20 w-20 border-t-4 border-b-4 border-green-500 mx-auto"></div>
                        <button id="cancel-matchmaking-btn" class="mt-8 py-3 px-6 bg-red-600 hover:bg-red-700 text-white font-bold rounded-lg interactive-button">Cancel</button>
                    </div>
                    <div id="match-simulation-screen" class="hidden">
                         <div id="reaction-display-area" class="absolute top-1/2 left-1/2 -translate-x-1/2 -translate-y-1/2 z-20 pointer-events-none"></div>
                        <div class="flex flex-col md:flex-row justify-between items-center bg-gray-900 bg-opacity-80 p-6 rounded-xl mb-6 shadow-2xl border-b-4 border-green-500">
                            <div class="flex flex-col items-center w-full md:w-1/3 mb-4 md:mb-0">
                                <img id="teamA-avatar" src="https://placehold.co/60x60/161b22/FFFFFF?text=A" alt="Team A Logo" class="w-12 h-12 rounded-full border-2 border-green-500 object-cover mb-2">
                                <p id="teamA-name" class="font-bold text-xl md:text-2xl truncate text-green-400">Team A</p>
                                <p id="teamA-score" class="text-5xl font-extrabold text-white">0</p>
                            </div>
                            <div class="text-center mb-4 md:mb-0"><p id="match-timer" class="text-3xl font-mono text-yellow-400 bg-gray-700 px-4 py-2 rounded">00:00</p></div>
                            <div class="flex flex-col items-center w-full md:w-1/3">
                                <img id="teamB-avatar" src="https://placehold.co/60x60/161b22/FFFFFF?text=B" alt="Team B Logo" class="w-12 h-12 rounded-full border-2 border-green-500 object-cover mb-2">
                                <p id="teamB-name" class="font-bold text-xl md:text-2xl truncate text-green-400">Team B</p>
                                <p id="teamB-score" class="text-5xl font-extrabold text-white">0</p>
                            </div>
                        </div>
                        
                        <!-- Match Pitch Visualization -->
                        <div id="match-pitch-container" class="w-full p-4 bg-gray-900 rounded-lg mb-6 relative overflow-hidden">
                            <div id="match-pitch" class="relative w-full h-80 bg-green-700 border-2 border-white rounded-lg overflow-hidden">
                                <!-- Pitch markings -->
                                <div class="absolute top-0 left-1/2 w-1 h-full bg-white transform -translate-x-1/2"></div>
                                <div class="absolute top-1/2 left-1/2 w-20 h-20 border-2 border-white rounded-full transform -translate-x-1/2 -translate-y-1/2"></div>
                                <div class="absolute top-0 left-0 w-1/2 h-full border-r border-white"></div>
                                <div class="absolute top-0 right-0 w-1/2 h-full border-l border-white"></div>
                                <div class="absolute top-1/4 left-0 w-1/4 h-1/2 border-2 border-white"></div>
                                <div class="absolute top-1/4 right-0 w-1/4 h-1/2 border-2 border-white"></div>
                                <div class="absolute top-1/2 left-0 w-2 h-2 bg-white rounded-full transform -translate-y-1/2"></div>
                                <div class="absolute top-1/2 right-0 w-2 h-2 bg-white rounded-full transform -translate-y-1/2"></div>
                                
                                <!-- Ball element -->
                                <div id="match-ball" class="absolute w-4 h-4 bg-white rounded-full transform -translate-x-1/2 -translate-y-1/2 transition-all duration-300 ease-out shadow-lg" style="top: 50%; left: 50%;"></div>
                                
                                <!-- Player positions will be added here dynamically -->
                            </div>
                        </div>
                        
                        <!-- Match Stats Panel -->
                        <div id="match-stats-panel" class="w-full p-2 bg-gray-800 rounded-lg mb-6 flex flex-col justify-between">
                            
                            <div class="text-center mb-4">
                                <div class="flex justify-between items-center mt-2 text-sm">
                                    <span id="home-possession" class="font-bold text-green-400">0%</span>
                                    <div class="flex-grow mx-2 h-2 bg-red-600 rounded-full overflow-hidden">
                                        <div id="possession-bar" class="h-2 bg-green-400 transition-all duration-500 ease-out" style="width: 50%;"></div>
                                    </div>
                                    <span id="away-possession" class="font-bold text-red-400">0%</span>
                                </div>
                            </div>

                            <div class="flex flex-col space-y-2 text-sm">
                                <div class="flex justify-between">
                                    <span id="home-shots" class="font-bold">0</span>
                                    <span class="text-gray-400">Total Shots</span>
                                    <span id="away-shots" class="font-bold">0</span>
                                </div>
                                
                                <div class="flex justify-between">
                                    <span id="home-shots-on-target" class="font-bold">0</span>
                                    <span class="text-gray-400">Shots on Target</span>
                                    <span id="away-shots-on-target" class="font-bold">0</span>
                                </div>
                                
                                <div class="flex justify-between">
                                    <span id="home-corners" class="font-bold">0</span>
                                    <span class="text-gray-400">Corners</span>
                                    <span id="away-corners" class="font-bold">0</span>
                                </div>
                                
                                <div class="flex justify-between">
                                    <span id="home-fouls" class="font-bold">0</span>
                                    <span class="text-gray-400">Fouls</span>
                                    <span id="away-fouls" class="font-bold">0</span>
                                </div>
                                
                                <div class="flex justify-between">
                                    <span id="home-cards" class="font-bold">0 (0 Y/ 0 R)</span>
                                    <span class="text-gray-400">Cards</span>
                                    <span id="away-cards" class="font-bold">0 (0 Y/ 0 R)</span>
                                </div>
                            </div>

                        </div>
                        
                        <!-- In-Match Chat -->
                        <div id="in-match-chat" class="bg-gray-900 bg-opacity-80 rounded-xl mb-6 border border-gray-700 shadow-inner hidden">
                            <div class="flex justify-between items-center p-3 border-b border-gray-700">
                                <h3 class="text-lg font-bold text-green-400">Match Chat</h3>
                                <button id="toggle-chat-btn" class="text-gray-400 hover:text-white">
                                    <i class="fas fa-chevron-up"></i>
                                </button>
                            </div>
                            <div id="in-match-chat-messages" class="h-32 overflow-y-auto p-3 text-sm"></div>
                            <div class="p-3 border-t border-gray-700">
                                <form id="in-match-chat-form" class="flex space-x-2">
                                    <input type="text" id="in-match-chat-input" placeholder="Type a message..." class="flex-grow px-3 py-2 bg-gray-700 border border-gray-600 rounded-lg text-white text-sm" maxlength="100">
                                    <button type="submit" class="px-3 py-2 bg-green-600 hover:bg-green-700 text-white rounded-lg text-sm">Send</button>
                                </form>
                            </div>
                        </div>
                        <div id="in-match-strategy-control" class="flex justify-center space-x-4 mb-6">
                            <button data-strategy="Attack" class="strategy-btn flex-1 py-3 px-2 bg-red-600 hover:bg-red-700 text-white font-bold rounded-lg interactive-button">Attack ‚öΩ</button>
                            <button data-strategy="Balanced" class="strategy-btn flex-1 py-3 px-2 btn-primary rounded-lg">Balanced ‚öñÔ∏è</button>
                            <button data-strategy="Defense" class="strategy-btn flex-1 py-3 px-2 bg-blue-600 hover:bg-blue-700 text-white font-bold rounded-lg interactive-button">Defense üõ°Ô∏è</button>
                            <button id="substitution-btn" class="py-3 px-4 bg-purple-600 hover:bg-purple-700 text-white font-bold rounded-lg interactive-button">Substitutions</button>
                        </div>
                        <div id="live-commentary" class="bg-gray-900 bg-opacity-80 p-5 rounded-xl h-96 overflow-y-auto border border-gray-700 shadow-inner text-gray-300"></div>
                         <!-- Emoji Reaction System -->
                        <div id="emoji-reaction-container">
                             <div id="emoji-panel" class="hidden mb-2">
                                <span class="emoji" data-emoji="üëç">üëç</span>
                                <span class="emoji" data-emoji="üòÇ">üòÇ</span>
                                <span class="emoji" data-emoji="üò°">üò°</span>
                                <span class="emoji" data-emoji="‚öΩ">‚öΩ</span>
                                <span class="emoji" data-emoji="üî•">üî•</span>
                            </div>
                            <button id="emoji-toggle-btn" class="w-14 h-14 bg-yellow-500 hover:bg-yellow-600 rounded-full flex items-center justify-center text-3xl interactive-button">üòÄ</button>
                        </div>
                    </div>
                    
                    <!-- Victory Screen -->
                    <div id="victory-screen" class="hidden fixed inset-0 flex items-center justify-center z-50 bg-black bg-opacity-80">
                        <div class="text-center">
                            <h1 class="text-6xl md:text-8xl font-extrabold text-green-400 mb-6 animate-bounce">VICTORY!</h1>
                            <p class="text-2xl text-white mb-8">Congratulations on your win!</p>
                            <button id="back-to-main-menu-btn" class="py-3 px-8 bg-green-600 hover:bg-green-700 text-white font-bold rounded-lg text-xl interactive-button">Back to Main Menu</button>
                        </div>
                    </div>
                    
                    <!-- Defeat Screen -->
                    <div id="defeat-screen" class="hidden fixed inset-0 flex items-center justify-center z-50 bg-black bg-opacity-80">
                        <div class="text-center">
                            <h1 class="text-6xl md:text-8xl font-extrabold text-red-500 mb-6 animate-pulse">DEFEAT!</h1>
                            <p class="text-2xl text-white mb-8">Better luck next time!</p>
                            <button id="back-to-main-menu-defeat-btn" class="py-3 px-8 bg-red-600 hover:bg-red-700 text-white font-bold rounded-lg text-xl interactive-button">Back to Main Menu</button>
                        </div>
                    </div>
                </div>
                <div id="events-view" class="view hidden p-6">
                    <button class="back-to-home nav-link mb-6 bg-gray-700 hover:bg-gray-600 px-4 py-2 rounded-lg interactive-button">&larr; Back to Home</button>
                    <h1 class="text-3xl font-bold mb-8 text-green-400">Club Events</h1>
                    <div id="events-list" class="space-y-6"></div>
                </div>
                <!-- Season Pass View -->
                <div id="season-pass-view" class="view hidden p-6">
                    <button class="back-to-home nav-link mb-6 bg-gray-700 hover:bg-gray-600 px-4 py-2 rounded-lg interactive-button">&larr; Back to Home</button>
                    <div class="flex justify-between items-center mb-6">
                        <h1 class="text-3xl font-bold text-purple-400">Season Pass</h1>
                        <button id="buy-premium-pass-btn" class="bg-purple-600 hover:bg-purple-700 text-white font-bold py-3 px-6 rounded-lg interactive-button shadow-lg disabled:bg-gray-500 disabled:cursor-not-allowed">
                            Premium Pass (99 BDT)
                        </button>
                    </div>

                    <!-- Progress Bar -->
                    <div class="mb-8">
                        <div class="flex justify-between items-end mb-2">
                            <div class="text-lg">Level: <span id="sp-current-level" class="font-bold text-xl text-purple-300">1</span></div>
                            <div class="text-sm text-gray-400"><span id="sp-current-xp">0</span> / <span id="sp-needed-xp">100</span> XP</div>
                        </div>
                        <div class="season-pass-progress-container">
                            <div id="season-pass-progress-fill" style="width: 0%;"></div>
                        </div>
                        <p class="text-right text-sm mt-1 text-gray-500">Season ends in: <span id="season-end-timer">60d 0h 0m</span></p>
                    </div>

                    <!-- Tabs -->
                    <div class="flex border-b-2 border-gray-700 mb-6">
                        <button id="missions-tab" class="tab-button flex-1 py-2 px-4 text-lg font-semibold text-gray-400 border-b-4 border-transparent active">Missions</button>
                        <button id="rewards-tab" class="tab-button flex-1 py-2 px-4 text-lg font-semibold text-gray-400 border-b-4 border-transparent">Rewards</button>
                    </div>

                    <!-- Missions Content -->
                    <div id="missions-content">
                        <div class="mb-8">
                            <h2 class="text-2xl font-semibold mb-4 text-green-400 border-b-2 border-gray-700 pb-2">Daily Missions</h2>
                            <div id="daily-missions-list" class="space-y-4"></div>
                        </div>
                        <div class="mb-8">
                            <h2 class="text-2xl font-semibold mb-4 text-green-400 border-b-2 border-gray-700 pb-2">Weekly Missions</h2>
                            <div id="weekly-missions-list" class="space-y-4"></div>
                        </div>
                        <div>
                            <h2 class="text-2xl font-semibold mb-4 text-green-400 border-b-2 border-gray-700 pb-2">Seasonal Missions</h2>
                            <div id="seasonal-missions-list" class="space-y-4"></div>
                        </div>
                    </div>

                    <!-- Rewards Content -->
                    <div id="rewards-content" class="hidden">
                        <p class="text-center text-gray-400">View and claim your rewards as you level up!</p>
                        <div id="rewards-track-list" class="mt-6 space-y-4"></div>
                    </div>
                </div>

                <div id="leaderboard-view" class="view hidden p-6">
                    <button class="back-to-home nav-link mb-6 bg-gray-700 hover:bg-gray-600 px-4 py-2 rounded-lg interactive-button">&larr; Back to Home</button>
                    <h1 class="text-3xl font-bold mb-8 text-green-400">World Leaderboard</h1>
                    <div class="bg-gray-800 bg-opacity-80 rounded-xl shadow-xl overflow-hidden border border-green-500">
                        <table class="w-full text-left">
                            <thead class="bg-gray-900 border-b border-green-500"><tr><th class="p-4 text-green-400">Rank</th><th class="p-4 text-green-400">Club Name</th><th class="p-4 text-green-400">Level</th><th class="p-4 text-green-400">Points</th></tr></thead>
                            <tbody id="leaderboard-body"></tbody>
                        </table>
                    </div>
                </div>
                <div id="store-view" class="view hidden p-6">
                    <button class="back-to-home nav-link mb-6 bg-gray-700 hover:bg-gray-600 px-4 py-2 rounded-lg interactive-button">&larr; Back to Home</button>
                    <h1 class="text-3xl font-bold mb-8 text-green-400">Item Store</h1>
                    <div class="flex border-b-2 border-gray-700 mb-6">
                        <button id="players-tab" class="tab-button flex-1 py-2 px-4 text-lg font-semibold text-gray-400 border-b-4 border-transparent active">Players</button>
                        <button id="packs-tab" class="tab-button flex-1 py-2 px-4 text-lg font-semibold text-gray-400 border-b-4 border-transparent">Player Packs</button>
                        <button id="items-tab" class="tab-button flex-1 py-2 px-4 text-lg font-semibold text-gray-400 border-b-4 border-transparent">Special Items</button>
                    </div>
                    <div id="store-items" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6"></div>
                    <div id="store-packs" class="hidden grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6"></div>
                    <div id="store-special-items" class="hidden grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6"></div>
                </div>
                <div id="transfers-view" class="view hidden p-6">
                    <button class="back-to-home nav-link mb-6 bg-gray-700 hover:bg-gray-600 px-4 py-2 rounded-lg interactive-button">&larr; Back to Home</button>
                    <h1 class="text-3xl font-bold mb-8 text-green-400">Transfer Market</h1>
                    <div class="mb-6">
                        <button id="open-live-market-btn" class="py-3 px-6 bg-yellow-600 hover:bg-yellow-700 text-white font-bold rounded-lg interactive-button mb-6">
                            <i class="fas fa-globe-americas mr-2"></i>Live Player-to-Player Transfer Market
                        </button>
                    </div>
                    <div class="mb-10"><h2 class="text-2xl font-semibold mb-4 border-b-2 border-gray-700 pb-2 text-green-400">Buy Players</h2><div id="transfer-market-list" class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-4 xl:grid-cols-5 gap-6"></div></div>
                    <div><h2 class="text-2xl font-semibold mb-4 border-b-2 border-gray-700 pb-2 text-green-400">Sell Your Players</h2><div id="sell-player-list" class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-4 xl:grid-cols-5 gap-6"></div></div>
                </div>
                <div id="esports-view" class="view hidden p-6">
                    <button class="back-to-home nav-link mb-6 bg-gray-700 hover:bg-gray-600 px-4 py-2 rounded-lg interactive-button">&larr; Back to Home</button>
                    <h1 class="text-3xl font-bold mb-8 text-green-400">ESPORTS SECTION</h1>
                    <div id="tournament-list" class="space-y-6"></div>
                </div>
                <div id="chat-view" class="view hidden p-6">
                    <button class="back-to-home nav-link mb-6 bg-gray-700 hover:bg-gray-600 px-4 py-2 rounded-lg interactive-button">&larr; Back to Home</button>
                    <h1 class="text-3xl font-bold mb-8 text-green-400">Global Chat</h1>
                    <div class="flex flex-col h-[70vh] bg-gray-900 bg-opacity-80 rounded-xl shadow-2xl border border-green-500">
                        <div id="chat-messages" class="flex-grow p-4 overflow-y-auto space-y-3"></div>
                        <div class="p-4 border-t border-gray-700">
                            <form id="chat-form" class="flex space-x-3">
                                <input type="text" id="chat-input" placeholder="Type your message..." maxlength="100" class="flex-grow px-4 py-3 bg-gray-700 border border-gray-600 rounded-lg text-white focus:outline-none focus:ring-2 focus:ring-green-500" required>
                                <button type="submit" class="btn-primary py-3 px-6 rounded-lg font-bold">Send</button>
                            </form>
                        </div>
                    </div>
                </div>
                <div id="about-view" class="view hidden p-6">
                    <button class="back-to-home nav-link mb-6 bg-gray-700 hover:bg-gray-600 px-4 py-2 rounded-lg interactive-button">&larr; Back to Home</button>
                    <h1 class="text-4xl font-extrabold mb-6 text-green-400">About Volta Efootball Manager</h1>
                    <div class="player-card p-8 text-center max-w-2xl mx-auto">
                        <p class="text-2xl text-gray-200">This game was created by</p>
                        <h2 class="text-5xl font-bold my-4 text-green-300 tracking-wider">SWAMPOD & MITHUN</h2>
                        <div class="border-t border-gray-600 my-8"></div>
                        <p class="mt-4 text-lg text-gray-400">Version: <span class="font-bold text-yellow-400">1.0</span></p>
                    </div>
                </div>
                
                <div id="match-history-view" class="view hidden p-6">
                    <button class="back-to-home nav-link mb-6 bg-gray-700 hover:bg-gray-600 px-4 py-2 rounded-lg interactive-button">&larr; Back to Home</button>
                    <h1 class="text-3xl font-bold mb-8 text-green-400">Match History</h1>
                    
                    <div class="player-card p-6 mb-6">
                        <h2 class="text-2xl font-bold text-green-400 mb-4">Your Recent Matches</h2>
                        <div id="match-history-list" class="space-y-4">
                            <!-- Match history will be dynamically loaded here -->
                            <p class="text-gray-400 text-center">Loading match history...</p>
                        </div>
                    </div>
                    
                    <div class="player-card p-6">
                        <h2 class="text-2xl font-bold text-green-400 mb-4">Match Statistics</h2>
                        <div class="grid grid-cols-1 md:grid-cols-3 gap-4 text-center">
                            <div class="bg-gray-800 p-4 rounded-lg">
                                <p class="text-3xl font-bold text-green-400" id="total-matches">0</p>
                                <p class="text-gray-400">Total Matches</p>
                            </div>
                            <div class="bg-gray-800 p-4 rounded-lg">
                                <p class="text-3xl font-bold text-green-400" id="wins-count">0</p>
                                <p class="text-gray-400">Wins</p>
                            </div>
                            <div class="bg-gray-800 p-4 rounded-lg">
                                <p class="text-3xl font-bold text-green-400" id="win-rate">0%</p>
                                <p class="text-gray-400">Win Rate</p>
                            </div>
                        </div>
                    </div>
                </div>
                <!-- New Views for Enhanced Features -->
                <div id="club-management-view" class="view hidden p-6">
                    <button class="back-to-home nav-link mb-6 bg-gray-700 hover:bg-gray-600 px-4 py-2 rounded-lg interactive-button">&larr; Back to Home</button>
                    <h1 class="text-3xl font-bold mb-8 text-green-400">Club Management</h1>
                    
                    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6 mb-8">
                        <div class="player-card p-6 text-center cursor-pointer interactive-button" id="facilities-btn">
                            <div class="text-4xl mb-4 text-blue-400"><i class="fas fa-building"></i></div>
                            <h3 class="text-xl font-bold text-white mb-2">Club Facilities</h3>
                            <p class="text-gray-400">Upgrade your stadium, training ground, and youth academy</p>
                        </div>
                        <div class="player-card p-6 text-center cursor-pointer interactive-button" id="sponsorship-btn">
                            <div class="text-4xl mb-4 text-yellow-400"><i class="fas fa-handshake"></i></div>
                            <h3 class="text-xl font-bold text-white mb-2">Sponsorship</h3>
                            <p class="text-gray-400">Sign sponsorship deals for additional income</p>
                        </div>
                        <div class="player-card p-6 text-center cursor-pointer interactive-button" id="kit-designer-btn">
                            <div class="text-4xl mb-4 text-purple-400"><i class="fas fa-tshirt"></i></div>
                            <h3 class="text-xl font-bold text-white mb-2">Kit Designer</h3>
                            <p class="text-gray-400">Design custom kits for your club</p>
                        </div>
                        <div class="player-card p-6 text-center cursor-pointer interactive-button" id="youth-squad-btn">
                            <div class="text-4xl mb-4 text-green-400"><i class="fas fa-users"></i></div>
                            <h3 class="text-xl font-bold text-white mb-2">Youth Squad</h3>
                            <p class="text-gray-400">Manage your youth academy players</p>
                        </div>
                        <div class="player-card p-6 text-center cursor-pointer interactive-button" id="settings-btn">
                            <div class="text-4xl mb-4 text-green-400"><i class="fas fa-cog"></i></div>
                            <h3 class="text-xl font-bold text-white mb-2">Game Settings</h3>
                            <p class="text-gray-400">Adjust graphics, FPS, audio and view server info</p>
                        </div>
                    </div>
                    
                    <div class="player-card p-6">
                        <h2 class="text-2xl font-bold text-green-400 mb-4">Club Finances</h2>
                        <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                            <div class="text-center">
                                <p class="text-gray-400">Weekly Income</p>
                                <p class="text-2xl font-bold text-yellow-400" id="weekly-income">0 Coins</p>
                            </div>
                            <div class="text-center">
                                <p class="text-gray-400">Weekly Expenses</p>
                                <p class="text-2xl font-bold text-red-400" id="weekly-expenses">0 Coins</p>
                            </div>
                            <div class="text-center">
                                <p class="text-gray-400">Net Profit</p>
                                <p class="text-2xl font-bold text-green-400" id="net-profit">0 Coins</p>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div id="youth-squad-view" class="view hidden p-6">
                    <button class="back-to-home nav-link mb-6 bg-gray-700 hover:bg-gray-600 px-4 py-2 rounded-lg interactive-button">&larr; Back to Management</button>
                    <h1 class="text-3xl font-bold mb-8 text-green-400">Youth Squad</h1>
                    
                    <div class="player-card p-6 mb-6">
                        <h2 class="text-2xl font-bold text-green-400 mb-4">Youth Academy Players</h2>
                        <p class="text-gray-400 mb-4">Train your young talents and prepare them for the first team.</p>
                        
                        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6 mb-6" id="youth-players-container">
                            <!-- Youth players will be dynamically loaded here -->
                        </div>
                        
                        <div class="text-center">
                            <button id="generate-youth-player-btn" class="py-2 px-6 bg-green-600 hover:bg-green-700 text-white font-bold rounded-lg interactive-button">
                                <i class="fas fa-plus-circle mr-2"></i>Generate New Youth Player (500 Coins)
                            </button>
                        </div>
                    </div>
                    
                    <div class="player-card p-6">
                        <h2 class="text-2xl font-bold text-green-400 mb-4">Training Focus</h2>
                        <p class="text-gray-400 mb-4">Select a training focus to improve specific attributes of your youth players. Higher level Youth Academy facilities provide better training results.</p>
                        
                        <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-4">
                            <div class="bg-gray-800 p-4 rounded-lg cursor-pointer training-focus-option border-2 border-transparent hover:border-green-500" data-focus="pace">
                                <h3 class="text-lg font-bold text-white mb-2">Speed Training</h3>
                                <p class="text-gray-400 text-sm mb-3">Focus on improving player pace and acceleration</p>
                                <div class="flex items-center text-green-400">
                                    <i class="fas fa-tachometer-alt mr-2"></i>
                                    <span>Improves Pace attribute</span>
                                </div>
                            </div>
                            <div class="bg-gray-800 p-4 rounded-lg cursor-pointer training-focus-option border-2 border-transparent hover:border-green-500" data-focus="shooting">
                                <h3 class="text-lg font-bold text-white mb-2">Finishing Training</h3>
                                <p class="text-gray-400 text-sm mb-3">Focus on improving player shooting and finishing</p>
                                <div class="flex items-center text-red-400">
                                    <i class="fas fa-bullseye mr-2"></i>
                                    <span>Improves Shooting attribute</span>
                                </div>
                            </div>
                            <div class="bg-gray-800 p-4 rounded-lg cursor-pointer training-focus-option border-2 border-transparent hover:border-green-500" data-focus="passing">
                                <h3 class="text-lg font-bold text-white mb-2">Passing Training</h3>
                                <p class="text-gray-400 text-sm mb-3">Focus on improving player passing and vision</p>
                                <div class="flex items-center text-blue-400">
                                    <i class="fas fa-exchange-alt mr-2"></i>
                                    <span>Improves Passing attribute</span>
                                </div>
                            </div>
                        </div>
                        
                        <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                            <div class="bg-gray-800 p-4 rounded-lg cursor-pointer training-focus-option border-2 border-transparent hover:border-green-500" data-focus="dribbling">
                                <h3 class="text-lg font-bold text-white mb-2">Ball Skills</h3>
                                <p class="text-gray-400 text-sm mb-3">Focus on improving player dribbling and ball control</p>
                                <div class="flex items-center text-yellow-400">
                                    <i class="fas fa-futbol mr-2"></i>
                                    <span>Improves Dribbling attribute</span>
                                </div>
                            </div>
                            <div class="bg-gray-800 p-4 rounded-lg cursor-pointer training-focus-option border-2 border-transparent hover:border-green-500" data-focus="defending">
                                <h3 class="text-lg font-bold text-white mb-2">Defensive Training</h3>
                                <p class="text-gray-400 text-sm mb-3">Focus on improving player defending and positioning</p>
                                <div class="flex items-center text-purple-400">
                                    <i class="fas fa-shield-alt mr-2"></i>
                                    <span>Improves Defending attribute</span>
                                </div>
                            </div>
                            <div class="bg-gray-800 p-4 rounded-lg cursor-pointer training-focus-option border-2 border-transparent hover:border-green-500" data-focus="physical">
                                <h3 class="text-lg font-bold text-white mb-2">Fitness Training</h3>
                                <p class="text-gray-400 text-sm mb-3">Focus on improving player stamina and strength</p>
                                <div class="flex items-center text-orange-400">
                                    <i class="fas fa-dumbbell mr-2"></i>
                                    <span>Improves Physical attribute</span>
                                </div>
                            </div>
                        </div>
                        
                        <div class="mt-6 p-4 bg-gray-800 rounded-lg">
                            <h3 class="text-lg font-bold text-white mb-2">Training Progress</h3>
                            <div class="flex items-center">
                                <div class="flex-1 bg-gray-700 rounded-full h-4 mr-4">
                                    <div id="training-progress-bar" class="bg-gradient-to-r from-green-400 to-blue-500 h-4 rounded-full" style="width: 0%"></div>
                                </div>
                                <span id="training-progress-text" class="text-white font-bold">0%</span>
                            </div>
                            <p class="text-gray-400 text-sm mt-2">Training sessions are applied automatically. Higher Youth Academy level increases training effectiveness.</p>
                        </div>
                    </div>
                </div>
                
                <div id="social-view" class="view hidden p-6">
                    <button class="back-to-home nav-link mb-6 bg-gray-700 hover:bg-gray-600 px-4 py-2 rounded-lg interactive-button">&larr; Back to Home</button>
                    <h1 class="text-3xl font-bold mb-8 text-green-400">Social Features</h1>
                    
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-8">
                        <div class="player-card p-6 text-center cursor-pointer interactive-button" id="friends-btn">
                            <div class="text-4xl mb-4 text-blue-400"><i class="fas fa-user-friends"></i></div>
                            <h3 class="text-xl font-bold text-white mb-2">Friends & Alliances</h3>
                            <p class="text-gray-400">Connect with friends and join alliances</p>
                        </div>
                        <div class="player-card p-6 text-center cursor-pointer interactive-button" id="alliance-wars-btn">
                            <div class="text-4xl mb-4 text-red-400"><i class="fas fa-fist-raised"></i></div>
                            <h3 class="text-xl font-bold text-white mb-2">Alliance Wars</h3>
                            <p class="text-gray-400">Compete against other alliances in tournaments</p>
                        </div>
                        <div class="player-card p-6 text-center cursor-pointer interactive-button" id="private-leagues-btn">
                            <div class="text-4xl mb-4 text-purple-400"><i class="fas fa-trophy"></i></div>
                            <h3 class="text-xl font-bold text-white mb-2">Private Leagues</h3>
                            <p class="text-gray-400">Create or join private leagues with friends</p>
                        </div>
                        <div class="player-card p-6 text-center cursor-pointer interactive-button" id="custom-tournaments-btn">
                            <div class="text-4xl mb-4 text-yellow-400"><i class="fas fa-medal"></i></div>
                            <h3 class="text-xl font-bold text-white mb-2">Custom Tournaments</h3>
                            <p class="text-gray-400">Create or join custom tournaments</p>
                        </div>
                    </div>
                    
                    <div class="player-card p-6">
                        <h2 class="text-2xl font-bold text-green-400 mb-4">Recent Friend Activity</h2>
                        <div id="friend-activity-list" class="space-y-4">
                            <!-- Friend activity will be dynamically inserted here -->
                        </div>
                    </div>
                </div>
                
                <div id="alliance-wars-view" class="view hidden p-6">
                    <button class="back-to-home nav-link mb-6 bg-gray-700 hover:bg-gray-600 px-4 py-2 rounded-lg interactive-button">&larr; Back to Social</button>
                    <h1 class="text-3xl font-bold mb-8 text-green-400">Alliance Wars</h1>
                    
                    <div class="grid grid-cols-1 lg:grid-cols-3 gap-6 mb-8">
                        <div class="player-card p-6 lg:col-span-2">
                            <h2 class="text-2xl font-bold text-green-400 mb-4">Active Alliance Wars</h2>
                            <div id="active-wars-list" class="space-y-4">
                                <!-- Active wars will be dynamically loaded here -->
                                <p class="text-gray-400 text-center">No active alliance wars at the moment.</p>
                            </div>
                        </div>
                        
                        <div class="player-card p-6">
                            <h2 class="text-2xl font-bold text-green-400 mb-4">Your Alliance</h2>
                            <div id="alliance-info" class="text-center">
                                <!-- Alliance info will be dynamically loaded here -->
                                <p class="text-gray-400">You are not currently in an alliance.</p>
                                <button id="join-alliance-wars-btn" class="mt-4 py-2 px-4 bg-green-600 hover:bg-green-700 text-white font-bold rounded-lg interactive-button">
                                    Join an Alliance
                                </button>
                            </div>
                        </div>
                    </div>
                    
                    <div class="player-card p-6">
                        <h2 class="text-2xl font-bold text-green-400 mb-4">War Tournament Bracket</h2>
                        <div class="bg-gray-800 rounded-lg p-6 text-center">
                            <p class="text-gray-400 mb-4">Tournament bracket will appear here when a war is active.</p>
                            <div class="flex justify-center space-x-8">
                                <div class="text-center">
                                    <div class="w-24 h-24 bg-gray-700 rounded-lg flex items-center justify-center mx-auto mb-2">
                                        <span class="text-gray-500">Alliance A</span>
                                    </div>
                                    <p class="text-sm text-gray-400">0 pts</p>
                                </div>
                                <div class="text-center">
                                    <div class="text-3xl text-gray-600 my-8">VS</div>
                                </div>
                                <div class="text-center">
                                    <div class="w-24 h-24 bg-gray-700 rounded-lg flex items-center justify-center mx-auto mb-2">
                                        <span class="text-gray-500">Alliance B</span>
                                    </div>
                                    <p class="text-sm text-gray-400">0 pts</p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div id="live-transfer-view" class="view hidden p-6">
                    <button class="back-to-home nav-link mb-6 bg-gray-700 hover:bg-gray-600 px-4 py-2 rounded-lg interactive-button">&larr; Back to Home</button>
                    <h1 class="text-3xl font-bold mb-8 text-green-400">Live Transfer Market</h1>
                    
                    <div class="player-card p-6 mb-6">
                        <div class="flex justify-between items-center mb-4">
                            <h2 class="text-xl font-bold text-white">Active Auctions</h2>
                            <button id="refresh-auctions-btn" class="py-2 px-4 bg-blue-600 hover:bg-blue-700 text-white font-bold rounded-lg interactive-button">
                                <i class="fas fa-sync-alt mr-2"></i>Refresh
                            </button>
                        </div>
                        <div id="auction-list" class="space-y-4 max-h-96 overflow-y-auto">
                            <!-- Active auctions will be dynamically inserted here -->
                        </div>
                    </div>
                    
                    <div class="player-card p-6">
                        <h2 class="text-xl font-bold text-white mb-4">Your Active Listings</h2>
                        <div id="my-listings" class="space-y-4">
                            <!-- User's active listings will be dynamically inserted here -->
                        </div>
                    </div>
                </div>
                
                <div id="custom-tournaments-view" class="view hidden p-6">
                    <button class="back-to-home nav-link mb-6 bg-gray-700 hover:bg-gray-600 px-4 py-2 rounded-lg interactive-button">&larr; Back to Home</button>
                    <h1 class="text-3xl font-bold mb-8 text-green-400">Custom Tournaments</h1>
                    
                    <div class="grid grid-cols-1 lg:grid-cols-3 gap-6 mb-8">
                        <div class="player-card p-6 lg:col-span-2">
                            <h2 class="text-2xl font-bold text-green-400 mb-4">Active Tournaments</h2>
                            <div id="active-tournaments-list" class="space-y-4">
                                <!-- Active tournaments will be dynamically loaded here -->
                                <p class="text-gray-400 text-center">No active tournaments at the moment.</p>
                            </div>
                        </div>
                        
                        <div class="player-card p-6">
                            <h2 class="text-2xl font-bold text-green-400 mb-4">Create Tournament</h2>
                            <p class="text-gray-400 mb-4">Create your own custom tournament with friends.</p>
                            <button id="create-tournament-btn" class="w-full py-3 px-4 bg-green-600 hover:bg-green-700 text-white font-bold rounded-lg interactive-button mb-4">
                                <i class="fas fa-plus-circle mr-2"></i>Create New Tournament
                            </button>
                            <div class="mt-6">
                                <h3 class="text-lg font-bold text-white mb-3">Tournament Types</h3>
                                <ul class="space-y-2 text-gray-400 text-sm">
                                    <li class="flex items-center"><i class="fas fa-check-circle text-green-400 mr-2"></i> Knockout Tournament</li>
                                    <li class="flex items-center"><i class="fas fa-check-circle text-green-400 mr-2"></i> League Tournament</li>
                                    <li class="flex items-center"><i class="fas fa-check-circle text-green-400 mr-2"></i> Group Stage + Knockout</li>
                                </ul>
                            </div>
                        </div>
                    </div>
                    
                    <div class="player-card p-6">
                        <h2 class="text-2xl font-bold text-green-400 mb-4">Your Tournaments</h2>
                        <div id="my-tournaments-list" class="space-y-4">
                            <!-- User's tournaments will be dynamically loaded here -->
                            <p class="text-gray-400 text-center">You haven't created or joined any tournaments yet.</p>
                        </div>
                    </div>
                </div>
            </main>

            <footer class="bottom-nav fixed bottom-0 left-0 right-0 h-16 flex items-center justify-around z-40">
                 <a href="#home" class="nav-link back-to-home flex flex-col items-center text-gray-300 p-2" title="Home"><i class="fas fa-home text-2xl"></i><span class="text-xs mt-1 font-semibold">Home</span></a>
                 <a href="#squad" class="nav-link flex flex-col items-center text-gray-300 p-2" title="My Squad"><i class="fas fa-users text-2xl"></i><span class="text-xs mt-1 font-semibold">Club</span></a>
                 <a href="#transfers" class="nav-link flex flex-col items-center text-gray-300 p-2" title="Transfers"><i class="fas fa-exchange-alt text-2xl"></i><span class="text-xs mt-1 font-semibold">Transfers</span></a>
                 <a href="#store" class="nav-link flex flex-col items-center text-gray-300 p-2" title="Store"><i class="fas fa-store text-2xl"></i><span class="text-xs mt-1 font-semibold">Store</span></a>
                 <a href="#season-pass" class="nav-link flex flex-col items-center text-gray-300 p-2" title="Season Pass"><i class="fas fa-ticket-alt text-2xl"></i><span class="text-xs mt-1 font-semibold">Season Pass</span></a>
                 <a href="#match-history" class="nav-link flex flex-col items-center text-gray-300 p-2" title="Match History"><i class="fas fa-history text-2xl"></i><span class="text-xs mt-1 font-semibold">History</span></a>
                 <a href="#club-management" class="nav-link flex flex-col items-center text-gray-300 p-2" title="Club Management"><i class="fas fa-cog text-2xl"></i><span class="text-xs mt-1 font-semibold">Management</span></a>
                 <a href="#social" class="nav-link flex flex-col items-center text-gray-300 p-2" title="Social"><i class="fas fa-users text-2xl"></i><span class="text-xs mt-1 font-semibold">Social</span></a>
            </footer>

        </div>
    </div>
    
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
        import { getAuth, createUserWithEmailAndPassword, signInWithEmailAndPassword, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
        import { getDatabase, ref, set, get, onValue, update, serverTimestamp, remove, push, onChildAdded, onDisconnect } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-database.js";

        const firebaseConfig = {
         apiKey: "AIzaSyCc9VfxfKPxG8TKUq7kovp1kKQDyEQosHY",
  authDomain: "efootball-manager-a2739.firebaseapp.com",
  databaseURL: "https://efootball-manager-a2739-default-rtdb.asia-southeast1.firebasedatabase.app",
  projectId: "efootball-manager-a2739",
  storageBucket: "efootball-manager-a2739.firebasestorage.app",
  messagingSenderId: "990435760435",
  appId: "1:990435760435:web:dfd38cfb17d22d88170646",
  measurementId: "G-0QD82FGFRG"
        };
        const IMGBB_API_KEY = "fe3e06e5bbecab856c63cf7e6a50a251";
        const MARADONA_PLAYER_ID = "MARADONA_PRIME"; 
        const MARADONA_CLAIM_MIN_POWER = 60;

        // XP and Leveling constants
        const XP_PER_WIN = 3;
        const XP_PER_DRAW = 2;
        const XP_PER_LOSS = 1;
        const BASE_MATCHES_FOR_LEVEL_UP = 15;

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getDatabase(app);
        
        let currentUserData = null; 
        let teamPower = 0;
        let matchListener = null;
        let timerInterval = null;
        let matchSimulationInterval = null;
        let currentMatchId = null; 
        let opponentStatusListener = null;
        let reactionListener = null;
        
        let currentLocalStrategy = 'Balanced';
        let isLocalPlayerTeamA = false;
        
        const ALL_COMMENTARIES = [
            "GOAL! What a stunning finish by $PLAYER! The crowd is on its feet!", "Golazo! It's a marvelous strike, courtesy of $PLAYER! That pass from $ASSIST was perfect.", "$PLAYER breaks the deadlock! An absolute thunderbolt from outside the box!", "He scores! $PLAYER nets a crucial goal after a brilliant run.", "That's a goal! $PLAYER calmly slots it home, an easy tap-in thanks to $ASSIST's vision.", "GOAL! It's a rocket from $PLAYER! No chance for the keeper!", "The net bulges! $PLAYER with the finish, $ASSIST with the wonderful setup!", "He tucks it away! $PLAYER with the precision finish!", "It's a screamer! $PLAYER fires it into the top corner!", "A moment of magic from $PLAYER! That's what they call a big-game player!", "The pressure pays off! $PLAYER finds the back of the net.", "The goalkeeper had absolutely no chance! $PLAYER with a moment of brilliance!", "The header is good! $PLAYER rises highest to nod it home from the cross!", "They've done it! $PLAYER seals the deal with a cool, clinical finish.", "A tap-in! Simple but effective, $PLAYER capitalizes on the defensive error.", "What a beautiful, bending shot! $PLAYER makes it look effortless.", "The chip is perfect! $PLAYER leaves the keeper stranded!", "The stadium erupts! A decisive goal from $PLAYER!", "An excellent chance for $ATTACKER! But the shot goes wide of the post.", "Ooh, that was close! $ATTACKER almost found the target, just missing the frame.", "$ATTACKER is through on goal, but the keeper $DEFENDER makes a brilliant save!", "A dangerous free-kick for $TEAM just outside the box.", "Corner awarded to $TEAM. Can they capitalize on this set-piece opportunity?", "The attack is building up nicely for $TEAM down the flank.", "Superb through ball for $ATTACKER, but $DEFENDER intercepts at the last moment!", "$ATTACKER shoots! It hits the woodwork and rattles away!", "A clear opportunity goes begging! $ATTACKER will regret that miss.", "The ball is cut back, but the shot is blocked by a desperate lunge!", "The keeper is off his line quickly to smother the attempt from $ATTACKER.", "A venomous volley from $ATTACKER, but it just flies past the upright!", "The defense is caught sleeping! But the final shot from $ATTACKER lacked power.", "They're peppering the goal! $TEAM is dominating the attack now.", "A one-two move opens up the defense, but the cross is slightly overhit.", "A tactical foul in the midfield by $DEFENDER to break up the play.", "The possession is back with $TEAM after a commanding interception.", "Strong challenge by $DEFENDER to win the ball back cleanly.", "Midfield battle is intense, neither team giving an inch in this ferocious contest.", "A nice sequence of passes by $TEAM, retaining the ball under pressure.", "The long ball strategy is not quite connecting for $TEAM today.", "A patient build-up from the back line of $TEAM, controlling the tempo.", "Brilliant tackle by $DEFENDER! He stopped a certain goal-scoring opportunity.", "Off the post! The danger is cleared by $DEFENDER!", "A low cross into the box... cleared by the towering $DEFENDER!", "The team is pushing high, winning the ball back quickly with a great press.", "The keeper $DEFENDER pulls off an acrobatic save to keep his side in it!", "A critical interception in the penalty box! That was heroic defending.", "The defensive line of $TEAM steps up perfectly to catch $ATTACKER offside.", "A crucial block from $DEFENDER, sacrificing his body for the team.", "The keeper tips a powerful long-range effort over the bar!", "The full-back $DEFENDER recovers superbly to deny the counter-attack.", "Possession changing hands quickly‚Äîit's a real end-to-end affair.", "The intensity is palpable in the stadium. This is a fiercely contested match!", "We are in for a tight finish here. The pressure is mounting!", "Only a few minutes left in this half. Can they hold on?", "The referee is having a very stern word with the players.", "A moment of reflection as play pauses for an injured player.", "Can either side find a winner? It's too close to call.", "The clock is definitely a factor now. Time is running out!", "A great atmosphere inside the arena. The fans are certainly enjoying this.", "Both teams deserve credit for the sheer effort they are putting in.", "We've reached the halfway mark of the second half. Fitness will be key.", "The team needs a spark from somewhere, they look a little flat.", "They are looking for the perfect final pass, trying to unlock the defense.", "Defensive discipline is absolutely paramount at this stage of the game.", "No clear advantage for either side yet. It's a testament to the balance of power.", "A high-stakes encounter for both clubs, you can feel the tension.", "This is typical cup-tie drama, full of twists and turns!", "The substitution bench is warming up; a change must be imminent.", "Will we see extra time tonight? It certainly looks possible.", "A fantastic display of footballing skill on show.", "They must keep their concentration now; one mistake could be fatal.", "A little bit of frustration creeping in as tackles start flying.", "Both sides are pressing hard, trying to force an error.", "The game needs a moment of individual brilliance to settle it.", "It's all about who blinks first in this tactical deadlock.", "Tactical changes are being discussed on the sidelines.", "They are controlling the tempo, slowing the game down deliberately.", "The defensive line holds firm, refusing to be breached.", "Playing out from the back, taking a risk but showing confidence.", "Trying to exploit the flanks, looking for width in the attack.", "Looking for the aerial threat from a deep cross.", "The captain is visibly rallying his team, urging them forward.", "Possession stats are nearly equal; a true reflection of the match.", "A disciplined performance so far, keeping their shape well.", "They are dictating the play, forcing the opposition to chase.", "The long-range effort is well off target, a hopeful attempt at best.", "The keeper's distribution is excellent, launching a rapid counter-attack.", "The center-backs are dominant, winning every aerial duel.", "Working hard off the ball, their fitness levels are impressive.", "A rapid counter-attack opportunity! They need to be clinical!", "The full-backs are bombing forward, adding extra men to the attack.", "Finding space in the channels, exploiting the gaps between defense and midfield.", "The tension is mounting with every passing second!", "A very physical contest, the referee is letting a lot go.", "They need to keep the ball better, too many turnovers in midfield.", "The final ball is missing, letting themselves down in the critical area.", "The crowd loves the effort and commitment on display.", "Playing with a high press, looking to steal the ball deep in enemy territory.", "A cautious approach for now, prioritizing defense.", "Both managers look calm, but you know their heart rates are soaring.", "A true test of character for both sets of players.", "The defensive wall is set, ready for the free-kick.", "Looking to switch the play quickly to the unattended side.", "A promising attack fizzles out, poor decision-making at the end.", "They are running out of time, must create something quickly!", "Must be more clinical in front of goal; chances are rare.", "The difference between the teams is marginal, a single goal may decide it.", "The opponent is showing great resilience, refusing to break down.", "An evenly matched contest, a delight for the neutral spectator.", "All eyes are on the clock as the seconds tick away.", "This could go either way; a moment of genius is all it takes.", "The team is playing smart football, controlling their emotions.", "Need to avoid mistakes now; the pressure is immense.", "The game is on a knife-edge, one mistake and it's over.", "The bench reaction tells a story‚Äîthey sense a goal is coming.", "It's a game of fine margins, where small details matter most.", "A moment of hesitation costs them dearly in possession.", "The pass accuracy is remarkably high despite the pressure.", "They are absorbing the pressure well, sitting deep and defending.", "A fantastic advertisement for the beautiful game!", "Can they hold on for the win? They are defending with everything they have.", "A vital three points at stake in this league fixture.", "The intensity never drops, a non-stop, high-energy affair.", "Every tackle is important now, controlling the middle ground.", "They are hungry for the goal, pushing men forward fearlessly.", "The defense has to be alert, especially against the pace of the forwards.", "A battle of wits between the players and the opposing tactics.", "The players are giving their all, absolutely exhausted.", "The game is wide open, plenty of space to exploit.", "The tension is almost unbearable for the supporters!", "It's not over yet! They have time for one last attempt."
        ];

        const authScreen = document.getElementById('auth-screen');
        const gameContent = document.getElementById('game-content');
        const maintenanceModeDiv = document.getElementById('maintenance-mode');
        const bannedScreen = document.getElementById('banned-screen');
        const modal = document.getElementById('custom-modal');
        const modalMessage = document.getElementById('modal-message');
        const modalCloseBtn = document.getElementById('modal-close-btn');
        const fullScreenLoader = document.getElementById('full-screen-loader');
        const findMatchBtn = document.getElementById('find-match-btn');
        
        const promoBannerModal = document.getElementById('promo-banner-modal');
        const promoCloseBtn = document.getElementById('promo-close-btn');

        const paymentModal = document.getElementById('payment-modal');
        const buyPremiumPassBtn = document.getElementById('buy-premium-pass-btn');
        const paymentCloseBtn = document.getElementById('payment-close-btn');
        const paymentForm = document.getElementById('payment-form');
        
        const strategyButtons = document.querySelectorAll('#in-match-strategy-control .strategy-btn');

        const navLinks = document.querySelectorAll('.nav-link');
        const views = document.querySelectorAll('.view');
        
        const mainMenuAudio = document.getElementById('main-menu-audio');
        const matchAudio = document.getElementById('match-audio'); 
        const goalSound = document.getElementById('goal-sound');
        const whistleSound = document.getElementById('whistle-sound');
        const buttonSound = document.getElementById('button-sound');
        const packOpenSound = document.getElementById('pack-open-sound');

        // New feature elements
        const trainingBtn = document.getElementById('training-btn');
        const formationBtn = document.getElementById('formation-btn');
        const advancedTacticsBtn = document.getElementById('advanced-tactics-btn');
        const singlePlayerBtn = document.getElementById('single-player-btn');
        const friendlyMatchBtn = document.getElementById('friendly-match-btn');
        const playersTab = document.getElementById('players-tab');
        const packsTab = document.getElementById('packs-tab');
        const itemsTab = document.getElementById('items-tab');
        const storeItems = document.getElementById('store-items');
        const storePacks = document.getElementById('store-packs');
        const storeSpecialItems = document.getElementById('store-special-items');

        // Modal elements
        const trainingModal = document.getElementById('training-modal');
        const trainingCloseBtn = document.getElementById('training-close-btn');
        const formationModal = document.getElementById('formation-modal');
        const formationCloseBtn = document.getElementById('formation-close-btn');
        const formationSaveBtn = document.getElementById('formation-save-btn');
        const formationCancelBtn = document.getElementById('formation-cancel-btn');
        const advancedTacticsModal = document.getElementById('advanced-tactics-modal');
        const advancedTacticsCloseBtn = document.getElementById('advanced-tactics-close-btn');
        const advancedTacticsSaveBtn = document.getElementById('advanced-tactics-save-btn');
        const advancedTacticsCancelBtn = document.getElementById('advanced-tactics-cancel-btn');
        const facilitiesModal = document.getElementById('facilities-modal');
        const facilitiesCloseBtn = document.getElementById('facilities-close-btn');
        const facilitiesCloseBtn2 = document.getElementById('facilities-close-btn-2');
        const sponsorshipModal = document.getElementById('sponsorship-modal');
        const sponsorshipCloseBtn = document.getElementById('sponsorship-close-btn');
        const sponsorshipCloseBtn2 = document.getElementById('sponsorship-close-btn-2');
        const kitDesignerModal = document.getElementById('kit-designer-modal');
        const kitDesignerCloseBtn = document.getElementById('kit-designer-close-btn');
        const kitSaveBtn = document.getElementById('kit-save-btn');
        const kitCancelBtn = document.getElementById('kit-cancel-btn');
        const friendsModal = document.getElementById('friends-modal');
        const friendsCloseBtn = document.getElementById('friends-close-btn');
        const friendsCloseBtn2 = document.getElementById('friends-close-btn-2');
        const liveTransferModal = document.getElementById('live-transfer-modal');
        const liveTransferCloseBtn = document.getElementById('live-transfer-close-btn');
        const liveTransferCloseBtn2 = document.getElementById('live-transfer-close-btn-2');
        const packOpeningModal = document.getElementById('pack-opening-modal');
        const packCloseBtn = document.getElementById('pack-close-btn');
        const packOpenAgainBtn = document.getElementById('pack-open-again-btn');
        const packDoneBtn = document.getElementById('pack-done-btn');
        const dailyLoginModal = document.getElementById('daily-login-modal');
        const dailyLoginCloseBtn = document.getElementById('daily-login-close-btn');
        const dailyLoginClaimBtn = document.getElementById('daily-login-claim-btn');

        // New feature buttons
        const facilitiesBtn = document.getElementById('facilities-btn');
        const sponsorshipBtn = document.getElementById('sponsorship-btn');
        const kitDesignerBtn = document.getElementById('kit-designer-btn');
        const friendsBtn = document.getElementById('friends-btn');
        const privateLeaguesBtn = document.getElementById('private-leagues-btn');
        const substitutionBtn = document.getElementById('substitution-btn');
        const youthSquadBtn = document.getElementById('youth-squad-btn');
        const allianceWarsBtn = document.getElementById('alliance-wars-btn');
        const customTournamentsBtn = document.getElementById('custom-tournaments-btn');

        function playSound(sound) {
            sound.currentTime = 0;
            sound.play().catch(e => console.log("Audio play failed:", e));
        }

        function showModal(message) {
            modalMessage.textContent = message;
            modal.classList.remove('hidden');
        }
        modalCloseBtn.addEventListener('click', () => modal.classList.add('hidden'));
        
        promoCloseBtn.addEventListener('click', () => {
            promoBannerModal.classList.add('hidden');
        });
        
        function playMainMenuMusic() {
            pauseMatchMusic();
            if (mainMenuAudio.paused) {
                mainMenuAudio.play().catch(error => {
                    console.warn("Main Menu Audio playback failed (Autoplay likely blocked):", error);
                });
            }
        }

        function pauseMainMenuMusic() { mainMenuAudio.pause(); }

        function playMatchMusic() {
             pauseMainMenuMusic();
             if (matchAudio.paused) {
                matchAudio.play().catch(error => {
                    console.warn("Match Audio playback failed (Autoplay likely blocked):", error);
                    matchAudio.pause();
                });
            }
        }
        
        function pauseMatchMusic() {
            matchAudio.pause();
            matchAudio.currentTime = 0; 
        }

        function navigateToView(viewId) {
            views.forEach(view => view.classList.add('hidden'));
            const targetView = document.getElementById(viewId);
            if(targetView) targetView.classList.remove('hidden');
            
            if (viewId === 'home-view' && !currentMatchId) {
                 playMainMenuMusic();
            }
            
            if(viewId === 'match-view') {
                pauseMainMenuMusic(); 
            }
            
            if (viewId === 'chat-view') {
                loadChatMessages();
            }
             if (viewId === 'season-pass-view') {
                loadSeasonPassData();
            }
        }
        
        document.querySelectorAll('.back-to-home').forEach(button => {
            button.addEventListener('click', (e) => {
                e.preventDefault();
                navigateToView('home-view');
            });
        });

        const settingsRef = ref(db, "settings/game");
        onValue(settingsRef, (snapshot) => {
            const settings = snapshot.val();
            const isMaintenance = settings && settings.maintenance;

            if (isMaintenance) {
                authScreen.classList.add('hidden');
                gameContent.classList.add('hidden');
                fullScreenLoader.classList.add('hidden');
                bannedScreen.classList.add('hidden');
                pauseMainMenuMusic();
                pauseMatchMusic();

                const titleElement = document.getElementById('maintenance-title');
                const messageElement = document.getElementById('maintenance-message');
                
                let message = "The game is on maintenance, will back shortly.";
                let title = "‚ö†Ô∏è Maintenance in Progress";

                if (typeof isMaintenance === 'object' && isMaintenance !== null) {
                    if(isMaintenance.title) title = isMaintenance.title;
                    if(isMaintenance.message) message = isMaintenance.message;
                }
                
                if (titleElement) titleElement.textContent = title;
                if (messageElement) messageElement.textContent = message;

                maintenanceModeDiv.classList.remove('hidden');
            } else {
                maintenanceModeDiv.classList.add('hidden');
            }
        });

        async function loadAndShowPromoBanner() {
            const promoRef = ref(db, 'settings/promotionalBanner');
            const snapshot = await get(promoRef);
            if (snapshot.exists()) {
                const bannerData = snapshot.val();
                
                const promoImage = document.getElementById('promo-image');
                const promoLink = document.getElementById('promo-link');

                let hasContent = false;

                if (bannerData.imageUrl) {
                    promoImage.src = bannerData.imageUrl;
                    promoImage.classList.remove('hidden');
                    hasContent = true;
                } else {
                    promoImage.classList.add('hidden');
                }
                
                if (bannerData.linkUrl && bannerData.linkUrl.trim() !== "") {
                    promoLink.href = bannerData.linkUrl;
                    promoLink.classList.remove('hidden');
                    hasContent = true;
                } else {
                    promoLink.classList.add('hidden');
                }

                if (hasContent) {
                    promoBannerModal.classList.remove('hidden');
                }
            }
        }
        
        function setupPresence(user) {
            const userStatusDatabaseRef = ref(db, '/status/' + user.uid);
            const isOfflineForDatabase = { state: 'offline', last_changed: serverTimestamp() };
            const isOnlineForDatabase = { state: 'online', last_changed: serverTimestamp() };

            const connectedRef = ref(db, '.info/connected');
            onValue(connectedRef, (snapshot) => {
                if (snapshot.val() === false) { return; }
                onDisconnect(userStatusDatabaseRef).set(isOfflineForDatabase).then(() => {
                    set(userStatusDatabaseRef, isOnlineForDatabase);
                });
            });
        }

        onAuthStateChanged(auth, user => {
            if (user) {
                setupPresence(user);
                authScreen.classList.add('hidden');
                // Game content visibility will be handled by loadUserData after the ban check
                loadUserData(user.uid);
                listenForMatch(user.uid);
                loadAndShowPromoBanner(); 
                checkDailyLogin(user.uid);
            } else {
                authScreen.classList.remove('hidden');
                gameContent.classList.add('hidden');
                bannedScreen.classList.add('hidden');
                currentUserData = null;
                if(timerInterval) clearInterval(timerInterval);
                if(matchSimulationInterval) clearInterval(matchSimulationInterval);
                pauseMainMenuMusic();
                pauseMatchMusic();
            }

            setTimeout(() => {
                fullScreenLoader.classList.add('hidden');
            }, 500);
        });
        
        const authToggle = document.getElementById('auth-toggle');
        const loginForm = document.getElementById('login-form');
        const signupForm = document.getElementById('signup-form');
        const authTitle = document.getElementById('auth-title');

        authToggle.addEventListener('click', () => {
            loginForm.classList.toggle('hidden');
            signupForm.classList.toggle('hidden');
            if(signupForm.classList.contains('hidden')) {
                authTitle.textContent = 'Login to your Club';
                authToggle.textContent = "Don't have an account? Sign Up";
            } else {
                authTitle.textContent = 'Create a New Club';
                authToggle.textContent = 'Already have an account? Login';
            }
        });

        const authError = document.getElementById('auth-error');

        signupForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const email = document.getElementById('signup-email').value;
            const password = document.getElementById('signup-password').value;
            const clubName = document.getElementById('signup-club-name').value;
            const selectedServer = document.getElementById('signup-server').value;
            authError.textContent = '';
            try {
                const userCredential = await createUserWithEmailAndPassword(auth, email, password);
                const user = userCredential.user;

                const playersSnapshot = await get(ref(db, "players"));
                let allPlayerIds = [];
                if (playersSnapshot.exists()) {
                    allPlayerIds = Object.keys(playersSnapshot.val());
                }

                const shuffledPlayers = allPlayerIds.sort(() => 0.5 - Math.random());
                const startingSquad = shuffledPlayers.slice(0, 5);

                await set(ref(db, 'users/' + user.uid), {
                    email: email, clubName: clubName, balance: 1000, gems: 100, points: 0, wins: 0, 
                    squad: startingSquad, avatarUrl: `https://placehold.co/96x96/0d1117/00bcd4?text=${clubName.charAt(0)}`, 
                    claimedMaradonaEvent: false,
                    isBanned: false, 
                    level: 1, xp: 0, matchesPlayedThisLevel: 0, matchesNeededForLevelUp: BASE_MATCHES_FOR_LEVEL_UP,
                    seasonPass: { level: 1, xp: 0, premium: false },
                    trainingPoints: 0,
                    formation: "4-4-2",
                    advancedTactics: "Balanced",
                    lastLoginDate: new Date().toDateString(),
                    dailyLoginStreak: 1,
                    clubFacilities: {
                        stadium: { level: 1 },
                        trainingGround: { level: 1 },
                        youthAcademy: { level: 1 }
                    },
                    sponsorshipDeals: {},
                    kitDesign: {
                        jerseyColor: "#1e40af",
                        shortsColor: "#1e40af",
                        style: "plain"
                    },
                    friends: [],
                    alliances: [],
                    activeListings: [],
                    server: selectedServer,
                    graphics: 'medium',
                    fpsLimit: 60,
                    audioVolume: 100
                });
                
                await set(ref(db, 'players/' + MARADONA_PLAYER_ID), {
                    name: "Maradona Prime", position: "CAM", rating: 99, value: 50000, imageUrl: "https://placehold.co/96x96/FFD700/000?text=M+P",
                    attributes: { pace: 95, shooting: 98, passing: 97, dribbling: 99, defending: 65, physical: 85 },
                    rarity: "special"
                }, { merge: true });
                
                playMainMenuMusic();

            } catch (error) { authError.textContent = "Signup failed: " + error.message; }
        });

        loginForm.addEventListener('submit', (e) => {
            e.preventDefault();
            const email = document.getElementById('login-email').value;
            const password = document.getElementById('login-password').value;
            authError.textContent = '';
            signInWithEmailAndPassword(auth, email, password).catch(error => authError.textContent = "Login failed: " + error.message);
        });

        document.getElementById('logout-btn').addEventListener('click', () => {
            sessionStorage.removeItem('adShown');
            // Clear ping update interval
            if (window.pingUpdateInterval) {
                clearInterval(window.pingUpdateInterval);
                window.pingUpdateInterval = null;
            }
            signOut(auth);
        });
        
        function loadUserData(uid) {
            const userRef = ref(db, 'users/' + uid);
            onValue(userRef, async (snapshot) => {
                if (snapshot.exists()) {
                    currentUserData = snapshot.val();
                    currentUserData.uid = uid;

                    if (currentUserData.isBanned) {
                        gameContent.classList.add('hidden');
                        bannedScreen.classList.remove('hidden');
                        pauseMainMenuMusic();
                        pauseMatchMusic();
                        return; 
                    } else {
                        bannedScreen.classList.add('hidden');
                        if (gameContent.classList.contains('hidden')) {
                            gameContent.classList.remove('hidden');
                            gameContent.classList.add('flex');
                            navigateToView('home-view');
                        }
                    }
                    
                    document.getElementById('user-club-name').textContent = currentUserData.clubName;
                    document.getElementById('user-balance').textContent = currentUserData.balance;
                    document.getElementById('user-gems').textContent = currentUserData.gems || 0;
                    document.getElementById('user-training-points').textContent = currentUserData.trainingPoints || 0;
                    document.getElementById('user-avatar').src = currentUserData.avatarUrl || `https://placehold.co/96x96/0d1117/00bcd4?text=${currentUserData.clubName.charAt(0)}`;
                    
                    document.getElementById('user-level').textContent = currentUserData.level || 1;
                    const matchesPlayed = currentUserData.matchesPlayedThisLevel || 0;
                    const matchesNeeded = currentUserData.matchesNeededForLevelUp || BASE_MATCHES_FOR_LEVEL_UP;
                    const xpPercentage = (matchesPlayed / matchesNeeded) * 100;
                    document.getElementById('xp-bar-fill').style.width = `${xpPercentage}%`;
                    
                    // Display server information
                    const server = currentUserData.server || 'bangladesh';
                    const serverNames = {
                        'bangladesh': 'BD',
                        'singapore': 'SG',
                        'usa': 'US',
                        'brazil': 'BR'
                    };
                    document.getElementById('user-server').textContent = serverNames[server] || 'BD';
                    
                    // Simulate ping based on server
                    let ping = 0;
                    if (server === 'bangladesh') {
                        ping = Math.floor(Math.random() * 101); // 0-100ms
                    } else if (server === 'singapore') {
                        ping = Math.floor(Math.random() * 51) + 100; // 100-150ms
                    } else if (server === 'usa') {
                        ping = Math.floor(Math.random() * 101) + 200; // 200-300ms
                    } else if (server === 'brazil') {
                        ping = Math.floor(Math.random() * 101) + 200; // 200-300ms
                    }
                    document.getElementById('user-ping').textContent = `${ping}ms`;

                    if (currentUserData.squad && currentUserData.squad.length > 0) {
                        await loadSquad(currentUserData.squad);
                        loadSellPlayers(currentUserData.squad);
                    } else {
                         document.getElementById('squad-list').innerHTML = '<p>You have no players in your squad.</p>';
                         document.getElementById('sell-player-list').innerHTML = '<p>No players to sell.</p>';
                         document.getElementById('team-power-stat').textContent = 0;
                    }

                    loadStoreItems();
                    loadStorePacks();
                    loadStoreSpecialItems();
                    loadTransferMarket();
                    loadLeaderboard();
                    loadTournaments();
                    loadEvents();
                    loadClubFinances();
                    
                    findMatchBtn.disabled = false;
                    
                    // Set up periodic ping update
                    if (window.pingUpdateInterval) {
                        clearInterval(window.pingUpdateInterval);
                    }
                    window.pingUpdateInterval = setInterval(() => {
                        if (currentUserData) {
                            const server = currentUserData.server || 'bangladesh';
                            let ping = 0;
                            if (server === 'bangladesh') {
                                ping = Math.floor(Math.random() * 101); // 0-100ms
                            } else if (server === 'singapore') {
                                ping = Math.floor(Math.random() * 51) + 100; // 100-150ms
                            } else if (server === 'usa') {
                                ping = Math.floor(Math.random() * 101) + 200; // 200-300ms
                            } else if (server === 'brazil') {
                                ping = Math.floor(Math.random() * 101) + 200; // 200-300ms
                            }
                            document.getElementById('user-ping').textContent = `${ping}ms`;
                        }
                    }, 5000); // Update every 5 seconds
                }
            });
        }
        
        async function loadSquad(squadIds) {
            const squadListDiv = document.getElementById('squad-list');
            squadListDiv.innerHTML = '';
            let totalRating = 0;
            const playerPromises = squadIds.map(playerId => get(ref(db, 'players/' + playerId)));
            const playerSnapshots = await Promise.all(playerPromises);

            playerSnapshots.forEach(playerSnap => {
                if (playerSnap.exists()) {
                    const playerData = playerSnap.val();
                    totalRating += playerData.rating;
                    
                    // Calculate player's overall rating based on attributes
                    const attributes = playerData.attributes || { pace: 50, shooting: 50, passing: 50, dribbling: 50, defending: 50, physical: 50 };
                    const calculatedRating = Math.round(
                        (attributes.pace + attributes.shooting + attributes.passing + 
                         attributes.dribbling + attributes.defending + attributes.physical) / 6
                    );
                    
                    const rarity = playerData.rarity || "bronze";
                    const rarityClass = rarity === "bronze" ? "bronze" : 
                                       rarity === "silver" ? "silver" : 
                                       rarity === "gold" ? "gold" : "special";
                    
                    // Check for player injuries and stamina
                    const isInjured = playerData.injury && playerData.injury > 0;
                    const stamina = playerData.stamina || 100;
                    
                    // Check for player contract expiration
                    const contractExpiration = playerData.contractExpiration || 0;
                    const currentDate = new Date().getTime();
                    const daysUntilExpiration = Math.ceil((contractExpiration - currentDate) / (1000 * 60 * 60 * 24));
                    const isContractExpiring = contractExpiration > 0 && daysUntilExpiration <= 7;
                    const isContractExpired = contractExpiration > 0 && currentDate > contractExpiration;
                    
                    squadListDiv.innerHTML += `
                        <div class="player-card p-4 text-center shadow-lg ${rarityClass} relative">
                            ${isInjured ? '<div class="injury-indicator" title="Injured"><i class="fas fa-first-aid"></i></div>' : ''}
                            ${isContractExpiring ? '<div class="contract-indicator" title="Contract expiring soon"><i class="fas fa-file-contract"></i></div>' : ''}
                            ${isContractExpired ? '<div class="contract-expired-indicator" title="Contract expired"><i class="fas fa-exclamation-triangle"></i></div>' : ''}
                            <img src="${playerData.imageUrl}" alt="${playerData.name}" class="w-24 h-24 object-cover rounded-full mx-auto mb-3 border-2 border-gray-600">
                            <h4 class="font-bold text-lg text-white">${playerData.name}</h4>
                            <p class="text-sm text-gray-400">${playerData.position}</p>
                            <p class="text-2xl font-black text-green-400 mt-2">${calculatedRating}</p>
                            <div class="mt-2 text-xs text-gray-500">
                                <div class="flex justify-between"><span>Pace:</span><span>${attributes.pace}</span></div>
                                <div class="attribute-bar"><div class="attribute-fill pace-fill" style="width: ${attributes.pace}%"></div></div>
                                <div class="flex justify-between"><span>Shooting:</span><span>${attributes.shooting}</span></div>
                                <div class="attribute-bar"><div class="attribute-fill shooting-fill" style="width: ${attributes.shooting}%"></div></div>
                                <div class="flex justify-between"><span>Passing:</span><span>${attributes.passing}</span></div>
                                <div class="attribute-bar"><div class="attribute-fill passing-fill" style="width: ${attributes.passing}%"></div></div>
                            </div>
                            <div class="mt-2">
                                <div class="flex justify-between text-xs"><span>Stamina:</span><span>${stamina}%</span></div>
                                <div class="stamina-bar"><div class="stamina-fill" style="width: ${stamina}%"></div></div>
                            </div>
                            ${contractExpiration > 0 ? `<div class="mt-2 text-xs text-gray-500">
                                <div class="flex justify-between"><span>Contract:</span><span>${daysUntilExpiration > 0 ? daysUntilExpiration + ' days' : 'Expired'}</span></div>
                            </div>` : ''}
                            ${(isContractExpiring || isContractExpired) ? `<button onclick="renewContract('${playerId}')" class="mt-2 py-1 px-2 bg-blue-600 hover:bg-blue-700 text-white text-xs rounded">Renew Contract</button>` : ''}
                        </div>`;
                }
            });

            teamPower = squadIds.length > 0 ? Math.round(totalRating / squadIds.length) : 0;
            document.getElementById('team-power-stat').textContent = teamPower;
        }
        
        async function loadLeaderboard() {
            const leaderboardBody = document.getElementById('leaderboard-body');
            leaderboardBody.innerHTML = '<tr><td colspan="4" class="text-center p-4">Loading...</td></tr>';
            
            const usersRef = ref(db, 'users');
            const snapshot = await get(usersRef);

            if (snapshot.exists()) {
                const users = [];
                snapshot.forEach(childSnapshot => {
                    users.push({ uid: childSnapshot.key, ...childSnapshot.val() });
                });

                users.sort((a, b) => (b.points || 0) - (a.points || 0));

                leaderboardBody.innerHTML = '';
                users.forEach((user, index) => {
                    const rank = index + 1;
                    const isCurrentUser = currentUserData && user.uid === currentUserData.uid;
                    leaderboardBody.innerHTML += `
                        <tr class="border-b border-gray-800 ${isCurrentUser ? 'bg-green-900 border-l-4 border-green-500 font-semibold' : 'hover:bg-gray-800'}">
                            <td class="p-4 font-bold">${rank}</td>
                            <td class="p-4">${user.clubName}</td>
                            <td class="p-4">${user.level || 1}</td>
                            <td class="p-4">${user.points || 0}</td>
                        </tr>`;
                });
            } else {
                leaderboardBody.innerHTML = '<tr><td colspan="4" class="text-center p-4 text-gray-400">No data on the leaderboard.</td></tr>';
            }
        }
        
        async function loadEvents() {
            const eventsListDiv = document.getElementById('events-list');
            eventsListDiv.innerHTML = '';
            
            const isMaradonaClaimed = currentUserData.claimedMaradonaEvent;
            const canClaimMaradona = teamPower >= MARADONA_CLAIM_MIN_POWER;
            
            let maradonaButtonHtml;
            if (isMaradonaClaimed) {
                maradonaButtonHtml = `<button class="py-2 px-4 bg-gray-600 text-white font-bold rounded-md cursor-not-allowed" disabled>Claimed</button>`;
            } else if (canClaimMaradona) {
                 maradonaButtonHtml = `<button onclick="claimReward('${MARADONA_PLAYER_ID}', 'claimedMaradonaEvent')" class="py-2 px-4 bg-green-600 hover:bg-green-700 text-white font-bold rounded-md interactive-button">Claim Now</button>`;
            } else {
                 maradonaButtonHtml = `<button class="py-2 px-4 bg-yellow-700 text-white font-bold rounded-md cursor-not-allowed" disabled>Min Power ${MARADONA_CLAIM_MIN_POWER} Required</button>`;
            }

            const maradonaHtml = `
                <div class="player-card p-6 shadow-xl flex justify-between items-center">
                    <div>
                        <h2 class="text-2xl font-bold mb-1 text-yellow-400">1-Day Login Reward: Maradona Prime</h2>
                        <p class="text-gray-300">Claim the legendary Diego Maradona Prime card to strengthen your squad!</p>
                        ${!isMaradonaClaimed && !canClaimMaradona ? `<p class="text-red-400 font-bold mt-2">Requirement: Team Power ${MARADONA_CLAIM_MIN_POWER} (Current: ${teamPower})</p>` : ''}
                    </div>
                    ${maradonaButtonHtml}
                </div>`;
            eventsListDiv.innerHTML += maradonaHtml;
            
            const eventsRef = ref(db, 'events');
            const snapshot = await get(eventsRef);

            if (snapshot.exists()) {
                const events = snapshot.val();
                for (const eventId in events) {
                    const eventData = events[eventId];
                    const rewardHtml = eventData.reward_type === 'currency' ? `üí∞ <span class="text-yellow-300 font-bold">${eventData.value || 0} Coins</span>` : `${eventData.value || ''} ${eventData.reward_type || ''}`;
                    eventsListDiv.innerHTML += `
                        <div class="player-card p-6 shadow-xl">
                            <h2 class="text-2xl font-bold mb-2 text-green-400">${eventData.name || 'New Event'}</h2>
                            <p class="text-gray-300 mb-3">${eventData.description || 'Check out this new event!'}</p>
                            <p class="text-lg"><span class="font-semibold text-gray-300">Reward:</span> ${rewardHtml}</p>
                            <button class="mt-3 py-2 px-4 bg-green-600 hover:bg-green-700 text-white font-bold rounded-md interactive-button">Participate</button>
                        </div>`;
                }
            } else {
                eventsListDiv.innerHTML += `<div class="player-card p-6 text-center"><p class="text-gray-400">No other special events are active right now. Check back later!</p></div>`;
            }
        }
        
        window.claimReward = async (playerId, eventFlag) => {
            if (!currentUserData) return showModal("User data not loaded.");
            if (currentUserData[eventFlag]) return showModal("Reward already claimed.");
            if (currentUserData.squad && currentUserData.squad.includes(playerId)) return showModal("You already own this player.");
            if (eventFlag === 'claimedMaradonaEvent' && teamPower < MARADONA_CLAIM_MIN_POWER) { return showModal(`Cannot claim. Minimum Team Power of ${MARADONA_CLAIM_MIN_POWER} is required.`); }
            const newSquad = [...(currentUserData.squad || []), playerId];
            try {
                await update(ref(db, 'users/' + currentUserData.uid), { squad: newSquad, [eventFlag]: true });
                showModal("Reward claimed successfully! Maradona Prime is now in your squad.");
                loadEvents(); 
            } catch (error) { showModal("Failed to claim reward: " + error.message); }
        };
        
        window.renewContract = async (playerId) => {
            if (!currentUserData) return showModal("User data not loaded.");
            
            // Get player data
            const playerRef = ref(db, 'players/' + playerId);
            const playerSnap = await get(playerRef);
            
            if (!playerSnap.exists()) {
                showModal("Player not found.");
                return;
            }
            
            const playerData = playerSnap.val();
            const contractCost = playerData.value || 1000; // Default cost if not set
            
            // Create contract renewal modal
            const modalHtml = `
                <div id="contract-renewal-modal" class="fixed inset-0 modal-backdrop flex items-center justify-center z-50">
                    <div class="bg-gray-900 rounded-xl shadow-2xl p-6 w-full max-w-md text-left border-4 border-blue-500 relative">
                        <button id="contract-close-btn" class="absolute top-2 right-3 text-2xl text-gray-400 hover:text-white">&times;</button>
                        <h2 class="text-2xl font-bold text-blue-400 mb-4">Renew Contract</h2>
                        <div class="player-card p-4 mb-4">
                            <div class="flex items-center">
                                <img src="${playerData.imageUrl}" alt="${playerData.name}" class="w-16 h-16 object-cover rounded-full mr-4 border-2 border-gray-600">
                                <div>
                                    <h3 class="font-bold text-lg text-white">${playerData.name}</h3>
                                    <p class="text-gray-400">${playerData.position}</p>
                                </div>
                            </div>
                        </div>
                        <div class="mb-4">
                            <label class="block text-gray-300 mb-2">Contract Length</label>
                            <select id="contract-length" class="w-full px-4 py-2 bg-gray-700 border border-gray-600 rounded-lg text-white">
                                <option value="30">1 Month (30 days) - ${Math.round(contractCost * 0.1)} coins</option>
                                <option value="90">3 Months (90 days) - ${Math.round(contractCost * 0.25)} coins</option>
                                <option value="180" selected>6 Months (180 days) - ${Math.round(contractCost * 0.45)} coins</option>
                                <option value="365">1 Year (365 days) - ${contractCost} coins</option>
                            </select>
                        </div>
                        <div class="flex justify-between items-center mb-4">
                            <span class="text-gray-300">Total Cost:</span>
                            <span id="contract-cost" class="font-bold text-yellow-400">${Math.round(contractCost * 0.45)} coins</span>
                        </div>
                        <div class="flex space-x-3">
                            <button id="cancel-contract-btn" class="flex-1 py-2 px-4 bg-gray-700 hover:bg-gray-600 text-white font-bold rounded-lg interactive-button">Cancel</button>
                            <button id="confirm-contract-btn" class="flex-1 py-2 px-4 bg-blue-600 hover:bg-blue-700 text-white font-bold rounded-lg interactive-button" data-player="${playerId}">Renew Contract</button>
                        </div>
                    </div>
                </div>`;
            
            // Add the modal to the document
            document.body.insertAdjacentHTML('beforeend', modalHtml);
            
            // Add event listeners
            document.getElementById('contract-close-btn').addEventListener('click', closeContractModal);
            document.getElementById('cancel-contract-btn').addEventListener('click', closeContractModal);
            
            // Update cost when contract length changes
            document.getElementById('contract-length').addEventListener('change', (e) => {
                const length = parseInt(e.target.value);
                let costMultiplier = 0.45; // Default for 6 months
                
                switch(length) {
                    case 30: costMultiplier = 0.1; break;
                    case 90: costMultiplier = 0.25; break;
                    case 180: costMultiplier = 0.45; break;
                    case 365: costMultiplier = 1.0; break;
                }
                
                const totalCost = Math.round(contractCost * costMultiplier);
                document.getElementById('contract-cost').textContent = `${totalCost} coins`;
            });
            
            document.getElementById('confirm-contract-btn').addEventListener('click', async (e) => {
                const playerId = e.target.getAttribute('data-player');
                const length = parseInt(document.getElementById('contract-length').value);
                let costMultiplier = 0.45; // Default for 6 months
                
                switch(length) {
                    case 30: costMultiplier = 0.1; break;
                    case 90: costMultiplier = 0.25; break;
                    case 180: costMultiplier = 0.45; break;
                    case 365: costMultiplier = 1.0; break;
                }
                
                const totalCost = Math.round(contractCost * costMultiplier);
                
                // Check if user has enough coins
                if (currentUserData.balance < totalCost) {
                    showModal(`You don't have enough coins to renew this contract. Required: ${totalCost} coins.`);
                    return;
                }
                
                // Calculate new contract expiration
                const newExpiration = new Date().getTime() + (length * 24 * 60 * 60 * 1000);
                
                // Update player contract expiration
                await update(playerRef, { contractExpiration: newExpiration });
                
                // Deduct coins from user
                await update(ref(db, 'users/' + currentUserData.uid), { 
                    balance: currentUserData.balance - totalCost 
                });
                
                closeContractModal();
                showModal(`Contract renewed for ${playerData.name} for ${length} days!`);
                loadSquad(currentUserData.squad); // Refresh the squad view
            });
        };
        
        // Function to close contract modal
        function closeContractModal() {
            const modal = document.getElementById('contract-renewal-modal');
            if (modal) {
                modal.remove();
            }
        }

        async function loadStoreItems() {
            const storeItemsDiv = document.getElementById('store-items');
            storeItemsDiv.innerHTML = '';
            const playersRef = ref(db, 'players');
            const snapshot = await get(playersRef);
            if (snapshot.exists()) {
                const players = snapshot.val();
                for (const playerId in players) {
                    const playerData = players[playerId];
                    const isOwned = currentUserData && currentUserData.squad && currentUserData.squad.includes(playerId);
                    const buttonHtml = isOwned 
                        ? `<button class="w-full mt-3 py-2 px-4 bg-gray-600 text-white font-bold rounded-md cursor-not-allowed" disabled>Owned</button>`
                        : `<button onclick="buyPlayer('${playerId}', ${playerData.value})" class="w-full mt-3 py-2 px-4 btn-primary rounded-md">Buy (${playerData.value} C)</button>`;
                    
                    const rarity = playerData.rarity || "bronze";
                    const rarityClass = rarity === "bronze" ? "bronze" : 
                                       rarity === "silver" ? "silver" : 
                                       rarity === "gold" ? "gold" : "special";
                    
                    storeItemsDiv.innerHTML += `
                        <div class="player-card p-4 text-center shadow-lg ${rarityClass}">
                            <img src="${playerData.imageUrl}" alt="${playerData.name}" class="w-24 h-24 object-cover rounded-full mx-auto mb-3 border-2 border-gray-600">
                            <h4 class="font-bold text-lg">${playerData.name}</h4><p class="text-sm text-gray-400">${playerData.position}</p><p class="text-xl font-bold text-green-400 mt-2">${playerData.rating}</p>${buttonHtml}
                        </div>`;
                }
            } else { storeItemsDiv.innerHTML = '<p class="text-center p-4 text-gray-400">No players found in the store.</p>'; }
        }

        async function loadStorePacks() {
            const storePacksDiv = document.getElementById('store-packs');
            storePacksDiv.innerHTML = '';
            
            // Define player packs
            const packs = [
                { id: 'bronze_pack', name: 'Bronze Pack', price: 1000, coinsPrice: 1000, gemsPrice: 0, description: 'Contains 3 bronze players', rarity: 'bronze' },
                { id: 'silver_pack', name: 'Silver Pack', price: 2500, coinsPrice: 2500, gemsPrice: 50, description: 'Contains 3 silver players', rarity: 'silver' },
                { id: 'gold_pack', name: 'Gold Pack', price: 5000, coinsPrice: 5000, gemsPrice: 100, description: 'Contains 3 gold players', rarity: 'gold' },
                { id: 'premium_pack', name: 'Premium Pack', price: 10000, coinsPrice: 10000, gemsPrice: 200, description: 'Contains 5 players with chance for special', rarity: 'special' }
            ];
            
            packs.forEach(pack => {
                const priceHtml = pack.gemsPrice > 0 
                    ? `<div class="flex justify-center space-x-2">
                         <span class="text-yellow-400"><i class="fas fa-coins"></i> ${pack.coinsPrice}</span>
                         <span class="text-blue-400"><i class="fas fa-gem"></i> ${pack.gemsPrice}</span>
                       </div>`
                    : `<div class="text-yellow-400"><i class="fas fa-coins"></i> ${pack.coinsPrice}</div>`;
                
                storePacksDiv.innerHTML += `
                    <div class="pack-card p-4 text-center shadow-lg">
                        <div class="text-4xl mb-4">üéÅ</div>
                        <h4 class="font-bold text-lg text-white">${pack.name}</h4>
                        <p class="text-sm text-gray-400 mb-3">${pack.description}</p>
                        ${priceHtml}
                        <button onclick="buyPack('${pack.id}', ${pack.coinsPrice}, ${pack.gemsPrice})" class="w-full mt-3 py-2 px-4 bg-yellow-600 hover:bg-yellow-700 text-white font-bold rounded-md interactive-button">Buy Pack</button>
                    </div>`;
            });
        }

        async function loadStoreSpecialItems() {
            const storeSpecialItemsDiv = document.getElementById('store-special-items');
            storeSpecialItemsDiv.innerHTML = '';
            
            // Define special items
            const specialItems = [
                { id: 'fitness_card', name: 'Fitness Card', price: 500, coinsPrice: 500, gemsPrice: 10, description: 'Restores player stamina to 100%', type: 'fitness' },
                { id: 'healing_card', name: 'Healing Card', price: 1000, coinsPrice: 1000, gemsPrice: 20, description: 'Instantly heals injured players', type: 'healing' },
                { id: 'training_boost', name: 'Training Boost', price: 1500, coinsPrice: 1500, gemsPrice: 30, description: 'Doubles training effectiveness for 24 hours', type: 'boost' },
                { id: 'totw_pack', name: 'Team of the Week', price: 7500, coinsPrice: 7500, gemsPrice: 150, description: 'Special pack with Team of the Week players', type: 'special_pack' }
            ];
            
            specialItems.forEach(item => {
                const priceHtml = item.gemsPrice > 0 
                    ? `<div class="flex justify-center space-x-2">
                         <span class="text-yellow-400"><i class="fas fa-coins"></i> ${item.coinsPrice}</span>
                         <span class="text-blue-400"><i class="fas fa-gem"></i> ${item.gemsPrice}</span>
                       </div>`
                    : `<div class="text-yellow-400"><i class="fas fa-coins"></i> ${item.coinsPrice}</div>`;
                
                storeSpecialItemsDiv.innerHTML += `
                    <div class="pack-card p-4 text-center shadow-lg">
                        <div class="text-4xl mb-4">${item.type === 'fitness' ? 'üí™' : item.type === 'healing' ? 'üè•' : item.type === 'boost' ? '‚ö°' : 'üåü'}</div>
                        <h4 class="font-bold text-lg text-white">${item.name}</h4>
                        <p class="text-sm text-gray-400 mb-3">${item.description}</p>
                        ${priceHtml}
                        <button onclick="buySpecialItem('${item.id}', ${item.coinsPrice}, ${item.gemsPrice})" class="w-full mt-3 py-2 px-4 bg-purple-600 hover:bg-purple-700 text-white font-bold rounded-md interactive-button">Buy Item</button>
                    </div>`;
            });
        }

        async function loadTransferMarket() {
            const transferMarketListDiv = document.getElementById('transfer-market-list');
            transferMarketListDiv.innerHTML = ''; 
            const playersRef = ref(db, 'players');
            const snapshot = await get(playersRef);
            if (snapshot.exists()) {
                const players = snapshot.val();
                for (const playerId in players) {
                    const playerData = players[playerId];
                    const isOwned = currentUserData && currentUserData.squad && currentUserData.squad.includes(playerId);
                    const buttonHtml = isOwned 
                        ? `<button class="w-full mt-3 py-2 px-4 bg-gray-600 text-white font-bold rounded-md cursor-not-allowed" disabled>Owned</button>`
                        : `<button onclick="buyPlayer('${playerId}', ${playerData.value})" class="w-full mt-3 py-2 px-4 btn-primary rounded-md">Buy (${playerData.value} C)</button>`;
                    transferMarketListDiv.innerHTML += `
                        <div class="player-card p-4 text-center shadow-lg">
                            <img src="${playerData.imageUrl}" alt="${playerData.name}" class="w-24 h-24 object-cover rounded-full mx-auto mb-3 border-2 border-gray-600">
                            <h4 class="font-bold text-lg">${playerData.name}</h4><p class="text-sm text-gray-400">${playerData.position}</p><p class="text-xl font-bold text-green-400 mt-2">${playerData.rating}</p>${buttonHtml}
                        </div>`;
                }
            } else { transferMarketListDiv.innerHTML = '<p class="text-center p-4 text-gray-400">No players found in the transfer market.</p>'; }
        }
        
        async function loadSellPlayers(squadIds) {
            const sellPlayerListDiv = document.getElementById('sell-player-list');
            sellPlayerListDiv.innerHTML = '';
            if (!squadIds || squadIds.length === 0) { sellPlayerListDiv.innerHTML = '<p class="text-gray-400">No players to sell.</p>'; return; }
            const playerPromises = squadIds.map(playerId => get(ref(db, 'players/' + playerId)));
            const playerSnapshots = await Promise.all(playerPromises);
            sellPlayerListDiv.innerHTML = ''; 
            playerSnapshots.forEach((playerSnap, index) => {
                if (playerSnap.exists()) {
                    const playerData = playerSnap.val();
                    const playerId = squadIds[index];
                    const sellPrice = Math.round((playerData.value || 0) * 0.7);
                    sellPlayerListDiv.innerHTML += `
                        <div class="player-card p-4 text-center shadow-lg">
                            <img src="${playerData.imageUrl}" alt="${playerData.name}" class="w-24 h-24 object-cover rounded-full mx-auto mb-3 border-2 border-gray-600">
                            <h4 class="font-bold text-lg">${playerData.name}</h4><p class="text-sm text-gray-400">${playerData.position}</p><p class="text-xl font-bold text-green-400 mt-2">${playerData.rating}</p>
                            <button onclick="sellPlayer('${playerId}', ${sellPrice})" class="w-full mt-3 py-2 px-4 bg-red-600 hover:bg-red-700 text-white font-bold rounded-md interactive-button">Sell (${sellPrice} C)</button>
                        </div>`;
                }
            });
        }
        
        async function loadTournaments() {
            const tournamentListDiv = document.getElementById('tournament-list');
            tournamentListDiv.innerHTML = '';
            const tournamentsRef = ref(db, 'tournaments');
            const snapshot = await get(tournamentsRef);
            if (snapshot.exists()) {
                snapshot.forEach(childSnapshot => {
                    const t = childSnapshot.val();
                    const s = t.status || 'N/A';
                    let sc = 'text-gray-400', bc = 'border-green-500';
                    if (s.toLowerCase().includes('upcoming')) { sc = 'text-yellow-400'; bc = 'border-yellow-500'; } 
                    else if (s.toLowerCase().includes('ongoing')) { sc = 'text-green-400'; bc = 'border-green-500'; }
                    tournamentListDiv.innerHTML += `<div class="tournament-card p-6 shadow-xl hover:bg-gray-700 transition duration-200"><h2 class="text-2xl font-bold mb-2 text-white">${t.name||'Tournament'}</h2><p class="text-lg mb-1"><span class="font-semibold text-gray-300">Prize:</span> üí∞ <span class="text-yellow-300 font-bold">${t.prize||0} Coins</span></p><p class="text-lg"><span class="font-semibold text-gray-300">Status:</span> <span class="${sc} font-bold">${s}</span></p><button class="mt-3 py-2 px-4 bg-green-600 hover:bg-green-700 text-white font-bold rounded-md">View Details</button></div>`;
                });
            } else { tournamentListDiv.innerHTML = `<div class="text-center p-8 border border-gray-700 rounded-xl bg-gray-900"><h2 class="text-2xl font-bold mb-2 text-green-400">No ESPORTS Events</h2><p class="text-gray-400">New tournaments will be announced soon!</p></div>`; }
        }

        window.buyPlayer = async (playerId, price) => {
            if (!currentUserData) return showModal("User data not loaded.");
            if (currentUserData.balance < price) return showModal("You do not have enough coins.");
            if (currentUserData.squad && currentUserData.squad.includes(playerId)) return showModal("This player is already in your squad.");
            const newBalance = currentUserData.balance - price;
            const newSquad = [...(currentUserData.squad || []), playerId];
            try { await update(ref(db, 'users/' + currentUserData.uid), { balance: newBalance, squad: newSquad }); showModal("Player purchased successfully!"); } 
            catch (error) { showModal("Failed to purchase player: " + error.message); }
        };

        window.sellPlayer = async (playerId, sellPrice) => {
            if (!currentUserData) return showModal("User data not loaded.");
            if (!currentUserData.squad || !currentUserData.squad.includes(playerId)) return showModal("This player is not in your squad.");
            if (currentUserData.squad.length <= 5) return showModal("You must have at least 5 players in your squad to play a match.");
            const newBalance = currentUserData.balance + sellPrice;
            const newSquad = currentUserData.squad.filter(id => id !== playerId);
            try { await update(ref(db, 'users/' + currentUserData.uid), { balance: newBalance, squad: newSquad }); showModal("Player sold successfully!"); } 
            catch (error) { showModal("Failed to sell player: " + error.message); }
        };

        window.buyPack = async (packId, coinsPrice, gemsPrice) => {
            if (!currentUserData) return showModal("User data not loaded.");
            
            // Check if user has enough currency
            if (coinsPrice > 0 && currentUserData.balance < coinsPrice) {
                return showModal("You don't have enough coins to buy this pack.");
            }
            if (gemsPrice > 0 && currentUserData.gems < gemsPrice) {
                return showModal("You don't have enough gems to buy this pack.");
            }
            
            // Deduct currency
            const updates = {};
            if (coinsPrice > 0) updates.balance = currentUserData.balance - coinsPrice;
            if (gemsPrice > 0) updates.gems = currentUserData.gems - gemsPrice;
            
            try {
                await update(ref(db, 'users/' + currentUserData.uid), updates);
                openPack(packId);
            } catch (error) {
                showModal("Failed to purchase pack: " + error.message);
            }
        };

        window.buySpecialItem = async (itemId, coinsPrice, gemsPrice) => {
            if (!currentUserData) return showModal("User data not loaded.");
            
            // Check if user has enough currency
            if (coinsPrice > 0 && currentUserData.balance < coinsPrice) {
                return showModal("You don't have enough coins to buy this item.");
            }
            if (gemsPrice > 0 && currentUserData.gems < gemsPrice) {
                return showModal("You don't have enough gems to buy this item.");
            }
            
            // Deduct currency
            const updates = {};
            if (coinsPrice > 0) updates.balance = currentUserData.balance - coinsPrice;
            if (gemsPrice > 0) updates.gems = currentUserData.gems - gemsPrice;
            
            try {
                await update(ref(db, 'users/' + currentUserData.uid), updates);
                useSpecialItem(itemId);
            } catch (error) {
                showModal("Failed to purchase item: " + error.message);
            }
        };
        
        window.changeTrainingFocus = async (playerId) => {
            if (!currentUserData) return;
            
            // Get player data
            const playerRef = ref(db, `users/${currentUserData.uid}/youthPlayers/${playerId}`);
            const playerSnap = await get(playerRef);
            
            if (!playerSnap.exists()) {
                showModal("Player not found.");
                return;
            }
            
            const playerData = playerSnap.val();
            
            // Create training focus modal
            const focusOptions = [
                { value: 'pace', label: 'Speed Training', icon: 'tachometer-alt', color: 'green' },
                { value: 'shooting', label: 'Finishing Training', icon: 'bullseye', color: 'red' },
                { value: 'passing', label: 'Passing Training', icon: 'exchange-alt', color: 'blue' },
                { value: 'dribbling', label: 'Ball Skills', icon: 'futbol', color: 'yellow' },
                { value: 'defending', label: 'Defensive Training', icon: 'shield-alt', color: 'purple' },
                { value: 'physical', label: 'Fitness Training', icon: 'dumbbell', color: 'orange' }
            ];
            
            let optionsHtml = '';
            focusOptions.forEach(option => {
                const isSelected = playerData.trainingFocus === option.value;
                optionsHtml += `
                    <div class="training-focus-option p-3 rounded-lg cursor-pointer border-2 ${isSelected ? 'border-yellow-400 bg-gray-700' : 'border-gray-600 bg-gray-800'} hover:border-green-500" data-focus="${option.value}">
                        <div class="flex items-center">
                            <i class="fas fa-${option.icon} text-${option.color}-400 mr-3"></i>
                            <span class="font-medium text-white">${option.label}</span>
                            ${isSelected ? '<i class="fas fa-check-circle text-green-400 ml-auto"></i>' : ''}
                        </div>
                    </div>`;
            });
            
            const modalHtml = `
                <div id="training-focus-modal" class="fixed inset-0 modal-backdrop flex items-center justify-center z-50">
                    <div class="bg-gray-900 rounded-xl shadow-2xl p-6 w-full max-w-md text-left border-4 border-blue-500 relative">
                        <button id="focus-close-btn" class="absolute top-2 right-3 text-2xl text-gray-400 hover:text-white">&times;</button>
                        <h2 class="text-2xl font-bold text-blue-400 mb-4">Change Training Focus</h2>
                        <div class="player-card p-4 mb-4">
                            <div class="flex items-center">
                                <img src="${playerData.imageUrl || 'https://placehold.co/96x96/161b22/FFFFFF?text=Y'}" alt="${playerData.name}" class="w-16 h-16 object-cover rounded-full mr-4 border-2 border-gray-600">
                                <div>
                                    <h3 class="font-bold text-lg text-white">${playerData.name}</h3>
                                    <p class="text-gray-400">Current Focus: <span class="capitalize">${playerData.trainingFocus || 'balanced'}</span></p>
                                </div>
                            </div>
                        </div>
                        <div class="space-y-3 mb-6">
                            ${optionsHtml}
                        </div>
                        <div class="flex space-x-3">
                            <button id="cancel-focus-btn" class="flex-1 py-2 px-4 bg-gray-700 hover:bg-gray-600 text-white font-bold rounded-lg interactive-button">Cancel</button>
                            <button id="confirm-focus-btn" class="flex-1 py-2 px-4 bg-blue-600 hover:bg-blue-700 text-white font-bold rounded-lg interactive-button" data-player="${playerId}">Apply Focus</button>
                        </div>
                    </div>
                </div>`;
            
            // Add the modal to the document
            document.body.insertAdjacentHTML('beforeend', modalHtml);
            
            // Add event listeners
            document.getElementById('focus-close-btn').addEventListener('click', closeFocusModal);
            document.getElementById('cancel-focus-btn').addEventListener('click', closeFocusModal);
            
            // Add click listeners to focus options
            document.querySelectorAll('.training-focus-option').forEach(option => {
                option.addEventListener('click', () => {
                    // Remove selection from all options
                    document.querySelectorAll('.training-focus-option').forEach(opt => {
                        opt.classList.remove('border-yellow-400', 'bg-gray-700');
                        opt.classList.add('border-gray-600', 'bg-gray-800');
                        // Remove check icon if exists
                        const checkIcon = opt.querySelector('.fa-check-circle');
                        if (checkIcon) checkIcon.remove();
                    });
                    
                    // Add selection to clicked option
                    option.classList.remove('border-gray-600', 'bg-gray-800');
                    option.classList.add('border-yellow-400', 'bg-gray-700');
                    
                    // Add check icon
                    const iconContainer = option.querySelector('div');
                    iconContainer.innerHTML += '<i class="fas fa-check-circle text-green-400 ml-auto"></i>';
                });
            });
            
            document.getElementById('confirm-focus-btn').addEventListener('click', async (e) => {
                const playerId = e.target.getAttribute('data-player');
                const selectedFocus = document.querySelector('.training-focus-option.border-yellow-400');
                
                if (!selectedFocus) {
                    showModal("Please select a training focus.");
                    return;
                }
                
                const focusValue = selectedFocus.getAttribute('data-focus');
                
                // Update player training focus
                await update(playerRef, { trainingFocus: focusValue });
                
                closeFocusModal();
                showModal(`Training focus for ${playerData.name} changed to ${focusValue}!`);
                loadYouthPlayers(); // Refresh the youth players list
            });
        };
        
        // Function to close focus modal
        function closeFocusModal() {
            const modal = document.getElementById('training-focus-modal');
            if (modal) {
                modal.remove();
            }
        }
        
        // Update the setTrainingFocus function
        async function setTrainingFocus(focus) {
            if (!currentUserData) return;
            
            try {
                // Save training focus to user data
                await update(ref(db, 'users/' + currentUserData.uid), { 
                    youthTrainingFocus: focus 
                });
                
                // Update UI to show selected focus
                document.querySelectorAll('.training-focus-option').forEach(option => {
                    option.classList.remove('border-2', 'border-yellow-400');
                    if (option.getAttribute('data-focus') === focus) {
                        option.classList.add('border-2', 'border-yellow-400');
                    }
                });
                
                showModal(`Training focus set to ${focus}! All new youth players will have this focus.`);
            } catch (error) {
                console.error("Error setting training focus:", error);
                showModal("Error setting training focus. Please try again.");
            }
        }
        
        // Add auto-training functionality
        async function autoTrainYouthPlayers() {
            if (!currentUserData) return;
            
            try {
                // Get user's youth players from database
                const youthPlayersRef = ref(db, `users/${currentUserData.uid}/youthPlayers`);
                const snapshot = await get(youthPlayersRef);
                
                if (snapshot.exists()) {
                    const youthPlayers = snapshot.val();
                    const updates = {};
                    let trainingApplied = false;
                    
                    // Get youth academy level for training effectiveness
                    const youthAcademyLevel = currentUserData.clubFacilities?.youthAcademy?.level || 1;
                    const trainingEffectiveness = 1 + (youthAcademyLevel * 0.1); // 10% bonus per level
                    
                    for (const playerId in youthPlayers) {
                        const player = youthPlayers[playerId];
                        const attributes = player.attributes || { pace: 50, shooting: 50, passing: 50, dribbling: 50, defending: 50, physical: 50 };
                        const trainingFocus = player.trainingFocus || 'balanced';
                        let trainingProgress = player.trainingProgress || 0;
                        
                        // Apply training progress
                        trainingProgress = Math.min(100, trainingProgress + (2 * trainingEffectiveness));
                        
                        // If training is complete, improve the focused attribute
                        if (trainingProgress >= 100) {
                            trainingProgress = 0; // Reset progress
                            
                            // Improve the focused attribute (max 99)
                            if (trainingFocus !== 'balanced' && attributes[trainingFocus] < 99) {
                                attributes[trainingFocus] = Math.min(99, attributes[trainingFocus] + 1);
                                trainingApplied = true;
                            } else {
                                // If balanced or attribute is maxed, improve a random attribute
                                const attributeKeys = ['pace', 'shooting', 'passing', 'dribbling', 'defending', 'physical'];
                                const randomAttribute = attributeKeys[Math.floor(Math.random() * attributeKeys.length)];
                                if (attributes[randomAttribute] < 99) {
                                    attributes[randomAttribute] = Math.min(99, attributes[randomAttribute] + 1);
                                    trainingApplied = true;
                                }
                            }
                        }
                        
                        // Update player data
                        updates[`users/${currentUserData.uid}/youthPlayers/${playerId}`] = {
                            ...player,
                            attributes: attributes,
                            trainingProgress: trainingProgress
                        };
                    }
                    
                    // Apply all updates
                    if (Object.keys(updates).length > 0) {
                        await update(ref(db), updates);
                        
                        // Show notification if training was applied
                        if (trainingApplied) {
                            // Only show notification if user is on the youth squad view
                            if (!document.getElementById('youth-squad-view').classList.contains('hidden')) {
                                showModal("Youth players have improved their skills through training!");
                            }
                        }
                        
                        // Refresh youth players display if on youth squad view
                        if (!document.getElementById('youth-squad-view').classList.contains('hidden')) {
                            loadYouthPlayers();
                        }
                    }
                }
            } catch (error) {
                console.error("Error in auto training:", error);
            }
        }
        
        // Set up periodic auto-training (every 10 minutes)
        setInterval(() => {
            if (currentUserData) {
                autoTrainYouthPlayers();
            }
        }, 10 * 60 * 1000); // 10 minutes

        async function openPack(packId) {
            const playersRef = ref(db, 'players');
            const snapshot = await get(playersRef);
            if (!snapshot.exists()) return;
            
            const allPlayers = snapshot.val();
            const playerIds = Object.keys(allPlayers);
            
            // Filter players by rarity based on pack type
            let filteredPlayers = [];
            if (packId === 'bronze_pack') {
                filteredPlayers = playerIds.filter(id => allPlayers[id].rarity === 'bronze' || !allPlayers[id].rarity);
            } else if (packId === 'silver_pack') {
                filteredPlayers = playerIds.filter(id => allPlayers[id].rarity === 'silver' || allPlayers[id].rarity === 'bronze');
            } else if (packId === 'gold_pack') {
                filteredPlayers = playerIds.filter(id => allPlayers[id].rarity === 'gold' || allPlayers[id].rarity === 'silver');
            } else if (packId === 'premium_pack') {
                filteredPlayers = playerIds; // All players
            }
            
            // Select random players
            const selectedPlayers = [];
            const numPlayers = packId === 'premium_pack' ? 5 : 3;
            
            for (let i = 0; i < numPlayers; i++) {
                if (filteredPlayers.length === 0) break;
                const randomIndex = Math.floor(Math.random() * filteredPlayers.length);
                const playerId = filteredPlayers[randomIndex];
                selectedPlayers.push({ id: playerId, ...allPlayers[playerId] });
                filteredPlayers.splice(randomIndex, 1);
            }
            
            // Show pack opening modal
            const packContainer = document.getElementById('pack-opening-container');
            packContainer.innerHTML = '';
            
            selectedPlayers.forEach(player => {
                const rarity = player.rarity || "bronze";
                const rarityClass = rarity === "bronze" ? "bronze" : 
                                   rarity === "silver" ? "silver" : 
                                   rarity === "gold" ? "gold" : "special";
                
                packContainer.innerHTML += `
                    <div class="pack-card p-4 text-center shadow-lg ${rarityClass} pack-shake">
                        <img src="${player.imageUrl}" alt="${player.name}" class="w-32 h-32 object-cover rounded-full mx-auto mb-3 border-2 border-gray-600 card-reveal">
                        <h4 class="font-bold text-lg text-white">${player.name}</h4>
                        <p class="text-sm text-gray-400">${player.position}</p>
                        <p class="text-xl font-bold text-green-400 mt-2">${player.rating}</p>
                        <p class="text-xs text-gray-500 mt-1">${rarity.toUpperCase()}</p>
                    </div>`;
            });
            
            playSound(packOpenSound);
            packOpeningModal.classList.remove('hidden');
            
            // Add players to user's squad
            const newSquad = [...(currentUserData.squad || [])];
            selectedPlayers.forEach(player => {
                if (!newSquad.includes(player.id)) {
                    newSquad.push(player.id);
                }
            });
            
            await update(ref(db, 'users/' + currentUserData.uid), { squad: newSquad });
            
            // Track pack opening missions
            trackPurchaseMissions();
        }

        document.getElementById('edit-club-name').addEventListener('click', () => {
            if (!currentUserData) return;
            const newClubName = prompt("Enter your new Club Name:", currentUserData.clubName);
            if (newClubName && newClubName.trim() !== "") {
                update(ref(db, 'users/' + currentUserData.uid), { clubName: newClubName.trim() })
                    .then(() => showModal("Club name changed successfully."))
                    .catch((error) => showModal("Error: " + error.message));
            }
        });
        
        document.getElementById('user-avatar-container').addEventListener('click', () => {
            document.getElementById('logo-upload').click();
        });

        document.getElementById('logo-upload').addEventListener('change', async (e) => {
            const file = e.target.files[0];
            if (!file) return;
            showModal('Uploading Logo...');
            const formData = new FormData();
            formData.append('image', file);
            try {
                const response = await fetch(`https://api.imgbb.com/1/upload?key=${IMGBB_API_KEY}`, { method: 'POST', body: formData });
                const result = await response.json();
                if(result.success) { await update(ref(db, 'users/' + currentUserData.uid), { avatarUrl: result.data.url }); showModal('Logo updated successfully!'); } 
                else { throw new Error(result.error.message); }
            } catch (error) { showModal(`Upload failed: ${error.message}`); }
        });
        
        strategyButtons.forEach(button => {
            button.addEventListener('click', async (e) => {
                if (!currentMatchId || !currentUserData) return;
                const targetButton = e.currentTarget;
                const newStrategy = targetButton.getAttribute('data-strategy');
                if(newStrategy === currentLocalStrategy) return;
                currentLocalStrategy = newStrategy; 
                strategyButtons.forEach(btn => btn.classList.remove('border-2', 'border-yellow-400', 'ring-2', 'ring-yellow-400'));
                targetButton.classList.add('border-2', 'border-yellow-400', 'ring-2', 'ring-yellow-400');
                const matchSnapshot = await get(ref(db, `matches/${currentMatchId}`));
                if (!matchSnapshot.exists()) return;
                const matchData = matchSnapshot.val();
                let strategyPath = currentUserData.uid === matchData.teamA.uid ? 'teamAStrategy' : (currentUserData.uid === matchData.teamB.uid ? 'teamBStrategy' : null);
                if(!strategyPath) return;
                await update(ref(db, `matches/${currentMatchId}`), { [strategyPath]: newStrategy });
                let seconds = matchData.startTime ? Math.floor((Date.now() - matchData.startTime) / 1000) : 0;
                push(ref(db, `matches/${currentMatchId}/events`), { time: `${seconds}'`, text: `üîÑ ${currentUserData.clubName} changed strategy to ${newStrategy}.` });
                
                // Update player positions based on new strategy/formation
                updatePlayerPositions(matchData, newStrategy);
            });
        });
        
        // Update player positions based on strategy/formation
        function updatePlayerPositions(matchData, strategy) {
            // In a real implementation, you would adjust player positions based on the strategy
            // For now, we'll just move players slightly to simulate tactical changes
            const players = document.querySelectorAll('.player-icon');
            players.forEach(player => {
                // Add a small animation to show tactical change
                player.classList.add('transition-transform', 'duration-500');
                
                // Get current position
                const currentTop = parseFloat(player.style.top);
                const currentLeft = parseFloat(player.style.left);
                
                // Adjust position slightly based on strategy
                let newTop = currentTop;
                let newLeft = currentLeft;
                
                if (strategy === 'Attack') {
                    // Move players forward
                    newTop = player.classList.contains('teamA') ? currentTop - 5 : currentTop + 5;
                } else if (strategy === 'Defense') {
                    // Move players back
                    newTop = player.classList.contains('teamA') ? currentTop + 5 : currentTop - 5;
                }
                
                // Apply new position
                player.style.top = `${newTop}%`;
                player.style.left = `${newLeft}%`;
                
                // Remove animation class after transition
                setTimeout(() => {
                    player.classList.remove('transition-transform', 'duration-500');
                }, 500);
            });
        }

        const cancelMatchmakingBtn = document.getElementById('cancel-matchmaking-btn');

        async function getPlayerNamesBySquad(squadIds) {
            if (!squadIds || squadIds.length === 0) return [];
            const playerPromises = squadIds.map(playerId => get(ref(db, 'players/' + playerId)));
            const playerSnapshots = await Promise.all(playerPromises);
            return playerSnapshots.map(snap => snap.exists() ? snap.val().name : null).filter(name => name);
        }

        findMatchBtn.addEventListener('click', async () => {
            if (!currentUserData || !currentUserData.uid) return showModal("Your data is still loading. Please wait a moment.");
            if (!currentUserData.squad || currentUserData.squad.length < 5) return showModal("You must have at least 5 players in your squad to play a match.");
            document.getElementById('match-initial-screen').classList.add('hidden');
            document.getElementById('matchmaking-screen').classList.remove('hidden');
            pauseMainMenuMusic();
            const matchmakingRef = ref(db, 'matchmaking');
            const snapshot = await get(matchmakingRef);
            let opponent = null;
            if(snapshot.exists()){ snapshot.forEach(child => { if(!opponent && child.key !== currentUserData.uid) opponent = { uid: child.key, ...child.val() }; }); }
            if(opponent){
                const matchId = push(ref(db, 'matches')).key;
                currentMatchId = matchId;
                const opponentUserSnap = await get(ref(db, `users/${opponent.uid}`));
                const opponentSquad = opponentUserSnap.exists() ? (opponentUserSnap.val().squad || []) : [];
                const matchData = {
                    teamA: { uid: opponent.uid, clubName: opponent.clubName, teamPower: opponent.teamPower, squad: opponentSquad },
                    teamB: { uid: currentUserData.uid, clubName: currentUserData.clubName, teamPower: teamPower, squad: currentUserData.squad },
                    score: { teamA: 0, teamB: 0 }, status: 'starting', startTime: serverTimestamp(), events: {},
                    teamAStrategy: 'Balanced', teamBStrategy: 'Balanced'
                };
                const updates = {};
                updates[`/matches/${matchId}`] = matchData;
                updates[`/users/${opponent.uid}/currentMatch`] = matchId;
                updates[`/users/${currentUserData.uid}/currentMatch`] = matchId;
                updates[`/matchmaking/${opponent.uid}`] = null;
                updates[`/matchmaking/${currentUserData.uid}`] = null;
                await update(ref(db), updates);
            } else {
                await set(ref(db, `matchmaking/${currentUserData.uid}`), { clubName: currentUserData.clubName, teamPower: teamPower, timestamp: serverTimestamp() });
            }
        });

        singlePlayerBtn.addEventListener('click', async () => {
            if (!currentUserData || !currentUserData.uid) return showModal("Your data is still loading. Please wait a moment.");
            if (!currentUserData.squad || currentUserData.squad.length < 5) return showModal("You must have at least 5 players in your squad to play a match.");
            
            // Create a single player match against AI
            const matchId = push(ref(db, 'matches')).key;
            currentMatchId = matchId;
            
            // Generate AI opponent with similar team power
            const aiTeamPower = Math.max(teamPower - 5 + Math.floor(Math.random() * 10), 10);
            const aiClubName = "AI Team " + Math.floor(Math.random() * 1000);
            
            const matchData = {
                teamA: { uid: "ai_opponent", clubName: aiClubName, teamPower: aiTeamPower, squad: [] },
                teamB: { uid: currentUserData.uid, clubName: currentUserData.clubName, teamPower: teamPower, squad: currentUserData.squad },
                score: { teamA: 0, teamB: 0 }, status: 'starting', startTime: serverTimestamp(), events: {},
                teamAStrategy: 'Balanced', teamBStrategy: 'Balanced',
                isSinglePlayer: true
            };
            
            const updates = {};
            updates[`/matches/${matchId}`] = matchData;
            updates[`/users/${currentUserData.uid}/currentMatch`] = matchId;
            await update(ref(db), updates);
        });

        friendlyMatchBtn.addEventListener('click', async () => {
            if (!currentUserData || !currentUserData.uid) return showModal("Your data is still loading. Please wait a moment.");
            if (!currentUserData.squad || currentUserData.squad.length < 5) return showModal("You must have at least 5 players in your squad to play a match.");
            
            // Open friendly match modal
            openFriendlyMatchModal();
        });
        
        // Add event listener for private leagues button
        privateLeaguesBtn.addEventListener('click', async () => {
            if (!currentUserData || !currentUserData.uid) return showModal("Your data is still loading. Please wait a moment.");
            if (!currentUserData.squad || currentUserData.squad.length < 5) return showModal("You must have at least 5 players in your squad to play a match.");
            
            // Open private leagues modal
            openPrivateLeaguesModal();
        });
        
        // Add function to open friendly match modal
        function openFriendlyMatchModal() {
            // Create a modal for friendly matches
            const modalHtml = `
                <div id="friendly-match-modal" class="fixed inset-0 modal-backdrop flex items-center justify-center z-50">
                    <div class="bg-gray-900 rounded-xl shadow-2xl p-6 w-full max-w-md text-left border-4 border-yellow-500 relative">
                        <button id="friendly-match-close-btn" class="absolute top-2 right-3 text-2xl text-gray-400 hover:text-white">&times;</button>
                        <h2 class="text-2xl font-bold text-yellow-400 mb-4">Friendly Match</h2>
                        <div class="space-y-4">
                            <div>
                                <label class="block text-gray-300 mb-2">Invite Friend</label>
                                <input type="text" id="friend-name" placeholder="Enter friend's club name" class="w-full px-4 py-2 bg-gray-700 border border-gray-600 rounded-lg text-white">
                            </div>
                            <div class="flex space-x-3 pt-4">
                                <button id="cancel-friendly-match-btn" class="flex-1 py-2 px-4 bg-gray-700 hover:bg-gray-600 text-white font-bold rounded-lg interactive-button">Cancel</button>
                                <button id="send-invite-btn" class="flex-1 py-2 px-4 bg-green-600 hover:bg-green-700 text-white font-bold rounded-lg interactive-button">Send Invite</button>
                            </div>
                        </div>
                    </div>
                </div>`;
            
            // Add the modal to the document
            document.body.insertAdjacentHTML('beforeend', modalHtml);
            
            // Add event listeners
            document.getElementById('friendly-match-close-btn').addEventListener('click', closeFriendlyMatchModal);
            document.getElementById('cancel-friendly-match-btn').addEventListener('click', closeFriendlyMatchModal);
            document.getElementById('send-invite-btn').addEventListener('click', sendFriendlyMatchInvite);
        }
        
        // Add function to close friendly match modal
        function closeFriendlyMatchModal() {
            const modal = document.getElementById('friendly-match-modal');
            if (modal) {
                modal.remove();
            }
        }
        
        // Add function to send friendly match invite
        async function sendFriendlyMatchInvite() {
            if (!currentUserData) return;
            
            const friendName = document.getElementById('friend-name').value.trim();
            
            if (!friendName) {
                showModal("Please enter a friend's club name.");
                return;
            }
            
            // In a real implementation, you would search for the friend and send an invite
            // For now, we'll just show a message
            closeFriendlyMatchModal();
            showModal(`Friendly match invite sent to ${friendName}!`);
        }
        
        // Add function to open private leagues modal
        function openPrivateLeaguesModal() {
            // Create a modal for private leagues
            const modalHtml = `
                <div id="private-leagues-modal" class="fixed inset-0 modal-backdrop flex items-center justify-center z-50">
                    <div class="bg-gray-900 rounded-xl shadow-2xl p-6 w-full max-w-md text-left border-4 border-blue-500 relative">
                        <button id="private-leagues-close-btn" class="absolute top-2 right-3 text-2xl text-gray-400 hover:text-white">&times;</button>
                        <h2 class="text-2xl font-bold text-blue-400 mb-4">Private Leagues</h2>
                        <div class="space-y-4">
                            <div>
                                <label class="block text-gray-300 mb-2">League Name</label>
                                <input type="text" id="league-name" placeholder="Enter league name" class="w-full px-4 py-2 bg-gray-700 border border-gray-600 rounded-lg text-white">
                            </div>
                            <div>
                                <label class="block text-gray-300 mb-2">League Code (for joining)</label>
                                <input type="text" id="league-code" placeholder="Enter league code" class="w-full px-4 py-2 bg-gray-700 border border-gray-600 rounded-lg text-white">
                            </div>
                            <div class="flex space-x-3 pt-4">
                                <button id="cancel-private-leagues-btn" class="flex-1 py-2 px-4 bg-gray-700 hover:bg-gray-600 text-white font-bold rounded-lg interactive-button">Cancel</button>
                                <button id="create-league-btn" class="flex-1 py-2 px-4 bg-green-600 hover:bg-green-700 text-white font-bold rounded-lg interactive-button">Create League</button>
                                <button id="join-league-btn" class="flex-1 py-2 px-4 bg-blue-600 hover:bg-blue-700 text-white font-bold rounded-lg interactive-button">Join League</button>
                            </div>
                        </div>
                    </div>
                </div>`;
            
            // Add the modal to the document
            document.body.insertAdjacentHTML('beforeend', modalHtml);
            
            // Add event listeners
            document.getElementById('private-leagues-close-btn').addEventListener('click', closePrivateLeaguesModal);
            document.getElementById('cancel-private-leagues-btn').addEventListener('click', closePrivateLeaguesModal);
            document.getElementById('create-league-btn').addEventListener('click', createPrivateLeague);
            document.getElementById('join-league-btn').addEventListener('click', joinPrivateLeague);
        }
        
        // Add function to close private leagues modal
        function closePrivateLeaguesModal() {
            const modal = document.getElementById('private-leagues-modal');
            if (modal) {
                modal.remove();
            }
        }
        
        // Add function to create private league
        async function createPrivateLeague() {
            if (!currentUserData) return;
            
            const leagueName = document.getElementById('league-name').value.trim();
            
            if (!leagueName) {
                showModal("Please enter a league name.");
                return;
            }
            
            // In a real implementation, you would create the league in Firebase
            // For now, we'll just show a message
            closePrivateLeaguesModal();
            showModal(`Private league "${leagueName}" created successfully!`);
        }
        
        // Add function to join private league
        async function joinPrivateLeague() {
            if (!currentUserData) return;
            
            const leagueCode = document.getElementById('league-code').value.trim();
            
            if (!leagueCode) {
                showModal("Please enter a league code.");
                return;
            }
            
            // In a real implementation, you would join the league in Firebase
            // For now, we'll just show a message
            closePrivateLeaguesModal();
            showModal(`Joined private league with code ${leagueCode}!`);
        }

        cancelMatchmakingBtn.addEventListener('click', async () => {
            if (!currentUserData || !currentUserData.uid) return;
            await remove(ref(db, `matchmaking/${currentUserData.uid}`));
            document.getElementById('matchmaking-screen').classList.add('hidden');
            document.getElementById('match-initial-screen').classList.remove('hidden');
            pauseMatchMusic();
            playMainMenuMusic();
        });

        function listenForMatch(uid) {
            const userMatchRef = ref(db, `users/${uid}/currentMatch`);
            if(matchListener) matchListener(); 
            matchListener = onValue(userMatchRef, (snapshot) => {
                const matchId = snapshot.val();
                if(matchId){
                    currentMatchId = matchId;
                    navigateToView('match-view'); 
                    startMatch(matchId);
                } else {
                    currentMatchId = null;
                    if(timerInterval) clearInterval(timerInterval);
                    if(matchSimulationInterval) clearInterval(matchSimulationInterval);
                    if(opponentStatusListener) opponentStatusListener();
                    if(reactionListener) reactionListener();
                    pauseMatchMusic();
                    if(!document.getElementById('match-view').classList.contains('hidden')) { navigateToView('home-view'); } 
                    else { playMainMenuMusic(); }
                    document.getElementById('match-simulation-screen').classList.add('hidden');
                    document.getElementById('matchmaking-screen').classList.add('hidden');
                    document.getElementById('match-initial-screen').classList.remove('hidden');
                }
            });
        }
        
        async function handleWalkover(matchId, disconnectedOpponentUid) {
            if (!currentUserData) return;
            if(matchListener) { matchListener(); matchListener = null; }
            if(opponentStatusListener) { opponentStatusListener(); opponentStatusListener = null; }
            if(timerInterval) clearInterval(timerInterval);
            if(matchSimulationInterval) clearInterval(matchSimulationInterval);
            if(reactionListener) reactionListener();
            
            showModal(`Opponent Disconnected! You win the match by walkover. Rewards have been added.`);
            
            const updates = {};
            const winnerData = currentUserData; 
            
            updates[`/users/${winnerData.uid}/points`] = (winnerData.points || 0) + 10;
            updates[`/users/${winnerData.uid}/wins`] = (winnerData.wins || 0) + 1;
            updates[`/users/${winnerData.uid}/balance`] = (winnerData.balance || 0) + 500;
            await updatePlayerStatsAfterMatch(winnerData.uid, "win");

            const leaverRef = ref(db, `users/${disconnectedOpponentUid}`);
            const leaverSnap = await get(leaverRef);
            if(leaverSnap.exists()){
                const leaverData = leaverSnap.val();
                updates[`/users/${disconnectedOpponentUid}/balance`] = (leaverData.balance || 0) + 50;
                await updatePlayerStatsAfterMatch(disconnectedOpponentUid, "loss");
            }

            updates[`/users/${winnerData.uid}/currentMatch`] = null;
            updates[`/users/${disconnectedOpponentUid}/currentMatch`] = null;
            updates[`/matches/${matchId}`] = null;
            
            await update(ref(db), updates);
        }

        async function startMatch(matchId) {
            document.getElementById('matchmaking-screen').classList.add('hidden');
            document.getElementById('match-initial-screen').classList.add('hidden');
            document.getElementById('match-simulation-screen').classList.remove('hidden');
            document.getElementById('live-commentary').innerHTML = '';
            pauseMainMenuMusic();
            
            // Reset match stats
            matchStats = {
                time: 0,
                teamA: {
                    score: 0,
                    possession: 0,
                    shots: 0,
                    shotsOnTarget: 0,
                    corners: 0,
                    fouls: 0,
                    yellowCards: 0,
                    redCards: 0
                },
                teamB: {
                    score: 0,
                    possession: 0,
                    shots: 0,
                    shotsOnTarget: 0,
                    corners: 0,
                    fouls: 0,
                    yellowCards: 0,
                    redCards: 0
                }
            };
            
            // Initialize stats UI
            updateMatchStatsUI();
            
            const matchRef = ref(db, `matches/${matchId}`);
            const initialSnap = await get(matchRef);
            if (!initialSnap.exists()) return;
            const initialMatchData = initialSnap.val();
            
            // Ensure initial match data has proper score structure
            if (!initialMatchData.score) {
                initialMatchData.score = { teamA: 0, teamB: 0 };
            }
            
            // Only set up opponent status listener if it's not a single player match
            if (!initialMatchData.isSinglePlayer) {
                const opponent = initialMatchData.teamA.uid === currentUserData.uid ? initialMatchData.teamB : initialMatchData.teamA;
                const opponentStatusRef = ref(db, `/status/${opponent.uid}`);
                if (opponentStatusListener) opponentStatusListener();
                opponentStatusListener = onValue(opponentStatusRef, (snapshot) => {
                    if (!snapshot.exists() || snapshot.val().state === 'offline') {
                        handleWalkover(matchId, opponent.uid);
                    }
                });
            }

            // For single player matches, teamA (AI) may have an empty squad
            const teamA_PlayerNames = initialMatchData.isSinglePlayer ? [initialMatchData.teamA.clubName] : await getPlayerNamesBySquad(initialMatchData.teamA.squad);
            const teamB_PlayerNames = await getPlayerNamesBySquad(initialMatchData.teamB.squad);

            if(matchListener) matchListener(); 
            
            matchListener = onValue(matchRef, async (snapshot) => {
                const matchData = snapshot.val();
                if(!matchData) { playMainMenuMusic(); return; }
                document.getElementById('teamA-name').textContent = matchData.teamA.clubName;
                document.getElementById('teamB-name').textContent = matchData.teamB.clubName;
                document.getElementById('teamA-score').textContent = matchData.score.teamA;
                document.getElementById('teamB-score').textContent = matchData.score.teamB;
                
                // Update match stats from Firebase data
                matchStats.teamA.score = matchData.score.teamA;
                matchStats.teamB.score = matchData.score.teamB;
                // Initialize other stats if not already set
                if (matchStats.teamA.possession === undefined) matchStats.teamA.possession = 0;
                if (matchStats.teamA.shots === undefined) matchStats.teamA.shots = 0;
                if (matchStats.teamA.shotsOnTarget === undefined) matchStats.teamA.shotsOnTarget = 0;
                if (matchStats.teamA.corners === undefined) matchStats.teamA.corners = 0;
                if (matchStats.teamA.fouls === undefined) matchStats.teamA.fouls = 0;
                if (matchStats.teamA.yellowCards === undefined) matchStats.teamA.yellowCards = 0;
                if (matchStats.teamA.redCards === undefined) matchStats.teamA.redCards = 0;
                if (matchStats.teamB.possession === undefined) matchStats.teamB.possession = 0;
                if (matchStats.teamB.shots === undefined) matchStats.teamB.shots = 0;
                if (matchStats.teamB.shotsOnTarget === undefined) matchStats.teamB.shotsOnTarget = 0;
                if (matchStats.teamB.corners === undefined) matchStats.teamB.corners = 0;
                if (matchStats.teamB.fouls === undefined) matchStats.teamB.fouls = 0;
                if (matchStats.teamB.yellowCards === undefined) matchStats.teamB.yellowCards = 0;
                if (matchStats.teamB.redCards === undefined) matchStats.teamB.redCards = 0;
                updateMatchStatsUI();
                
                // Load team avatars
                if (matchData.teamA.uid !== 'ai_opponent') {
                    const teamAUserSnap = await get(ref(db, `users/${matchData.teamA.uid}`));
                    if (teamAUserSnap.exists()) {
                        const teamAData = teamAUserSnap.val();
                        document.getElementById('teamA-avatar').src = teamAData.avatarUrl || `https://placehold.co/60x60/161b22/FFFFFF?text=${teamAData.clubName.charAt(0)}`;
                    }
                } else {
                    document.getElementById('teamA-avatar').src = 'https://placehold.co/60x60/161b22/FFFFFF?text=AI';
                }
                
                if (matchData.teamB.uid !== 'ai_opponent') {
                    const teamBUserSnap = await get(ref(db, `users/${matchData.teamB.uid}`));
                    if (teamBUserSnap.exists()) {
                        const teamBData = teamBUserSnap.val();
                        document.getElementById('teamB-avatar').src = teamBData.avatarUrl || `https://placehold.co/60x60/161b22/FFFFFF?text=${teamBData.clubName.charAt(0)}`;
                    }
                } else {
                    document.getElementById('teamB-avatar').src = 'https://placehold.co/60x60/161b22/FFFFFF?text=AI';
                }
                
                isLocalPlayerTeamA = currentUserData.uid === matchData.teamA.uid;
                currentLocalStrategy = isLocalPlayerTeamA ? matchData.teamAStrategy : matchData.teamBStrategy;
                
                strategyButtons.forEach(btn => {
                    btn.classList.remove('border-2', 'border-yellow-400', 'ring-2', 'ring-yellow-400');
                    if (btn.getAttribute('data-strategy') === currentLocalStrategy) {
                        btn.classList.add('border-2', 'border-yellow-400', 'ring-2', 'ring-yellow-400');
                    }
                });

                if(timerInterval) clearInterval(timerInterval);
                const matchDuration = 90; 
                const timerDisplay = document.getElementById('match-timer');
                
                if (matchData.status === 'ongoing' && matchData.startTime) {
                    if (matchData.teamA.uid !== currentUserData.uid) { playMatchMusic(); }
                    const matchStartTimestamp = matchData.startTime;
                    timerInterval = setInterval(() => {
                        const elapsedSeconds = Math.floor((Date.now() - matchStartTimestamp) / 1000);
                        const remaining = matchDuration - elapsedSeconds;
                        if (remaining <= 0) { clearInterval(timerInterval); timerDisplay.textContent = '00:00'; } 
                        else { timerDisplay.textContent = `${Math.floor(remaining / 60).toString().padStart(2, '0')}:${(remaining % 60).toString().padStart(2, '0')}`; }
                    }, 1000);
                } else if (matchData.status === 'completed') { 
                    timerDisplay.textContent = '00:00 (FT)'; 
                    // Hide victory/defeat screens if match is completed but user didn't win/lose
                    const victoryScreen = document.getElementById('victory-screen');
                    if (victoryScreen && !victoryScreen.classList.contains('hidden')) {
                        victoryScreen.classList.add('hidden');
                    }
                    const defeatScreen = document.getElementById('defeat-screen');
                    if (defeatScreen && !defeatScreen.classList.contains('hidden')) {
                        defeatScreen.classList.add('hidden');
                    }
                } 
                else { timerDisplay.textContent = '01:30'; }

                if(currentUserData && matchData.status === 'starting' && (matchData.teamA.uid === currentUserData.uid || matchData.teamB.uid === currentUserData.uid || matchData.isSinglePlayer)){
                     runMatchSimulation(matchId, matchData, teamA_PlayerNames, teamB_PlayerNames);
                }
            });
            
            const commentaryRef = ref(db, `matches/${matchId}/events`);
            onChildAdded(commentaryRef, (snapshot) => {
                const event = snapshot.val();
                const commentaryBox = document.getElementById('live-commentary');
                commentaryBox.innerHTML += `<p class="mb-2 text-sm">${event.time}: ${event.text}</p>`;
                commentaryBox.scrollTop = commentaryBox.scrollHeight;
                
                // Play goal sound if it's a goal event
                if (event.text.includes('GOAL') || event.text.includes('Golazo') || event.text.includes('scores')) {
                    playSound(goalSound);
                }
            });
            
            const reactionRef = ref(db, `matches/${matchId}/reactions`);
            if(reactionListener) reactionListener();
            reactionListener = onChildAdded(reactionRef, (snapshot) => {
                const { emoji, senderId } = snapshot.val();
                if(senderId !== currentUserData.uid) {
                    displayReaction(emoji);
                }
            });
            
            // Set up in-match chat
            setupInMatchChat(matchId);
        }

        function getRandomItem(arr) { return arr[Math.floor(Math.random() * arr.length)]; }
        function getRandomCommentary(type = 'default', teamName = '', attacker = '', defender = '') {
            let filtered = ALL_COMMENTARIES;
            if (type === 'goal') filtered = ALL_COMMENTARIES.filter(c => c.includes('GOAL')||c.includes('Golazo')||c.includes('bulges'));
            else if (type === 'chance') filtered = ALL_COMMENTARIES.filter(c => c.includes('chance')||c.includes('close')||c.includes('shoots'));
            else if (type === 'save' || type === 'tackle') filtered = ALL_COMMENTARIES.filter(c => c.includes('save')||c.includes('tackle')||c.includes('keeper'));
            else filtered = ALL_COMMENTARIES.filter(c => !c.includes('GOAL') && !c.includes('$PLAYER') && !c.includes('chance') && !c.includes('save'));
            if(filtered.length === 0) return `Action in the midfield.`;
            let c = getRandomItem(filtered);
            return c.replace(/\$PLAYER/g, attacker||teamName).replace(/\$ASSIST/g, getRandomItem([attacker, teamName])||attacker).replace(/\$ATTACKER/g, attacker||teamName).replace(/\$DEFENDER/g, defender||teamName).replace(/\$TEAM/g, teamName);
        }

        async function updatePlayerStatsAfterMatch(uid, result) {
            const userRef = ref(db, `users/${uid}`);
            const snapshot = await get(userRef);
            if (!snapshot.exists()) return;

            const userData = snapshot.val();
            const updates = {};

            let xpGained = 0;
            if (result === 'win') xpGained = XP_PER_WIN;
            else if (result === 'draw') xpGained = XP_PER_DRAW;
            else if (result === 'loss') xpGained = XP_PER_LOSS;
            
            updates.xp = (userData.xp || 0) + xpGained;

            let currentMatchesPlayed = (userData.matchesPlayedThisLevel || 0) + 1;
            let currentMatchesNeeded = userData.matchesNeededForLevelUp || BASE_MATCHES_FOR_LEVEL_UP;
            let currentLevel = userData.level || 1;

            if (currentMatchesPlayed >= currentMatchesNeeded) {
                currentLevel++;
                updates.level = currentLevel;
                updates.matchesPlayedThisLevel = 0;
                updates.matchesNeededForLevelUp = BASE_MATCHES_FOR_LEVEL_UP * currentLevel;
                
                if(uid === currentUserData.uid) {
                    showModal(`üéâ Congratulations! You have reached Level ${currentLevel}!`);
                }
            } else {
                updates.matchesPlayedThisLevel = currentMatchesPlayed;
            }

            // Award training points based on match result
            let trainingPointsGained = 0;
            if (result === 'win') trainingPointsGained = 5;
            else if (result === 'draw') trainingPointsGained = 3;
            else if (result === 'loss') trainingPointsGained = 1;
            
            updates.trainingPoints = (userData.trainingPoints || 0) + trainingPointsGained;

            await update(userRef, updates);
            
            // Track season pass missions if this is the current user
            if (uid === currentUserData?.uid) {
                trackMatchMissions(result);
            }
        }
        
        // Match Stats System
        // This system tracks real-time match statistics and visual elements
        let matchStats = {
            time: 0,
            teamA: {
                score: 0,
                possession: 0,
                shots: 0,
                shotsOnTarget: 0,
                corners: 0,
                fouls: 0,
                yellowCards: 0,
                redCards: 0
            },
            teamB: {
                score: 0,
                possession: 0,
                shots: 0,
                shotsOnTarget: 0,
                corners: 0,
                fouls: 0,
                yellowCards: 0,
                redCards: 0
            }
        };
        
        function updateMatchStatsUI() {
            // Update match time
            const minutes = Math.floor(matchStats.time / 60);
            const seconds = matchStats.time % 60;
            const timerDisplay = document.getElementById('match-timer');
            if (timerDisplay) {
                timerDisplay.textContent = `${String(minutes).padStart(2, '0')}:${String(seconds).padStart(2, '0')}`;
            }
            
            // Update main score display
            const teamAScoreDisplay = document.getElementById('teamA-score');
            const teamBScoreDisplay = document.getElementById('teamB-score');
            if (teamAScoreDisplay) teamAScoreDisplay.textContent = matchStats.teamA.score;
            if (teamBScoreDisplay) teamBScoreDisplay.textContent = matchStats.teamB.score;

            // Update possession
            let totalTime = matchStats.time > 0 ? matchStats.time : 1; // Avoid division by zero
            let teamAPct = Math.round((matchStats.teamA.possession / totalTime) * 100);
            let teamBPct = 100 - teamAPct;
            
            const homePossessionDisplay = document.getElementById('home-possession');
            const awayPossessionDisplay = document.getElementById('away-possession');
            const possessionBar = document.getElementById('possession-bar');
            
            if (homePossessionDisplay) homePossessionDisplay.textContent = `${teamAPct}%`;
            if (awayPossessionDisplay) awayPossessionDisplay.textContent = `${teamBPct}%`;
            if (possessionBar) possessionBar.style.width = `${teamAPct}%`;
            
            // Update other stats
            const homeShotsDisplay = document.getElementById('home-shots');
            const awayShotsDisplay = document.getElementById('away-shots');
            if (homeShotsDisplay) homeShotsDisplay.textContent = matchStats.teamA.shots;
            if (awayShotsDisplay) awayShotsDisplay.textContent = matchStats.teamB.shots;
            
            const homeShotsOnTargetDisplay = document.getElementById('home-shots-on-target');
            const awayShotsOnTargetDisplay = document.getElementById('away-shots-on-target');
            if (homeShotsOnTargetDisplay) homeShotsOnTargetDisplay.textContent = matchStats.teamA.shotsOnTarget;
            if (awayShotsOnTargetDisplay) awayShotsOnTargetDisplay.textContent = matchStats.teamB.shotsOnTarget;
            
            const homeCornersDisplay = document.getElementById('home-corners');
            const awayCornersDisplay = document.getElementById('away-corners');
            if (homeCornersDisplay) homeCornersDisplay.textContent = matchStats.teamA.corners;
            if (awayCornersDisplay) awayCornersDisplay.textContent = matchStats.teamB.corners;
            
            const homeFoulsDisplay = document.getElementById('home-fouls');
            const awayFoulsDisplay = document.getElementById('away-fouls');
            if (homeFoulsDisplay) homeFoulsDisplay.textContent = matchStats.teamA.fouls;
            if (awayFoulsDisplay) awayFoulsDisplay.textContent = matchStats.teamB.fouls;
            
            // Update cards
            const teamACardsText = `${matchStats.teamA.yellowCards + matchStats.teamA.redCards} (${matchStats.teamA.yellowCards} Y/ ${matchStats.teamA.redCards} R)`;
            const teamBCardsText = `${matchStats.teamB.yellowCards + matchStats.teamB.redCards} (${matchStats.teamB.yellowCards} Y/ ${matchStats.teamB.redCards} R)`;
            
            const homeCardsDisplay = document.getElementById('home-cards');
            const awayCardsDisplay = document.getElementById('away-cards');
            if (homeCardsDisplay) homeCardsDisplay.textContent = teamACardsText;
            if (awayCardsDisplay) awayCardsDisplay.textContent = teamBCardsText;
        }
        
        // Show victory screen with animation
        function showVictoryScreen() {
            const victoryScreen = document.getElementById('victory-screen');
            if (victoryScreen) {
                victoryScreen.classList.remove('hidden');
                
                // Add back to main menu button functionality
                const backToMainMenuBtn = document.getElementById('back-to-main-menu-btn');
                if (backToMainMenuBtn) {
                    backToMainMenuBtn.addEventListener('click', () => {
                        victoryScreen.classList.add('hidden');
                        navigateToView('home-view');
                    });
                }
            }
        }
        
        // Show defeat screen with animation
        function showDefeatScreen() {
            const defeatScreen = document.getElementById('defeat-screen');
            if (defeatScreen) {
                defeatScreen.classList.remove('hidden');
                
                // Add back to main menu button functionality
                const backToMainMenuDefeatBtn = document.getElementById('back-to-main-menu-defeat-btn');
                if (backToMainMenuDefeatBtn) {
                    backToMainMenuDefeatBtn.addEventListener('click', () => {
                        defeatScreen.classList.add('hidden');
                        navigateToView('home-view');
                    });
                }
            }
        }

        // Initialize pitch visualization with player positions
        function initializePitchVisualization(matchData) {
            const pitch = document.getElementById('match-pitch');
            if (!pitch) return;
            
            // Clear existing players
            const existingPlayers = pitch.querySelectorAll('.player-icon');
            existingPlayers.forEach(player => player.remove());
            
            // Define formations (4-4-2 as default)
            const teamAFormation = getFormationPositions(matchData.teamA.formation || '4-4-2', 'teamA');
            const teamBFormation = getFormationPositions(matchData.teamB.formation || '4-4-2', 'teamB');
            
            // Add Team A players (attacking from left to right)
            if (matchData.teamA.squad && Array.isArray(matchData.teamA.squad)) {
                console.log('Team A squad:', matchData.teamA.squad);
                matchData.teamA.squad.forEach((playerId, index) => {
                    if (index < 11) { // Only first 11 players
                        const position = teamAFormation[index] || { top: 50, left: 30 };
                        console.log(`Adding Team A player ${playerId} at position ${position.top}%, ${position.left}%`);
                        addPlayerToPitch(playerId, position.top, position.left, 'teamA', index + 1);
                    }
                });
            }
            
            // Add Team B players (attacking from right to left)
            if (matchData.teamB.squad && Array.isArray(matchData.teamB.squad)) {
                console.log('Team B squad:', matchData.teamB.squad);
                matchData.teamB.squad.forEach((playerId, index) => {
                    if (index < 11) { // Only first 11 players
                        const position = teamBFormation[index] || { top: 50, left: 70 };
                        console.log(`Adding Team B player ${playerId} at position ${position.top}%, ${position.left}%`);
                        addPlayerToPitch(playerId, position.top, position.left, 'teamB', index + 1);
                    }
                });
            }
            
            // Log total players added
            const totalPlayers = pitch.querySelectorAll('.player-icon').length;
            console.log(`Total players added to pitch: ${totalPlayers}`);
        }
        
        // Get player positions based on formation
        function getFormationPositions(formation, team) {
            // Base positions for different formations
            const formations = {
                '4-4-2': [
                    // Goalkeeper
                    { top: 10, left: team === 'teamA' ? 10 : 90 },
                    // Defenders
                    { top: 30, left: team === 'teamA' ? 20 : 80 },
                    { top: 50, left: team === 'teamA' ? 20 : 80 },
                    { top: 70, left: team === 'teamA' ? 20 : 80 },
                    { top: 90, left: team === 'teamA' ? 20 : 80 },
                    // Midfielders
                    { top: 30, left: team === 'teamA' ? 40 : 60 },
                    { top: 50, left: team === 'teamA' ? 40 : 60 },
                    { top: 70, left: team === 'teamA' ? 40 : 60 },
                    { top: 90, left: team === 'teamA' ? 40 : 60 },
                    // Forwards
                    { top: 40, left: team === 'teamA' ? 70 : 30 },
                    { top: 80, left: team === 'teamA' ? 70 : 30 }
                ],
                '4-3-3': [
                    // Goalkeeper
                    { top: 10, left: team === 'teamA' ? 10 : 90 },
                    // Defenders
                    { top: 30, left: team === 'teamA' ? 20 : 80 },
                    { top: 50, left: team === 'teamA' ? 20 : 80 },
                    { top: 70, left: team === 'teamA' ? 20 : 80 },
                    { top: 90, left: team === 'teamA' ? 20 : 80 },
                    // Midfielders
                    { top: 40, left: team === 'teamA' ? 50 : 50 },
                    { top: 60, left: team === 'teamA' ? 50 : 50 },
                    { top: 80, left: team === 'teamA' ? 50 : 50 },
                    // Forwards
                    { top: 30, left: team === 'teamA' ? 80 : 20 },
                    { top: 60, left: team === 'teamA' ? 80 : 20 },
                    { top: 90, left: team === 'teamA' ? 80 : 20 }
                ],
                '3-5-2': [
                    // Goalkeeper
                    { top: 10, left: team === 'teamA' ? 10 : 90 },
                    // Defenders
                    { top: 40, left: team === 'teamA' ? 20 : 80 },
                    { top: 60, left: team === 'teamA' ? 20 : 80 },
                    { top: 80, left: team === 'teamA' ? 20 : 80 },
                    // Midfielders
                    { top: 20, left: team === 'teamA' ? 40 : 60 },
                    { top: 40, left: team === 'teamA' ? 40 : 60 },
                    { top: 60, left: team === 'teamA' ? 40 : 60 },
                    { top: 80, left: team === 'teamA' ? 40 : 60 },
                    { top: 100, left: team === 'teamA' ? 40 : 60 },
                    // Forwards
                    { top: 40, left: team === 'teamA' ? 70 : 30 },
                    { top: 80, left: team === 'teamA' ? 70 : 30 }
                ]
            };
            
            return formations[formation] || formations['4-4-2'];
        }
        
        // Add a player to the pitch
        function addPlayerToPitch(playerId, top, left, team, jerseyNumber) {
            const pitch = document.getElementById('match-pitch');
            if (!pitch) return;
            
            const playerElement = document.createElement('div');
            playerElement.id = `player-${playerId}`;
            playerElement.className = `player-icon absolute w-6 h-6 rounded-full flex items-center justify-center text-xs font-bold transition-all duration-300 ease-out ${team === 'teamA' ? 'bg-blue-500 text-white' : 'bg-red-500 text-white'} ${team}`;
            playerElement.style.top = `${top}%`;
            playerElement.style.left = `${left}%`;
            playerElement.innerHTML = `<span class="player-jersey-number">${jerseyNumber}</span>`;
            playerElement.dataset.jerseyNumber = jerseyNumber;
            playerElement.dataset.team = team;
            
            pitch.appendChild(playerElement);
        }
        
        // Highlight a player
        function highlightPlayer(playerId) {
            const playerElement = document.getElementById(`player-${playerId}`);
            if (playerElement) {
                playerElement.classList.add('ring-4', 'ring-yellow-400', 'scale-125');
                setTimeout(() => {
                    playerElement.classList.remove('ring-4', 'ring-yellow-400', 'scale-125');
                }, 1000);
            }
        }
        
        // Move a player to a new position
        function movePlayer(playerId, top, left) {
            const playerElement = document.getElementById(`player-${playerId}`);
            if (playerElement) {
                playerElement.style.top = `${top}%`;
                playerElement.style.left = `${left}%`;
            }
        }
        
        // Move the ball
        function moveBall(top, left) {
            const ballElement = document.getElementById('match-ball');
            if (ballElement) {
                console.log(`Moving ball to ${top}%, ${left}%`);
                ballElement.style.top = `${top}%`;
                ballElement.style.left = `${left}%`;
            }
        }
        
        // Create a shot effect
        function createShotEffect(startTop, startLeft, endTop, endLeft) {
            const pitch = document.getElementById('match-pitch');
            if (!pitch) return;
            
            // Create shot trail
            const shotTrail = document.createElement('div');
            shotTrail.className = 'shot-trail';
            shotTrail.style.width = '4px';
            shotTrail.style.height = '4px';
            shotTrail.style.top = `${startTop}%`;
            shotTrail.style.left = `${startLeft}%`;
            shotTrail.style.transition = 'all 0.5s ease-out';
            
            pitch.appendChild(shotTrail);
            
            // Animate the shot
            setTimeout(() => {
                shotTrail.style.top = `${endTop}%`;
                shotTrail.style.left = `${endLeft}%`;
                shotTrail.style.opacity = '0';
                shotTrail.style.width = '2px';
                shotTrail.style.height = '2px';
            }, 10);
            
            // Remove trail after animation
            setTimeout(() => {
                if (shotTrail.parentNode) {
                    shotTrail.parentNode.removeChild(shotTrail);
                }
            }, 500);
        }
        
        async function runMatchSimulation(matchId, initialMatchData, teamA_Players, teamB_Players){
            if (!currentUserData) return;
            if(matchSimulationInterval) clearInterval(matchSimulationInterval);
            playMatchMusic(); 
            await update(ref(db, `matches/${matchId}`), { status: 'ongoing', startTime: serverTimestamp() });
            
            // Reset match stats with initial scores
            matchStats = {
                time: 0,
                teamA: {
                    score: initialMatchData.score.teamA || 0,
                    possession: 0,
                    shots: 0,
                    shotsOnTarget: 0,
                    corners: 0,
                    fouls: 0,
                    yellowCards: 0,
                    redCards: 0
                },
                teamB: {
                    score: initialMatchData.score.teamB || 0,
                    possession: 0,
                    shots: 0,
                    shotsOnTarget: 0,
                    corners: 0,
                    fouls: 0,
                    yellowCards: 0,
                    redCards: 0
                }
            };
            
            // Initialize stats UI
            updateMatchStatsUI();
            
            // Initialize pitch visualization
            initializePitchVisualization(initialMatchData);
            
            let seconds = 0;
            const matchDuration = 90; const attackBonus = 0.2; const defenseBonus = 0.2;
            function getOffenseModifier(s) { if(s==='Attack')return 1+attackBonus; if(s==='Defense')return 1-attackBonus; return 1.0; }
            function getDefenseModifier(s) { if(s==='Defense')return 1+defenseBonus; if(s==='Attack')return 1-defenseBonus; return 1.0; }

            matchSimulationInterval = setInterval(async () => {
                seconds += 1;
                matchStats.time = seconds;
                
                // Update possession based on team strategies and power
                const teamAPower = matchData.teamA.teamPower || 50;
                const teamBPower = matchData.teamB.teamPower || 50;
                const totalPower = teamAPower + teamBPower;
                
                // Team A possession chance based on relative power
                const teamAPossessionChance = teamAPower / totalPower;
                
                if (Math.random() < teamAPossessionChance) {
                    matchStats.teamA.possession++;
                } else {
                    matchStats.teamB.possession++;
                }
                
                // Occasionally track fouls and cards during regular play (1% chance per second)
                if (Math.random() < 0.01) {
                    // 70% chance it's a foul on team A, 30% on team B
                    if (Math.random() < 0.7) {
                        matchStats.teamA.fouls++;
                        // 10% chance of yellow card, 2% chance of red card
                        if (Math.random() < 0.1) {
                            matchStats.teamA.yellowCards++;
                        } else if (Math.random() < 0.02) {
                            matchStats.teamA.redCards++;
                        }
                    } else {
                        matchStats.teamB.fouls++;
                        // 10% chance of yellow card, 2% chance of red card
                        if (Math.random() < 0.1) {
                            matchStats.teamB.yellowCards++;
                        } else if (Math.random() < 0.02) {
                            matchStats.teamB.redCards++;
                        }
                    }
                }
                
                // Update UI with current stats
                updateMatchStatsUI();
                
                const matchSnapshot = await get(ref(db, `matches/${matchId}`));
                if (!matchSnapshot.exists()) { clearInterval(matchSimulationInterval); return; }
                matchData = matchSnapshot.val(); // Use var to make it accessible in the possession calculation
                let scoreUpdated = false;

                if (seconds % 10 === 0 && seconds <= matchDuration) {
                    const pA = matchData.teamA.teamPower, pB = matchData.teamB.teamPower;
                    const totalP = pA + pB; const baseC = 0.45; let eventText = "";
                    const sA = matchData.teamAStrategy || 'Balanced', sB = matchData.teamBStrategy || 'Balanced';
                    const offA = (pA / totalP) * baseC * getOffenseModifier(sA);
                    
                    // Visual: Move ball to random position to simulate play
                    moveBall(30 + Math.random() * 40, 20 + Math.random() * 60);
                    
                    if (Math.random() < offA) {
                        const defB = (pB / totalP) * getDefenseModifier(sB);
                        if(Math.random() > defB){
                            matchData.score.teamA++; scoreUpdated = true;
                            matchStats.teamA.score = matchData.score.teamA;
                            matchStats.teamA.shots++;
                            matchStats.teamA.shotsOnTarget++;
                            
                            // 20% chance of corner kick
                            if (Math.random() < 0.2) {
                                matchStats.teamA.corners++;
                                eventText += " Corner for " + matchData.teamA.clubName + ".";
                            }
                            
                            const scorer = (teamA_Players && teamA_Players.length > 0) ? getRandomItem(teamA_Players) : matchData.teamA.clubName;
                            const otherPlayer = (teamA_Players && teamA_Players.length > 0) ? getRandomItem(teamA_Players.filter(p => p !== scorer)) : matchData.teamA.clubName;
                            eventText = getRandomCommentary('goal', matchData.teamA.clubName, scorer, otherPlayer);
                            
                            // Visual updates for goal
                            if (scorer && typeof scorer === 'string') {
                                // Highlight the scorer
                                const scorerElement = Array.from(document.querySelectorAll('.player-icon')).find(el => 
                                    el.dataset.team === 'teamA' && 
                                    Array.from(el.parentNode.children).indexOf(el) < 11
                                );
                                if (scorerElement) {
                                    scorerElement.classList.add('ring-4', 'ring-yellow-400', 'scale-150');
                                    setTimeout(() => {
                                        scorerElement.classList.remove('ring-4', 'ring-yellow-400', 'scale-150');
                                    }, 2000);
                                }
                            }
                            
                            // Move ball to goal area
                            moveBall(5, matchData.teamA.uid === currentUserData.uid ? 95 : 5);
                            
                            // Create shot effect
                            createShotEffect(50, 50, 5, matchData.teamA.uid === currentUserData.uid ? 95 : 5);
                        } else { 
                            matchStats.teamA.shots++;
                            matchStats.teamA.shotsOnTarget++; // Shot was on target but saved
                            matchStats.teamB.fouls++;
                            
                            const teamAPlayer = (teamA_Players && teamA_Players.length > 0) ? getRandomItem(teamA_Players) : matchData.teamA.clubName;
                            const teamBPlayer = (teamB_Players && teamB_Players.length > 0) ? getRandomItem(teamB_Players) : matchData.teamB.clubName;
                            
                            // 10% chance of yellow card, 2% chance of red card
                            if (Math.random() < 0.1) {
                                matchStats.teamB.yellowCards++;
                                eventText += " Yellow card for " + matchData.teamB.clubName + ".";
                                
                                // Visual effect for yellow card
                                const foulPlayer = Array.from(document.querySelectorAll('.player-icon.teamB')).find(el => 
                                    el.dataset.team === 'teamB' && 
                                    Array.from(el.parentNode.children).indexOf(el) < 11
                                );
                                if (foulPlayer) {
                                    foulPlayer.classList.add('ring-2', 'ring-yellow-400');
                                    setTimeout(() => {
                                        foulPlayer.classList.remove('ring-2', 'ring-yellow-400');
                                    }, 2000);
                                }
                            } else if (Math.random() < 0.02) {
                                matchStats.teamB.redCards++;
                                eventText += " Red card for " + matchData.teamB.clubName + ".";
                                
                                // Visual effect for red card
                                const foulPlayer = Array.from(document.querySelectorAll('.player-icon.teamB')).find(el => 
                                    el.dataset.team === 'teamB' && 
                                    Array.from(el.parentNode.children).indexOf(el) < 11
                                );
                                if (foulPlayer) {
                                    foulPlayer.classList.add('ring-2', 'ring-red-500');
                                    setTimeout(() => {
                                        foulPlayer.classList.remove('ring-2', 'ring-red-500');
                                    }, 2000);
                                }
                            }
                            
                            eventText = getRandomCommentary('save', matchData.teamB.clubName, teamAPlayer, teamBPlayer); 
                            
                            // Visual effect for save
                            const savePlayer = Array.from(document.querySelectorAll('.player-icon.teamB')).find(el => 
                                el.dataset.team === 'teamB' && 
                                Array.from(el.parentNode.children).indexOf(el) < 11
                            );
                            if (savePlayer) {
                                savePlayer.classList.add('ring-2', 'ring-green-400');
                                setTimeout(() => {
                                    savePlayer.classList.remove('ring-2', 'ring-green-400');
                                }, 1000);
                            } 
                        }
                    } else {
                        const offB = (pB / totalP) * baseC * getOffenseModifier(sB);
                        if(Math.random() < offB){
                            const defA = (pA / totalP) * getDefenseModifier(sA);
                            if(Math.random() > defA){
                                matchData.score.teamB++; scoreUpdated = true;
                                matchStats.teamB.score = matchData.score.teamB;
                                matchStats.teamB.shots++;
                                matchStats.teamB.shotsOnTarget++;
                                
                                // 20% chance of corner kick
                                if (Math.random() < 0.2) {
                                    matchStats.teamB.corners++;
                                    eventText += " Corner for " + matchData.teamB.clubName + ".";
                                }
                                
                                const scorer = (teamB_Players && teamB_Players.length > 0) ? getRandomItem(teamB_Players) : matchData.teamB.clubName;
                                const otherPlayer = (teamB_Players && teamB_Players.length > 0) ? getRandomItem(teamB_Players.filter(p => p !== scorer)) : matchData.teamB.clubName;
                                eventText = getRandomCommentary('goal', matchData.teamB.clubName, scorer, otherPlayer);
                                
                                // Visual updates for goal
                                if (scorer && typeof scorer === 'string') {
                                    // Highlight the scorer
                                    const scorerElement = Array.from(document.querySelectorAll('.player-icon')).find(el => 
                                        el.dataset.team === 'teamB' && 
                                        Array.from(el.parentNode.children).indexOf(el) < 11
                                    );
                                    if (scorerElement) {
                                        scorerElement.classList.add('ring-4', 'ring-yellow-400', 'scale-150');
                                        setTimeout(() => {
                                            scorerElement.classList.remove('ring-4', 'ring-yellow-400', 'scale-150');
                                        }, 2000);
                                    }
                                }
                                
                                // Move ball to goal area
                                moveBall(95, matchData.teamB.uid === currentUserData.uid ? 95 : 5);
                                
                                // Create shot effect
                                createShotEffect(50, 50, 95, matchData.teamB.uid === currentUserData.uid ? 95 : 5);
                            } else { 
                                matchStats.teamB.shots++;
                                matchStats.teamB.shotsOnTarget++; // Shot was on target but saved
                                matchStats.teamA.fouls++;
                                
                                const teamBPlayer = (teamB_Players && teamB_Players.length > 0) ? getRandomItem(teamB_Players) : matchData.teamB.clubName;
                                const teamAPlayer = (teamA_Players && teamA_Players.length > 0) ? getRandomItem(teamA_Players) : matchData.teamA.clubName;
                                
                                // 10% chance of yellow card, 2% chance of red card
                                if (Math.random() < 0.1) {
                                    matchStats.teamA.yellowCards++;
                                    eventText += " Yellow card for " + matchData.teamA.clubName + ".";
                                    
                                    // Visual effect for yellow card
                                    const foulPlayer = Array.from(document.querySelectorAll('.player-icon.teamA')).find(el => 
                                        el.dataset.team === 'teamA' && 
                                        Array.from(el.parentNode.children).indexOf(el) < 11
                                    );
                                    if (foulPlayer) {
                                        foulPlayer.classList.add('ring-2', 'ring-yellow-400');
                                        setTimeout(() => {
                                            foulPlayer.classList.remove('ring-2', 'ring-yellow-400');
                                        }, 2000);
                                    }
                                } else if (Math.random() < 0.02) {
                                    matchStats.teamA.redCards++;
                                    eventText += " Red card for " + matchData.teamA.clubName + ".";
                                    
                                    // Visual effect for red card
                                    const foulPlayer = Array.from(document.querySelectorAll('.player-icon.teamA')).find(el => 
                                        el.dataset.team === 'teamA' && 
                                        Array.from(el.parentNode.children).indexOf(el) < 11
                                    );
                                    if (foulPlayer) {
                                        foulPlayer.classList.add('ring-2', 'ring-red-500');
                                        setTimeout(() => {
                                            foulPlayer.classList.remove('ring-2', 'ring-red-500');
                                        }, 2000);
                                    }
                                }
                                
                                eventText = getRandomCommentary('save', matchData.teamA.clubName, teamBPlayer, teamAPlayer); 
                                
                                // Visual effect for save
                                const savePlayer = Array.from(document.querySelectorAll('.player-icon.teamA')).find(el => 
                                    el.dataset.team === 'teamA' && 
                                    Array.from(el.parentNode.children).indexOf(el) < 11
                                );
                                if (savePlayer) {
                                    savePlayer.classList.add('ring-2', 'ring-green-400');
                                    setTimeout(() => {
                                        savePlayer.classList.remove('ring-2', 'ring-green-400');
                                    }, 1000);
                                }
                            }
                        } else { 
                            // Midfield event
                            matchStats.teamA.shots++;
                            matchStats.teamB.shots++;
                            
                            // 30% chance of shots on target for both teams during midfield events
                            if (Math.random() < 0.3) {
                                matchStats.teamA.shotsOnTarget++;
                            }
                            if (Math.random() < 0.3) {
                                matchStats.teamB.shotsOnTarget++;
                            }
                            
                            eventText = getRandomCommentary('midfield'); 
                            
                            // Visual update for pass
                            moveBall(50, 50);
                        }
                    }
                    await push(ref(db, `matches/${matchId}/events`), { time: `${seconds}'`, text: eventText });
                    if(scoreUpdated) await update(ref(db, `matches/${matchId}/score`), matchData.score);
                    
                    // Update UI immediately after events
                    updateMatchStatsUI();
                }

                // Update match scores from Firebase data to ensure consistency
                const matchSnap = await get(ref(db, `matches/${matchId}`));
                if (matchSnap.exists()) {
                    const updatedMatchData = matchSnap.val();
                    matchStats.teamA.score = updatedMatchData.score.teamA;
                    matchStats.teamB.score = updatedMatchData.score.teamB;
                }

                if (seconds >= matchDuration) {
                    clearInterval(matchSimulationInterval);
                    if(opponentStatusListener) opponentStatusListener();
                    if(reactionListener) reactionListener();

                    let resultText = "The match ended in a draw!", winnerUid = null, loserUid = null;
                    if(matchData.score.teamA > matchData.score.teamB){
                        winnerUid = matchData.teamA.uid; loserUid = matchData.teamB.uid;
                        resultText = `${matchData.teamA.clubName} wins the match!`;
                    } else if (matchData.score.teamB > matchData.score.teamA){
                        winnerUid = matchData.teamB.uid; loserUid = matchData.teamA.uid;
                        resultText = `${matchData.teamB.clubName} wins the match!`;
                    }
                    
                    // Show victory/defeat screen based on match result
                    if (winnerUid === currentUserData.uid) {
                        showVictoryScreen();
                    } else if (loserUid === currentUserData.uid) {
                        showDefeatScreen();
                    }

                    await push(ref(db, `matches/${matchId}/events`), { time: 'Final', text: `üèÅ ${resultText}` });
                    await update(ref(db, `matches/${matchId}`), { status: 'completed' });
                    
                    const updates = {};
                    // For single player matches, only update the real user's stats
                    if (matchData.isSinglePlayer) {
                        if (winnerUid === matchData.teamB.uid) {
                            // User won
                            await updatePlayerStatsAfterMatch(matchData.teamB.uid, "win");
                        } else if (loserUid === matchData.teamB.uid) {
                            // User lost
                            await updatePlayerStatsAfterMatch(matchData.teamB.uid, "loss");
                        } else {
                            // Draw
                            await updatePlayerStatsAfterMatch(matchData.teamB.uid, "draw");
                        }
                    } else {
                        // For PvP matches, update both players' stats
                        if(winnerUid && loserUid){
                            await updatePlayerStatsAfterMatch(winnerUid, "win");
                            await updatePlayerStatsAfterMatch(loserUid, "loss");
                        } else { // Draw
                            await updatePlayerStatsAfterMatch(matchData.teamA.uid, "draw");
                            await updatePlayerStatsAfterMatch(matchData.teamB.uid, "draw");
                        }
                    }
                    
                    // Save match data to match history for both players
                    const matchHistoryData = {
                        id: matchId,
                        opponent: matchData.teamA.uid === currentUserData.uid ? matchData.teamB.clubName : matchData.teamA.clubName,
                        result: winnerUid === currentUserData.uid ? 'win' : (loserUid === currentUserData.uid ? 'loss' : 'draw'),
                        score: `${matchData.score.teamA}-${matchData.score.teamB}`,
                        date: new Date().toISOString(),
                        goals: [] // In a real implementation, you would track actual goals
                    };
                    
                    // Save to both players' match history
                    if (!matchData.isSinglePlayer) {
                        // For PvP matches, save to both players
                        updates[`/users/${matchData.teamA.uid}/matchHistory/${matchId}`] = matchHistoryData;
                        
                        // Create a separate match history entry for teamB with reversed score
                        const teamBMatchHistoryData = {...matchHistoryData};
                        teamBMatchHistoryData.opponent = matchData.teamA.clubName;
                        teamBMatchHistoryData.result = winnerUid === matchData.teamB.uid ? 'win' : (loserUid === matchData.teamB.uid ? 'loss' : 'draw');
                        teamBMatchHistoryData.score = `${matchData.score.teamB}-${matchData.score.teamA}`;
                        updates[`/users/${matchData.teamB.uid}/matchHistory/${matchId}`] = teamBMatchHistoryData;
                    } else {
                        // For single player matches, only save to the real user
                        updates[`/users/${matchData.teamB.uid}/matchHistory/${matchId}`] = matchHistoryData;
                    }
                    
                    if(winnerUid) {
                         const winnerSnap = await get(ref(db, `users/${winnerUid}`));
                         if(winnerSnap.exists()) { const d = winnerSnap.val(); updates[`/users/${winnerUid}/points`] = (d.points||0)+10; updates[`/users/${winnerUid}/wins`]=(d.wins||0)+1; updates[`/users/${winnerUid}/balance`]=(d.balance||0)+500; }
                    }
                    if(loserUid) {
                         const loserSnap = await get(ref(db, `users/${loserUid}`));
                         if(loserSnap.exists()) { const d = loserSnap.val(); updates[`/users/${loserUid}/balance`]=(d.balance||0)+100; }
                    }
                    
                    updates[`/users/${matchData.teamA.uid}/currentMatch`] = null;
                    updates[`/users/${matchData.teamB.uid}/currentMatch`] = null;
                    updates[`/matches/${matchId}`] = null;
                    
                    await update(ref(db), updates);
                    pauseMatchMusic(); playMainMenuMusic(); 
                }
            }, 1000);
        }
        
        const chatForm = document.getElementById('chat-form');
        const chatInput = document.getElementById('chat-input');
        const chatMessages = document.getElementById('chat-messages');

        if (chatForm) {
            chatForm.addEventListener('submit', async (e) => {
                e.preventDefault();
                if (!currentUserData || !chatInput.value.trim()) return;
                const messageText = chatInput.value.trim();
                chatInput.value = '';
                try { await push(ref(db, 'globalChat'), { uid: currentUserData.uid, clubName: currentUserData.clubName, message: messageText, timestamp: serverTimestamp() }); } 
                catch (error) { showModal("Failed to send message: " + error.message); }
            });
        }

        let chatListener = null;
        function loadChatMessages() {
            if (chatListener) return;
            chatMessages.innerHTML = '';
            const chatRef = ref(db, 'globalChat');
            chatListener = onChildAdded(chatRef, (snapshot) => {
                const msgData = snapshot.val(); if (!msgData) return;
                const isMe = msgData.uid === currentUserData.uid;
                const alignClass = isMe ? 'message-me' : 'message-other';
                const sender = isMe ? 'You' : msgData.clubName;
                const msgEl = document.createElement('div');
                msgEl.className = `chat-message ${alignClass}`;
                msgEl.innerHTML = `<span class="font-bold">${sender}:</span> ${msgData.message}`;
                chatMessages.appendChild(msgEl);
                chatMessages.scrollTop = chatMessages.scrollHeight;
            });
        }
        
        // --- SEASON PASS LOGIC ---
        const missionsTab = document.getElementById('missions-tab');
        const rewardsTab = document.getElementById('rewards-tab');
        const missionsContent = document.getElementById('missions-content');
        const rewardsContent = document.getElementById('rewards-content');

        missionsTab.addEventListener('click', () => {
            missionsTab.classList.add('active');
            rewardsTab.classList.remove('active');
            missionsContent.classList.remove('hidden');
            rewardsContent.classList.add('hidden');
        });

        rewardsTab.addEventListener('click', () => {
            rewardsTab.classList.add('active');
            missionsTab.classList.remove('active');
            rewardsContent.classList.remove('hidden');
            missionsContent.classList.add('hidden');
        });

        async function loadSeasonPassData() {
            if (!currentUserData) return;

            const sp = currentUserData.seasonPass || { level: 1, xp: 0, premium: false };
            const seasonConfigSnap = await get(ref(db, 'seasonPass/config'));
            if (!seasonConfigSnap.exists()) return;
            const config = seasonConfigSnap.val();
            
            // Update UI
            document.getElementById('sp-current-level').textContent = sp.level;
            document.getElementById('sp-current-xp').textContent = sp.xp;
            document.getElementById('sp-needed-xp').textContent = config.xpPerLevel || 100;
            const progressPercentage = (sp.xp / (config.xpPerLevel || 100)) * 100;
            document.getElementById('season-pass-progress-fill').style.width = `${progressPercentage}%`;
            
            if (sp.premium) {
                buyPremiumPassBtn.textContent = 'Premium Activated';
                buyPremiumPassBtn.disabled = true;
            } else {
                buyPremiumPassBtn.textContent = 'Premium Pass (99 BDT)';
                buyPremiumPassBtn.disabled = false;
            }

            // Load Missions
            loadMissions(config.missions);
            // Load Rewards
            loadRewards(config.rewards, sp);
        }

        function loadMissions(missions) {
            const dailyList = document.getElementById('daily-missions-list');
            const weeklyList = document.getElementById('weekly-missions-list');
            const seasonalList = document.getElementById('seasonal-missions-list');
            dailyList.innerHTML = weeklyList.innerHTML = seasonalList.innerHTML = ''; // Clear lists

            // Get user's mission progress
            const userMissions = currentUserData.missions || {};

            for(const missionId in missions) {
                const mission = missions[missionId];
                const userMission = userMissions[missionId] || { progress: 0, completed: false };
                
                // Check if mission is completed
                const isCompleted = userMission.completed;
                const canClaim = !isCompleted && userMission.progress >= mission.target;
                
                let buttonHtml;
                if (isCompleted) {
                    buttonHtml = `<button class="py-2 px-4 bg-gray-600 text-white font-bold rounded-md cursor-not-allowed" disabled>Completed</button>`;
                } else if (canClaim) {
                    buttonHtml = `<button class="claim-mission-btn py-2 px-4 bg-green-600 hover:bg-green-700 text-white font-bold rounded-md interactive-button" data-mission="${missionId}">Claim</button>`;
                } else {
                    buttonHtml = `<button class="py-2 px-4 bg-gray-600 text-white font-bold rounded-md cursor-not-allowed" disabled>Claim</button>`;
                }
                
                const progressText = isCompleted ? 'Completed' : `${userMission.progress} / ${mission.target}`;
                
                const missionHtml = `<div class="mission-card p-4 flex justify-between items-center">
                    <div>
                        <p class="font-semibold text-white">${mission.description}</p>
                        <p class="text-sm text-gray-400">Progress: ${progressText}</p>
                        <p class="text-sm text-gray-400">Reward: ${mission.xpReward} XP</p>
                    </div>
                    ${buttonHtml}
                </div>`;

                if (mission.type === 'daily') dailyList.innerHTML += missionHtml;
                else if (mission.type === 'weekly') weeklyList.innerHTML += missionHtml;
                else if (mission.type === 'seasonal') seasonalList.innerHTML += missionHtml;
            }
             if(!dailyList.innerHTML) dailyList.innerHTML = `<p class="text-gray-500 text-center">No daily missions available.</p>`;
             if(!weeklyList.innerHTML) weeklyList.innerHTML = `<p class="text-gray-500 text-center">No weekly missions available.</p>`;
             if(!seasonalList.innerHTML) seasonalList.innerHTML = `<p class="text-gray-500 text-center">No seasonal missions available.</p>`;
             
             // Add event listeners to claim buttons
             document.querySelectorAll('.claim-mission-btn').forEach(button => {
                 button.addEventListener('click', async (e) => {
                     const missionId = e.target.getAttribute('data-mission');
                     await claimMissionReward(missionId);
                 });
             });
        }
        
        // Add function to claim mission rewards
        async function claimMissionReward(missionId) {
            if (!currentUserData) return;
            
            try {
                // Get mission config
                const seasonConfigSnap = await get(ref(db, 'seasonPass/config'));
                if (!seasonConfigSnap.exists()) {
                    showModal("Failed to load mission data.");
                    return;
                }
                
                const config = seasonConfigSnap.val();
                const mission = config.missions[missionId];
                
                if (!mission) {
                    showModal("Mission not found.");
                    return;
                }
                
                // Get user's current mission progress
                const userMissions = currentUserData.missions || {};
                const userMission = userMissions[missionId] || { progress: 0, completed: false };
                
                // Check if mission can be claimed
                if (userMission.completed) {
                    showModal("Mission already completed.");
                    return;
                }
                
                if (userMission.progress < mission.target) {
                    showModal(`Mission not completed yet. Progress: ${userMission.progress}/${mission.target}`);
                    return;
                }
                
                // Mark mission as completed and award rewards
                userMissions[missionId] = { progress: userMission.progress, completed: true };
                
                // Update season pass XP
                const sp = currentUserData.seasonPass || { level: 1, xp: 0, premium: false };
                sp.xp += mission.xpReward;
                
                // Update user data
                await update(ref(db, 'users/' + currentUserData.uid), {
                    missions: userMissions,
                    seasonPass: sp
                });
                
                showModal(`Mission completed! You earned ${mission.xpReward} XP.`);
                loadSeasonPassData(); // Refresh the display
            } catch (error) {
                console.error("Error claiming mission reward:", error);
                showModal("Failed to claim mission reward: " + error.message);
            }
        }
        
        // Add function to track mission progress
        async function trackMissionProgress(missionId, increment = 1) {
            if (!currentUserData) return;
            
            try {
                // Get user's current mission progress
                const userMissions = currentUserData.missions || {};
                const userMission = userMissions[missionId] || { progress: 0, completed: false };
                
                // Skip if already completed
                if (userMission.completed) return;
                
                // Increment progress
                userMission.progress += increment;
                
                // Update in database
                const updates = {};
                updates[`missions/${missionId}`] = userMission;
                await update(ref(db, 'users/' + currentUserData.uid), updates);
                
                // Update in memory
                if (!currentUserData.missions) currentUserData.missions = {};
                currentUserData.missions[missionId] = userMission;
            } catch (error) {
                console.error("Error tracking mission progress:", error);
            }
        }
        
        // Add function to track match-related missions
        function trackMatchMissions(result) {
            if (!currentUserData) return;
            
            // Track PvP match missions
            trackMissionProgress('weekly_win_5', result === 'win' ? 1 : 0);
            trackMissionProgress('weekly_play_10', 1);
            
            // Track seasonal missions based on result
            if (result === 'win') {
                trackMissionProgress('seasonal_win_20', 1);
            }
        }
        
        // Add function to track purchase missions
        function trackPurchaseMissions() {
            if (!currentUserData) return;
            
            // Track purchase-related missions
            trackMissionProgress('daily_spend_1000', 1); // This would need to be called with actual amount
            trackMissionProgress('weekly_open_5_packs', 1);
        }
        
        function loadRewards(rewards, userSP) {
            const rewardsList = document.getElementById('rewards-track-list');
            rewardsList.innerHTML = '';
            
            for(const level in rewards) {
                const levelRewards = rewards[level];
                
                const freeRewardHtml = levelRewards.free ? `<div class="reward-item p-3 w-1/2 text-center ${userSP.level >= level ? 'border-green-400' : 'border-gray-600 opacity-60'}">
                    <p class="font-bold">${levelRewards.free.name}</p><p class="text-sm text-gray-300">Free</p>
                    </div>` : `<div class="w-1/2 p-3 text-center text-gray-600">--</div>`;
                
                const premiumRewardHtml = levelRewards.premium ? `<div class="reward-item p-3 w-1/2 text-center ${userSP.premium ? (userSP.level >= level ? 'border-purple-400' : 'border-gray-600 opacity-60') : 'border-gray-600 opacity-40'}">
                    <p class="font-bold text-purple-300">${levelRewards.premium.name}</p><p class="text-sm text-purple-400">Premium</p>
                    </div>` : `<div class="w-1/2 p-3 text-center text-gray-600">--</div>`;

                rewardsList.innerHTML += `
                    <div class="flex items-center gap-4">
                        <div class="w-16 h-16 flex items-center justify-center bg-gray-800 rounded-full font-bold text-xl ${userSP.level >= level ? 'text-purple-400 border-2 border-purple-400' : 'text-gray-500'}">
                           ${level}
                        </div>
                        <div class="flex-grow flex gap-2">
                           ${freeRewardHtml}
                           ${premiumRewardHtml}
                        </div>
                    </div>`;
            }
        }

        buyPremiumPassBtn.addEventListener('click', () => {
            paymentModal.classList.remove('hidden');
        });
        paymentCloseBtn.addEventListener('click', () => {
            paymentModal.classList.add('hidden');
        });
        paymentForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            if (!currentUserData) return showModal("User data not loaded.");
            
            const tnxIdInput = document.getElementById('transaction-id-input');
            const tnxId = tnxIdInput.value.trim();
            if (!tnxId) return showModal("Please enter a valid Transaction ID.");

            const transactionData = {
                transactionId: tnxId,
                userId: currentUserData.uid,
                clubName: currentUserData.clubName,
                amount: 99,
                timestamp: serverTimestamp(),
                status: 'pending_verification' // Status for manual check
            };
            
            try {
                await push(ref(db, 'premiumPassTransactions'), transactionData);
                tnxIdInput.value = '';
                paymentModal.classList.add('hidden');
                showModal('Transaction submitted! Your premium pass will be activated after manual verification. Thank you!');
            } catch (error) {
                showModal("Failed to submit transaction: " + error.message);
            }
        });
        
        // --- EMOJI REACTION LOGIC ---
        const emojiToggleBtn = document.getElementById('emoji-toggle-btn');
        const emojiPanel = document.getElementById('emoji-panel');
        const emojis = document.querySelectorAll('.emoji');
        const reactionDisplayArea = document.getElementById('reaction-display-area');

        emojiToggleBtn.addEventListener('click', () => {
            emojiPanel.classList.toggle('hidden');
        });

        emojis.forEach(emoji => {
            emoji.addEventListener('click', async () => {
                if (!currentMatchId || !currentUserData) return;
                const emojiToSend = emoji.getAttribute('data-emoji');
                
                displayReaction(emojiToSend); // Show locally immediately
                emojiPanel.classList.add('hidden');
                
                // Send to opponent
                const reactionRef = ref(db, `matches/${currentMatchId}/reactions`);
                await push(reactionRef, { emoji: emojiToSend, senderId: currentUserData.uid });
            });
        });

        function displayReaction(emoji) {
            const reactionEl = document.createElement('div');
            reactionEl.className = 'reaction-display';
            reactionEl.textContent = emoji;
            reactionDisplayArea.appendChild(reactionEl);
            
            // Clean up the element after the animation
            setTimeout(() => {
                reactionEl.remove();
            }, 2000);
        }
        
        // Set up in-match chat
        function setupInMatchChat(matchId) {
            // Show the chat panel
            document.getElementById('in-match-chat').classList.remove('hidden');
            
            // Set up chat form submission
            const chatForm = document.getElementById('in-match-chat-form');
            const chatInput = document.getElementById('in-match-chat-input');
            const chatMessages = document.getElementById('in-match-chat-messages');
            
            // Clear previous chat messages
            chatMessages.innerHTML = '';
            
            if (chatForm) {
                chatForm.addEventListener('submit', async (e) => {
                    e.preventDefault();
                    if (!currentUserData || !chatInput.value.trim()) return;
                    
                    const messageText = chatInput.value.trim();
                    chatInput.value = '';
                    
                    try {
                        // Send message to match chat
                        await push(ref(db, `matches/${matchId}/chat`), { 
                            uid: currentUserData.uid, 
                            clubName: currentUserData.clubName, 
                            message: messageText, 
                            timestamp: serverTimestamp() 
                        });
                    } catch (error) {
                        console.error("Failed to send message: " + error.message);
                    }
                });
            }
            
            // Listen for new chat messages
            const chatRef = ref(db, `matches/${matchId}/chat`);
            onChildAdded(chatRef, (snapshot) => {
                const msgData = snapshot.val();
                if (!msgData) return;
                
                const isMe = msgData.uid === currentUserData.uid;
                const alignClass = isMe ? 'text-green-400' : 'text-blue-400';
                const sender = isMe ? 'You' : msgData.clubName;
                
                const msgEl = document.createElement('div');
                msgEl.className = `mb-2 text-sm ${alignClass}`;
                msgEl.innerHTML = `<span class="font-bold">${sender}:</span> ${msgData.message}`;
                chatMessages.appendChild(msgEl);
                chatMessages.scrollTop = chatMessages.scrollHeight;
            });
            
            // Set up chat toggle button
            const toggleChatBtn = document.getElementById('toggle-chat-btn');
            const chatMessagesContainer = document.getElementById('in-match-chat-messages');
            const chatFormContainer = document.getElementById('in-match-chat-form').closest('div');
            
            toggleChatBtn.addEventListener('click', () => {
                const icon = toggleChatBtn.querySelector('i');
                if (chatMessagesContainer.classList.contains('hidden')) {
                    chatMessagesContainer.classList.remove('hidden');
                    chatFormContainer.classList.remove('hidden');
                    icon.className = 'fas fa-chevron-up';
                } else {
                    chatMessagesContainer.classList.add('hidden');
                    chatFormContainer.classList.add('hidden');
                    icon.className = 'fas fa-chevron-down';
                }
            });
        }

        // --- NEW FEATURES IMPLEMENTATION ---

        // Training System
        trainingBtn.addEventListener('click', () => {
            if (!currentUserData) return;
            openTrainingModal();
        });

        trainingCloseBtn.addEventListener('click', () => {
            trainingModal.classList.add('hidden');
        });

        async function openTrainingModal() {
            if (!currentUserData || !currentUserData.squad) return;
            
            const trainingPoints = currentUserData.trainingPoints || 0;
            document.getElementById('training-points').textContent = trainingPoints;
            
            const playerList = document.getElementById('training-player-list');
            playerList.innerHTML = '';
            
            const playerPromises = currentUserData.squad.map(playerId => get(ref(db, 'players/' + playerId)));
            const playerSnapshots = await Promise.all(playerPromises);
            
            playerSnapshots.forEach((playerSnap, index) => {
                if (playerSnap.exists()) {
                    const playerData = playerSnap.val();
                    const playerId = currentUserData.squad[index];
                    const attributes = playerData.attributes || { pace: 50, shooting: 50, passing: 50, dribbling: 50, defending: 50, physical: 50 };
                    
                    playerList.innerHTML += `
                        <div class="player-card p-4 flex flex-col md:flex-row justify-between items-center">
                            <div class="flex items-center mb-4 md:mb-0">
                                <img src="${playerData.imageUrl}" alt="${playerData.name}" class="w-16 h-16 object-cover rounded-full mr-4 border-2 border-gray-600">
                                <div>
                                    <h4 class="font-bold text-lg text-white">${playerData.name}</h4>
                                    <p class="text-sm text-gray-400">${playerData.position}</p>
                                </div>
                            </div>
                            <div class="grid grid-cols-2 md:grid-cols-3 gap-2 w-full md:w-auto">
                                <div class="text-center">
                                    <div class="text-xs text-gray-400">Pace</div>
                                    <div class="attribute-bar"><div class="attribute-fill pace-fill" style="width: ${attributes.pace}%"></div></div>
                                    <button class="train-btn mt-1 px-2 py-1 bg-blue-600 hover:bg-blue-700 text-white text-xs rounded disabled:bg-gray-600 disabled:cursor-not-allowed" data-player="${playerId}" data-attribute="pace" ${trainingPoints < 1 ? 'disabled' : ''}>+</button>
                                </div>
                                <div class="text-center">
                                    <div class="text-xs text-gray-400">Shooting</div>
                                    <div class="attribute-bar"><div class="attribute-fill shooting-fill" style="width: ${attributes.shooting}%"></div></div>
                                    <button class="train-btn mt-1 px-2 py-1 bg-red-600 hover:bg-red-700 text-white text-xs rounded disabled:bg-gray-600 disabled:cursor-not-allowed" data-player="${playerId}" data-attribute="shooting" ${trainingPoints < 1 ? 'disabled' : ''}>+</button>
                                </div>
                                <div class="text-center">
                                    <div class="text-xs text-gray-400">Passing</div>
                                    <div class="attribute-bar"><div class="attribute-fill passing-fill" style="width: ${attributes.passing}%"></div></div>
                                    <button class="train-btn mt-1 px-2 py-1 bg-blue-600 hover:bg-blue-700 text-white text-xs rounded disabled:bg-gray-600 disabled:cursor-not-allowed" data-player="${playerId}" data-attribute="passing" ${trainingPoints < 1 ? 'disabled' : ''}>+</button>
                                </div>
                            </div>
                        </div>`;
                }
            });
            
            // Add event listeners to training buttons
            document.querySelectorAll('.train-btn').forEach(button => {
                button.addEventListener('click', async (e) => {
                    const playerId = e.target.getAttribute('data-player');
                    const attribute = e.target.getAttribute('data-attribute');
                    await trainPlayer(playerId, attribute);
                });
            });
            
            trainingModal.classList.remove('hidden');
        }

        async function trainPlayer(playerId, attribute) {
            if (!currentUserData) return;
            
            const trainingPoints = currentUserData.trainingPoints || 0;
            if (trainingPoints < 1) {
                showModal("You don't have enough training points!");
                return;
            }
            
            // Get player data
            const playerRef = ref(db, 'players/' + playerId);
            const playerSnap = await get(playerRef);
            if (!playerSnap.exists()) return;
            
            const playerData = playerSnap.val();
            const attributes = playerData.attributes || { pace: 50, shooting: 50, passing: 50, dribbling: 50, defending: 50, physical: 50 };
            
            // Increase attribute (max 99)
            if (attributes[attribute] < 99) {
                attributes[attribute] += 1;
                
                // Update player and user data
                await update(playerRef, { attributes: attributes });
                await update(ref(db, 'users/' + currentUserData.uid), { 
                    trainingPoints: trainingPoints - 1 
                });
                
                showModal(`${playerData.name}'s ${attribute} increased to ${attributes[attribute]}!`);
                openTrainingModal(); // Refresh the modal
            } else {
                showModal(`${playerData.name}'s ${attribute} is already at maximum!`);
            }
        }

        // Formation System
        formationBtn.addEventListener('click', () => {
            if (!currentUserData) return;
            openFormationModal();
        });

        formationCloseBtn.addEventListener('click', () => {
            formationModal.classList.add('hidden');
        });

        formationCancelBtn.addEventListener('click', () => {
            formationModal.classList.add('hidden');
        });

        formationSaveBtn.addEventListener('click', async () => {
            const selectedFormation = document.querySelector('.formation-option.selected');
            if (!selectedFormation) {
                showModal("Please select a formation!");
                return;
            }
            
            const formation = selectedFormation.getAttribute('data-formation');
            await update(ref(db, 'users/' + currentUserData.uid), { formation: formation });
            showModal(`Formation changed to ${formation}!`);
            formationModal.classList.add('hidden');
        });

        function openFormationModal() {
            // Set current formation as selected
            const currentFormation = currentUserData.formation || "4-4-2";
            document.querySelectorAll('.formation-option').forEach(option => {
                option.classList.remove('selected');
                if (option.getAttribute('data-formation') === currentFormation) {
                    option.classList.add('selected');
                }
            });
            
            // Calculate team chemistry
            calculateTeamChemistry();
            
            formationModal.classList.remove('hidden');
        }

        // Add event listeners to formation options
        document.querySelectorAll('.formation-option').forEach(option => {
            option.addEventListener('click', () => {
                document.querySelectorAll('.formation-option').forEach(opt => opt.classList.remove('selected'));
                option.classList.add('selected');
                calculateTeamChemistry();
            });
        });

        async function calculateTeamChemistry() {
            if (!currentUserData || !currentUserData.squad) return;
            
            let chemistry = 0;
            const playerPromises = currentUserData.squad.map(playerId => get(ref(db, 'players/' + playerId)));
            const playerSnapshots = await Promise.all(playerPromises);
            
            // Simple chemistry calculation based on player positions matching formation requirements
            // In a real game, this would be more complex
            playerSnapshots.forEach(playerSnap => {
                if (playerSnap.exists()) {
                    const playerData = playerSnap.val();
                    // Add some chemistry for each player (this is a simplified version)
                    chemistry += 15;
                }
            });
            
            // Cap at 100%
            chemistry = Math.min(chemistry, 100);
            
            document.getElementById('chemistry-bar').style.width = `${chemistry}%`;
            document.getElementById('chemistry-value').textContent = `${chemistry}%`;
        }

        // Advanced Tactics System
        advancedTacticsBtn.addEventListener('click', () => {
            if (!currentUserData) return;
            openAdvancedTacticsModal();
        });

        advancedTacticsCloseBtn.addEventListener('click', () => {
            advancedTacticsModal.classList.add('hidden');
        });

        advancedTacticsCancelBtn.addEventListener('click', () => {
            advancedTacticsModal.classList.add('hidden');
        });

        advancedTacticsSaveBtn.addEventListener('click', async () => {
            const selectedTactic = document.querySelector('.tactic-option.selected');
            if (!selectedTactic) {
                showModal("Please select a tactic!");
                return;
            }
            
            const tactic = selectedTactic.getAttribute('data-tactic');
            await update(ref(db, 'users/' + currentUserData.uid), { advancedTactics: tactic });
            showModal(`Advanced tactics changed to ${tactic}!`);
            advancedTacticsModal.classList.add('hidden');
        });

        function openAdvancedTacticsModal() {
            // Set current tactic as selected
            const currentTactic = currentUserData.advancedTactics || "Balanced";
            document.querySelectorAll('.tactic-option').forEach(option => {
                option.classList.remove('selected');
                if (option.getAttribute('data-tactic') === currentTactic) {
                    option.classList.add('selected');
                }
            });
            
            advancedTacticsModal.classList.remove('hidden');
        }

        // Add event listeners to tactic options
        document.querySelectorAll('.tactic-option').forEach(option => {
            option.addEventListener('click', () => {
                document.querySelectorAll('.tactic-option').forEach(opt => opt.classList.remove('selected'));
                option.classList.add('selected');
            });
        });

        // Club Facilities System
        facilitiesBtn.addEventListener('click', () => {
            if (!currentUserData) return;
            openFacilitiesModal();
        });

        facilitiesCloseBtn.addEventListener('click', () => {
            facilitiesModal.classList.add('hidden');
        });

        facilitiesCloseBtn2.addEventListener('click', () => {
            facilitiesModal.classList.add('hidden');
        });

        function openFacilitiesModal() {
            const facilities = currentUserData.clubFacilities || {
                stadium: { level: 1 },
                trainingGround: { level: 1 },
                youthAcademy: { level: 1 }
            };
            
            document.getElementById('stadium-level').textContent = facilities.stadium.level;
            document.getElementById('training-ground-level').textContent = facilities.trainingGround.level;
            document.getElementById('youth-academy-level').textContent = facilities.youthAcademy.level;
            
            // Add event listeners to upgrade buttons
            document.querySelectorAll('.upgrade-facility-btn').forEach(button => {
                button.addEventListener('click', async (e) => {
                    const facility = e.target.getAttribute('data-facility');
                    await upgradeFacility(facility);
                });
            });
            
            facilitiesModal.classList.remove('hidden');
        }

        async function upgradeFacility(facility) {
            if (!currentUserData) return;
            
            const facilities = currentUserData.clubFacilities || {
                stadium: { level: 1 },
                trainingGround: { level: 1 },
                youthAcademy: { level: 1 }
            };
            
            const currentLevel = facilities[facility].level;
            const upgradeCost = getFacilityUpgradeCost(facility, currentLevel);
            
            if (currentUserData.balance < upgradeCost) {
                showModal(`You don't have enough coins to upgrade this facility. Required: ${upgradeCost} coins.`);
                return;
            }
            
            // Update facility level and deduct coins
            facilities[facility].level = currentLevel + 1;
            const newBalance = currentUserData.balance - upgradeCost;
            
            await update(ref(db, 'users/' + currentUserData.uid), {
                clubFacilities: facilities,
                balance: newBalance
            });
            
            showModal(`${facility} upgraded to level ${currentLevel + 1}!`);
            openFacilitiesModal(); // Refresh the modal
        }

        function getFacilityUpgradeCost(facility, currentLevel) {
            const baseCosts = {
                stadium: 5000,
                trainingGround: 3000,
                youthAcademy: 8000
            };
            
            return baseCosts[facility] * currentLevel;
        }

        // Sponsorship System
        sponsorshipBtn.addEventListener('click', () => {
            if (!currentUserData) return;
            openSponsorshipModal();
        });

        sponsorshipCloseBtn.addEventListener('click', () => {
            sponsorshipModal.classList.add('hidden');
        });

        sponsorshipCloseBtn2.addEventListener('click', () => {
            sponsorshipModal.classList.add('hidden');
        });

        async function openSponsorshipModal() {
            const sponsorshipList = document.getElementById('sponsorship-list');
            sponsorshipList.innerHTML = '';
            
            // Define sponsorship deals
            const sponsorshipDeals = [
                { id: 'local_sponsor', name: 'Local Sponsor', income: 500, duration: 7, requirement: 'Club Level 2' },
                { id: 'regional_sponsor', name: 'Regional Sponsor', income: 1000, duration: 7, requirement: 'Club Level 5' },
                { id: 'national_sponsor', name: 'National Sponsor', income: 2000, duration: 7, requirement: 'Club Level 10' },
                { id: 'international_sponsor', name: 'International Sponsor', income: 5000, duration: 7, requirement: 'Club Level 20' }
            ];
            
            const userSponsorships = currentUserData.sponsorshipDeals || {};
            const userLevel = currentUserData.level || 1;
            
            sponsorshipDeals.forEach(deal => {
                const isActive = userSponsorships[deal.id] && userSponsorships[deal.id].active;
                const canSign = userLevel >= parseInt(deal.requirement.split(' ')[2]);
                
                let buttonHtml;
                if (isActive) {
                    buttonHtml = `<button class="py-2 px-4 bg-gray-600 text-white font-bold rounded-md cursor-not-allowed" disabled>Active</button>`;
                } else if (canSign) {
                    buttonHtml = `<button class="sign-sponsor-btn py-2 px-4 bg-green-600 hover:bg-green-700 text-white font-bold rounded-md interactive-button" data-deal='${JSON.stringify(deal)}'>Sign Deal</button>`;
                } else {
                    buttonHtml = `<button class="py-2 px-4 bg-yellow-600 text-white font-bold rounded-md cursor-not-allowed" disabled>Requirement: ${deal.requirement}</button>`;
                }
                
                sponsorshipList.innerHTML += `
                    <div class="player-card p-4 flex justify-between items-center">
                        <div>
                            <h3 class="text-xl font-bold text-white">${deal.name}</h3>
                            <p class="text-gray-300">Weekly Income: ${deal.income} coins</p>
                            <p class="text-gray-400 text-sm">Duration: ${deal.duration} days</p>
                        </div>
                        ${buttonHtml}
                    </div>`;
            });
            
            // Add event listeners to sign buttons
            document.querySelectorAll('.sign-sponsor-btn').forEach(button => {
                button.addEventListener('click', async (e) => {
                    const deal = JSON.parse(e.target.getAttribute('data-deal'));
                    await signSponsorshipDeal(deal);
                });
            });
            
            sponsorshipModal.classList.remove('hidden');
        }

        async function signSponsorshipDeal(deal) {
            if (!currentUserData) return;
            
            const sponsorshipDeals = currentUserData.sponsorshipDeals || {};
            
            // Check if already has an active deal
            if (sponsorshipDeals[deal.id] && sponsorshipDeals[deal.id].active) {
                showModal("You already have an active sponsorship deal with this sponsor!");
                return;
            }
            
            // Add the sponsorship deal
            sponsorshipDeals[deal.id] = {
                active: true,
                signedDate: new Date().toISOString(),
                endDate: new Date(Date.now() + deal.duration * 24 * 60 * 60 * 1000).toISOString(),
                income: deal.income
            };
            
            await update(ref(db, 'users/' + currentUserData.uid), {
                sponsorshipDeals: sponsorshipDeals
            });
            
            showModal(`Successfully signed sponsorship deal with ${deal.name}! You will receive ${deal.income} coins weekly.`);
            openSponsorshipModal(); // Refresh the modal
        }

        // Kit Designer System
        kitDesignerBtn.addEventListener('click', () => {
            if (!currentUserData) return;
            openKitDesignerModal();
        });

        kitDesignerCloseBtn.addEventListener('click', () => {
            kitDesignerModal.classList.add('hidden');
        });

        kitCancelBtn.addEventListener('click', () => {
            kitDesignerModal.classList.add('hidden');
        });

        kitSaveBtn.addEventListener('click', async () => {
            const jerseyColor = document.getElementById('jersey-color').value;
            const shortsColor = document.getElementById('shorts-color').value;
            const socksColor = document.getElementById('socks-color').value;
            const kitStyle = document.getElementById('kit-style').value;
            const numberStyle = document.getElementById('number-style').value;
            const fontStyle = document.getElementById('font-style').value;
            
            await update(ref(db, 'users/' + currentUserData.uid), {
                kitDesign: {
                    jerseyColor: jerseyColor,
                    shortsColor: shortsColor,
                    socksColor: socksColor,
                    style: kitStyle,
                    numberStyle: numberStyle,
                    fontStyle: fontStyle
                }
            });
            
            showModal("Kit design saved successfully!");
            kitDesignerModal.classList.add('hidden');
        });

        function openKitDesignerModal() {
            const kitDesign = currentUserData.kitDesign || {
                jerseyColor: "#1e40af",
                shortsColor: "#1e40af",
                socksColor: "#ffffff",
                style: "plain",
                numberStyle: "plain",
                fontStyle: "default"
            };
            
            // Set current values
            document.getElementById('jersey-color').value = kitDesign.jerseyColor;
            document.getElementById('shorts-color').value = kitDesign.shortsColor;
            document.getElementById('socks-color').value = kitDesign.socksColor;
            document.getElementById('kit-style').value = kitDesign.style;
            document.getElementById('number-style').value = kitDesign.numberStyle;
            document.getElementById('font-style').value = kitDesign.fontStyle;
            
            // Update kit preview
            updateKitPreview(kitDesign.jerseyColor, kitDesign.shortsColor, kitDesign.socksColor, kitDesign.style);
            
            // Add event listeners for real-time preview
            document.getElementById('jersey-color').addEventListener('input', (e) => {
                updateKitPreview(e.target.value, document.getElementById('shorts-color').value, document.getElementById('socks-color').value, document.getElementById('kit-style').value);
            });
            
            document.getElementById('shorts-color').addEventListener('input', (e) => {
                updateKitPreview(document.getElementById('jersey-color').value, e.target.value, document.getElementById('socks-color').value, document.getElementById('kit-style').value);
            });
            
            document.getElementById('socks-color').addEventListener('input', (e) => {
                updateKitPreview(document.getElementById('jersey-color').value, document.getElementById('shorts-color').value, e.target.value, document.getElementById('kit-style').value);
            });
            
            document.getElementById('kit-style').addEventListener('change', (e) => {
                updateKitPreview(document.getElementById('jersey-color').value, document.getElementById('shorts-color').value, document.getElementById('socks-color').value, e.target.value);
            });
            
            kitDesignerModal.classList.remove('hidden');
        }
        
        // Youth Squad System
        async function openYouthSquadView() {
            // Navigate to youth squad view
            navigateToView('youth-squad-view');
            
            // Load youth players
            await loadYouthPlayers();
        }
        
        async function loadYouthPlayers() {
            const youthPlayersContainer = document.getElementById('youth-players-container');
            youthPlayersContainer.innerHTML = '<p class="text-gray-400 text-center">Loading youth players...</p>';
            
            try {
                // Get user's youth players from database
                const youthPlayersRef = ref(db, `users/${currentUserData.uid}/youthPlayers`);
                const snapshot = await get(youthPlayersRef);
                
                if (snapshot.exists()) {
                    const youthPlayers = snapshot.val();
                    let playersHtml = '';
                    
                    for (const playerId in youthPlayers) {
                        const player = youthPlayers[playerId];
                        const attributes = player.attributes || { pace: 50, shooting: 50, passing: 50, dribbling: 50, defending: 50, physical: 50 };
                        
                        // Calculate overall rating
                        const overallRating = Math.round(
                            (attributes.pace + attributes.shooting + attributes.passing + 
                             attributes.dribbling + attributes.defending + attributes.physical) / 6
                        );
                        
                        // Get training focus
                        const trainingFocus = player.trainingFocus || 'balanced';
                        
                        // Calculate training progress (0-100%)
                        const trainingProgress = player.trainingProgress || 0;
                        
                        playersHtml += `
                            <div class="player-card p-4 text-center relative" data-player-id="${playerId}">
                                <div class="absolute top-2 right-2">
                                    <span class="px-2 py-1 bg-blue-600 text-white text-xs rounded capitalize">${trainingFocus}</span>
                                </div>
                                <img src="${player.imageUrl || 'https://placehold.co/96x96/161b22/FFFFFF?text=Y'}" alt="${player.name}" class="w-24 h-24 object-cover rounded-full mx-auto mb-3 border-2 border-gray-600">
                                <h4 class="font-bold text-lg text-white">${player.name}</h4>
                                <p class="text-sm text-gray-400">${player.position || 'ANY'} | Age: ${player.age || 'N/A'}</p>
                                <p class="text-2xl font-black text-green-400 mt-2">${overallRating}</p>
                                <div class="mt-2 text-xs text-gray-500">
                                    <div class="flex justify-between"><span>Pace:</span><span>${attributes.pace}</span></div>
                                    <div class="attribute-bar"><div class="attribute-fill pace-fill" style="width: ${attributes.pace}%"></div></div>
                                    <div class="flex justify-between"><span>Shooting:</span><span>${attributes.shooting}</span></div>
                                    <div class="attribute-bar"><div class="attribute-fill shooting-fill" style="width: ${attributes.shooting}%"></div></div>
                                    <div class="flex justify-between"><span>Passing:</span><span>${attributes.passing}</span></div>
                                    <div class="attribute-bar"><div class="attribute-fill passing-fill" style="width: ${attributes.passing}%"></div></div>
                                </div>
                                <div class="mt-3">
                                    <div class="flex justify-between text-xs mb-1">
                                        <span>Training Progress:</span>
                                        <span>${trainingProgress}%</span>
                                    </div>
                                    <div class="w-full bg-gray-700 rounded-full h-2">
                                        <div class="bg-gradient-to-r from-blue-400 to-purple-500 h-2 rounded-full" style="width: ${trainingProgress}%"></div>
                                    </div>
                                </div>
                                <div class="mt-3 flex justify-center space-x-2">
                                    <button onclick="promoteYouthPlayer('${playerId}')" class="py-1 px-3 bg-green-600 hover:bg-green-700 text-white text-xs rounded">Promote</button>
                                    <button onclick="releaseYouthPlayer('${playerId}')" class="py-1 px-3 bg-red-600 hover:bg-red-700 text-white text-xs rounded">Release</button>
                                    <button onclick="changeTrainingFocus('${playerId}')" class="py-1 px-3 bg-blue-600 hover:bg-blue-700 text-white text-xs rounded">Focus</button>
                                </div>
                            </div>`;
                    }
                    
                    youthPlayersContainer.innerHTML = playersHtml;
                } else {
                    youthPlayersContainer.innerHTML = '<p class="text-gray-400 text-center">No youth players in your academy. Generate some players to get started!</p>';
                }
            } catch (error) {
                console.error("Error loading youth players:", error);
                youthPlayersContainer.innerHTML = '<p class="text-red-400 text-center">Error loading youth players. Please try again.</p>';
            }
        }
        
        async function generateYouthPlayer() {
            if (!currentUserData) return;
            
            try {
                // Check if user has enough coins (cost: 500 coins)
                if (currentUserData.balance < 500) {
                    showModal("You don't have enough coins to generate a youth player. Required: 500 coins.");
                    return;
                }
                
                // Generate random player attributes
                const positions = ['GK', 'DEF', 'MID', 'ATT'];
                const position = positions[Math.floor(Math.random() * positions.length)];
                
                // Base attributes based on position
                let attributes = {
                    pace: Math.floor(Math.random() * 30) + 40, // 40-70
                    shooting: Math.floor(Math.random() * 30) + 40,
                    passing: Math.floor(Math.random() * 30) + 40,
                    dribbling: Math.floor(Math.random() * 30) + 40,
                    defending: Math.floor(Math.random() * 30) + 40,
                    physical: Math.floor(Math.random() * 30) + 40
                };
                
                // Adjust attributes based on position
                switch(position) {
                    case 'GK':
                        attributes.pace = Math.floor(Math.random() * 20) + 30; // Lower pace for GK
                        attributes.shooting = Math.floor(Math.random() * 20) + 30;
                        attributes.passing = Math.floor(Math.random() * 30) + 50;
                        attributes.dribbling = Math.floor(Math.random() * 20) + 30;
                        attributes.defending = Math.floor(Math.random() * 20) + 50;
                        attributes.physical = Math.floor(Math.random() * 30) + 50;
                        break;
                    case 'DEF':
                        attributes.pace = Math.floor(Math.random() * 20) + 60;
                        attributes.shooting = Math.floor(Math.random() * 20) + 30;
                        attributes.passing = Math.floor(Math.random() * 20) + 50;
                        attributes.dribbling = Math.floor(Math.random() * 20) + 40;
                        attributes.defending = Math.floor(Math.random() * 30) + 60; // Higher defending
                        attributes.physical = Math.floor(Math.random() * 30) + 60;
                        break;
                    case 'MID':
                        attributes.pace = Math.floor(Math.random() * 20) + 60;
                        attributes.shooting = Math.floor(Math.random() * 20) + 50;
                        attributes.passing = Math.floor(Math.random() * 30) + 60; // Higher passing
                        attributes.dribbling = Math.floor(Math.random() * 20) + 60;
                        attributes.defending = Math.floor(Math.random() * 20) + 50;
                        attributes.physical = Math.floor(Math.random() * 20) + 60;
                        break;
                    case 'ATT':
                        attributes.pace = Math.floor(Math.random() * 30) + 70; // Higher pace
                        attributes.shooting = Math.floor(Math.random() * 30) + 60; // Higher shooting
                        attributes.passing = Math.floor(Math.random() * 20) + 50;
                        attributes.dribbling = Math.floor(Math.random() * 30) + 60;
                        attributes.defending = Math.floor(Math.random() * 20) + 30;
                        attributes.physical = Math.floor(Math.random() * 20) + 50;
                        break;
                }
                
                // Generate player name
                const firstNames = ['Alex', 'Jamie', 'Taylor', 'Jordan', 'Casey', 'Riley', 'Morgan', 'Cameron', 'Drew', 'Quinn'];
                const lastNames = ['Smith', 'Johnson', 'Williams', 'Brown', 'Jones', 'Garcia', 'Miller', 'Davis', 'Rodriguez', 'Martinez'];
                const firstName = firstNames[Math.floor(Math.random() * firstNames.length)];
                const lastName = lastNames[Math.floor(Math.random() * lastNames.length)];
                const playerName = `${firstName} ${lastName}`;
                
                // Calculate overall rating
                const overallRating = Math.round(
                    (attributes.pace + attributes.shooting + attributes.passing + 
                     attributes.dribbling + attributes.defending + attributes.physical) / 6
                );
                
                // Create player object
                const youthPlayer = {
                    name: playerName,
                    position: position,
                    attributes: attributes,
                    overall: overallRating,
                    potential: Math.min(99, overallRating + Math.floor(Math.random() * 20) + 5), // 5-25 points higher potential
                    age: Math.floor(Math.random() * 5) + 15, // 15-19 years old
                    trainingFocus: 'balanced',
                    createdAt: serverTimestamp(),
                    imageUrl: `https://placehold.co/96x96/161b22/FFFFFF?text=${firstName.charAt(0)}${lastName.charAt(0)}`
                };
                
                // Add player to user's youth players
                const youthPlayersRef = ref(db, `users/${currentUserData.uid}/youthPlayers`);
                const newPlayerRef = push(youthPlayersRef);
                await set(newPlayerRef, youthPlayer);
                
                // Deduct coins
                await update(ref(db, 'users/' + currentUserData.uid), { 
                    balance: currentUserData.balance - 500 
                });
                
                showModal(`${playerName} has been added to your youth academy!`);
                
                // Refresh the youth players list
                await loadYouthPlayers();
            } catch (error) {
                console.error("Error generating youth player:", error);
                showModal("Error generating youth player. Please try again.");
            }
        }
        
        // Alliance Wars System
        function openAllianceWarsView() {
            // Navigate to alliance wars view
            navigateToView('alliance-wars-view');
            
            // Load alliance wars data
            loadAllianceWars();
        }
        
        async function loadAllianceWars() {
            const activeWarsList = document.getElementById('active-wars-list');
            const allianceInfo = document.getElementById('alliance-info');
            
            activeWarsList.innerHTML = '<p class="text-gray-400 text-center">Loading active wars...</p>';
            
            try {
                // Check if user is in an alliance
                if (currentUserData.alliances && currentUserData.alliances.length > 0) {
                    // Get user's alliance
                    const allianceId = currentUserData.alliances[0];
                    const allianceRef = ref(db, `alliances/${allianceId}`);
                    const allianceSnap = await get(allianceRef);
                    
                    if (allianceSnap.exists()) {
                        const allianceData = allianceSnap.val();
                        
                        // Update alliance info
                        allianceInfo.innerHTML = `
                            <div class="alliance-badge mx-auto mb-3">${allianceData.name.charAt(0)}</div>
                            <h3 class="text-xl font-bold text-white">${allianceData.name}</h3>
                            <p class="text-gray-400 mb-2">Members: ${allianceData.members ? Object.keys(allianceData.members).length : 0}</p>
                            <p class="text-gray-400 mb-4">Points: ${allianceData.warPoints || 0}</p>
                            <button id="participate-war-btn" class="py-2 px-4 bg-red-600 hover:bg-red-700 text-white font-bold rounded-lg interactive-button">
                                Participate in War
                            </button>
                        `;
                        
                        // Add event listener for participate button
                        document.getElementById('participate-war-btn').addEventListener('click', () => {
                            participateInWar(allianceId);
                        });
                    }
                } else {
                    // User not in alliance
                    allianceInfo.innerHTML = `
                        <p class="text-gray-400">You are not currently in an alliance.</p>
                        <button id="join-alliance-wars-btn-2" class="mt-4 py-2 px-4 bg-green-600 hover:bg-green-700 text-white font-bold rounded-lg interactive-button">
                            Join an Alliance
                        </button>
                    `;
                    
                    // Add event listener for join button
                    document.getElementById('join-alliance-wars-btn-2').addEventListener('click', () => {
                        // Navigate to friends & alliances view
                        navigateToView('social-view');
                        // Then click on friends button to show alliances
                        setTimeout(() => {
                            document.getElementById('friends-btn').click();
                            // Switch to alliances tab
                            setTimeout(() => {
                                document.getElementById('alliances-tab').click();
                            }, 100);
                        }, 100);
                    });
                }
                
                // Load active wars
                const warsRef = ref(db, 'allianceWars');
                const warsSnap = await get(warsRef);
                
                if (warsSnap.exists()) {
                    const wars = warsSnap.val();
                    let warsHtml = '';
                    
                    for (const warId in wars) {
                        const war = wars[warId];
                        
                        // Only show active wars
                        if (war.status === 'active') {
                            warsHtml += `
                                <div class="player-card p-4">
                                    <div class="flex justify-between items-center mb-3">
                                        <h3 class="text-lg font-bold text-white">${war.name || 'Alliance War'}</h3>
                                        <span class="px-2 py-1 bg-red-600 text-white text-xs rounded">Active</span>
                                    </div>
                                    <div class="flex justify-between text-sm mb-2">
                                        <span class="text-gray-400">${war.allianceA.name}</span>
                                        <span class="text-gray-400">vs</span>
                                        <span class="text-gray-400">${war.allianceB.name}</span>
                                    </div>
                                    <div class="flex justify-between text-sm mb-3">
                                        <span class="font-bold text-green-400">${war.allianceA.points || 0} pts</span>
                                        <span class="font-bold text-green-400">${war.allianceB.points || 0} pts</span>
                                    </div>
                                    <button onclick="viewWarDetails('${warId}')" class="w-full py-2 px-4 bg-blue-600 hover:bg-blue-700 text-white font-bold rounded-lg interactive-button">
                                        View Details
                                    </button>
                                </div>
                            `;
                        }
                    }
                    
                    if (warsHtml) {
                        activeWarsList.innerHTML = warsHtml;
                    } else {
                        activeWarsList.innerHTML = '<p class="text-gray-400 text-center">No active alliance wars at the moment.</p>';
                    }
                } else {
                    activeWarsList.innerHTML = '<p class="text-gray-400 text-center">No active alliance wars at the moment.</p>';
                }
            } catch (error) {
                console.error("Error loading alliance wars:", error);
                activeWarsList.innerHTML = '<p class="text-red-400 text-center">Error loading alliance wars. Please try again.</p>';
                allianceInfo.innerHTML = '<p class="text-red-400 text-center">Error loading alliance info.</p>';
            }
        }
        
        function participateInWar(allianceId) {
            showModal("You have been registered for the next alliance war! You will receive a notification when the war begins.");
        }
        
        window.viewWarDetails = (warId) => {
            showModal(`War details for war ID: ${warId}\n\nThis would show the full war details, bracket, and match schedule.`);
        };
        
        // Custom Tournaments System
        function openCustomTournamentsView() {
            // Navigate to custom tournaments view
            navigateToView('custom-tournaments-view');
            
            // Load custom tournaments data
            loadCustomTournaments();
        }
        
        async function loadCustomTournaments() {
            const activeTournamentsList = document.getElementById('active-tournaments-list');
            const myTournamentsList = document.getElementById('my-tournaments-list');
            
            activeTournamentsList.innerHTML = '<p class="text-gray-400 text-center">Loading active tournaments...</p>';
            myTournamentsList.innerHTML = '<p class="text-gray-400 text-center">Loading your tournaments...</p>';
            
            try {
                // Load active tournaments
                const tournamentsRef = ref(db, 'customTournaments');
                const tournamentsSnap = await get(tournamentsRef);
                
                if (tournamentsSnap.exists()) {
                    const tournaments = tournamentsSnap.val();
                    let activeTournamentsHtml = '';
                    let myTournamentsHtml = '';
                    
                    for (const tournamentId in tournaments) {
                        const tournament = tournaments[tournamentId];
                        
                        // Format tournament data
                        const formattedTournament = {
                            id: tournamentId,
                            name: tournament.name || 'Custom Tournament',
                            type: tournament.type || 'knockout',
                            status: tournament.status || 'pending',
                            creator: tournament.creatorName || 'Unknown',
                            participants: tournament.participants ? Object.keys(tournament.participants).length : 0,
                            maxParticipants: tournament.maxParticipants || 8,
                            entryFee: tournament.entryFee || 0,
                            prize: tournament.prize || 0
                        };
                        
                        // Check if user is participating in this tournament
                        const isUserParticipant = tournament.participants && tournament.participants[currentUserData.uid];
                        
                        // Add to active tournaments if it's active
                        if (formattedTournament.status === 'active' || formattedTournament.status === 'registration') {
                            activeTournamentsHtml += `
                                <div class="player-card p-4">
                                    <div class="flex justify-between items-center mb-2">
                                        <h3 class="text-lg font-bold text-white">${formattedTournament.name}</h3>
                                        <span class="px-2 py-1 bg-green-600 text-white text-xs rounded">${formattedTournament.status.charAt(0).toUpperCase() + formattedTournament.status.slice(1)}</span>
                                    </div>
                                    <div class="text-sm text-gray-400 mb-1">
                                        <i class="fas fa-user mr-1"></i> Created by ${formattedTournament.creator}
                                    </div>
                                    <div class="text-sm text-gray-400 mb-3">
                                        <i class="fas fa-users mr-1"></i> ${formattedTournament.participants}/${formattedTournament.maxParticipants} participants
                                    </div>
                                    <div class="flex justify-between mb-3">
                                        <div>
                                            <span class="text-gray-400 text-sm">Entry:</span>
                                            <span class="text-yellow-400 font-bold ml-1">${formattedTournament.entryFee} coins</span>
                                        </div>
                                        <div>
                                            <span class="text-gray-400 text-sm">Prize:</span>
                                            <span class="text-green-400 font-bold ml-1">${formattedTournament.prize} coins</span>
                                        </div>
                                    </div>
                                    ${isUserParticipant 
                                        ? '<button class="w-full py-2 px-4 bg-gray-600 text-white font-bold rounded-lg cursor-not-allowed">Already Joined</button>' 
                                        : `<button onclick="joinTournament('${tournamentId}')" class="w-full py-2 px-4 bg-green-600 hover:bg-green-700 text-white font-bold rounded-lg interactive-button">Join Tournament</button>`}
                                </div>
                            `;
                        }
                        
                        // Add to user's tournaments if they're participating
                        if (isUserParticipant) {
                            myTournamentsHtml += `
                                <div class="player-card p-4">
                                    <div class="flex justify-between items-center mb-2">
                                        <h3 class="text-lg font-bold text-white">${formattedTournament.name}</h3>
                                        <span class="px-2 py-1 bg-blue-600 text-white text-xs rounded">${formattedTournament.type}</span>
                                    </div>
                                    <div class="text-sm text-gray-400 mb-1">
                                        <i class="fas fa-user mr-1"></i> Created by ${formattedTournament.creator}
                                    </div>
                                    <div class="text-sm text-gray-400 mb-3">
                                        <i class="fas fa-users mr-1"></i> ${formattedTournament.participants}/${formattedTournament.maxParticipants} participants
                                    </div>
                                    <div class="flex justify-between mb-3">
                                        <div>
                                            <span class="text-gray-400 text-sm">Status:</span>
                                            <span class="text-green-400 font-bold ml-1">${formattedTournament.status.charAt(0).toUpperCase() + formattedTournament.status.slice(1)}</span>
                                        </div>
                                        <div>
                                            <span class="text-gray-400 text-sm">Prize:</span>
                                            <span class="text-green-400 font-bold ml-1">${formattedTournament.prize} coins</span>
                                        </div>
                                    </div>
                                    <button onclick="viewTournamentDetails('${tournamentId}')" class="w-full py-2 px-4 bg-blue-600 hover:bg-blue-700 text-white font-bold rounded-lg interactive-button">
                                        View Details
                                    </button>
                                </div>
                            `;
                        }
                    }
                    
                    if (activeTournamentsHtml) {
                        activeTournamentsList.innerHTML = activeTournamentsHtml;
                    } else {
                        activeTournamentsList.innerHTML = '<p class="text-gray-400 text-center">No active tournaments at the moment.</p>';
                    }
                    
                    if (myTournamentsHtml) {
                        myTournamentsList.innerHTML = myTournamentsHtml;
                    } else {
                        myTournamentsList.innerHTML = '<p class="text-gray-400 text-center">You haven\'t created or joined any tournaments yet.</p>';
                    }
                } else {
                    activeTournamentsList.innerHTML = '<p class="text-gray-400 text-center">No active tournaments at the moment.</p>';
                    myTournamentsList.innerHTML = '<p class="text-gray-400 text-center">You haven\'t created or joined any tournaments yet.</p>';
                }
            } catch (error) {
                console.error("Error loading custom tournaments:", error);
                activeTournamentsList.innerHTML = '<p class="text-red-400 text-center">Error loading tournaments. Please try again.</p>';
                myTournamentsList.innerHTML = '<p class="text-red-400 text-center">Error loading your tournaments. Please try again.</p>';
            }
        }
        
        function openCreateTournamentModal() {
            // Create tournament modal
            const modalHtml = `
                <div id="create-tournament-modal" class="fixed inset-0 modal-backdrop flex items-center justify-center z-50">
                    <div class="bg-gray-900 rounded-xl shadow-2xl p-6 w-full max-w-md text-left border-4 border-yellow-500 relative">
                        <button id="close-create-tournament-modal" class="absolute top-2 right-3 text-2xl text-gray-400 hover:text-white">&times;</button>
                        <h2 class="text-2xl font-bold text-yellow-400 mb-4">Create Custom Tournament</h2>
                        <div class="space-y-4">
                            <div>
                                <label class="block text-gray-300 mb-2">Tournament Name</label>
                                <input type="text" id="tournament-name" placeholder="Enter tournament name" class="w-full px-4 py-2 bg-gray-700 border border-gray-600 rounded-lg text-white">
                            </div>
                            <div>
                                <label class="block text-gray-300 mb-2">Tournament Type</label>
                                <select id="tournament-type" class="w-full px-4 py-2 bg-gray-700 border border-gray-600 rounded-lg text-white">
                                    <option value="knockout">Knockout Tournament</option>
                                    <option value="league">League Tournament</option>
                                    <option value="group_knockout">Group Stage + Knockout</option>
                                </select>
                            </div>
                            <div>
                                <label class="block text-gray-300 mb-2">Maximum Participants</label>
                                <select id="max-participants" class="w-full px-4 py-2 bg-gray-700 border border-gray-600 rounded-lg text-white">
                                    <option value="4">4</option>
                                    <option value="8" selected>8</option>
                                    <option value="16">16</option>
                                </select>
                            </div>
                            <div>
                                <label class="block text-gray-300 mb-2">Entry Fee (Coins)</label>
                                <input type="number" id="entry-fee" min="0" value="0" class="w-full px-4 py-2 bg-gray-700 border border-gray-600 rounded-lg text-white">
                            </div>
                            <div>
                                <label class="block text-gray-300 mb-2">Prize Pool (Coins)</label>
                                <input type="number" id="prize-pool" min="0" value="1000" class="w-full px-4 py-2 bg-gray-700 border border-gray-600 rounded-lg text-white">
                            </div>
                            <div class="flex space-x-3 pt-4">
                                <button id="cancel-create-tournament" class="flex-1 py-2 px-4 bg-gray-700 hover:bg-gray-600 text-white font-bold rounded-lg interactive-button">Cancel</button>
                                <button id="confirm-create-tournament" class="flex-1 py-2 px-4 bg-green-600 hover:bg-green-700 text-white font-bold rounded-lg interactive-button">Create Tournament</button>
                            </div>
                        </div>
                    </div>
                </div>`;
            
            // Add modal to document
            document.body.insertAdjacentHTML('beforeend', modalHtml);
            
            // Add event listeners
            document.getElementById('close-create-tournament-modal').addEventListener('click', closeCreateTournamentModal);
            document.getElementById('cancel-create-tournament').addEventListener('click', closeCreateTournamentModal);
            document.getElementById('confirm-create-tournament').addEventListener('click', createTournament);
        }
        
        function closeCreateTournamentModal() {
            const modal = document.getElementById('create-tournament-modal');
            if (modal) {
                modal.remove();
            }
        }
        
        async function createTournament() {
            if (!currentUserData) return;
            
            try {
                // Get form values
                const name = document.getElementById('tournament-name').value.trim();
                const type = document.getElementById('tournament-type').value;
                const maxParticipants = parseInt(document.getElementById('max-participants').value);
                const entryFee = parseInt(document.getElementById('entry-fee').value);
                const prizePool = parseInt(document.getElementById('prize-pool').value);
                
                // Validate inputs
                if (!name) {
                    showModal("Please enter a tournament name.");
                    return;
                }
                
                if (entryFee < 0) {
                    showModal("Entry fee cannot be negative.");
                    return;
                }
                
                if (prizePool <= 0) {
                    showModal("Prize pool must be greater than zero.");
                    return;
                }
                
                // Check if user has enough coins for prize pool
                if (currentUserData.balance < prizePool) {
                    showModal(`You don't have enough coins for the prize pool. Required: ${prizePool} coins.`);
                    return;
                }
                
                // Create tournament in database
                const tournamentsRef = ref(db, 'customTournaments');
                const newTournamentRef = push(tournamentsRef);
                
                const tournamentData = {
                    name: name,
                    type: type,
                    status: 'registration',
                    creatorId: currentUserData.uid,
                    creatorName: currentUserData.clubName,
                    maxParticipants: maxParticipants,
                    entryFee: entryFee,
                    prize: prizePool,
                    participants: {
                        [currentUserData.uid]: {
                            clubName: currentUserData.clubName,
                            joinedAt: serverTimestamp()
                        }
                    },
                    createdAt: serverTimestamp()
                };
                
                await set(newTournamentRef, tournamentData);
                
                // Deduct prize pool from user's balance
                await update(ref(db, 'users/' + currentUserData.uid), { 
                    balance: currentUserData.balance - prizePool 
                });
                
                // Close modal and show success message
                closeCreateTournamentModal();
                showModal(`Tournament "${name}" created successfully!`);
                
                // Refresh tournaments list
                loadCustomTournaments();
            } catch (error) {
                console.error("Error creating tournament:", error);
                showModal("Error creating tournament. Please try again.");
            }
        }
        
        window.joinTournament = async (tournamentId) => {
            if (!currentUserData) return;
            
            try {
                // Get tournament data
                const tournamentRef = ref(db, `customTournaments/${tournamentId}`);
                const tournamentSnap = await get(tournamentRef);
                
                if (!tournamentSnap.exists()) {
                    showModal("Tournament not found.");
                    return;
                }
                
                const tournament = tournamentSnap.val();
                
                // Check if tournament is still in registration phase
                if (tournament.status !== 'registration') {
                    showModal(`This tournament is no longer accepting new participants.`);
                    return;
                }
                
                // Check if user is already participating
                if (tournament.participants && tournament.participants[currentUserData.uid]) {
                    showModal("You are already participating in this tournament.");
                    return;
                }
                
                // Check if tournament is full
                const participantCount = tournament.participants ? Object.keys(tournament.participants).length : 0;
                if (participantCount >= tournament.maxParticipants) {
                    showModal("This tournament is already full.");
                    return;
                }
                
                // Check if user has enough coins for entry fee
                if (currentUserData.balance < (tournament.entryFee || 0)) {
                    showModal(`You don't have enough coins to join this tournament. Required: ${tournament.entryFee || 0} coins.`);
                    return;
                }
                
                // Add user to tournament participants
                const updatedParticipants = {
                    ...tournament.participants,
                    [currentUserData.uid]: {
                        clubName: currentUserData.clubName,
                        joinedAt: serverTimestamp()
                    }
                };
                
                await update(tournamentRef, { participants: updatedParticipants });
                
                // Deduct entry fee from user's balance
                if (tournament.entryFee > 0) {
                    await update(ref(db, 'users/' + currentUserData.uid), { 
                        balance: currentUserData.balance - tournament.entryFee 
                    });
                }
                
                showModal(`You have successfully joined the tournament!`);
                
                // Refresh tournaments list
                loadCustomTournaments();
            } catch (error) {
                console.error("Error joining tournament:", error);
                showModal("Error joining tournament. Please try again.");
            }
        };
        
        window.viewTournamentDetails = (tournamentId) => {
            showModal(`Tournament details for ID: ${tournamentId}\n\nThis would show the full tournament details, bracket, and match schedule.`);
        };
        
        // Set initial state for custom tournaments
        if (document.getElementById('custom-tournaments-view') && !document.getElementById('custom-tournaments-view').classList.contains('hidden')) {
            loadCustomTournaments();
        }
        
        window.promoteYouthPlayer = async (playerId) => {
            if (!currentUserData) return;
            
            try {
                // Get the youth player
                const playerRef = ref(db, `users/${currentUserData.uid}/youthPlayers/${playerId}`);
                const playerSnap = await get(playerRef);
                
                if (!playerSnap.exists()) {
                    showModal("Player not found.");
                    return;
                }
                
                const playerData = playerSnap.val();
                
                // Check if user has space in squad (max 20 players)
                if (currentUserData.squad && currentUserData.squad.length >= 20) {
                    showModal("You have reached the maximum squad size (20 players). Release some players first.");
                    return;
                }
                
                // Add player to main squad
                const newSquad = [...(currentUserData.squad || []), playerId];
                
                // Move player from youth players to main players database
                const mainPlayerRef = ref(db, `players/${playerId}`);
                await set(mainPlayerRef, {
                    name: playerData.name,
                    position: playerData.position,
                    rating: playerData.overall,
                    value: playerData.overall * 100, // Simple valuation
                    imageUrl: playerData.imageUrl,
                    attributes: playerData.attributes,
                    rarity: "bronze" // Youth players start as bronze
                });
                
                // Remove from youth players
                await remove(playerRef);
                
                // Update user squad
                await update(ref(db, 'users/' + currentUserData.uid), { 
                    squad: newSquad 
                });
                
                showModal(`${playerData.name} has been promoted to your main squad!`);
                
                // Refresh the youth players list
                await loadYouthPlayers();
            } catch (error) {
                console.error("Error promoting youth player:", error);
                showModal("Error promoting youth player. Please try again.");
            }
        };
        
        window.releaseYouthPlayer = async (playerId) => {
            if (!currentUserData) return;
            
            // Confirm release
            if (!confirm("Are you sure you want to release this player? This action cannot be undone.")) {
                return;
            }
            
            try {
                // Remove player from youth players
                const playerRef = ref(db, `users/${currentUserData.uid}/youthPlayers/${playerId}`);
                await remove(playerRef);
                
                showModal("Player has been released from the youth academy.");
                
                // Refresh the youth players list
                await loadYouthPlayers();
            } catch (error) {
                console.error("Error releasing youth player:", error);
                showModal("Error releasing youth player. Please try again.");
            }
        };
        
        // Set initial training focus if exists
        if (currentUserData && currentUserData.youthTrainingFocus) {
            document.querySelectorAll('.training-focus-option').forEach(option => {
                if (option.getAttribute('data-focus') === currentUserData.youthTrainingFocus) {
                    option.classList.add('border-2', 'border-yellow-400');
                }
            });
        }

        function updateKitPreview(jerseyColor, shortsColor, socksColor, style) {
            const kitJersey = document.getElementById('kit-jersey');
            const kitShorts = document.getElementById('kit-shorts');
            const kitSocks = document.getElementById('kit-socks');
            
            // Reset styles
            kitJersey.style.backgroundColor = jerseyColor;
            kitShorts.style.backgroundColor = shortsColor;
            kitSocks.style.backgroundColor = socksColor;
            
            // Clear existing stripes
            const existingStripes = kitJersey.querySelectorAll('.kit-stripe');
            existingStripes.forEach(stripe => stripe.remove());
            
            // Add stripes based on style
            if (style === 'stripes') {
                for (let i = 0; i < 5; i++) {
                    const stripe = document.createElement('div');
                    stripe.className = 'kit-stripe vertical';
                    stripe.style.left = `${20 + i * 15}%`;
                    stripe.style.backgroundColor = '#ffffff';
                    kitJersey.appendChild(stripe);
                }
            } else if (style === 'hoops') {
                for (let i = 0; i < 3; i++) {
                    const stripe = document.createElement('div');
                    stripe.className = 'kit-stripe horizontal';
                    stripe.style.top = `${20 + i * 20}%`;
                    stripe.style.backgroundColor = '#ffffff';
                    kitJersey.appendChild(stripe);
                }
            } else if (style === 'sash') {
                const stripe = document.createElement('div');
                stripe.className = 'kit-stripe';
                stripe.style.width = '100%';
                stripe.style.height = '20px';
                stripe.style.backgroundColor = '#ffffff';
                stripe.style.transform = 'rotate(-45deg)';
                stripe.style.position = 'absolute';
                stripe.style.top = '40%';
                stripe.style.left = '-20%';
                kitJersey.appendChild(stripe);
            }
        }

        // Game Settings System
        const settingsBtn = document.getElementById('settings-btn');
        const settingsModal = document.getElementById('settings-modal');
        const settingsCloseBtn = document.getElementById('settings-close-btn');
        const settingsCloseBtn2 = document.getElementById('settings-close-btn-2');
        
        settingsBtn.addEventListener('click', () => {
            if (!currentUserData) return;
            openSettingsModal();
        });
        
        // Add event listener for the settings button in the header
        document.getElementById('header-settings-btn').addEventListener('click', () => {
            if (!currentUserData) return;
            openSettingsModal();
        });
        
        // Match History System
        async function loadMatchHistory() {
            if (!currentUserData) return;
            
            const matchHistoryList = document.getElementById('match-history-list');
            matchHistoryList.innerHTML = '<p class="text-gray-400 text-center">Loading match history...</p>';
            
            try {
                // Load real match history from the database
                
                // Get user's match statistics
                const totalMatches = currentUserData.matchesPlayed || 0;
                const wins = currentUserData.wins || 0;
                const winRate = totalMatches > 0 ? Math.round((wins / totalMatches) * 100) : 0;
                
                // Update statistics
                document.getElementById('total-matches').textContent = totalMatches;
                document.getElementById('wins-count').textContent = wins;
                document.getElementById('win-rate').textContent = `${winRate}%`;
                
                // Load match history from database
                const matchHistoryRef = ref(db, `users/${currentUserData.uid}/matchHistory`);
                const matchHistorySnap = await get(matchHistoryRef);
                
                if (matchHistorySnap.exists()) {
                    const matchHistory = matchHistorySnap.val();
                    let matchHistoryHtml = '';
                    
                    // Convert object to array and sort by date (newest first)
                    const matches = Object.values(matchHistory);
                    matches.sort((a, b) => new Date(b.date) - new Date(a.date));
                    
                    matches.forEach(match => {
                        const resultClass = match.result === 'win' ? 'text-green-400' : 
                                          match.result === 'loss' ? 'text-red-400' : 'text-yellow-400';
                        const resultText = match.result === 'win' ? 'Victory' : 
                                         match.result === 'loss' ? 'Defeat' : 'Draw';
                        
                        // Format date
                        const matchDate = new Date(match.date);
                        const formattedDate = matchDate.toLocaleDateString();
                        
                        matchHistoryHtml += `
                            <div class="player-card p-4">
                                <div class="flex justify-between items-center mb-2">
                                    <h3 class="text-lg font-bold text-white">vs ${match.opponent}</h3>
                                    <span class="px-2 py-1 ${resultClass} text-xs font-bold rounded">${resultText}</span>
                                </div>
                                <div class="text-sm text-gray-400 mb-2">
                                    <i class="fas fa-calendar-alt mr-1"></i> ${formattedDate}
                                </div>
                                <div class="text-xl font-bold text-center my-3">
                                    <span class="text-white">${currentUserData.clubName}</span>
                                    <span class="mx-2 text-gray-400">${match.score}</span>
                                    <span class="text-white">${match.opponent}</span>
                                </div>
                                <div class="mt-3">
                                    <h4 class="text-sm font-bold text-gray-400 mb-1">Goals:</h4>
                                    <div class="flex flex-wrap gap-1">
                                        ${match.goals ? match.goals.map(goal => `<span class="px-2 py-1 bg-gray-700 text-xs rounded">${goal}</span>`).join('') : '<span class="px-2 py-1 bg-gray-700 text-xs rounded">No goals recorded</span>'}
                                    </div>
                                </div>
                                <div class="mt-3 flex justify-center">
                                    <button onclick="replayMatch('${match.id}')" class="py-1 px-3 bg-blue-600 hover:bg-blue-700 text-white text-sm rounded interactive-button">
                                        <i class="fas fa-play mr-1"></i> Watch Replay
                                    </button>
                                </div>
                            </div>
                        `;
                    });
                    
                    if (matchHistoryHtml) {
                        matchHistoryList.innerHTML = matchHistoryHtml;
                    } else {
                        matchHistoryList.innerHTML = '<p class="text-gray-400 text-center">No match history found.</p>';
                    }
                } else {
                    matchHistoryList.innerHTML = '<p class="text-gray-400 text-center">No match history found.</p>';
                }
            } catch (error) {
                console.error("Error loading match history:", error);
                matchHistoryList.innerHTML = '<p class="text-red-400 text-center">Error loading match history. Please try again.</p>';
            }
        }
        
        window.replayMatch = (matchId) => {
            showModal(`Replaying match ${matchId}.\n\nIn a real implementation, this would show a replay of the match with commentary and key moments.`);
        };
        
        // Add navigation handler for match history
        document.addEventListener('DOMContentLoaded', () => {
            // Add click handler for match history nav link
            const matchHistoryNavLink = document.querySelector('a[href="#match-history"]');
            if (matchHistoryNavLink) {
                matchHistoryNavLink.addEventListener('click', (e) => {
                    e.preventDefault();
                    navigateToView('match-history-view');
                    loadMatchHistory();
                });
            }
        });
        
        // Youth Squad System
        youthSquadBtn.addEventListener('click', () => {
            if (!currentUserData) return;
            openYouthSquadView();
        });
        
        // Add event listener for generate youth player button
        document.getElementById('generate-youth-player-btn').addEventListener('click', async () => {
            if (!currentUserData) return;
            await generateYouthPlayer();
        });
        
        // Add event listeners for training focus options
        document.querySelectorAll('.training-focus-option').forEach(option => {
            option.addEventListener('click', async (e) => {
                if (!currentUserData) return;
                const focus = e.currentTarget.getAttribute('data-focus');
                await setTrainingFocus(focus);
            });
        });
        
        // Alliance Wars System
        allianceWarsBtn.addEventListener('click', () => {
            if (!currentUserData) return;
            openAllianceWarsView();
        });
        
        // Add event listener for join alliance wars button
        document.getElementById('join-alliance-wars-btn').addEventListener('click', () => {
            // Navigate to friends & alliances view
            navigateToView('social-view');
            // Then click on friends button to show alliances
            setTimeout(() => {
                document.getElementById('friends-btn').click();
                // Switch to alliances tab
                setTimeout(() => {
                    document.getElementById('alliances-tab').click();
                }, 100);
            }, 100);
        });
        
        // Custom Tournaments System
        customTournamentsBtn.addEventListener('click', () => {
            if (!currentUserData) return;
            openCustomTournamentsView();
        });
        
        // Add event listener for create tournament button
        document.getElementById('create-tournament-btn').addEventListener('click', () => {
            openCreateTournamentModal();
        });

        settingsCloseBtn.addEventListener('click', () => {
            settingsModal.classList.add('hidden');
        });

        settingsCloseBtn2.addEventListener('click', () => {
            settingsModal.classList.add('hidden');
        });

        function openSettingsModal() {
            // Display server information
            const server = currentUserData.server || 'bangladesh';
            const serverNames = {
                'bangladesh': 'Bangladesh',
                'singapore': 'Singapore',
                'usa': 'USA',
                'brazil': 'Brazil'
            };
            
            document.getElementById('current-server').textContent = serverNames[server] || 'Bangladesh';
            
            // Simulate ping based on server
            let ping = 0;
            if (server === 'bangladesh') {
                ping = Math.floor(Math.random() * 101); // 0-100ms
            } else if (server === 'singapore') {
                ping = Math.floor(Math.random() * 51) + 100; // 100-150ms
            } else if (server === 'usa') {
                ping = Math.floor(Math.random() * 101) + 200; // 200-300ms
            } else if (server === 'brazil') {
                ping = Math.floor(Math.random() * 101) + 200; // 200-300ms
            }
            
            document.getElementById('simulated-ping').textContent = `${ping} ms`;
            
            // Display graphics settings
            const graphics = currentUserData.graphics || 'medium';
            document.getElementById('current-graphics').textContent = graphics.charAt(0).toUpperCase() + graphics.slice(1);
            
            // Highlight current graphics setting
            document.getElementById('graphics-low').classList.remove('bg-green-600', 'border-green-500');
            document.getElementById('graphics-medium').classList.remove('bg-green-600', 'border-green-500');
            document.getElementById('graphics-high').classList.remove('bg-green-600', 'border-green-500');
            
            if (graphics === 'low') {
                document.getElementById('graphics-low').classList.add('bg-green-600', 'border-green-500');
            } else if (graphics === 'medium') {
                document.getElementById('graphics-medium').classList.add('bg-green-600', 'border-green-500');
            } else if (graphics === 'high') {
                document.getElementById('graphics-high').classList.add('bg-green-600', 'border-green-500');
            }
            
            // Display FPS settings
            const fpsLimit = currentUserData.fpsLimit || 60;
            document.getElementById('current-fps').textContent = fpsLimit === 0 ? 'Unlimited' : `${fpsLimit} FPS`;
            
            // Highlight current FPS setting
            document.getElementById('fps-30').classList.remove('bg-green-600', 'border-green-500');
            document.getElementById('fps-60').classList.remove('bg-green-600', 'border-green-500');
            document.getElementById('fps-unlimited').classList.remove('bg-green-600', 'border-green-500');
            
            if (fpsLimit === 30) {
                document.getElementById('fps-30').classList.add('bg-green-600', 'border-green-500');
            } else if (fpsLimit === 60) {
                document.getElementById('fps-60').classList.add('bg-green-600', 'border-green-500');
            } else if (fpsLimit === 0) {
                document.getElementById('fps-unlimited').classList.add('bg-green-600', 'border-green-500');
            }
            
            // Display audio volume
            const audioVolume = currentUserData.audioVolume || 100;
            document.getElementById('audio-volume').value = audioVolume;
            document.getElementById('volume-value').textContent = `${audioVolume}%`;
            
            settingsModal.classList.remove('hidden');
        }

        // Graphics settings buttons
        document.getElementById('graphics-low').addEventListener('click', async () => {
            await update(ref(db, 'users/' + currentUserData.uid), { graphics: 'low' });
            currentUserData.graphics = 'low';
            openSettingsModal(); // Refresh the modal
            showModal('Graphics quality set to Low');
        });

        document.getElementById('graphics-medium').addEventListener('click', async () => {
            await update(ref(db, 'users/' + currentUserData.uid), { graphics: 'medium' });
            currentUserData.graphics = 'medium';
            openSettingsModal(); // Refresh the modal
            showModal('Graphics quality set to Medium');
        });

        document.getElementById('graphics-high').addEventListener('click', async () => {
            await update(ref(db, 'users/' + currentUserData.uid), { graphics: 'high' });
            currentUserData.graphics = 'high';
            openSettingsModal(); // Refresh the modal
            showModal('Graphics quality set to High');
        });

        // FPS limit buttons
        document.getElementById('fps-30').addEventListener('click', async () => {
            await update(ref(db, 'users/' + currentUserData.uid), { fpsLimit: 30 });
            currentUserData.fpsLimit = 30;
            openSettingsModal(); // Refresh the modal
            showModal('FPS limit set to 30');
        });

        document.getElementById('fps-60').addEventListener('click', async () => {
            await update(ref(db, 'users/' + currentUserData.uid), { fpsLimit: 60 });
            currentUserData.fpsLimit = 60;
            openSettingsModal(); // Refresh the modal
            showModal('FPS limit set to 60');
        });

        document.getElementById('fps-unlimited').addEventListener('click', async () => {
            await update(ref(db, 'users/' + currentUserData.uid), { fpsLimit: 0 });
            currentUserData.fpsLimit = 0;
            openSettingsModal(); // Refresh the modal
            showModal('FPS limit set to Unlimited');
        });

        // Audio volume slider
        document.getElementById('audio-volume').addEventListener('input', (e) => {
            const volume = e.target.value;
            document.getElementById('volume-value').textContent = `${volume}%`;
        });

        document.getElementById('audio-volume').addEventListener('change', async (e) => {
            const volume = parseInt(e.target.value);
            await update(ref(db, 'users/' + currentUserData.uid), { audioVolume: volume });
            currentUserData.audioVolume = volume;
            showModal(`Audio volume set to ${volume}%`);
        });

        // Friends & Alliances System
        friendsBtn.addEventListener('click', () => {
            if (!currentUserData) return;
            openFriendsModal();
        });

        friendsCloseBtn.addEventListener('click', () => {
            friendsModal.classList.add('hidden');
        });

        friendsCloseBtn2.addEventListener('click', () => {
            friendsModal.classList.add('hidden');
        });

        function openFriendsModal() {
            // Set active tab to friends
            document.getElementById('friends-tab').classList.add('active');
            document.getElementById('alliances-tab').classList.remove('active');
            document.getElementById('friends-content').classList.remove('hidden');
            document.getElementById('alliances-content').classList.add('hidden');
            
            loadFriendsList();
            loadAlliancesList();
            
            friendsModal.classList.remove('hidden');
        }

        async function loadFriendsList() {
            const friendsList = document.getElementById('friends-list');
            friendsList.innerHTML = '<p class="text-gray-400 text-center">Loading friends...</p>';
            
            const userFriends = currentUserData.friends || [];
            
            if (userFriends.length === 0) {
                friendsList.innerHTML = '<p class="text-gray-400 text-center">You have no friends yet. Search for other players to add them!</p>';
                return;
            }
            
            friendsList.innerHTML = '';
            
            for (const friendId of userFriends) {
                const friendSnap = await get(ref(db, 'users/' + friendId));
                if (friendSnap.exists()) {
                    const friendData = friendSnap.val();
                    friendsList.innerHTML += `
                        <div class="player-card p-4 flex justify-between items-center">
                            <div class="flex items-center">
                                <img src="${friendData.avatarUrl || 'https://placehold.co/40x40/0d1117/00bcd4?text=U'}" alt="${friendData.clubName}" class="w-10 h-10 rounded-full mr-3">
                                <div>
                                    <h4 class="font-bold text-white">${friendData.clubName}</h4>
                                    <p class="text-sm text-gray-400">Level ${friendData.level || 1}</p>
                                </div>
                            </div>
                            <div class="flex space-x-2">
                                <button class="challenge-friend-btn py-1 px-3 bg-green-600 hover:bg-green-700 text-white text-sm rounded interactive-button" data-friend="${friendId}">Challenge</button>
                                <button class="remove-friend-btn py-1 px-3 bg-red-600 hover:bg-red-700 text-white text-sm rounded interactive-button" data-friend="${friendId}">Remove</button>
                            </div>
                        </div>`;
                }
            }
            
            // Add event listeners
            document.querySelectorAll('.challenge-friend-btn').forEach(button => {
                button.addEventListener('click', async (e) => {
                    const friendId = e.target.getAttribute('data-friend');
                    await challengeFriend(friendId);
                });
            });
            
            document.querySelectorAll('.remove-friend-btn').forEach(button => {
                button.addEventListener('click', async (e) => {
                    const friendId = e.target.getAttribute('data-friend');
                    await removeFriend(friendId);
                });
            });
        }

        async function loadAlliancesList() {
            const alliancesList = document.getElementById('alliances-list');
            alliancesList.innerHTML = '<p class="text-gray-400 text-center">Loading alliances...</p>';
            
            const userAlliances = currentUserData.alliances || [];
            
            if (userAlliances.length === 0) {
                alliancesList.innerHTML = '<p class="text-gray-400 text-center">You are not in any alliances yet. Create one or search for existing alliances!</p>';
                return;
            }
            
            alliancesList.innerHTML = '';
            
            for (const allianceId of userAlliances) {
                const allianceSnap = await get(ref(db, 'alliances/' + allianceId));
                if (allianceSnap.exists()) {
                    const allianceData = allianceSnap.val();
                    alliancesList.innerHTML += `
                        <div class="player-card p-4 flex justify-between items-center">
                            <div class="flex items-center">
                                <div class="alliance-badge mr-3">${allianceData.name.charAt(0)}</div>
                                <div>
                                    <h4 class="font-bold text-white">${allianceData.name}</h4>
                                    <p class="text-sm text-gray-400">Members: ${allianceData.members ? Object.keys(allianceData.members).length : 0}</p>
                                </div>
                            </div>
                            <button class="view-alliance-btn py-1 px-3 bg-blue-600 hover:bg-blue-700 text-white text-sm rounded interactive-button" data-alliance="${allianceId}">View</button>
                        </div>`;
                }
            }
        }
        
        // Add event listener for create alliance button
        const createAllianceBtn = document.getElementById('create-alliance-btn');
        if (createAllianceBtn) {
            createAllianceBtn.addEventListener('click', () => {
                openCreateAllianceModal();
            });
        }
        
        // Add event listeners for search buttons
        const searchFriendBtn = document.getElementById('search-friend-btn');
        if (searchFriendBtn) {
            searchFriendBtn.addEventListener('click', () => {
                searchFriends();
            });
        }
        
        const searchAllianceBtn = document.getElementById('search-alliance-btn');
        if (searchAllianceBtn) {
            searchAllianceBtn.addEventListener('click', () => {
                searchAlliances();
            });
        }
        
        // Add event listeners for Enter key press on search inputs
        const friendSearchInput = document.getElementById('friend-search');
        if (friendSearchInput) {
            friendSearchInput.addEventListener('keypress', (e) => {
                if (e.key === 'Enter') {
                    searchFriends();
                }
            });
        }
        
        const allianceSearchInput = document.getElementById('alliance-search');
        if (allianceSearchInput) {
            allianceSearchInput.addEventListener('keypress', (e) => {
                if (e.key === 'Enter') {
                    searchAlliances();
                }
            });
        }
        
        // Add function to open create alliance modal
        function openCreateAllianceModal() {
            // Create a modal for creating an alliance
            const modalHtml = `
                <div id="create-alliance-modal" class="fixed inset-0 modal-backdrop flex items-center justify-center z-50">
                    <div class="bg-gray-900 rounded-xl shadow-2xl p-6 w-full max-w-md text-left border-4 border-purple-500 relative">
                        <button id="create-alliance-close-btn" class="absolute top-2 right-3 text-2xl text-gray-400 hover:text-white">&times;</button>
                        <h2 class="text-2xl font-bold text-purple-400 mb-4">Create New Alliance</h2>
                        <div class="space-y-4">
                            <div>
                                <label class="block text-gray-300 mb-2">Alliance Name</label>
                                <input type="text" id="alliance-name" maxlength="30" placeholder="Enter alliance name" class="w-full px-4 py-2 bg-gray-700 border border-gray-600 rounded-lg text-white">
                            </div>
                            <div>
                                <label class="block text-gray-300 mb-2">Alliance Tag</label>
                                <input type="text" id="alliance-tag" maxlength="5" placeholder="Enter alliance tag (max 5 characters)" class="w-full px-4 py-2 bg-gray-700 border border-gray-600 rounded-lg text-white">
                            </div>
                            <div>
                                <label class="block text-gray-300 mb-2">Description</label>
                                <textarea id="alliance-description" rows="3" placeholder="Enter alliance description" class="w-full px-4 py-2 bg-gray-700 border border-gray-600 rounded-lg text-white"></textarea>
                            </div>
                            <div class="flex space-x-3 pt-4">
                                <button id="cancel-create-alliance-btn" class="flex-1 py-2 px-4 bg-gray-700 hover:bg-gray-600 text-white font-bold rounded-lg interactive-button">Cancel</button>
                                <button id="confirm-create-alliance-btn" class="flex-1 py-2 px-4 bg-green-600 hover:bg-green-700 text-white font-bold rounded-lg interactive-button">Create Alliance</button>
                            </div>
                        </div>
                    </div>
                </div>`;
            
            // Add the modal to the document
            document.body.insertAdjacentHTML('beforeend', modalHtml);
            
            // Add event listeners
            document.getElementById('create-alliance-close-btn').addEventListener('click', closeCreateAllianceModal);
            document.getElementById('cancel-create-alliance-btn').addEventListener('click', closeCreateAllianceModal);
            document.getElementById('confirm-create-alliance-btn').addEventListener('click', createAlliance);
        }
        
        // Add function to close create alliance modal
        function closeCreateAllianceModal() {
            const modal = document.getElementById('create-alliance-modal');
            if (modal) {
                modal.remove();
            }
        }
        
        // Add function to create alliance
        async function createAlliance() {
            if (!currentUserData) return;
            
            const name = document.getElementById('alliance-name').value.trim();
            const tag = document.getElementById('alliance-tag').value.trim();
            const description = document.getElementById('alliance-description').value.trim();
            
            // Validate inputs
            if (!name || name.length < 3) {
                showModal("Alliance name must be at least 3 characters long.");
                return;
            }
            
            if (!tag || tag.length < 2) {
                showModal("Alliance tag must be at least 2 characters long.");
                return;
            }
            
            try {
                // Create the alliance in Firebase
                const allianceRef = push(ref(db, 'alliances'));
                const allianceData = {
                    name: name,
                    tag: tag,
                    description: description,
                    owner: currentUserData.uid,
                    ownerName: currentUserData.clubName,
                    members: {
                        [currentUserData.uid]: {
                            name: currentUserData.clubName,
                            role: 'leader',
                            joinDate: serverTimestamp()
                        }
                    },
                    createdAt: serverTimestamp(),
                    memberCount: 1
                };
                
                await set(allianceRef, allianceData);
                
                // Add alliance to user's alliances
                const userAlliances = currentUserData.alliances || [];
                userAlliances.push(allianceRef.key);
                
                await update(ref(db, 'users/' + currentUserData.uid), {
                    alliances: userAlliances
                });
                
                closeCreateAllianceModal();
                showModal("Alliance created successfully!");
                loadAlliancesList(); // Refresh the alliances list
            } catch (error) {
                console.error("Error creating alliance:", error);
                showModal("Failed to create alliance: " + error.message);
            }
        }

        async function challengeFriend(friendId) {
            if (!currentUserData) return;
            
            try {
                // Get friend data
                const friendRef = ref(db, `users/${friendId}`);
                const friendSnap = await get(friendRef);
                
                if (!friendSnap.exists()) {
                    showModal("Friend not found.");
                    return;
                }
                
                const friendData = friendSnap.val();
                
                // Create a friendly match
                const matchId = push(ref(db, 'matches')).key;
                
                const matchData = {
                    teamA: { uid: currentUserData.uid, clubName: currentUserData.clubName, teamPower: teamPower, squad: currentUserData.squad },
                    teamB: { uid: friendId, clubName: friendData.clubName, teamPower: friendData.teamPower || 0, squad: friendData.squad || [] },
                    score: { teamA: 0, teamB: 0 }, 
                    status: 'starting', 
                    startTime: serverTimestamp(), 
                    events: {},
                    teamAStrategy: 'Balanced', 
                    teamBStrategy: 'Balanced',
                    isFriendlyMatch: true
                };
                
                const updates = {};
                updates[`/matches/${matchId}`] = matchData;
                updates[`/users/${currentUserData.uid}/currentMatch`] = matchId;
                updates[`/users/${friendId}/currentMatch`] = matchId;
                
                await update(ref(db), updates);
                
                showModal(`Challenge sent to ${friendData.clubName}! Match will start shortly.`);
                
                // Navigate to match view
                navigateToView('match-view');
                
            } catch (error) {
                console.error("Error sending challenge:", error);
                showModal("Error sending challenge. Please try again.");
            }
        }

        async function removeFriend(friendId) {
            if (!currentUserData) return;
            
            const friends = currentUserData.friends || [];
            const updatedFriends = friends.filter(id => id !== friendId);
            
            await update(ref(db, 'users/' + currentUserData.uid), {
                friends: updatedFriends
            });
            
            showModal("Friend removed successfully!");
            loadFriendsList(); // Refresh the list
        }
        
        // Search for friends by club name
        async function searchFriends() {
            const searchTerm = document.getElementById('friend-search').value.trim().toLowerCase();
            if (!searchTerm) {
                showModal("Please enter a club name to search for.");
                return;
            }
            
            const friendsList = document.getElementById('friends-list');
            friendsList.innerHTML = '<p class="text-gray-400 text-center">Searching...</p>';
            
            try {
                // Get all users from database
                const usersRef = ref(db, 'users');
                const snapshot = await get(usersRef);
                
                if (!snapshot.exists()) {
                    friendsList.innerHTML = '<p class="text-gray-400 text-center">No users found.</p>';
                    return;
                }
                
                const users = [];
                snapshot.forEach(childSnapshot => {
                    // Don't include current user in search results
                    if (childSnapshot.key !== currentUserData.uid) {
                        users.push({ uid: childSnapshot.key, ...childSnapshot.val() });
                    }
                });
                
                // Filter users by search term
                const filteredUsers = users.filter(user => 
                    user.clubName && user.clubName.toLowerCase().includes(searchTerm)
                );
                
                if (filteredUsers.length === 0) {
                    friendsList.innerHTML = '<p class="text-gray-400 text-center">No users found matching your search.</p>';
                    return;
                }
                
                // Get current user's friends
                const userFriends = currentUserData.friends || [];
                
                // Display search results
                friendsList.innerHTML = '';
                for (const user of filteredUsers) {
                    // Check if user is already a friend
                    const isFriend = userFriends.includes(user.uid);
                    
                    friendsList.innerHTML += `
                        <div class="player-card p-4 flex justify-between items-center">
                            <div class="flex items-center">
                                <img src="${user.avatarUrl || 'https://placehold.co/40x40/0d1117/00bcd4?text=U'}" alt="${user.clubName}" class="w-10 h-10 rounded-full mr-3">
                                <div>
                                    <h4 class="font-bold text-white">${user.clubName}</h4>
                                    <p class="text-sm text-gray-400">Level ${user.level || 1}</p>
                                </div>
                            </div>
                            <div class="flex space-x-2">
                                ${isFriend 
                                    ? '<button class="py-1 px-3 bg-gray-600 text-white text-sm rounded cursor-not-allowed" disabled>Friend</button>' 
                                    : `<button class="send-friend-request-btn py-1 px-3 bg-green-600 hover:bg-green-700 text-white text-sm rounded interactive-button" data-user="${user.uid}">Add Friend</button>`}
                            </div>
                        </div>`;
                }
                
                // Add event listeners to friend request buttons
                document.querySelectorAll('.send-friend-request-btn').forEach(button => {
                    button.addEventListener('click', async (e) => {
                        const userId = e.target.getAttribute('data-user');
                        await sendFriendRequest(userId);
                    });
                });
                
            } catch (error) {
                console.error("Error searching friends:", error);
                friendsList.innerHTML = '<p class="text-red-400 text-center">Error searching for friends. Please try again.</p>';
            }
        }
        
        // Send friend request
        async function sendFriendRequest(userId) {
            if (!currentUserData) return;
            
            try {
                // Get target user data
                const userRef = ref(db, `users/${userId}`);
                const userSnap = await get(userRef);
                
                if (!userSnap.exists()) {
                    showModal("User not found.");
                    return;
                }
                
                const targetUser = userSnap.val();
                
                // Add friend to current user's friend list
                const currentUserFriends = currentUserData.friends || [];
                if (!currentUserFriends.includes(userId)) {
                    currentUserFriends.push(userId);
                    await update(ref(db, `users/${currentUserData.uid}`), {
                        friends: currentUserFriends
                    });
                    
                    // Update current user data in memory
                    currentUserData.friends = currentUserFriends;
                }
                
                // Add current user to target user's friend list
                const targetUserFriends = targetUser.friends || [];
                if (!targetUserFriends.includes(currentUserData.uid)) {
                    targetUserFriends.push(currentUserData.uid);
                    await update(ref(db, `users/${userId}`), {
                        friends: targetUserFriends
                    });
                }
                
                showModal(`Friend request sent to ${targetUser.clubName}!`);
                searchFriends(); // Refresh search results
                
            } catch (error) {
                console.error("Error sending friend request:", error);
                showModal("Error sending friend request. Please try again.");
            }
        }
        
        // Search for alliances by name
        async function searchAlliances() {
            const searchTerm = document.getElementById('alliance-search').value.trim().toLowerCase();
            if (!searchTerm) {
                showModal("Please enter an alliance name to search for.");
                return;
            }
            
            const alliancesList = document.getElementById('alliances-list');
            alliancesList.innerHTML = '<p class="text-gray-400 text-center">Searching...</p>';
            
            try {
                // Get all alliances from database
                const alliancesRef = ref(db, 'alliances');
                const snapshot = await get(alliancesRef);
                
                if (!snapshot.exists()) {
                    alliancesList.innerHTML = '<p class="text-gray-400 text-center">No alliances found.</p>';
                    return;
                }
                
                const alliances = [];
                snapshot.forEach(childSnapshot => {
                    alliances.push({ id: childSnapshot.key, ...childSnapshot.val() });
                });
                
                // Filter alliances by search term
                const filteredAlliances = alliances.filter(alliance => 
                    alliance.name && alliance.name.toLowerCase().includes(searchTerm)
                );
                
                if (filteredAlliances.length === 0) {
                    alliancesList.innerHTML = '<p class="text-gray-400 text-center">No alliances found matching your search.</p>';
                    return;
                }
                
                // Get current user's alliances
                const userAlliances = currentUserData.alliances || [];
                
                // Display search results
                alliancesList.innerHTML = '';
                for (const alliance of filteredAlliances) {
                    // Check if user is already in this alliance
                    const isInAlliance = userAlliances.includes(alliance.id);
                    
                    alliancesList.innerHTML += `
                        <div class="player-card p-4 flex justify-between items-center">
                            <div class="flex items-center">
                                <div class="alliance-badge mr-3">${alliance.name.charAt(0)}</div>
                                <div>
                                    <h4 class="font-bold text-white">${alliance.name}</h4>
                                    <p class="text-sm text-gray-400">Members: ${alliance.members ? Object.keys(alliance.members).length : 0}</p>
                                </div>
                            </div>
                            <div class="flex space-x-2">
                                ${isInAlliance 
                                    ? '<button class="py-1 px-3 bg-gray-600 text-white text-sm rounded cursor-not-allowed" disabled>Joined</button>' 
                                    : `<button class="join-alliance-btn py-1 px-3 bg-purple-600 hover:bg-purple-700 text-white text-sm rounded interactive-button" data-alliance="${alliance.id}">Join</button>`}
                            </div>
                        </div>`;
                }
                
                // Add event listeners to join alliance buttons
                document.querySelectorAll('.join-alliance-btn').forEach(button => {
                    button.addEventListener('click', async (e) => {
                        const allianceId = e.target.getAttribute('data-alliance');
                        await joinAlliance(allianceId);
                    });
                });
                
            } catch (error) {
                console.error("Error searching alliances:", error);
                alliancesList.innerHTML = '<p class="text-red-400 text-center">Error searching for alliances. Please try again.</p>';
            }
        }
        
        // Join an alliance
        async function joinAlliance(allianceId) {
            if (!currentUserData) return;
            
            try {
                // Get alliance data
                const allianceRef = ref(db, `alliances/${allianceId}`);
                const allianceSnap = await get(allianceRef);
                
                if (!allianceSnap.exists()) {
                    showModal("Alliance not found.");
                    return;
                }
                
                const alliance = allianceSnap.val();
                
                // Add user to alliance members
                const updatedMembers = {
                    ...alliance.members,
                    [currentUserData.uid]: {
                        name: currentUserData.clubName,
                        role: 'member',
                        joinDate: serverTimestamp()
                    }
                };
                
                await update(ref(db, `alliances/${allianceId}`), {
                    members: updatedMembers,
                    memberCount: Object.keys(updatedMembers).length
                });
                
                // Add alliance to user's alliances
                const userAlliances = currentUserData.alliances || [];
                if (!userAlliances.includes(allianceId)) {
                    userAlliances.push(allianceId);
                    await update(ref(db, `users/${currentUserData.uid}`), {
                        alliances: userAlliances
                    });
                    
                    // Update current user data in memory
                    currentUserData.alliances = userAlliances;
                }
                
                showModal(`Successfully joined ${alliance.name}!`);
                searchAlliances(); // Refresh search results
                
            } catch (error) {
                console.error("Error joining alliance:", error);
                showModal("Error joining alliance. Please try again.");
            }
        }

        // Store Tabs
        playersTab.addEventListener('click', () => {
            playersTab.classList.add('active');
            packsTab.classList.remove('active');
            itemsTab.classList.remove('active');
            storeItems.classList.remove('hidden');
            storePacks.classList.add('hidden');
            storeSpecialItems.classList.add('hidden');
        });

        packsTab.addEventListener('click', () => {
            packsTab.classList.add('active');
            playersTab.classList.remove('active');
            itemsTab.classList.remove('active');
            storePacks.classList.remove('hidden');
            storeItems.classList.add('hidden');
            storeSpecialItems.classList.add('hidden');
        });

        itemsTab.addEventListener('click', () => {
            itemsTab.classList.add('active');
            playersTab.classList.remove('active');
            packsTab.classList.remove('active');
            storeSpecialItems.classList.remove('hidden');
            storeItems.classList.add('hidden');
            storePacks.classList.add('hidden');
        });

        // Pack Opening Modal Controls
        packCloseBtn.addEventListener('click', () => {
            packOpeningModal.classList.add('hidden');
        });

        packOpenAgainBtn.addEventListener('click', () => {
            packOpeningModal.classList.add('hidden');
            navigateToView('store-view');
        });

        packDoneBtn.addEventListener('click', () => {
            packOpeningModal.classList.add('hidden');
        });

        // Daily Login System
        dailyLoginCloseBtn.addEventListener('click', () => {
            dailyLoginModal.classList.add('hidden');
        });

        dailyLoginClaimBtn.addEventListener('click', async () => {
            await claimDailyLoginReward();
            dailyLoginModal.classList.add('hidden');
        });

        async function checkDailyLogin(uid) {
            const userRef = ref(db, 'users/' + uid);
            const userSnap = await get(userRef);
            if (!userSnap.exists()) return;
            
            const userData = userSnap.val();
            const today = new Date().toDateString();
            const lastLogin = userData.lastLoginDate;
            let streak = userData.dailyLoginStreak || 1;
            
            // Check if user already logged in today
            if (lastLogin === today) return;
            
            // Check if streak continues (logged in yesterday)
            const yesterday = new Date();
            yesterday.setDate(yesterday.getDate() - 1);
            const yesterdayStr = yesterday.toDateString();
            
            if (lastLogin === yesterdayStr) {
                streak += 1;
            } else {
                streak = 1; // Reset streak
            }
            
            // Cap streak at 7 days
            if (streak > 7) streak = 7;
            
            // Show daily login modal
            showDailyLoginModal(streak);
            
            // Update user data
            await update(userRef, {
                lastLoginDate: today,
                dailyLoginStreak: streak
            });
        }

        function showDailyLoginModal(day) {
            document.getElementById('login-day').textContent = day;
            
            const rewards = [
                { day: 1, reward: "500 Coins" },
                { day: 2, reward: "10 Gems" },
                { day: 3, reward: "Bronze Pack" },
                { day: 4, reward: "1000 Coins" },
                { day: 5, reward: "20 Gems" },
                { day: 6, reward: "Silver Pack" },
                { day: 7, reward: "Gold Pack" }
            ];
            
            const todayReward = rewards[day - 1];
            document.getElementById('daily-reward-content').textContent = todayReward.reward;
            
            dailyLoginModal.classList.remove('hidden');
        }

        async function claimDailyLoginReward() {
            if (!currentUserData) return;
            
            const day = currentUserData.dailyLoginStreak || 1;
            const updates = {};
            
            switch(day) {
                case 1:
                    updates.balance = (currentUserData.balance || 0) + 500;
                    break;
                case 2:
                    updates.gems = (currentUserData.gems || 0) + 10;
                    break;
                case 3:
                    // Add bronze pack logic
                    await openPack('bronze_pack');
                    break;
                case 4:
                    updates.balance = (currentUserData.balance || 0) + 1000;
                    break;
                case 5:
                    updates.gems = (currentUserData.gems || 0) + 20;
                    break;
                case 6:
                    // Add silver pack logic
                    await openPack('silver_pack');
                    break;
                case 7:
                    // Add gold pack logic
                    await openPack('gold_pack');
                    break;
            }
            
            // Apply updates for non-pack rewards
            if (Object.keys(updates).length > 0) {
                await update(ref(db, 'users/' + currentUserData.uid), updates);
            }
            
            showModal(`Daily login reward claimed: ${getRewardDescription(day)}`);
        }

        function getRewardDescription(day) {
            const rewards = [
                "500 Coins",
                "10 Gems",
                "Bronze Pack",
                "1000 Coins",
                "20 Gems",
                "Silver Pack",
                "Gold Pack"
            ];
            
            return rewards[day - 1] || "Unknown Reward";
        }

        // Club Finances
        async function loadClubFinances() {
            const weeklyIncome = calculateWeeklyIncome();
            const weeklyExpenses = calculateWeeklyExpenses();
            const netProfit = weeklyIncome - weeklyExpenses;
            
            document.getElementById('weekly-income').textContent = `${weeklyIncome} Coins`;
            document.getElementById('weekly-expenses').textContent = `${weeklyExpenses} Coins`;
            document.getElementById('net-profit').textContent = `${netProfit} Coins`;
        }

        function calculateWeeklyIncome() {
            let income = 0;
            
            // Sponsorship income
            const sponsorships = currentUserData.sponsorshipDeals || {};
            for (const dealId in sponsorships) {
                if (sponsorships[dealId].active) {
                    income += sponsorships[dealId].income || 0;
                }
            }
            
            // Stadium income based on level
            const stadiumLevel = currentUserData.clubFacilities?.stadium?.level || 1;
            income += stadiumLevel * 200;
            
            return income;
        }

        function calculateWeeklyExpenses() {
            let expenses = 0;
            
            // Player salaries based on team power
            expenses += teamPower * 10;
            
            // Facility maintenance
            const facilities = currentUserData.clubFacilities || {
                stadium: { level: 1 },
                trainingGround: { level: 1 },
                youthAcademy: { level: 1 }
            };
            
            expenses += facilities.stadium.level * 100;
            expenses += facilities.trainingGround.level * 50;
            expenses += facilities.youthAcademy.level * 75;
            
            return expenses;
        }

        // Substitution System
        substitutionBtn.addEventListener('click', () => {
            openSubstitutionModal();
        });
        
        // Add function to open substitution modal
        function openSubstitutionModal() {
            if (!currentUserData || !currentUserData.squad) return;
            
            // Create a modal for substitutions
            const modalHtml = `
                <div id="substitution-modal" class="fixed inset-0 modal-backdrop flex items-center justify-center z-50">
                    <div class="bg-gray-900 rounded-xl shadow-2xl p-6 w-full max-w-4xl text-left border-4 border-purple-500 relative">
                        <button id="substitution-close-btn" class="absolute top-2 right-3 text-2xl text-gray-400 hover:text-white">&times;</button>
                        <h2 class="text-2xl font-bold text-purple-400 mb-4">In-Match Substitutions</h2>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                            <div>
                                <h3 class="text-xl font-bold text-white mb-3">Current Players</h3>
                                <div id="current-players-list" class="space-y-3 max-h-96 overflow-y-auto">
                                    <!-- Current players will be dynamically inserted here -->
                                </div>
                            </div>
                            <div>
                                <h3 class="text-xl font-bold text-white mb-3">Substitute Players</h3>
                                <div id="substitute-players-list" class="space-y-3 max-h-96 overflow-y-auto">
                                    <!-- Substitute players will be dynamically inserted here -->
                                </div>
                            </div>
                        </div>
                        <div class="mt-4 p-4 bg-gray-800 rounded-lg">
                            <h4 class="text-lg font-bold text-white mb-2">Substitution Rules</h4>
                            <ul class="text-sm text-gray-300 list-disc pl-5 space-y-1">
                                <li>Players with low stamina (&lt;30%) should be substituted</li>
                                <li>Injured players cannot be substituted on</li>
                                <li>Only 3 substitutions allowed per match</li>
                            </ul>
                        </div>
                        <div class="flex justify-center mt-6">
                            <button id="close-substitution-btn" class="py-2 px-6 bg-gray-700 hover:bg-gray-600 text-white font-bold rounded-lg interactive-button">Close</button>
                        </div>
                    </div>
                </div>`;
            
            // Add the modal to the document
            document.body.insertAdjacentHTML('beforeend', modalHtml);
            
            // Load players
            loadSubstitutionPlayers();
            
            // Add event listeners
            document.getElementById('substitution-close-btn').addEventListener('click', closeSubstitutionModal);
            document.getElementById('close-substitution-btn').addEventListener('click', closeSubstitutionModal);
        }
        
        // Add function to close substitution modal
        function closeSubstitutionModal() {
            const modal = document.getElementById('substitution-modal');
            if (modal) {
                modal.remove();
            }
        }
        
        // Add function to load players for substitution
        async function loadSubstitutionPlayers() {
            if (!currentUserData || !currentUserData.squad) return;
            
            const currentPlayersList = document.getElementById('current-players-list');
            const substitutePlayersList = document.getElementById('substitute-players-list');
            
            if (!currentPlayersList || !substitutePlayersList) return;
            
            currentPlayersList.innerHTML = '<p class="text-gray-400">Loading players...</p>';
            substitutePlayersList.innerHTML = '<p class="text-gray-400">Loading players...</p>';
            
            try {
                // Get all players in squad
                const playerPromises = currentUserData.squad.map(playerId => get(ref(db, 'players/' + playerId)));
                const playerSnapshots = await Promise.all(playerPromises);
                
                let currentPlayersHtml = '';
                let substitutePlayersHtml = '';
                
                // For demonstration, we'll show the first 5 as current players and the rest as substitutes
                playerSnapshots.forEach((playerSnap, index) => {
                    if (playerSnap.exists()) {
                        const playerData = playerSnap.val();
                        const playerId = currentUserData.squad[index];
                        const attributes = playerData.attributes || { pace: 50, shooting: 50, passing: 50, dribbling: 50, defending: 50, physical: 50 };
                        
                        // Check for player injuries and stamina
                        const isInjured = playerData.injury && playerData.injury > 0;
                        const stamina = playerData.stamina || 100;
                        
                        const playerHtml = `
                            <div class="player-card p-3 flex items-center justify-between relative">
                                ${isInjured ? '<div class="injury-indicator" title="Injured"><i class="fas fa-first-aid"></i></div>' : ''}
                                <div class="flex items-center">
                                    <img src="${playerData.imageUrl}" alt="${playerData.name}" class="w-12 h-12 object-cover rounded-full mr-3 border-2 border-gray-600">
                                    <div>
                                        <h4 class="font-bold text-white">${playerData.name}</h4>
                                        <p class="text-sm text-gray-400">${playerData.position}</p>
                                        <div class="mt-1">
                                            <div class="flex justify-between text-xs"><span>Stamina:</span><span>${stamina}%</span></div>
                                            <div class="stamina-bar"><div class="stamina-fill" style="width: ${stamina}%"></div></div>
                                        </div>
                                    </div>
                                </div>
                                <div class="text-right">
                                    <p class="font-bold text-green-400">${playerData.rating}</p>
                                    <button class="substitute-btn mt-1 px-2 py-1 bg-purple-600 hover:bg-purple-700 text-white text-xs rounded ${isInjured ? 'opacity-50 cursor-not-allowed' : ''}" data-player="${playerId}" ${isInjured ? 'disabled' : ''}>
                                        ${index < 5 ? 'Sub Off' : 'Sub On'}
                                    </button>
                                </div>
                            </div>`;
                        
                        if (index < 5) {
                            currentPlayersHtml += playerHtml;
                        } else {
                            substitutePlayersHtml += playerHtml;
                        }
                    }
                });
                
                currentPlayersList.innerHTML = currentPlayersHtml || '<p class="text-gray-400">No current players.</p>';
                substitutePlayersList.innerHTML = substitutePlayersHtml || '<p class="text-gray-400">No substitute players.</p>';
                
                // Add event listeners to substitute buttons
                document.querySelectorAll('.substitute-btn').forEach(button => {
                    button.addEventListener('click', (e) => {
                        const playerId = e.target.getAttribute('data-player');
                        makeSubstitution(playerId);
                    });
                });
            } catch (error) {
                console.error("Error loading substitution players:", error);
                currentPlayersList.innerHTML = '<p class="text-red-400">Error loading players.</p>';
                substitutePlayersList.innerHTML = '<p class="text-red-400">Error loading players.</p>';
            }
        }
        
        // Add function to make substitution
        async function makeSubstitution(playerId) {
            if (!currentUserData || !currentMatchId) return;
            
            // Get match data
            const matchRef = ref(db, `matches/${currentMatchId}`);
            const matchSnap = await get(matchRef);
            
            if (!matchSnap.exists()) {
                showModal("Match not found.");
                return;
            }
            
            const matchData = matchSnap.val();
            
            // Determine which team the current user is on
            let userTeam, opponentTeam;
            if (currentUserData.uid === matchData.teamA.uid) {
                userTeam = 'teamA';
                opponentTeam = 'teamB';
            } else if (currentUserData.uid === matchData.teamB.uid) {
                userTeam = 'teamB';
                opponentTeam = 'teamA';
            } else {
                showModal("You are not part of this match.");
                return;
            }
            
            // Check if player is in user's squad
            const playerIndex = matchData[userTeam].squad.indexOf(playerId);
            const isPlayerInStartingEleven = playerIndex >= 0 && playerIndex < 5;
            const isPlayerSubstitute = playerIndex >= 5;
            
            if (!matchData[userTeam].squad.includes(playerId)) {
                showModal("You can only substitute your own players.");
                return;
            }
            
            // Get player data
            const playerRef = ref(db, `players/${playerId}`);
            const playerSnap = await get(playerRef);
            
            if (!playerSnap.exists()) {
                showModal("Player not found.");
                return;
            }
            
            const playerData = playerSnap.val();
            
            // Check if player is injured
            const isInjured = playerData.injury && playerData.injury > 0;
            if (isInjured && !isPlayerInStartingEleven) {
                showModal("Cannot substitute an injured player on.");
                return;
            }
            
            // Check substitution count (max 3 per match)
            const substitutionsMade = matchData[userTeam].substitutions || 0;
            if (substitutionsMade >= 3 && isPlayerInStartingEleven) {
                showModal("Maximum substitutions (3) already made.");
                return;
            }
            
            // In a real implementation, you would update the match state with the substitution
            // For now, we'll just show a message and update the UI
            if (playerSnap.exists()) {
                // Add a commentary event for the substitution
                const seconds = matchData.startTime ? Math.floor((Date.now() - matchData.startTime) / 1000) : 0;
                await push(ref(db, `matches/${currentMatchId}/events`), { 
                    time: `${seconds}'`, 
                    text: `üîÑ ${matchData[userTeam].clubName} makes a substitution: ${playerData.name} comes on.` 
                });
                
                // Update substitution count
                if (isPlayerInStartingEleven) {
                    await update(matchRef, {
                        [`${userTeam}.substitutions`]: substitutionsMade + 1
                    });
                }
                
                showModal(`Substitution made for player ${playerData.name}!`);
            } else {
                showModal(`Substitution made for player ${playerId}!`);
            }
            
            // Refresh the substitution modal
            loadSubstitutionPlayers();
        }

        // Add sound effects to buttons
        document.querySelectorAll('.interactive-button').forEach(button => {
            button.addEventListener('click', () => {
                playSound(buttonSound);
            });
        });

        // Navigation
        navLinks.forEach(link => {
            link.addEventListener('click', (e) => {
                e.preventDefault();
                const targetId = link.getAttribute('href').substring(1);
                if(targetId === 'home') { navigateToView('home-view'); } 
                else { navigateToView(targetId + '-view'); }
            });
        });
        
        // Tab navigation for new views
        document.getElementById('friends-tab').addEventListener('click', () => {
            document.getElementById('friends-tab').classList.add('active');
            document.getElementById('alliances-tab').classList.remove('active');
            document.getElementById('friends-content').classList.remove('hidden');
            document.getElementById('alliances-content').classList.add('hidden');
        });
        
        document.getElementById('alliances-tab').addEventListener('click', () => {
            document.getElementById('alliances-tab').classList.add('active');
            document.getElementById('friends-tab').classList.remove('active');
            document.getElementById('alliances-content').classList.remove('hidden');
            document.getElementById('friends-content').classList.add('hidden');
        });
        
        document.getElementById('buy-players-tab').addEventListener('click', () => {
            document.getElementById('buy-players-tab').classList.add('active');
            document.getElementById('sell-players-tab').classList.remove('active');
            document.getElementById('buy-players-content').classList.remove('hidden');
            document.getElementById('sell-players-content').classList.add('hidden');
        });
        
        document.getElementById('sell-players-tab').addEventListener('click', () => {
            document.getElementById('sell-players-tab').classList.add('active');
            document.getElementById('buy-players-tab').classList.remove('active');
            document.getElementById('sell-players-content').classList.remove('hidden');
            document.getElementById('buy-players-content').classList.add('hidden');
        });
        
        // Add event listeners for the live transfer modal
        if (liveTransferCloseBtn) {
            liveTransferCloseBtn.addEventListener('click', () => {
                liveTransferModal.classList.add('hidden');
            });
        }

        if (liveTransferCloseBtn2) {
            liveTransferCloseBtn2.addEventListener('click', () => {
                liveTransferModal.classList.add('hidden');
            });
        }
        
        // Add event listener for the button to open live transfer market
        const openLiveMarketBtn = document.getElementById('open-live-market-btn');
        if (openLiveMarketBtn) {
            openLiveMarketBtn.addEventListener('click', () => {
                openLiveTransferMarket();
            });
        }

        // Add function to open the live transfer market modal
        function openLiveTransferMarket() {
            if (liveTransferModal) {
                liveTransferModal.classList.remove('hidden');
                loadLiveTransferMarket();
            }
        }

        // Add function to load the live transfer market
        async function loadLiveTransferMarket() {
            if (!currentUserData) return;
            
            // Load players available for buying
            loadLiveTransferListings();
            
            // Load user's players for selling
            loadSellPlayerListLive();
        }

        // Add function to load live transfer listings
        async function loadLiveTransferListings() {
            const liveTransferListDiv = document.getElementById('live-transfer-list');
            if (!liveTransferListDiv) return;
            
            liveTransferListDiv.innerHTML = '<p class="text-center p-4 text-gray-400">Loading listings...</p>';
            
            try {
                // Get active listings from Firebase
                const listingsRef = ref(db, 'transferListings');
                const snapshot = await get(listingsRef);
                
                if (snapshot.exists()) {
                    const listings = snapshot.val();
                    let listingsHtml = '';
                    
                    // Display each listing
                    for (const listingId in listings) {
                        const listing = listings[listingId];
                        // Skip if it's the current user's listing
                        if (listing.sellerId === currentUserData.uid) continue;
                        
                        // Skip if listing has expired
                        const now = Date.now();
                        if (listing.endTime && now > listing.endTime) continue;
                        
                        // Get player data
                        const playerRef = ref(db, 'players/' + listing.playerId);
                        const playerSnap = await get(playerRef);
                        
                        if (playerSnap.exists()) {
                            const playerData = playerSnap.val();
                            const rarity = playerData.rarity || "bronze";
                            const rarityClass = rarity === "bronze" ? "bronze" : 
                                               rarity === "silver" ? "silver" : 
                                               rarity === "gold" ? "gold" : "special";
                            
                            const timeLeft = listing.endTime ? Math.max(0, Math.floor((listing.endTime - now) / (1000 * 60))) : 0;
                            
                            listingsHtml += `
                                <div class="player-card p-4 text-center shadow-lg ${rarityClass} relative">
                                    <img src="${playerData.imageUrl}" alt="${playerData.name}" class="w-24 h-24 object-cover rounded-full mx-auto mb-3 border-2 border-gray-600">
                                    <h4 class="font-bold text-lg text-white">${playerData.name}</h4>
                                    <p class="text-sm text-gray-400">${playerData.position}</p>
                                    <p class="text-xl font-bold text-green-400 mt-2">${playerData.rating}</p>
                                    <div class="mt-3 text-left">
                                        <p class="text-sm"><span class="font-semibold">Seller:</span> ${listing.sellerName}</p>
                                        <p class="text-sm"><span class="font-semibold">Starting Bid:</span> ${listing.startingBid || 0} C</p>
                                        ${listing.buyNowPrice ? `<p class="text-sm"><span class="font-semibold">Buy Now:</span> ${listing.buyNowPrice} C</p>` : ''}
                                        <p class="text-sm"><span class="font-semibold">Time Left:</span> ${timeLeft} min</p>
                                    </div>
                                    <div class="flex space-x-2 mt-3">
                                        <button onclick="placeBid('${listingId}', ${listing.currentBid || listing.startingBid || 0})" class="flex-1 py-1 px-2 bg-blue-600 hover:bg-blue-700 text-white text-xs rounded interactive-button">Bid</button>
                                        ${listing.buyNowPrice ? `<button onclick="buyNow('${listingId}', ${listing.buyNowPrice})" class="flex-1 py-1 px-2 bg-green-600 hover:bg-green-700 text-white text-xs rounded interactive-button">Buy Now</button>` : ''}
                                    </div>
                                </div>`;
                        }
                    }
                    
                    liveTransferListDiv.innerHTML = listingsHtml || '<p class="text-center p-4 text-gray-400">No active listings found.</p>';
                } else {
                    liveTransferListDiv.innerHTML = '<p class="text-center p-4 text-gray-400">No active listings found.</p>';
                }
            } catch (error) {
                console.error("Error loading live transfer listings:", error);
                liveTransferListDiv.innerHTML = '<p class="text-center p-4 text-red-400">Error loading listings. Please try again.</p>';
            }
        }

        // Add function to load user's players for selling
        async function loadSellPlayerListLive() {
            const sellPlayerListDiv = document.getElementById('sell-player-list-live');
            if (!sellPlayerListDiv || !currentUserData || !currentUserData.squad) return;
            
            sellPlayerListDiv.innerHTML = '<p class="text-center p-4 text-gray-400">Loading your players...</p>';
            
            try {
                const playerPromises = currentUserData.squad.map(playerId => get(ref(db, 'players/' + playerId)));
                const playerSnapshots = await Promise.all(playerPromises);
                
                let playersHtml = '';
                playerSnapshots.forEach((playerSnap, index) => {
                    if (playerSnap.exists()) {
                        const playerData = playerSnap.val();
                        const playerId = currentUserData.squad[index];
                        
                        playersHtml += `
                            <div class="player-card p-4 text-center shadow-lg">
                                <img src="${playerData.imageUrl}" alt="${playerData.name}" class="w-24 h-24 object-cover rounded-full mx-auto mb-3 border-2 border-gray-600">
                                <h4 class="font-bold text-lg">${playerData.name}</h4>
                                <p class="text-sm text-gray-400">${playerData.position}</p>
                                <p class="text-xl font-bold text-green-400 mt-2">${playerData.rating}</p>
                                <button onclick="openListPlayerModal('${playerId}')" class="w-full mt-3 py-2 px-4 bg-yellow-600 hover:bg-yellow-700 text-white font-bold rounded-md interactive-button">List for Sale</button>
                            </div>`;
                    }
                });
                
                sellPlayerListDiv.innerHTML = playersHtml || '<p class="text-center p-4 text-gray-400">No players available to sell.</p>';
            } catch (error) {
                console.error("Error loading sell player list:", error);
                sellPlayerListDiv.innerHTML = '<p class="text-center p-4 text-red-400">Error loading players. Please try again.</p>';
            }
        }

        // Add function to open the list player modal
        function openListPlayerModal(playerId) {
            // Create a modal for listing a player
            const modalHtml = `
                <div id="list-player-modal" class="fixed inset-0 modal-backdrop flex items-center justify-center z-50">
                    <div class="bg-gray-900 rounded-xl shadow-2xl p-6 w-full max-w-md text-left border-4 border-yellow-500 relative">
                        <button id="list-player-close-btn" class="absolute top-2 right-3 text-2xl text-gray-400 hover:text-white">&times;</button>
                        <h2 class="text-2xl font-bold text-yellow-400 mb-4">List Player for Sale</h2>
                        <div class="space-y-4">
                            <div>
                                <label class="block text-gray-300 mb-2">Starting Bid (Coins)</label>
                                <input type="number" id="starting-bid" min="100" value="1000" class="w-full px-4 py-2 bg-gray-700 border border-gray-600 rounded-lg text-white">
                            </div>
                            <div>
                                <label class="block text-gray-300 mb-2">Buy Now Price (optional)</label>
                                <input type="number" id="buy-now-price" min="0" value="0" class="w-full px-4 py-2 bg-gray-700 border border-gray-600 rounded-lg text-white">
                                <p class="text-xs text-gray-500 mt-1">Set to 0 if you don't want a Buy Now option</p>
                            </div>
                            <div>
                                <label class="block text-gray-300 mb-2">Listing Duration</label>
                                <select id="listing-duration" class="w-full px-4 py-2 bg-gray-700 border border-gray-600 rounded-lg text-white">
                                    <option value="60">1 hour</option>
                                    <option value="120">2 hours</option>
                                    <option value="240">4 hours</option>
                                    <option value="480">8 hours</option>
                                    <option value="1440">24 hours</option>
                                </select>
                            </div>
                            <div class="flex space-x-3 pt-4">
                                <button id="cancel-list-btn" class="flex-1 py-2 px-4 bg-gray-700 hover:bg-gray-600 text-white font-bold rounded-lg interactive-button">Cancel</button>
                                <button id="confirm-list-btn" class="flex-1 py-2 px-4 bg-green-600 hover:bg-green-700 text-white font-bold rounded-lg interactive-button" data-player="${playerId}">List Player</button>
                            </div>
                        </div>
                    </div>
                </div>`;
            
            // Add the modal to the document
            document.body.insertAdjacentHTML('beforeend', modalHtml);
            
            // Add event listeners
            document.getElementById('list-player-close-btn').addEventListener('click', closeListPlayerModal);
            document.getElementById('cancel-list-btn').addEventListener('click', closeListPlayerModal);
            document.getElementById('confirm-list-btn').addEventListener('click', async (e) => {
                const playerId = e.target.getAttribute('data-player');
                await listPlayerForSale(playerId);
            });
        }

        // Add function to close the list player modal
        function closeListPlayerModal() {
            const modal = document.getElementById('list-player-modal');
            if (modal) {
                modal.remove();
            }
        }

        // Add function to list a player for sale
        async function listPlayerForSale(playerId) {
            if (!currentUserData) return;
            
            const startingBid = parseInt(document.getElementById('starting-bid').value) || 1000;
            const buyNowPrice = parseInt(document.getElementById('buy-now-price').value) || 0;
            const duration = parseInt(document.getElementById('listing-duration').value) || 60; // in minutes
            
            // Validate inputs
            if (startingBid < 100) {
                showModal("Starting bid must be at least 100 coins.");
                return;
            }
            
            if (buyNowPrice > 0 && buyNowPrice <= startingBid) {
                showModal("Buy Now price must be higher than the starting bid.");
                return;
            }
            
            try {
                // Create the listing in Firebase
                const listingRef = push(ref(db, 'transferListings'));
                const endTime = Date.now() + (duration * 60 * 1000); // Convert minutes to milliseconds
                
                const listingData = {
                    playerId: playerId,
                    sellerId: currentUserData.uid,
                    sellerName: currentUserData.clubName,
                    startingBid: startingBid,
                    currentBid: startingBid,
                    buyNowPrice: buyNowPrice > 0 ? buyNowPrice : null,
                    endTime: endTime,
                    createdAt: serverTimestamp(),
                    bids: {}
                };
                
                await set(listingRef, listingData);
                
                // Add to user's active listings
                const userActiveListings = currentUserData.activeListings || [];
                userActiveListings.push(listingRef.key);
                
                await update(ref(db, 'users/' + currentUserData.uid), {
                    activeListings: userActiveListings
                });
                
                closeListPlayerModal();
                showModal("Player listed successfully!");
                loadSellPlayerListLive(); // Refresh the sell list
                loadLiveTransferListings(); // Refresh the market listings
            } catch (error) {
                console.error("Error listing player:", error);
                showModal("Failed to list player: " + error.message);
            }
        }

        // Add function to place a bid on a listing
        async function placeBid(listingId, currentBid) {
            if (!currentUserData) return;
            
            // Prompt for bid amount
            const bidAmount = prompt(`Enter your bid amount (minimum ${currentBid + 100} coins):`, currentBid + 100);
            if (!bidAmount) return;
            
            const bidValue = parseInt(bidAmount);
            if (isNaN(bidValue) || bidValue < currentBid + 100) {
                showModal(`Bid must be at least ${currentBid + 100} coins.`);
                return;
            }
            
            if (bidValue > currentUserData.balance) {
                showModal("You don't have enough coins for this bid.");
                return;
            }
            
            try {
                // Update the listing with the new bid
                const listingRef = ref(db, 'transferListings/' + listingId);
                const listingSnap = await get(listingRef);
                
                if (!listingSnap.exists()) {
                    showModal("This listing is no longer available.");
                    return;
                }
                
                const listing = listingSnap.val();
                
                // Check if listing has expired
                if (listing.endTime && Date.now() > listing.endTime) {
                    showModal("This listing has expired.");
                    return;
                }
                
                // Check if there's already a higher bid
                if (bidValue <= (listing.currentBid || listing.startingBid)) {
                    showModal("There is already a higher bid on this listing.");
                    return;
                }
                
                // Update the listing
                const updates = {
                    currentBid: bidValue,
                    [`bids/${currentUserData.uid}`]: {
                        bidderName: currentUserData.clubName,
                        bidAmount: bidValue,
                        timestamp: serverTimestamp()
                    }
                };
                
                await update(listingRef, updates);
                
                // Deduct coins from bidder (will be refunded if outbid)
                await update(ref(db, 'users/' + currentUserData.uid), {
                    balance: currentUserData.balance - bidValue
                });
                
                showModal("Bid placed successfully!");
                loadLiveTransferListings(); // Refresh listings
            } catch (error) {
                console.error("Error placing bid:", error);
                showModal("Failed to place bid: " + error.message);
            }
        }

        // Add function to buy a player immediately
        async function buyNow(listingId, buyNowPrice) {
            if (!currentUserData) return;
            
            if (buyNowPrice > currentUserData.balance) {
                showModal("You don't have enough coins to buy this player.");
                return;
            }
            
            // Confirm purchase
            if (!confirm(`Are you sure you want to buy this player for ${buyNowPrice} coins?`)) {
                return;
            }
            
            try {
                // Get the listing
                const listingRef = ref(db, 'transferListings/' + listingId);
                const listingSnap = await get(listingRef);
                
                if (!listingSnap.exists()) {
                    showModal("This listing is no longer available.");
                    return;
                }
                
                const listing = listingSnap.val();
                
                // Check if listing has expired
                if (listing.endTime && Date.now() > listing.endTime) {
                    showModal("This listing has expired.");
                    return;
                }
                
                // Check if the buy now price is still valid
                if (listing.buyNowPrice !== buyNowPrice) {
                    showModal("The buy now price has changed. Please refresh the page.");
                    return;
                }
                
                // Process the transfer
                await processPlayerTransfer(listingId, buyNowPrice, 'buyNow');
                
                showModal("Player purchased successfully!");
                loadLiveTransferListings(); // Refresh listings
                loadSellPlayerListLive(); // Refresh sell list
            } catch (error) {
                console.error("Error buying player:", error);
                showModal("Failed to buy player: " + error.message);
            }
        }

        // Add function to process player transfer
        async function processPlayerTransfer(listingId, amount, transferType) {
            if (!currentUserData) return;
            
            try {
                // Get the listing
                const listingRef = ref(db, 'transferListings/' + listingId);
                const listingSnap = await get(listingRef);
                
                if (!listingSnap.exists()) {
                    throw new Error("Listing not found");
                }
                
                const listing = listingSnap.val();
                
                // Get player data
                const playerRef = ref(db, 'players/' + listing.playerId);
                const playerSnap = await get(playerRef);
                
                if (!playerSnap.exists()) {
                    throw new Error("Player not found");
                }
                
                const playerData = playerSnap.val();
                
                // Update buyer's squad and balance
                const buyerSquad = [...(currentUserData.squad || []), listing.playerId];
                const buyerBalance = currentUserData.balance - amount;
                
                // Update seller's balance
                const sellerRef = ref(db, 'users/' + listing.sellerId);
                const sellerSnap = await get(sellerRef);
                
                if (!sellerSnap.exists()) {
                    throw new Error("Seller not found");
                }
                
                const sellerData = sellerSnap.val();
                const sellerBalance = (sellerData.balance || 0) + amount;
                
                // Update seller's squad (remove player)
                let sellerSquad = sellerData.squad || [];
                sellerSquad = sellerSquad.filter(id => id !== listing.playerId);
                
                // Create transaction record
                const transactionRef = push(ref(db, 'transactions'));
                const transactionData = {
                    playerId: listing.playerId,
                    playerName: playerData.name,
                    buyerId: currentUserData.uid,
                    buyerName: currentUserData.clubName,
                    sellerId: listing.sellerId,
                    sellerName: listing.sellerName,
                    amount: amount,
                    transferType: transferType,
                    timestamp: serverTimestamp()
                };
                
                // Perform all updates in a single transaction
                const updates = {};
                updates[`/users/${currentUserData.uid}/squad`] = buyerSquad;
                updates[`/users/${currentUserData.uid}/balance`] = buyerBalance;
                updates[`/users/${listing.sellerId}/squad`] = sellerSquad;
                updates[`/users/${listing.sellerId}/balance`] = sellerBalance;
                updates[`/transferListings/${listingId}`] = null; // Remove the listing
                updates[`/transactions/${transactionRef.key}`] = transactionData;
                
                // Remove from seller's active listings
                if (sellerData.activeListings) {
                    const updatedListings = sellerData.activeListings.filter(id => id !== listingId);
                    updates[`/users/${listing.sellerId}/activeListings`] = updatedListings;
                }
                
                await update(ref(db), updates);
                
                // Update current user data in memory
                currentUserData.squad = buyerSquad;
                currentUserData.balance = buyerBalance;
            } catch (error) {
                console.error("Error processing transfer:", error);
                throw error;
            }
        }
        
        document.addEventListener('DOMContentLoaded', () => {
            const balancedBtn = document.querySelector('#in-match-strategy-control [data-strategy="Balanced"]');
            if(balancedBtn) balancedBtn.classList.add('border-2', 'border-yellow-400', 'ring-2', 'ring-yellow-400');
            if (!auth.currentUser) {} else { navigateToView('home-view'); }
        });
        
        document.addEventListener('click', () => {
             if (mainMenuAudio.paused && currentMatchId === null) { playMainMenuMusic(); }
        }, { once: true }); 

    </script>
</body>
</html>
                throw error;
            }
        }
        
        document.addEventListener('DOMContentLoaded', () => {
            const balancedBtn = document.querySelector('#in-match-strategy-control [data-strategy="Balanced"]');
            if(balancedBtn) balancedBtn.classList.add('border-2', 'border-yellow-400', 'ring-2', 'ring-yellow-400');
            if (!auth.currentUser) {} else { navigateToView('home-view'); }
        });
        
        document.addEventListener('click', () => {
             if (mainMenuAudio.paused && currentMatchId === null) { playMainMenuMusic(); }
        }, { once: true }); 

    </script>
</body>
</html>
        
        document.addEventListener('DOMContentLoaded', () => {
            const balancedBtn = document.querySelector('#in-match-strategy-control [data-strategy="Balanced"]');
            if(balancedBtn) balancedBtn.classList.add('border-2', 'border-yellow-400', 'ring-2', 'ring-yellow-400');
            if (!auth.currentUser) {} else { navigateToView('home-view'); }
        });
        
        document.addEventListener('click', () => {
             if (mainMenuAudio.paused && currentMatchId === null) { playMainMenuMusic(); }
        }, { once: true }); 

    </script>
</body>
</html>

    </script>
</body>
</html>
