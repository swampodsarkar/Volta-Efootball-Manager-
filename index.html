<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>‚öΩ Volta Efootball Manager</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@300;400;500;700;900&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css">
    <style>
        /* New "Green Glow" UI Theme */
        body {
            font-family: 'Roboto', sans-serif;
            background-color: #0d1117;
            color: #ffffff;
            overflow: hidden; 
        }
        
        #game-background {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-image: url('https://c4.wallpaperflare.com/wallpaper/468/371/692/soccer-neymar-brazilian-footballer-hd-wallpaper-preview.jpg'); /* Thematic Background */
            background-size: cover;
            background-position: center;
            z-index: -1;
            filter: brightness(0.4); 
        }

        .nav-card, .stat-card, .player-card, .tournament-card, .mission-card, .reward-item, .pack-card {
            background: linear-gradient(135deg, rgba(14, 51, 26, 0.85), rgba(22, 79, 45, 0.9)); /* Greenish Gradient */
            backdrop-filter: blur(10px);
            border: 1px solid rgba(0, 255, 153, 0.4); /* Greenish Border */
            border-radius: 12px;
            box-shadow: 0 0 15px rgba(50, 255, 150, 0.2); /* Green Glow Effect */
            transition: transform 0.2s ease-in-out, box-shadow 0.2s ease-in-out, border-color 0.2s ease-in-out;
        }

        .nav-card:hover, .stat-card:hover, .player-card:hover, .tournament-card:hover, .mission-card:hover, .pack-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 8px 30px rgba(0, 0, 0, 0.7), 0 0 25px rgba(50, 255, 150, 0.5); /* Enhanced Glow on Hover */
            border-color: #39ff14; /* Neon green accent on hover */
        }
        
        .interactive-button { transition: transform 0.1s ease-out; }
        .interactive-button:active { transform: scale(0.95); }
        
        /* Modal & Loader styles */
        .hidden { display: none; }
        .modal-backdrop { background-color: rgba(0,0,0,0.85); }
        .animate-bounce { animation: bounce 1.5s infinite; }
        @keyframes bounce {
            0%, 100% { transform: translateY(-25%); animation-timing-function: cubic-bezier(0.8, 0, 1, 1); }
            50% { transform: translateY(0); animation-timing-function: cubic-bezier(0, 0, 0.2, 1); }
        }
        #loading-bar { animation: loading-progress 2.5s ease-in-out infinite; }
        @keyframes loading-progress { 0% { width: 0%; } 100% { width: 100%; } }
        
        .btn-primary {
             background-color: #00c5a4;
             color: white;
             font-weight: 700;
             transition: background-color 0.3s, transform 0.1s ease-out;
             border: 1px solid #39ff14;
        }
        .btn-primary:hover { background-color: #00a88e; }
        .btn-primary:active { transform: scale(0.95); }

        .top-bar {
            background: linear-gradient(to right, rgba(15, 20, 28, 0.9), rgba(25, 32, 42, 0.8));
            border-bottom: 1px solid #30363d;
        }
        .left-sidebar {
            background: rgba(15, 20, 28, 0.9);
            border-right: 1px solid #30363d;
        }
        .left-sidebar .nav-link:hover, .left-sidebar .nav-link.active {
            background-color: #00c5a4;
            color: #ffffff;
        }
        .bottom-nav {
            background: linear-gradient(to right, rgba(15, 20, 28, 0.95), rgba(25, 32, 42, 0.9));
            border-top: 1px solid #30363d;
        }
        .bottom-nav .nav-link:hover span {
             color: #39ff14;
        }
        
        .promo-card {
            background-size: cover; background-position: center; border-radius: 16px;
            overflow: hidden; border: 2px solid #30363d;
        }
        .promo-card .overlay { background: linear-gradient(to top, rgba(0,0,0,0.9) 0%, rgba(0,0,0,0.1) 100%); }
        
        .chat-message { max-width: 80%; padding: 8px 12px; border-radius: 15px; word-wrap: break-word; font-size: 0.95rem; }
        .message-me { margin-left: auto; background-color: #00c5a4; color: white; }
        .message-other { margin-right: auto; background-color: #30363d; color: #ffffff; }

        /* XP Bar Styles */
        .xp-bar-container {
            width: 100px;
            height: 8px;
            background-color: #2c3a47;
            border-radius: 4px;
            overflow: hidden;
            border: 1px solid #444;
        }
        #xp-bar-fill {
            height: 100%;
            background: linear-gradient(to right, #39ff14, #2cffa1);
            border-radius: 4px;
            transition: width 0.5s ease-in-out;
        }
        /* Season Pass Progress Bar */
        .season-pass-progress-container {
            background-color: #2c3a47;
            border-radius: 8px;
            overflow: hidden;
            border: 1px solid #444;
            padding: 4px;
        }
        #season-pass-progress-fill {
            height: 1rem;
            background: linear-gradient(to right, #a855f7, #ec4899);
            border-radius: 6px;
            transition: width 0.5s ease-in-out;
        }
        .tab-button.active {
            background-color: #00c5a4;
            color: white;
            border-bottom-color: #39ff14;
        }

        /* In-match emoji reaction */
        #emoji-reaction-container {
            position: absolute;
            bottom: 80px;
            right: 20px;
            z-index: 50;
        }
        #emoji-panel {
            background-color: rgba(13, 17, 23, 0.9);
            border: 1px solid #39ff14;
            border-radius: 10px;
            padding: 8px;
            display: flex;
            gap: 8px;
        }
        .emoji { cursor: pointer; font-size: 24px; transition: transform 0.1s; }
        .emoji:hover { transform: scale(1.2); }
        .reaction-display {
             position: absolute;
             bottom: 150px;
             left: 50%;
             transform: translateX(-50%);
             font-size: 4rem;
             animation: fade-up-out 2s forwards;
             text-shadow: 0 0 10px #000;
        }
        @keyframes fade-up-out {
            0% { transform: translate(-50%, 0); opacity: 1; }
            100% { transform: translate(-50%, -100px); opacity: 0; }
        }

        /* Player attribute bars */
        .attribute-bar {
            height: 8px;
            background-color: #2c3a47;
            border-radius: 4px;
            overflow: hidden;
            margin-top: 4px;
        }
        .attribute-fill {
            height: 100%;
            border-radius: 4px;
            transition: width 0.5s ease-in-out;
        }
        .pace-fill { background: linear-gradient(to right, #39ff14, #2cffa1); }
        .shooting-fill { background: linear-gradient(to right, #ff6b6b, #ff8e8e); }
        .passing-fill { background: linear-gradient(to right, #4dabf7, #74c0fc); }
        .dribbling-fill { background: linear-gradient(to right, #ffd43b, #ffe066); }
        .defending-fill { background: linear-gradient(to right, #9775fa, #b197fc); }
        .physical-fill { background: linear-gradient(to right, #ff922b, #ffa94d); }

        /* Pack opening animation */
        @keyframes pack-shake {
            0%, 100% { transform: translateX(0); }
            10%, 30%, 50%, 70%, 90% { transform: translateX(-5px); }
            20%, 40%, 60%, 80% { transform: translateX(5px); }
        }
        .pack-shake {
            animation: pack-shake 0.5s;
        }
        @keyframes card-reveal {
            0% { transform: scale(0.5) rotateY(0deg); opacity: 0; }
            50% { transform: scale(1.1) rotateY(180deg); opacity: 1; }
            100% { transform: scale(1) rotateY(360deg); opacity: 1; }
        }
        .card-reveal {
            animation: card-reveal 1s forwards;
        }

        /* Formation selector */
        .formation-option {
            border: 2px solid transparent;
            transition: all 0.2s;
        }
        .formation-option:hover, .formation-option.selected {
            border-color: #39ff14;
            box-shadow: 0 0 10px rgba(57, 255, 20, 0.5);
        }

        /* Player card rarity colors */
        .bronze { border-color: #cd7f32; box-shadow: 0 0 10px rgba(205, 127, 50, 0.5); }
        .silver { border-color: #c0c0c0; box-shadow: 0 0 10px rgba(192, 192, 192, 0.5); }
        .gold { border-color: #ffd700; box-shadow: 0 0 10px rgba(255, 215, 0, 0.5); }
        .special { border-color: #a855f7; box-shadow: 0 0 15px rgba(168, 85, 247, 0.7); }

    </style>
</head>
<body class="overflow-hidden">
    
    <div id="game-background"></div>

    <audio id="main-menu-audio" loop>
        <source src="asset/main menu.mp3" type="audio/mpeg">
    </audio>
    <audio id="match-audio" loop>
        <source src="asset/match.mp3" type="audio/mpeg">
    </audio>
    <audio id="goal-sound">
        <source src="asset/goal.mp3" type="audio/mpeg">
    </audio>
    <audio id="whistle-sound">
        <source src="asset/whistle.mp3" type="audio/mpeg">
    </audio>
    <audio id="button-sound">
        <source src="asset/button.mp3" type="audio/mpeg">
    </audio>
    <audio id="pack-open-sound">
        <source src="asset/pack.mp3" type="audio/mpeg">
    </audio>

    <div id="game-container-wrapper" class="w-full h-screen">

        <div id="full-screen-loader" class="fixed inset-0 bg-[#0d1117] bg-opacity-95 flex flex-col items-center justify-center z-[100]">
            <div class="flex flex-col items-center justify-center">
                <div class="text-6xl mb-6 animate-bounce">‚öΩ</div>
                <h1 class="text-4xl font-extrabold text-green-400 mb-4 tracking-wider">Volta Efootball Manager</h1>
                <div class="w-full max-w-sm bg-gray-700 rounded-full h-2.5">
                    <div id="loading-bar" class="bg-green-400 h-2.5 rounded-full"></div>
                </div>
                <p class="text-lg font-bold text-gray-300 mt-4">Loading by SWAMPOD X MITHUN...</p>
            </div>
        </div>
        <div id="promo-banner-modal" class="hidden fixed inset-0 modal-backdrop flex items-center justify-center z-50">
            <div class="bg-gray-900 rounded-xl shadow-2xl p-6 w-full max-w-lg text-center border-4 border-yellow-500 relative">
                <img id="promo-image" src="" alt="Promotional Banner" class="w-full h-auto rounded-lg mb-4 hidden">
                <a id="promo-link" href="#" target="_blank" class="hidden w-full py-3 btn-primary rounded-lg mb-4 hover:bg-teal-600">Learn More</a>
                <button id="promo-close-btn" class="mt-4 py-2 px-6 bg-gray-700 hover:bg-gray-600 text-white font-bold rounded-lg interactive-button">Close</button>
            </div>
        </div>
        <div id="maintenance-mode" class="hidden fixed inset-0 modal-backdrop flex items-center justify-center z-50">
            <div class="text-center p-8 bg-gray-800 rounded-lg shadow-xl border border-green-500">
                <h2 id="maintenance-title" class="text-3xl font-bold text-yellow-400 mb-4">‚ö†Ô∏è Maintenance in Progress</h2>
                <p id="maintenance-message" class="text-lg text-gray-300">The game is on maintenance, will back shortly.</p>
            </div>
        </div>
        <div id="banned-screen" class="hidden fixed inset-0 modal-backdrop flex items-center justify-center z-50">
            <div class="text-center p-8 bg-gray-800 rounded-lg shadow-xl border border-red-500">
                <h2 class="text-3xl font-bold text-red-400 mb-4">üö´ You are Banned</h2>
                <p class="text-lg text-gray-300">Please contact support for assistance: <a href="mailto:voltaefootball@gmail.com" class="text-green-400 hover:underline">voltaefootball@gmail.com</a></p>
            </div>
        </div>
        <div id="custom-modal" class="hidden fixed inset-0 modal-backdrop flex items-center justify-center z-50">
            <div class="bg-gray-900 rounded-lg shadow-2xl p-6 w-full max-w-sm text-center border border-green-500">
                <p id="modal-message" class="text-lg mb-4"></p>
                <button id="modal-close-btn" class="btn-primary py-2 px-6 rounded">OK</button>
            </div>
        </div>
        <!-- Payment Modal -->
        <div id="payment-modal" class="hidden fixed inset-0 modal-backdrop flex items-center justify-center z-50">
            <div class="bg-gray-900 rounded-lg shadow-2xl p-6 w-full max-w-md text-left border border-purple-500 relative">
                <button id="payment-close-btn" class="absolute top-2 right-3 text-2xl text-gray-400 hover:text-white">&times;</button>
                <h2 class="text-2xl font-bold text-purple-400 mb-4">Purchase Premium Season Pass (99 BDT)</h2>
                <div class="space-y-4 text-gray-300">
                    <p>1. Choose a payment method: <span class="font-bold text-white">bKash, Nagad, or Rocket</span>.</p>
                    <p>2. Use the "Send Money" option to send 99 BDT to the following number:</p>
                    <div class="bg-gray-800 p-3 rounded-lg text-center">
                        <p class="text-xl font-mono tracking-widest text-green-400">01767882562</p>
                    </div>
                    <p>3. After sending the money, copy the Transaction ID (TnxID) from the confirmation message.</p>
                    <p>4. Enter the Transaction ID below and submit for verification.</p>
                </div>
                <form id="payment-form" class="mt-6 space-y-4">
                    <input id="transaction-id-input" type="text" placeholder="Enter Transaction ID (TnxID)" required class="w-full px-4 py-3 bg-gray-700 border border-gray-600 rounded-lg text-white focus:outline-none focus:ring-2 focus:ring-purple-500">
                    <button type="submit" class="w-full py-3 px-4 bg-purple-600 hover:bg-purple-700 text-white font-bold rounded-lg interactive-button">Submit Transaction</button>
                </form>
            </div>
        </div>

        <!-- Pack Opening Modal -->
        <div id="pack-opening-modal" class="hidden fixed inset-0 modal-backdrop flex items-center justify-center z-50">
            <div class="bg-gray-900 rounded-xl shadow-2xl p-6 w-full max-w-2xl text-center border-4 border-yellow-500 relative">
                <button id="pack-close-btn" class="absolute top-2 right-3 text-2xl text-gray-400 hover:text-white">&times;</button>
                <h2 class="text-3xl font-bold text-yellow-400 mb-6">Player Pack Opening</h2>
                <div id="pack-opening-container" class="flex flex-wrap justify-center gap-4">
                    <!-- Pack cards will be dynamically inserted here -->
                </div>
                <button id="pack-open-again-btn" class="mt-6 py-3 px-6 bg-yellow-600 hover:bg-yellow-700 text-white font-bold rounded-lg interactive-button hidden">Open Another Pack</button>
                <button id="pack-done-btn" class="mt-6 py-3 px-6 bg-gray-700 hover:bg-gray-600 text-white font-bold rounded-lg interactive-button">Done</button>
            </div>
        </div>

        <!-- Training Modal -->
        <div id="training-modal" class="hidden fixed inset-0 modal-backdrop flex items-center justify-center z-50">
            <div class="bg-gray-900 rounded-xl shadow-2xl p-6 w-full max-w-2xl text-left border-4 border-blue-500 relative">
                <button id="training-close-btn" class="absolute top-2 right-3 text-2xl text-gray-400 hover:text-white">&times;</button>
                <h2 class="text-3xl font-bold text-blue-400 mb-6">Player Training</h2>
                <div class="flex items-center mb-4">
                    <span class="text-lg font-bold text-gray-300 mr-4">Training Points:</span>
                    <div class="flex items-center bg-gray-800 px-4 py-2 rounded-lg">
                        <i class="fas fa-dumbbell text-yellow-400 mr-2"></i>
                        <span id="training-points" class="font-bold text-white">0</span>
                    </div>
                </div>
                <div id="training-player-list" class="space-y-4 max-h-96 overflow-y-auto">
                    <!-- Player training cards will be dynamically inserted here -->
                </div>
            </div>
        </div>

        <!-- Formation Modal -->
        <div id="formation-modal" class="hidden fixed inset-0 modal-backdrop flex items-center justify-center z-50">
            <div class="bg-gray-900 rounded-xl shadow-2xl p-6 w-full max-w-4xl text-center border-4 border-green-500 relative">
                <button id="formation-close-btn" class="absolute top-2 right-3 text-2xl text-gray-400 hover:text-white">&times;</button>
                <h2 class="text-3xl font-bold text-green-400 mb-6">Team Formation & Tactics</h2>
                
                <div class="mb-6">
                    <h3 class="text-xl font-bold text-gray-300 mb-4">Select Formation</h3>
                    <div class="flex justify-center gap-4 flex-wrap">
                        <div class="formation-option p-4 bg-gray-800 rounded-lg cursor-pointer" data-formation="4-4-2">
                            <div class="text-lg font-bold text-white mb-2">4-4-2</div>
                            <div class="text-sm text-gray-400">Balanced</div>
                        </div>
                        <div class="formation-option p-4 bg-gray-800 rounded-lg cursor-pointer" data-formation="4-3-3">
                            <div class="text-lg font-bold text-white mb-2">4-3-3</div>
                            <div class="text-sm text-gray-400">Attacking</div>
                        </div>
                        <div class="formation-option p-4 bg-gray-800 rounded-lg cursor-pointer" data-formation="3-5-2">
                            <div class="text-lg font-bold text-white mb-2">3-5-2</div>
                            <div class="text-sm text-gray-400">Midfield Control</div>
                        </div>
                        <div class="formation-option p-4 bg-gray-800 rounded-lg cursor-pointer" data-formation="5-3-2">
                            <div class="text-lg font-bold text-white mb-2">5-3-2</div>
                            <div class="text-sm text-gray-400">Defensive</div>
                        </div>
                    </div>
                </div>
                
                <div class="mb-6">
                    <h3 class="text-xl font-bold text-gray-300 mb-4">Team Chemistry</h3>
                    <div class="flex items-center justify-center">
                        <div class="w-full max-w-md bg-gray-800 rounded-full h-4">
                            <div id="chemistry-bar" class="bg-gradient-to-r from-red-500 via-yellow-500 to-green-500 h-4 rounded-full" style="width: 0%"></div>
                        </div>
                        <span id="chemistry-value" class="ml-4 text-xl font-bold text-white">0%</span>
                    </div>
                </div>
                
                <div class="flex justify-center gap-4">
                    <button id="formation-save-btn" class="py-3 px-6 bg-green-600 hover:bg-green-700 text-white font-bold rounded-lg interactive-button">Save Formation</button>
                    <button id="formation-cancel-btn" class="py-3 px-6 bg-gray-700 hover:bg-gray-600 text-white font-bold rounded-lg interactive-button">Cancel</button>
                </div>
            </div>
        </div>

        <!-- Daily Login Modal -->
        <div id="daily-login-modal" class="hidden fixed inset-0 modal-backdrop flex items-center justify-center z-50">
            <div class="bg-gray-900 rounded-xl shadow-2xl p-6 w-full max-w-lg text-center border-4 border-yellow-500 relative">
                <button id="daily-login-close-btn" class="absolute top-2 right-3 text-2xl text-gray-400 hover:text-white">&times;</button>
                <h2 class="text-3xl font-bold text-yellow-400 mb-6">Daily Login Reward</h2>
                <div class="text-xl text-gray-300 mb-4">Day <span id="login-day">1</span> of 7</div>
                <div id="daily-reward" class="bg-gray-800 p-6 rounded-lg mb-6">
                    <div id="daily-reward-content" class="text-2xl font-bold text-yellow-400">
                        <!-- Reward content will be dynamically inserted here -->
                    </div>
                </div>
                <button id="daily-login-claim-btn" class="py-3 px-6 bg-yellow-600 hover:bg-yellow-700 text-white font-bold rounded-lg interactive-button">Claim Reward</button>
            </div>
        </div>

        <div id="auth-screen" class="w-full h-full flex items-center justify-center bg-gray-900 hidden">
            <div class="w-full max-w-md p-8 space-y-6 bg-gray-800 rounded-xl shadow-2xl border border-green-500">
                <div>
                    <h2 class="text-center text-4xl font-extrabold text-green-400">‚öΩ Volta Efootball Manager</h2>
                    <p id="auth-title" class="mt-2 text-center text-sm text-gray-400">Login to your Club</p>
                </div>
                <form id="login-form" class="space-y-6">
                    <input id="login-email" type="email" placeholder="Email" required class="w-full px-4 py-3 bg-gray-700 border border-gray-600 rounded-lg text-white focus:outline-none focus:ring-2 focus:ring-green-500">
                    <input id="login-password" type="password" placeholder="Password" required class="w-full px-4 py-3 bg-gray-700 border border-gray-600 rounded-lg text-white focus:outline-none focus:ring-2 focus:ring-green-500">
                    <button type="submit" class="w-full py-3 px-4 btn-primary rounded-lg">Login</button>
                </form>
                <form id="signup-form" class="space-y-6 hidden">
                    <input id="signup-email" type="email" placeholder="Email" required class="w-full px-4 py-3 bg-gray-700 border border-gray-600 rounded-lg text-white focus:outline-none focus:ring-2 focus:ring-green-500">
                    <input id="signup-password" type="password" placeholder="Password" required class="w-full px-4 py-3 bg-gray-700 border border-gray-600 rounded-lg text-white focus:outline-none focus:ring-2 focus:ring-green-500">
                    <input id="signup-club-name" type="text" placeholder="Club Name" required class="w-full px-4 py-3 bg-gray-700 border border-gray-600 rounded-lg text-white focus:outline-none focus:ring-2 focus:ring-green-500">
                    <button type="submit" class="w-full py-3 px-4 bg-green-600 hover:bg-green-700 text-white font-bold rounded-lg interactive-button">Sign Up</button>
                </form>
                <p id="auth-toggle" class="text-center text-sm text-green-400 hover:underline cursor-pointer">
                    Don't have an account? Sign Up
                </p>
                <p id="auth-error" class="text-center text-sm text-red-400"></p>
            </div>
        </div>

        <div id="game-content" class="hidden w-full h-full flex relative">
            
            <header class="top-bar fixed top-0 left-0 right-0 h-16 flex items-center justify-between px-4 z-40">
                <div class="flex items-center space-x-3">
                    <div id="user-avatar-container" class="relative group cursor-pointer">
                        <img id="user-avatar" src="https://placehold.co/96x96/161b22/FFFFFF?text=S" alt="Club Logo" class="w-12 h-12 rounded-full border-2 border-green-500 object-cover">
                        <input type="file" id="logo-upload" class="hidden" accept="image/*">
                    </div>
                    <div>
                         <div class="flex items-center">
                            <h1 id="user-club-name" class="text-lg font-bold text-white truncate max-w-[150px]">Club Name</h1>
                             <span id="edit-club-name" class="ml-2 cursor-pointer text-gray-400 hover:text-green-400"><i class="fas fa-edit text-xs"></i></span>
                         </div>
                         <div class="flex items-center space-x-2 mt-1">
                            <p class="text-sm text-gray-400">Lvl: <span id="user-level">1</span></p>
                            <div class="xp-bar-container">
                                <div id="xp-bar-fill" style="width: 0%;"></div>
                            </div>
                         </div>
                    </div>
                </div>
                <div class="flex items-center space-x-4 bg-gray-900 px-4 py-1 rounded-full">
                    <div class="flex items-center space-x-2">
                        <i class="fas fa-coins text-yellow-400"></i>
                        <span id="user-balance" class="font-bold text-white">1000</span>
                    </div>
                    <div class="flex items-center space-x-2">
                         <i class="fas fa-gem text-blue-400"></i>
                         <span id="user-gems" class="font-bold text-white">100</span>
                    </div>
                    <div class="flex items-center space-x-2">
                         <i class="fas fa-dumbbell text-yellow-400"></i>
                         <span id="user-training-points" class="font-bold text-white">0</span>
                    </div>
                </div>
                 <div class="flex items-center space-x-4">
                     <button id="logout-btn" class="text-gray-300 hover:text-red-500 text-xl"><i class="fas fa-sign-out-alt"></i></button>
                </div>
            </header>

            <aside class="left-sidebar fixed top-16 left-0 w-24 h-[calc(100%-4rem-4rem)] flex flex-col items-center py-4 space-y-4 z-30">
                <a href="#season-pass" class="nav-link flex flex-col items-center text-gray-300 w-full py-2" title="Season Pass"><i class="fas fa-ticket-alt text-2xl"></i><span class="text-xs mt-1 font-semibold">Season Pass</span></a>
                <a href="#events" class="nav-link flex flex-col items-center text-gray-300 w-full py-2" title="Events"><i class="fas fa-star text-2xl"></i><span class="text-xs mt-1 font-semibold">Events</span></a>
                <a href="#esports" class="nav-link flex flex-col items-center text-gray-300 w-full py-2" title="ESPORTS"><i class="fas fa-gamepad text-2xl"></i><span class="text-xs mt-1 font-semibold">ESPORTS</span></a>
                <a href="#leaderboard" class="nav-link flex flex-col items-center text-gray-300 w-full py-2" title="Leaderboard"><i class="fas fa-trophy text-2xl"></i><span class="text-xs mt-1 font-semibold">Ranking</span></a>
                <a href="#chat" class="nav-link flex flex-col items-center text-gray-300 w-full py-2" title="Global Chat"><i class="fas fa-comments text-2xl"></i><span class="text-xs mt-1 font-semibold">Chat</span></a>
                <a href="#about" class="nav-link flex flex-col items-center text-gray-300 w-full py-2" title="About"><i class="fas fa-info-circle text-2xl"></i><span class="text-xs mt-1 font-semibold">About</span></a>
            </aside>

            <main class="w-full h-full pt-16 pb-16 pl-24 overflow-y-auto">
                <div id="home-view" class="view p-6">
                    <div class="grid grid-cols-5 gap-6 h-full">
                        <a href="#events" class="nav-link col-span-3 h-full promo-card interactive-button" style="background-image: url('https://e0.pxfuel.com/wallpapers/36/389/desktop-wallpaper-fifa-23-background-fifa-2023.jpg');">
                            <div class="relative w-full h-full flex flex-col justify-end p-8 overlay">
                                <h2 class="text-4xl font-black text-white tracking-wider">SPECIAL EVENTS</h2>
                                <p class="text-lg text-gray-200 mt-2">Check out limited-time challenges and rewards!</p>
                            </div>
                        </a>
                        <div class="col-span-2 h-full flex flex-col gap-6">
                            <a href="#squad" class="nav-link h-1/2 w-full promo-card interactive-button" style="background-image: url('https://e1.pxfuel.com/desktop-wallpaper/683/288/desktop-wallpaper-fifa-21-ultimate-team-on-behance-fut.jpg'); background-position: top;">
                                 <div class="relative w-full h-full flex flex-col justify-end p-6 overlay">
                                    <h3 class="text-3xl font-bold text-white">CLUB</h3>
                                    <div class="mt-2 text-xl font-semibold bg-black bg-opacity-50 px-3 py-1 rounded-full w-fit text-yellow-400">
                                        OVR: <span id="team-power-stat">0</span>
                                    </div>
                                </div>
                            </a>
                            <a href="#match" class="nav-link h-1/2 w-full promo-card interactive-button" style="background-image: url('https://wallpaper.dog/large/10988167.jpg');">
                                 <div class="relative w-full h-full flex flex-col justify-end p-6 overlay bg-green-800 bg-opacity-30">
                                    <h3 class="text-3xl font-bold text-white">PLAY</h3>
                                    <p class="text-md text-gray-200">Face off against rivals in PvP matches.</p>
                                </div>
                            </a>
                        </div>
                    </div>
                </div>

                <div id="squad-view" class="view hidden p-6">
                    <button class="back-to-home nav-link mb-6 bg-gray-700 hover:bg-gray-600 px-4 py-2 rounded-lg interactive-button">&larr; Back to Home</button>
                    <div class="flex justify-between items-center mb-6">
                        <h1 class="text-3xl font-bold text-green-400">My Squad (5-player team)</h1>
                        <div class="flex space-x-4">
                            <button id="training-btn" class="py-2 px-4 bg-blue-600 hover:bg-blue-700 text-white font-bold rounded-lg interactive-button">
                                <i class="fas fa-dumbbell mr-2"></i>Training
                            </button>
                            <button id="formation-btn" class="py-2 px-4 bg-purple-600 hover:bg-purple-700 text-white font-bold rounded-lg interactive-button">
                                <i class="fas fa-chess-board mr-2"></i>Formation
                            </button>
                        </div>
                    </div>
                    <div id="squad-list" class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-4 xl:grid-cols-5 gap-6"></div>
                </div>
                <div id="match-view" class="view hidden p-6 relative">
                    <button class="back-to-home nav-link mb-6 bg-gray-700 hover:bg-gray-600 px-4 py-2 rounded-lg interactive-button">&larr; Back to Home</button>
                     <h1 class="text-3xl font-bold mb-8 text-green-400">PvP Match</h1>
                    <div id="match-initial-screen">
                        <div class="flex flex-col md:flex-row gap-6 mb-6">
                            <button id="find-match-btn" class="flex-1 py-5 px-6 bg-green-600 hover:bg-green-700 text-white font-bold rounded-xl text-2xl transition duration-300 disabled:bg-gray-500 disabled:cursor-not-allowed interactive-button" disabled>
                                Find PvP Match
                            </button>
                            <button id="single-player-btn" class="flex-1 py-5 px-6 bg-blue-600 hover:bg-blue-700 text-white font-bold rounded-xl text-2xl transition duration-300 interactive-button">
                                Single Player
                            </button>
                        </div>
                        <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                            <div class="player-card p-4 text-center">
                                <h3 class="text-xl font-bold text-green-400 mb-2">League</h3>
                                <p class="text-gray-300 mb-4">Play in league matches</p>
                                <button class="w-full py-2 px-4 bg-green-600 hover:bg-green-700 text-white font-bold rounded-lg interactive-button">Join League</button>
                            </div>
                            <div class="player-card p-4 text-center">
                                <h3 class="text-xl font-bold text-yellow-400 mb-2">Tournament</h3>
                                <p class="text-gray-300 mb-4">Knockout competitions</p>
                                <button class="w-full py-2 px-4 bg-yellow-600 hover:bg-yellow-700 text-white font-bold rounded-lg interactive-button">Enter Tournament</button>
                            </div>
                            <div class="player-card p-4 text-center">
                                <h3 class="text-xl font-bold text-blue-400 mb-2">Friendly</h3>
                                <p class="text-gray-300 mb-4">Practice matches</p>
                                <button class="w-full py-2 px-4 bg-blue-600 hover:bg-blue-700 text-white font-bold rounded-lg interactive-button">Friendly Match</button>
                            </div>
                        </div>
                    </div>
                     <div id="matchmaking-screen" class="hidden text-center">
                        <p class="text-2xl mb-4 text-yellow-400">Searching for opponent...</p>
                        <div class="animate-spin rounded-full h-20 w-20 border-t-4 border-b-4 border-green-500 mx-auto"></div>
                        <button id="cancel-matchmaking-btn" class="mt-8 py-3 px-6 bg-red-600 hover:bg-red-700 text-white font-bold rounded-lg interactive-button">Cancel</button>
                    </div>
                    <div id="match-simulation-screen" class="hidden">
                         <div id="reaction-display-area" class="absolute top-1/2 left-1/2 -translate-x-1/2 -translate-y-1/2 z-20 pointer-events-none"></div>
                        <div class="flex justify-between items-center bg-gray-900 bg-opacity-80 p-6 rounded-xl mb-6 shadow-2xl border-b-4 border-green-500">
                            <div class="text-center w-1/3"><p id="teamA-name" class="font-bold text-xl md:text-2xl truncate text-green-400">Team A</p><p id="teamA-score" class="text-5xl font-extrabold text-white">0</p></div>
                            <div class="text-center"><p id="match-timer" class="text-3xl font-mono text-yellow-400 bg-gray-700 px-4 py-2 rounded">01:30</p></div>
                            <div class="text-center w-1/3"><p id="teamB-name" class="font-bold text-xl md:text-2xl truncate text-green-400">Team B</p><p id="teamB-score" class="text-5xl font-extrabold text-white">0</p></div>
                        </div>
                        <div id="in-match-strategy-control" class="flex justify-center space-x-4 mb-6">
                            <button data-strategy="Attack" class="strategy-btn flex-1 py-3 px-2 bg-red-600 hover:bg-red-700 text-white font-bold rounded-lg interactive-button">Attack ‚öΩ</button>
                            <button data-strategy="Balanced" class="strategy-btn flex-1 py-3 px-2 btn-primary rounded-lg">Balanced ‚öñÔ∏è</button>
                            <button data-strategy="Defense" class="strategy-btn flex-1 py-3 px-2 bg-blue-600 hover:bg-blue-700 text-white font-bold rounded-lg interactive-button">Defense üõ°Ô∏è</button>
                        </div>
                        <div id="live-commentary" class="bg-gray-900 bg-opacity-80 p-5 rounded-xl h-96 overflow-y-auto border border-gray-700 shadow-inner text-gray-300"></div>
                         <!-- Emoji Reaction System -->
                        <div id="emoji-reaction-container">
                             <div id="emoji-panel" class="hidden mb-2">
                                <span class="emoji" data-emoji="üëç">üëç</span>
                                <span class="emoji" data-emoji="üòÇ">üòÇ</span>
                                <span class="emoji" data-emoji="üò°">üò°</span>
                                <span class="emoji" data-emoji="‚öΩ">‚öΩ</span>
                                <span class="emoji" data-emoji="üî•">üî•</span>
                            </div>
                            <button id="emoji-toggle-btn" class="w-14 h-14 bg-yellow-500 hover:bg-yellow-600 rounded-full flex items-center justify-center text-3xl interactive-button">üòÄ</button>
                        </div>
                    </div>
                </div>
                <div id="events-view" class="view hidden p-6">
                    <button class="back-to-home nav-link mb-6 bg-gray-700 hover:bg-gray-600 px-4 py-2 rounded-lg interactive-button">&larr; Back to Home</button>
                    <h1 class="text-3xl font-bold mb-8 text-green-400">Club Events</h1>
                    <div id="events-list" class="space-y-6"></div>
                </div>
                <!-- Season Pass View -->
                <div id="season-pass-view" class="view hidden p-6">
                    <button class="back-to-home nav-link mb-6 bg-gray-700 hover:bg-gray-600 px-4 py-2 rounded-lg interactive-button">&larr; Back to Home</button>
                    <div class="flex justify-between items-center mb-6">
                        <h1 class="text-3xl font-bold text-purple-400">Season Pass</h1>
                        <button id="buy-premium-pass-btn" class="bg-purple-600 hover:bg-purple-700 text-white font-bold py-3 px-6 rounded-lg interactive-button shadow-lg disabled:bg-gray-500 disabled:cursor-not-allowed">
                            Premium Pass (99 BDT)
                        </button>
                    </div>

                    <!-- Progress Bar -->
                    <div class="mb-8">
                        <div class="flex justify-between items-end mb-2">
                            <div class="text-lg">Level: <span id="sp-current-level" class="font-bold text-xl text-purple-300">1</span></div>
                            <div class="text-sm text-gray-400"><span id="sp-current-xp">0</span> / <span id="sp-needed-xp">100</span> XP</div>
                        </div>
                        <div class="season-pass-progress-container">
                            <div id="season-pass-progress-fill" style="width: 0%;"></div>
                        </div>
                        <p class="text-right text-sm mt-1 text-gray-500">Season ends in: <span id="season-end-timer">60d 0h 0m</span></p>
                    </div>

                    <!-- Tabs -->
                    <div class="flex border-b-2 border-gray-700 mb-6">
                        <button id="missions-tab" class="tab-button flex-1 py-2 px-4 text-lg font-semibold text-gray-400 border-b-4 border-transparent active">Missions</button>
                        <button id="rewards-tab" class="tab-button flex-1 py-2 px-4 text-lg font-semibold text-gray-400 border-b-4 border-transparent">Rewards</button>
                    </div>

                    <!-- Missions Content -->
                    <div id="missions-content">
                        <div class="mb-8">
                            <h2 class="text-2xl font-semibold mb-4 text-green-400 border-b-2 border-gray-700 pb-2">Daily Missions</h2>
                            <div id="daily-missions-list" class="space-y-4"></div>
                        </div>
                        <div class="mb-8">
                            <h2 class="text-2xl font-semibold mb-4 text-green-400 border-b-2 border-gray-700 pb-2">Weekly Missions</h2>
                            <div id="weekly-missions-list" class="space-y-4"></div>
                        </div>
                        <div>
                            <h2 class="text-2xl font-semibold mb-4 text-green-400 border-b-2 border-gray-700 pb-2">Seasonal Missions</h2>
                            <div id="seasonal-missions-list" class="space-y-4"></div>
                        </div>
                    </div>

                    <!-- Rewards Content -->
                    <div id="rewards-content" class="hidden">
                        <p class="text-center text-gray-400">View and claim your rewards as you level up!</p>
                        <div id="rewards-track-list" class="mt-6 space-y-4"></div>
                    </div>
                </div>

                <div id="leaderboard-view" class="view hidden p-6">
                    <button class="back-to-home nav-link mb-6 bg-gray-700 hover:bg-gray-600 px-4 py-2 rounded-lg interactive-button">&larr; Back to Home</button>
                    <h1 class="text-3xl font-bold mb-8 text-green-400">World Leaderboard</h1>
                    <div class="bg-gray-800 bg-opacity-80 rounded-xl shadow-xl overflow-hidden border border-green-500">
                        <table class="w-full text-left">
                            <thead class="bg-gray-900 border-b border-green-500"><tr><th class="p-4 text-green-400">Rank</th><th class="p-4 text-green-400">Club Name</th><th class="p-4 text-green-400">Level</th><th class="p-4 text-green-400">Points</th></tr></thead>
                            <tbody id="leaderboard-body"></tbody>
                        </table>
                    </div>
                </div>
                <div id="store-view" class="view hidden p-6">
                    <button class="back-to-home nav-link mb-6 bg-gray-700 hover:bg-gray-600 px-4 py-2 rounded-lg interactive-button">&larr; Back to Home</button>
                    <h1 class="text-3xl font-bold mb-8 text-green-400">Item Store</h1>
                    <div class="flex border-b-2 border-gray-700 mb-6">
                        <button id="players-tab" class="tab-button flex-1 py-2 px-4 text-lg font-semibold text-gray-400 border-b-4 border-transparent active">Players</button>
                        <button id="packs-tab" class="tab-button flex-1 py-2 px-4 text-lg font-semibold text-gray-400 border-b-4 border-transparent">Player Packs</button>
                    </div>
                    <div id="store-items" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6"></div>
                    <div id="store-packs" class="hidden grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6"></div>
                </div>
                <div id="transfers-view" class="view hidden p-6">
                    <button class="back-to-home nav-link mb-6 bg-gray-700 hover:bg-gray-600 px-4 py-2 rounded-lg interactive-button">&larr; Back to Home</button>
                    <h1 class="text-3xl font-bold mb-8 text-green-400">Transfer Market</h1>
                    <div class="mb-10"><h2 class="text-2xl font-semibold mb-4 border-b-2 border-gray-700 pb-2 text-green-400">Buy Players</h2><div id="transfer-market-list" class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-4 xl:grid-cols-5 gap-6"></div></div>
                    <div><h2 class="text-2xl font-semibold mb-4 border-b-2 border-gray-700 pb-2 text-green-400">Sell Your Players</h2><div id="sell-player-list" class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-4 xl:grid-cols-5 gap-6"></div></div>
                </div>
                <div id="esports-view" class="view hidden p-6">
                    <button class="back-to-home nav-link mb-6 bg-gray-700 hover:bg-gray-600 px-4 py-2 rounded-lg interactive-button">&larr; Back to Home</button>
                    <h1 class="text-3xl font-bold mb-8 text-green-400">ESPORTS SECTION</h1>
                    <div id="tournament-list" class="space-y-6"></div>
                </div>
                <div id="chat-view" class="view hidden p-6">
                    <button class="back-to-home nav-link mb-6 bg-gray-700 hover:bg-gray-600 px-4 py-2 rounded-lg interactive-button">&larr; Back to Home</button>
                    <h1 class="text-3xl font-bold mb-8 text-green-400">Global Chat</h1>
                    <div class="flex flex-col h-[70vh] bg-gray-900 bg-opacity-80 rounded-xl shadow-2xl border border-green-500">
                        <div id="chat-messages" class="flex-grow p-4 overflow-y-auto space-y-3"></div>
                        <div class="p-4 border-t border-gray-700">
                            <form id="chat-form" class="flex space-x-3">
                                <input type="text" id="chat-input" placeholder="Type your message..." maxlength="100" class="flex-grow px-4 py-3 bg-gray-700 border border-gray-600 rounded-lg text-white focus:outline-none focus:ring-2 focus:ring-green-500" required>
                                <button type="submit" class="btn-primary py-3 px-6 rounded-lg font-bold">Send</button>
                            </form>
                        </div>
                    </div>
                </div>
                <div id="about-view" class="view hidden p-6">
                    <button class="back-to-home nav-link mb-6 bg-gray-700 hover:bg-gray-600 px-4 py-2 rounded-lg interactive-button">&larr; Back to Home</button>
                    <h1 class="text-4xl font-extrabold mb-6 text-green-400">About Volta Efootball Manager</h1>
                    <div class="player-card p-8 text-center max-w-2xl mx-auto">
                        <p class="text-2xl text-gray-200">This game was created by</p>
                        <h2 class="text-5xl font-bold my-4 text-green-300 tracking-wider">SWAMPOD & MITHUN</h2>
                        <div class="border-t border-gray-600 my-8"></div>
                        <p class="mt-4 text-lg text-gray-400">Version: <span class="font-bold text-yellow-400">1.0</span></p>
                    </div>
                </div>
            </main>

            <footer class="bottom-nav fixed bottom-0 left-0 right-0 h-16 flex items-center justify-around z-40">
                 <a href="#home" class="nav-link back-to-home flex flex-col items-center text-gray-300 p-2" title="Home"><i class="fas fa-home text-2xl"></i><span class="text-xs mt-1 font-semibold">Home</span></a>
                 <a href="#squad" class="nav-link flex flex-col items-center text-gray-300 p-2" title="My Squad"><i class="fas fa-users text-2xl"></i><span class="text-xs mt-1 font-semibold">Club</span></a>
                 <a href="#transfers" class="nav-link flex flex-col items-center text-gray-300 p-2" title="Transfers"><i class="fas fa-exchange-alt text-2xl"></i><span class="text-xs mt-1 font-semibold">Transfers</span></a>
                 <a href="#store" class="nav-link flex flex-col items-center text-gray-300 p-2" title="Store"><i class="fas fa-store text-2xl"></i><span class="text-xs mt-1 font-semibold">Store</span></a>
                 <a href="#season-pass" class="nav-link flex flex-col items-center text-gray-300 p-2" title="Season Pass"><i class="fas fa-ticket-alt text-2xl"></i><span class="text-xs mt-1 font-semibold">Season Pass</span></a>
            </footer>

        </div>
    </div>
    
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
        import { getAuth, createUserWithEmailAndPassword, signInWithEmailAndPassword, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
        import { getDatabase, ref, set, get, onValue, update, serverTimestamp, remove, push, onChildAdded, onDisconnect } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-database.js";

        const firebaseConfig = {
            apiKey: "AIzaSyAVs3SuUH0P9hGu57v0A9kZ5dwBulMD80Y",
            authDomain: "voltefootball.firebaseapp.com",
            databaseURL: "https://voltefootball-default-rtdb.asia-southeast1.firebasedatabase.app",
            projectId: "voltefootball",
            storageBucket: "voltefootball.firebasestorage.app",
            messagingSenderId: "549298882625",
            appId: "1:549298882625:web:1aaecf96ebbb64c5c7dec0",
            measurementId: "G-0F5B1D98Y3"
        };
        const IMGBB_API_KEY = "fe3e06e5bbecab856c63cf7e6a50a251";
        const MARADONA_PLAYER_ID = "MARADONA_PRIME"; 
        const MARADONA_CLAIM_MIN_POWER = 60;

        // XP and Leveling constants
        const XP_PER_WIN = 3;
        const XP_PER_DRAW = 2;
        const XP_PER_LOSS = 1;
        const BASE_MATCHES_FOR_LEVEL_UP = 15;

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getDatabase(app);
        
        let currentUserData = null; 
        let teamPower = 0;
        let matchListener = null;
        let timerInterval = null;
        let matchSimulationInterval = null;
        let currentMatchId = null; 
        let opponentStatusListener = null;
        let reactionListener = null;
        
        let currentLocalStrategy = 'Balanced';
        let isLocalPlayerTeamA = false;
        
        const ALL_COMMENTARIES = [
            "GOAL! What a stunning finish by $PLAYER! The crowd is on its feet!", "Golazo! It's a marvelous strike, courtesy of $PLAYER! That pass from $ASSIST was perfect.", "$PLAYER breaks the deadlock! An absolute thunderbolt from outside the box!", "He scores! $PLAYER nets a crucial goal after a brilliant run.", "That's a goal! $PLAYER calmly slots it home, an easy tap-in thanks to $ASSIST's vision.", "GOAL! It's a rocket from $PLAYER! No chance for the keeper!", "The net bulges! $PLAYER with the finish, $ASSIST with the wonderful setup!", "He tucks it away! $PLAYER with the precision finish!", "It's a screamer! $PLAYER fires it into the top corner!", "A moment of magic from $PLAYER! That's what they call a big-game player!", "The pressure pays off! $PLAYER finds the back of the net.", "The goalkeeper had absolutely no chance! $PLAYER with a moment of brilliance!", "The header is good! $PLAYER rises highest to nod it home from the cross!", "They've done it! $PLAYER seals the deal with a cool, clinical finish.", "A tap-in! Simple but effective, $PLAYER capitalizes on the defensive error.", "What a beautiful, bending shot! $PLAYER makes it look effortless.", "The chip is perfect! $PLAYER leaves the keeper stranded!", "The stadium erupts! A decisive goal from $PLAYER!", "An excellent chance for $ATTACKER! But the shot goes wide of the post.", "Ooh, that was close! $ATTACKER almost found the target, just missing the frame.", "$ATTACKER is through on goal, but the keeper $DEFENDER makes a brilliant save!", "A dangerous free-kick for $TEAM just outside the box.", "Corner awarded to $TEAM. Can they capitalize on this set-piece opportunity?", "The attack is building up nicely for $TEAM down the flank.", "Superb through ball for $ATTACKER, but $DEFENDER intercepts at the last moment!", "$ATTACKER shoots! It hits the woodwork and rattles away!", "A clear opportunity goes begging! $ATTACKER will regret that miss.", "The ball is cut back, but the shot is blocked by a desperate lunge!", "The keeper is off his line quickly to smother the attempt from $ATTACKER.", "A venomous volley from $ATTACKER, but it just flies past the upright!", "The defense is caught sleeping! But the final shot from $ATTACKER lacked power.", "They're peppering the goal! $TEAM is dominating the attack now.", "A one-two move opens up the defense, but the cross is slightly overhit.", "A tactical foul in the midfield by $DEFENDER to break up the play.", "The possession is back with $TEAM after a commanding interception.", "Strong challenge by $DEFENDER to win the ball back cleanly.", "Midfield battle is intense, neither team giving an inch in this ferocious contest.", "A nice sequence of passes by $TEAM, retaining the ball under pressure.", "The long ball strategy is not quite connecting for $TEAM today.", "A patient build-up from the back line of $TEAM, controlling the tempo.", "Brilliant tackle by $DEFENDER! He stopped a certain goal-scoring opportunity.", "Off the post! The danger is cleared by $DEFENDER!", "A low cross into the box... cleared by the towering $DEFENDER!", "The team is pushing high, winning the ball back quickly with a great press.", "The keeper $DEFENDER pulls off an acrobatic save to keep his side in it!", "A critical interception in the penalty box! That was heroic defending.", "The defensive line of $TEAM steps up perfectly to catch $ATTACKER offside.", "A crucial block from $DEFENDER, sacrificing his body for the team.", "The keeper tips a powerful long-range effort over the bar!", "The full-back $DEFENDER recovers superbly to deny the counter-attack.", "Possession changing hands quickly‚Äîit's a real end-to-end affair.", "The intensity is palpable in the stadium. This is a fiercely contested match!", "We are in for a tight finish here. The pressure is mounting!", "Only a few minutes left in this half. Can they hold on?", "The referee is having a very stern word with the players.", "A moment of reflection as play pauses for an injured player.", "Can either side find a winner? It's too close to call.", "The clock is definitely a factor now. Time is running out!", "A great atmosphere inside the arena. The fans are certainly enjoying this.", "Both teams deserve credit for the sheer effort they are putting in.", "We've reached the halfway mark of the second half. Fitness will be key.", "The team needs a spark from somewhere, they look a little flat.", "They are looking for the perfect final pass, trying to unlock the defense.", "Defensive discipline is absolutely paramount at this stage of the game.", "No clear advantage for either side yet. It's a testament to the balance of power.", "A high-stakes encounter for both clubs, you can feel the tension.", "This is typical cup-tie drama, full of twists and turns!", "The substitution bench is warming up; a change must be imminent.", "Will we see extra time tonight? It certainly looks possible.", "A fantastic display of footballing skill on show.", "They must keep their concentration now; one mistake could be fatal.", "A little bit of frustration creeping in as tackles start flying.", "Both sides are pressing hard, trying to force an error.", "The game needs a moment of individual brilliance to settle it.", "It's all about who blinks first in this tactical deadlock.", "Tactical changes are being discussed on the sidelines.", "They are controlling the tempo, slowing the game down deliberately.", "The defensive line holds firm, refusing to be breached.", "Playing out from the back, taking a risk but showing confidence.", "Trying to exploit the flanks, looking for width in the attack.", "Looking for the aerial threat from a deep cross.", "The captain is visibly rallying his team, urging them forward.", "Possession stats are nearly equal; a true reflection of the match.", "A disciplined performance so far, keeping their shape well.", "They are dictating the play, forcing the opposition to chase.", "The long-range effort is well off target, a hopeful attempt at best.", "The keeper's distribution is excellent, launching a rapid counter-attack.", "The center-backs are dominant, winning every aerial duel.", "Working hard off the ball, their fitness levels are impressive.", "A rapid counter-attack opportunity! They need to be clinical!", "The full-backs are bombing forward, adding extra men to the attack.", "Finding space in the channels, exploiting the gaps between defense and midfield.", "The tension is mounting with every passing second!", "A very physical contest, the referee is letting a lot go.", "They need to keep the ball better, too many turnovers in midfield.", "The final ball is missing, letting themselves down in the critical area.", "The crowd loves the effort and commitment on display.", "Playing with a high press, looking to steal the ball deep in enemy territory.", "A cautious approach for now, prioritizing defense.", "Both managers look calm, but you know their heart rates are soaring.", "A true test of character for both sets of players.", "The defensive wall is set, ready for the free-kick.", "Looking to switch the play quickly to the unattended side.", "A promising attack fizzles out, poor decision-making at the end.", "They are running out of time, must create something quickly!", "Must be more clinical in front of goal; chances are rare.", "The difference between the teams is marginal, a single goal may decide it.", "The opponent is showing great resilience, refusing to break down.", "An evenly matched contest, a delight for the neutral spectator.", "All eyes are on the clock as the seconds tick away.", "This could go either way; a moment of genius is all it takes.", "The team is playing smart football, controlling their emotions.", "Need to avoid mistakes now; the pressure is immense.", "The game is on a knife-edge, one mistake and it's over.", "The bench reaction tells a story‚Äîthey sense a goal is coming.", "It's a game of fine margins, where small details matter most.", "A moment of hesitation costs them dearly in possession.", "The pass accuracy is remarkably high despite the pressure.", "They are absorbing the pressure well, sitting deep and defending.", "A fantastic advertisement for the beautiful game!", "Can they hold on for the win? They are defending with everything they have.", "A vital three points at stake in this league fixture.", "The intensity never drops, a non-stop, high-energy affair.", "Every tackle is important now, controlling the middle ground.", "They are hungry for the goal, pushing men forward fearlessly.", "The defense has to be alert, especially against the pace of the forwards.", "A battle of wits between the players and the opposing tactics.", "The players are giving their all, absolutely exhausted.", "The game is wide open, plenty of space to exploit.", "The tension is almost unbearable for the supporters!", "It's not over yet! They have time for one last attempt."
        ];

        const authScreen = document.getElementById('auth-screen');
        const gameContent = document.getElementById('game-content');
        const maintenanceModeDiv = document.getElementById('maintenance-mode');
        const bannedScreen = document.getElementById('banned-screen');
        const modal = document.getElementById('custom-modal');
        const modalMessage = document.getElementById('modal-message');
        const modalCloseBtn = document.getElementById('modal-close-btn');
        const fullScreenLoader = document.getElementById('full-screen-loader');
        const findMatchBtn = document.getElementById('find-match-btn');
        
        const promoBannerModal = document.getElementById('promo-banner-modal');
        const promoCloseBtn = document.getElementById('promo-close-btn');

        const paymentModal = document.getElementById('payment-modal');
        const buyPremiumPassBtn = document.getElementById('buy-premium-pass-btn');
        const paymentCloseBtn = document.getElementById('payment-close-btn');
        const paymentForm = document.getElementById('payment-form');
        
        const strategyButtons = document.querySelectorAll('#in-match-strategy-control .strategy-btn');

        const navLinks = document.querySelectorAll('.nav-link');
        const views = document.querySelectorAll('.view');
        
        const mainMenuAudio = document.getElementById('main-menu-audio');
        const matchAudio = document.getElementById('match-audio'); 
        const goalSound = document.getElementById('goal-sound');
        const whistleSound = document.getElementById('whistle-sound');
        const buttonSound = document.getElementById('button-sound');
        const packOpenSound = document.getElementById('pack-open-sound');

        // New feature elements
        const trainingBtn = document.getElementById('training-btn');
        const formationBtn = document.getElementById('formation-btn');
        const singlePlayerBtn = document.getElementById('single-player-btn');
        const playersTab = document.getElementById('players-tab');
        const packsTab = document.getElementById('packs-tab');
        const storeItems = document.getElementById('store-items');
        const storePacks = document.getElementById('store-packs');

        // Modal elements
        const trainingModal = document.getElementById('training-modal');
        const trainingCloseBtn = document.getElementById('training-close-btn');
        const formationModal = document.getElementById('formation-modal');
        const formationCloseBtn = document.getElementById('formation-close-btn');
        const formationSaveBtn = document.getElementById('formation-save-btn');
        const formationCancelBtn = document.getElementById('formation-cancel-btn');
        const packOpeningModal = document.getElementById('pack-opening-modal');
        const packCloseBtn = document.getElementById('pack-close-btn');
        const packOpenAgainBtn = document.getElementById('pack-open-again-btn');
        const packDoneBtn = document.getElementById('pack-done-btn');
        const dailyLoginModal = document.getElementById('daily-login-modal');
        const dailyLoginCloseBtn = document.getElementById('daily-login-close-btn');
        const dailyLoginClaimBtn = document.getElementById('daily-login-claim-btn');

        function playSound(sound) {
            sound.currentTime = 0;
            sound.play().catch(e => console.log("Audio play failed:", e));
        }

        function showModal(message) {
            modalMessage.textContent = message;
            modal.classList.remove('hidden');
        }
        modalCloseBtn.addEventListener('click', () => modal.classList.add('hidden'));
        
        promoCloseBtn.addEventListener('click', () => {
            promoBannerModal.classList.add('hidden');
        });
        
        function playMainMenuMusic() {
            pauseMatchMusic();
            if (mainMenuAudio.paused) {
                mainMenuAudio.play().catch(error => {
                    console.warn("Main Menu Audio playback failed (Autoplay likely blocked):", error);
                });
            }
        }

        function pauseMainMenuMusic() { mainMenuAudio.pause(); }

        function playMatchMusic() {
             pauseMainMenuMusic();
             if (matchAudio.paused) {
                matchAudio.play().catch(error => {
                    console.warn("Match Audio playback failed (Autoplay likely blocked):", error);
                    matchAudio.pause();
                });
            }
        }
        
        function pauseMatchMusic() {
            matchAudio.pause();
            matchAudio.currentTime = 0; 
        }

        function navigateToView(viewId) {
            views.forEach(view => view.classList.add('hidden'));
            const targetView = document.getElementById(viewId);
            if(targetView) targetView.classList.remove('hidden');
            
            if (viewId === 'home-view' && !currentMatchId) {
                 playMainMenuMusic();
            }
            
            if(viewId === 'match-view') {
                pauseMainMenuMusic(); 
            }
            
            if (viewId === 'chat-view') {
                loadChatMessages();
            }
             if (viewId === 'season-pass-view') {
                loadSeasonPassData();
            }
        }
        
        document.querySelectorAll('.back-to-home').forEach(button => {
            button.addEventListener('click', (e) => {
                e.preventDefault();
                navigateToView('home-view');
            });
        });

        const settingsRef = ref(db, "settings/game");
        onValue(settingsRef, (snapshot) => {
            const settings = snapshot.val();
            const isMaintenance = settings && settings.maintenance;

            if (isMaintenance) {
                authScreen.classList.add('hidden');
                gameContent.classList.add('hidden');
                fullScreenLoader.classList.add('hidden');
                bannedScreen.classList.add('hidden');
                pauseMainMenuMusic();
                pauseMatchMusic();

                const titleElement = document.getElementById('maintenance-title');
                const messageElement = document.getElementById('maintenance-message');
                
                let message = "The game is on maintenance, will back shortly.";
                let title = "‚ö†Ô∏è Maintenance in Progress";

                if (typeof isMaintenance === 'object' && isMaintenance !== null) {
                    if(isMaintenance.title) title = isMaintenance.title;
                    if(isMaintenance.message) message = isMaintenance.message;
                }
                
                if (titleElement) titleElement.textContent = title;
                if (messageElement) messageElement.textContent = message;

                maintenanceModeDiv.classList.remove('hidden');
            } else {
                maintenanceModeDiv.classList.add('hidden');
            }
        });

        async function loadAndShowPromoBanner() {
            const promoRef = ref(db, 'settings/promotionalBanner');
            const snapshot = await get(promoRef);
            if (snapshot.exists()) {
                const bannerData = snapshot.val();
                
                const promoImage = document.getElementById('promo-image');
                const promoLink = document.getElementById('promo-link');

                let hasContent = false;

                if (bannerData.imageUrl) {
                    promoImage.src = bannerData.imageUrl;
                    promoImage.classList.remove('hidden');
                    hasContent = true;
                } else {
                    promoImage.classList.add('hidden');
                }
                
                if (bannerData.linkUrl && bannerData.linkUrl.trim() !== "") {
                    promoLink.href = bannerData.linkUrl;
                    promoLink.classList.remove('hidden');
                    hasContent = true;
                } else {
                    promoLink.classList.add('hidden');
                }

                if (hasContent) {
                    promoBannerModal.classList.remove('hidden');
                }
            }
        }
        
        function setupPresence(user) {
            const userStatusDatabaseRef = ref(db, '/status/' + user.uid);
            const isOfflineForDatabase = { state: 'offline', last_changed: serverTimestamp() };
            const isOnlineForDatabase = { state: 'online', last_changed: serverTimestamp() };

            const connectedRef = ref(db, '.info/connected');
            onValue(connectedRef, (snapshot) => {
                if (snapshot.val() === false) { return; }
                onDisconnect(userStatusDatabaseRef).set(isOfflineForDatabase).then(() => {
                    set(userStatusDatabaseRef, isOnlineForDatabase);
                });
            });
        }

        onAuthStateChanged(auth, user => {
            if (user) {
                setupPresence(user);
                authScreen.classList.add('hidden');
                // Game content visibility will be handled by loadUserData after the ban check
                loadUserData(user.uid);
                listenForMatch(user.uid);
                loadAndShowPromoBanner(); 
                checkDailyLogin(user.uid);
            } else {
                authScreen.classList.remove('hidden');
                gameContent.classList.add('hidden');
                bannedScreen.classList.add('hidden');
                currentUserData = null;
                if(timerInterval) clearInterval(timerInterval);
                if(matchSimulationInterval) clearInterval(matchSimulationInterval);
                pauseMainMenuMusic();
                pauseMatchMusic();
            }

            setTimeout(() => {
                fullScreenLoader.classList.add('hidden');
            }, 500);
        });
        
        const authToggle = document.getElementById('auth-toggle');
        const loginForm = document.getElementById('login-form');
        const signupForm = document.getElementById('signup-form');
        const authTitle = document.getElementById('auth-title');

        authToggle.addEventListener('click', () => {
            loginForm.classList.toggle('hidden');
            signupForm.classList.toggle('hidden');
            if(signupForm.classList.contains('hidden')) {
                authTitle.textContent = 'Login to your Club';
                authToggle.textContent = "Don't have an account? Sign Up";
            } else {
                authTitle.textContent = 'Create a New Club';
                authToggle.textContent = 'Already have an account? Login';
            }
        });

        const authError = document.getElementById('auth-error');

        signupForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const email = document.getElementById('signup-email').value;
            const password = document.getElementById('signup-password').value;
            const clubName = document.getElementById('signup-club-name').value;
            authError.textContent = '';
            try {
                const userCredential = await createUserWithEmailAndPassword(auth, email, password);
                const user = userCredential.user;

                const playersSnapshot = await get(ref(db, "players"));
                let allPlayerIds = [];
                if (playersSnapshot.exists()) {
                    allPlayerIds = Object.keys(playersSnapshot.val());
                }

                const shuffledPlayers = allPlayerIds.sort(() => 0.5 - Math.random());
                const startingSquad = shuffledPlayers.slice(0, 5);

                await set(ref(db, 'users/' + user.uid), {
                    email: email, clubName: clubName, balance: 1000, gems: 100, points: 0, wins: 0, 
                    squad: startingSquad, avatarUrl: `https://placehold.co/96x96/0d1117/00bcd4?text=${clubName.charAt(0)}`, 
                    claimedMaradonaEvent: false,
                    isBanned: false, 
                    level: 1, xp: 0, matchesPlayedThisLevel: 0, matchesNeededForLevelUp: BASE_MATCHES_FOR_LEVEL_UP,
                    seasonPass: { level: 1, xp: 0, premium: false },
                    trainingPoints: 0,
                    formation: "4-4-2",
                    lastLoginDate: new Date().toDateString(),
                    dailyLoginStreak: 1
                });
                
                await set(ref(db, 'players/' + MARADONA_PLAYER_ID), {
                    name: "Maradona Prime", position: "CAM", rating: 99, value: 50000, imageUrl: "https://placehold.co/96x96/FFD700/000?text=M+P",
                    attributes: { pace: 95, shooting: 98, passing: 97, dribbling: 99, defending: 65, physical: 85 },
                    rarity: "special"
                }, { merge: true });
                
                playMainMenuMusic();

            } catch (error) { authError.textContent = "Signup failed: " + error.message; }
        });

        loginForm.addEventListener('submit', (e) => {
            e.preventDefault();
            const email = document.getElementById('login-email').value;
            const password = document.getElementById('login-password').value;
            authError.textContent = '';
            signInWithEmailAndPassword(auth, email, password).catch(error => authError.textContent = "Login failed: " + error.message);
        });

        document.getElementById('logout-btn').addEventListener('click', () => {
            sessionStorage.removeItem('adShown');
            signOut(auth);
        });
        
        function loadUserData(uid) {
            const userRef = ref(db, 'users/' + uid);
            onValue(userRef, async (snapshot) => {
                if (snapshot.exists()) {
                    currentUserData = snapshot.val();
                    currentUserData.uid = uid;

                    if (currentUserData.isBanned) {
                        gameContent.classList.add('hidden');
                        bannedScreen.classList.remove('hidden');
                        pauseMainMenuMusic();
                        pauseMatchMusic();
                        return; 
                    } else {
                        bannedScreen.classList.add('hidden');
                        if (gameContent.classList.contains('hidden')) {
                            gameContent.classList.remove('hidden');
                            gameContent.classList.add('flex');
                            navigateToView('home-view');
                        }
                    }
                    
                    document.getElementById('user-club-name').textContent = currentUserData.clubName;
                    document.getElementById('user-balance').textContent = currentUserData.balance;
                    document.getElementById('user-gems').textContent = currentUserData.gems || 0;
                    document.getElementById('user-training-points').textContent = currentUserData.trainingPoints || 0;
                    document.getElementById('user-avatar').src = currentUserData.avatarUrl || `https://placehold.co/96x96/0d1117/00bcd4?text=${currentUserData.clubName.charAt(0)}`;
                    
                    document.getElementById('user-level').textContent = currentUserData.level || 1;
                    const matchesPlayed = currentUserData.matchesPlayedThisLevel || 0;
                    const matchesNeeded = currentUserData.matchesNeededForLevelUp || BASE_MATCHES_FOR_LEVEL_UP;
                    const xpPercentage = (matchesPlayed / matchesNeeded) * 100;
                    document.getElementById('xp-bar-fill').style.width = `${xpPercentage}%`;

                    if (currentUserData.squad && currentUserData.squad.length > 0) {
                        await loadSquad(currentUserData.squad);
                        loadSellPlayers(currentUserData.squad);
                    } else {
                         document.getElementById('squad-list').innerHTML = '<p>You have no players in your squad.</p>';
                         document.getElementById('sell-player-list').innerHTML = '<p>No players to sell.</p>';
                         document.getElementById('team-power-stat').textContent = 0;
                    }

                    loadStoreItems();
                    loadStorePacks();
                    loadTransferMarket();
                    loadLeaderboard();
                    loadTournaments();
                    loadEvents();
                    
                    findMatchBtn.disabled = false;
                }
            });
        }
        
        async function loadSquad(squadIds) {
            const squadListDiv = document.getElementById('squad-list');
            squadListDiv.innerHTML = '';
            let totalRating = 0;
            const playerPromises = squadIds.map(playerId => get(ref(db, 'players/' + playerId)));
            const playerSnapshots = await Promise.all(playerPromises);

            playerSnapshots.forEach(playerSnap => {
                if (playerSnap.exists()) {
                    const playerData = playerSnap.val();
                    totalRating += playerData.rating;
                    
                    // Calculate player's overall rating based on attributes
                    const attributes = playerData.attributes || { pace: 50, shooting: 50, passing: 50, dribbling: 50, defending: 50, physical: 50 };
                    const calculatedRating = Math.round(
                        (attributes.pace + attributes.shooting + attributes.passing + 
                         attributes.dribbling + attributes.defending + attributes.physical) / 6
                    );
                    
                    const rarity = playerData.rarity || "bronze";
                    const rarityClass = rarity === "bronze" ? "bronze" : 
                                       rarity === "silver" ? "silver" : 
                                       rarity === "gold" ? "gold" : "special";
                    
                    squadListDiv.innerHTML += `
                        <div class="player-card p-4 text-center shadow-lg ${rarityClass}">
                            <img src="${playerData.imageUrl}" alt="${playerData.name}" class="w-24 h-24 object-cover rounded-full mx-auto mb-3 border-2 border-gray-600">
                            <h4 class="font-bold text-lg text-white">${playerData.name}</h4>
                            <p class="text-sm text-gray-400">${playerData.position}</p>
                            <p class="text-2xl font-black text-green-400 mt-2">${calculatedRating}</p>
                            <div class="mt-2 text-xs text-gray-500">
                                <div class="flex justify-between"><span>Pace:</span><span>${attributes.pace}</span></div>
                                <div class="attribute-bar"><div class="attribute-fill pace-fill" style="width: ${attributes.pace}%"></div></div>
                                <div class="flex justify-between"><span>Shooting:</span><span>${attributes.shooting}</span></div>
                                <div class="attribute-bar"><div class="attribute-fill shooting-fill" style="width: ${attributes.shooting}%"></div></div>
                                <div class="flex justify-between"><span>Passing:</span><span>${attributes.passing}</span></div>
                                <div class="attribute-bar"><div class="attribute-fill passing-fill" style="width: ${attributes.passing}%"></div></div>
                            </div>
                        </div>`;
                }
            });

            teamPower = squadIds.length > 0 ? Math.round(totalRating / squadIds.length) : 0;
            document.getElementById('team-power-stat').textContent = teamPower;
        }
        
        async function loadLeaderboard() {
            const leaderboardBody = document.getElementById('leaderboard-body');
            leaderboardBody.innerHTML = '<tr><td colspan="4" class="text-center p-4">Loading...</td></tr>';
            
            const usersRef = ref(db, 'users');
            const snapshot = await get(usersRef);

            if (snapshot.exists()) {
                const users = [];
                snapshot.forEach(childSnapshot => {
                    users.push({ uid: childSnapshot.key, ...childSnapshot.val() });
                });

                users.sort((a, b) => (b.points || 0) - (a.points || 0));

                leaderboardBody.innerHTML = '';
                users.forEach((user, index) => {
                    const rank = index + 1;
                    const isCurrentUser = currentUserData && user.uid === currentUserData.uid;
                    leaderboardBody.innerHTML += `
                        <tr class="border-b border-gray-800 ${isCurrentUser ? 'bg-green-900 border-l-4 border-green-500 font-semibold' : 'hover:bg-gray-800'}">
                            <td class="p-4 font-bold">${rank}</td>
                            <td class="p-4">${user.clubName}</td>
                            <td class="p-4">${user.level || 1}</td>
                            <td class="p-4">${user.points || 0}</td>
                        </tr>`;
                });
            } else {
                leaderboardBody.innerHTML = '<tr><td colspan="4" class="text-center p-4 text-gray-400">No data on the leaderboard.</td></tr>';
            }
        }
        
        async function loadEvents() {
            const eventsListDiv = document.getElementById('events-list');
            eventsListDiv.innerHTML = '';
            
            const isMaradonaClaimed = currentUserData.claimedMaradonaEvent;
            const canClaimMaradona = teamPower >= MARADONA_CLAIM_MIN_POWER;
            
            let maradonaButtonHtml;
            if (isMaradonaClaimed) {
                maradonaButtonHtml = `<button class="py-2 px-4 bg-gray-600 text-white font-bold rounded-md cursor-not-allowed" disabled>Claimed</button>`;
            } else if (canClaimMaradona) {
                 maradonaButtonHtml = `<button onclick="claimReward('${MARADONA_PLAYER_ID}', 'claimedMaradonaEvent')" class="py-2 px-4 bg-green-600 hover:bg-green-700 text-white font-bold rounded-md interactive-button">Claim Now</button>`;
            } else {
                 maradonaButtonHtml = `<button class="py-2 px-4 bg-yellow-700 text-white font-bold rounded-md cursor-not-allowed" disabled>Min Power ${MARADONA_CLAIM_MIN_POWER} Required</button>`;
            }

            const maradonaHtml = `
                <div class="player-card p-6 shadow-xl flex justify-between items-center">
                    <div>
                        <h2 class="text-2xl font-bold mb-1 text-yellow-400">1-Day Login Reward: Maradona Prime</h2>
                        <p class="text-gray-300">Claim the legendary Diego Maradona Prime card to strengthen your squad!</p>
                        ${!isMaradonaClaimed && !canClaimMaradona ? `<p class="text-red-400 font-bold mt-2">Requirement: Team Power ${MARADONA_CLAIM_MIN_POWER} (Current: ${teamPower})</p>` : ''}
                    </div>
                    ${maradonaButtonHtml}
                </div>`;
            eventsListDiv.innerHTML += maradonaHtml;
            
            const eventsRef = ref(db, 'events');
            const snapshot = await get(eventsRef);

            if (snapshot.exists()) {
                const events = snapshot.val();
                for (const eventId in events) {
                    const eventData = events[eventId];
                    const rewardHtml = eventData.reward_type === 'currency' ? `üí∞ <span class="text-yellow-300 font-bold">${eventData.value || 0} Coins</span>` : `${eventData.value || ''} ${eventData.reward_type || ''}`;
                    eventsListDiv.innerHTML += `
                        <div class="player-card p-6 shadow-xl">
                            <h2 class="text-2xl font-bold mb-2 text-green-400">${eventData.name || 'New Event'}</h2>
                            <p class="text-gray-300 mb-3">${eventData.description || 'Check out this new event!'}</p>
                            <p class="text-lg"><span class="font-semibold text-gray-300">Reward:</span> ${rewardHtml}</p>
                            <button class="mt-3 py-2 px-4 bg-green-600 hover:bg-green-700 text-white font-bold rounded-md interactive-button">Participate</button>
                        </div>`;
                }
            } else {
                eventsListDiv.innerHTML += `<div class="player-card p-6 text-center"><p class="text-gray-400">No other special events are active right now. Check back later!</p></div>`;
            }
        }
        
        window.claimReward = async (playerId, eventFlag) => {
            if (!currentUserData) return showModal("User data not loaded.");
            if (currentUserData[eventFlag]) return showModal("Reward already claimed.");
            if (currentUserData.squad && currentUserData.squad.includes(playerId)) return showModal("You already own this player.");
            if (eventFlag === 'claimedMaradonaEvent' && teamPower < MARADONA_CLAIM_MIN_POWER) { return showModal(`Cannot claim. Minimum Team Power of ${MARADONA_CLAIM_MIN_POWER} is required.`); }
            const newSquad = [...(currentUserData.squad || []), playerId];
            try {
                await update(ref(db, 'users/' + currentUserData.uid), { squad: newSquad, [eventFlag]: true });
                showModal("Reward claimed successfully! Maradona Prime is now in your squad.");
                loadEvents(); 
            } catch (error) { showModal("Failed to claim reward: " + error.message); }
        };

        async function loadStoreItems() {
            const storeItemsDiv = document.getElementById('store-items');
            storeItemsDiv.innerHTML = '';
            const playersRef = ref(db, 'players');
            const snapshot = await get(playersRef);
            if (snapshot.exists()) {
                const players = snapshot.val();
                for (const playerId in players) {
                    const playerData = players[playerId];
                    const isOwned = currentUserData && currentUserData.squad && currentUserData.squad.includes(playerId);
                    const buttonHtml = isOwned 
                        ? `<button class="w-full mt-3 py-2 px-4 bg-gray-600 text-white font-bold rounded-md cursor-not-allowed" disabled>Owned</button>`
                        : `<button onclick="buyPlayer('${playerId}', ${playerData.value})" class="w-full mt-3 py-2 px-4 btn-primary rounded-md">Buy (${playerData.value} C)</button>`;
                    
                    const rarity = playerData.rarity || "bronze";
                    const rarityClass = rarity === "bronze" ? "bronze" : 
                                       rarity === "silver" ? "silver" : 
                                       rarity === "gold" ? "gold" : "special";
                    
                    storeItemsDiv.innerHTML += `
                        <div class="player-card p-4 text-center shadow-lg ${rarityClass}">
                            <img src="${playerData.imageUrl}" alt="${playerData.name}" class="w-24 h-24 object-cover rounded-full mx-auto mb-3 border-2 border-gray-600">
                            <h4 class="font-bold text-lg">${playerData.name}</h4><p class="text-sm text-gray-400">${playerData.position}</p><p class="text-xl font-bold text-green-400 mt-2">${playerData.rating}</p>${buttonHtml}
                        </div>`;
                }
            } else { storeItemsDiv.innerHTML = '<p class="text-center p-4 text-gray-400">No players found in the store.</p>'; }
        }

        async function loadStorePacks() {
            const storePacksDiv = document.getElementById('store-packs');
            storePacksDiv.innerHTML = '';
            
            // Define player packs
            const packs = [
                { id: 'bronze_pack', name: 'Bronze Pack', price: 1000, coinsPrice: 1000, gemsPrice: 0, description: 'Contains 3 bronze players', rarity: 'bronze' },
                { id: 'silver_pack', name: 'Silver Pack', price: 2500, coinsPrice: 2500, gemsPrice: 50, description: 'Contains 3 silver players', rarity: 'silver' },
                { id: 'gold_pack', name: 'Gold Pack', price: 5000, coinsPrice: 5000, gemsPrice: 100, description: 'Contains 3 gold players', rarity: 'gold' },
                { id: 'premium_pack', name: 'Premium Pack', price: 10000, coinsPrice: 10000, gemsPrice: 200, description: 'Contains 5 players with chance for special', rarity: 'special' }
            ];
            
            packs.forEach(pack => {
                const priceHtml = pack.gemsPrice > 0 
                    ? `<div class="flex justify-center space-x-2">
                         <span class="text-yellow-400"><i class="fas fa-coins"></i> ${pack.coinsPrice}</span>
                         <span class="text-blue-400"><i class="fas fa-gem"></i> ${pack.gemsPrice}</span>
                       </div>`
                    : `<div class="text-yellow-400"><i class="fas fa-coins"></i> ${pack.coinsPrice}</div>`;
                
                storePacksDiv.innerHTML += `
                    <div class="pack-card p-4 text-center shadow-lg">
                        <div class="text-4xl mb-4">üéÅ</div>
                        <h4 class="font-bold text-lg text-white">${pack.name}</h4>
                        <p class="text-sm text-gray-400 mb-3">${pack.description}</p>
                        ${priceHtml}
                        <button onclick="buyPack('${pack.id}', ${pack.coinsPrice}, ${pack.gemsPrice})" class="w-full mt-3 py-2 px-4 bg-yellow-600 hover:bg-yellow-700 text-white font-bold rounded-md interactive-button">Buy Pack</button>
                    </div>`;
            });
        }

        async function loadTransferMarket() {
            const transferMarketListDiv = document.getElementById('transfer-market-list');
            transferMarketListDiv.innerHTML = ''; 
            const playersRef = ref(db, 'players');
            const snapshot = await get(playersRef);
            if (snapshot.exists()) {
                const players = snapshot.val();
                for (const playerId in players) {
                    const playerData = players[playerId];
                    const isOwned = currentUserData && currentUserData.squad && currentUserData.squad.includes(playerId);
                    const buttonHtml = isOwned 
                        ? `<button class="w-full mt-3 py-2 px-4 bg-gray-600 text-white font-bold rounded-md cursor-not-allowed" disabled>Owned</button>`
                        : `<button onclick="buyPlayer('${playerId}', ${playerData.value})" class="w-full mt-3 py-2 px-4 btn-primary rounded-md">Buy (${playerData.value} C)</button>`;
                    transferMarketListDiv.innerHTML += `
                        <div class="player-card p-4 text-center shadow-lg">
                            <img src="${playerData.imageUrl}" alt="${playerData.name}" class="w-24 h-24 object-cover rounded-full mx-auto mb-3 border-2 border-gray-600">
                            <h4 class="font-bold text-lg">${playerData.name}</h4><p class="text-sm text-gray-400">${playerData.position}</p><p class="text-xl font-bold text-green-400 mt-2">${playerData.rating}</p>${buttonHtml}
                        </div>`;
                }
            } else { transferMarketListDiv.innerHTML = '<p class="text-center p-4 text-gray-400">No players found in the transfer market.</p>'; }
        }
        
        async function loadSellPlayers(squadIds) {
            const sellPlayerListDiv = document.getElementById('sell-player-list');
            sellPlayerListDiv.innerHTML = '';
            if (!squadIds || squadIds.length === 0) { sellPlayerListDiv.innerHTML = '<p class="text-gray-400">No players to sell.</p>'; return; }
            const playerPromises = squadIds.map(playerId => get(ref(db, 'players/' + playerId)));
            const playerSnapshots = await Promise.all(playerPromises);
            sellPlayerListDiv.innerHTML = ''; 
            playerSnapshots.forEach((playerSnap, index) => {
                if (playerSnap.exists()) {
                    const playerData = playerSnap.val();
                    const playerId = squadIds[index];
                    const sellPrice = Math.round((playerData.value || 0) * 0.7);
                    sellPlayerListDiv.innerHTML += `
                        <div class="player-card p-4 text-center shadow-lg">
                            <img src="${playerData.imageUrl}" alt="${playerData.name}" class="w-24 h-24 object-cover rounded-full mx-auto mb-3 border-2 border-gray-600">
                            <h4 class="font-bold text-lg">${playerData.name}</h4><p class="text-sm text-gray-400">${playerData.position}</p><p class="text-xl font-bold text-green-400 mt-2">${playerData.rating}</p>
                            <button onclick="sellPlayer('${playerId}', ${sellPrice})" class="w-full mt-3 py-2 px-4 bg-red-600 hover:bg-red-700 text-white font-bold rounded-md interactive-button">Sell (${sellPrice} C)</button>
                        </div>`;
                }
            });
        }
        
        async function loadTournaments() {
            const tournamentListDiv = document.getElementById('tournament-list');
            tournamentListDiv.innerHTML = '';
            const tournamentsRef = ref(db, 'tournaments');
            const snapshot = await get(tournamentsRef);
            if (snapshot.exists()) {
                snapshot.forEach(childSnapshot => {
                    const t = childSnapshot.val();
                    const s = t.status || 'N/A';
                    let sc = 'text-gray-400', bc = 'border-green-500';
                    if (s.toLowerCase().includes('upcoming')) { sc = 'text-yellow-400'; bc = 'border-yellow-500'; } 
                    else if (s.toLowerCase().includes('ongoing')) { sc = 'text-green-400'; bc = 'border-green-500'; }
                    tournamentListDiv.innerHTML += `<div class="tournament-card p-6 shadow-xl hover:bg-gray-700 transition duration-200"><h2 class="text-2xl font-bold mb-2 text-white">${t.name||'Tournament'}</h2><p class="text-lg mb-1"><span class="font-semibold text-gray-300">Prize:</span> üí∞ <span class="text-yellow-300 font-bold">${t.prize||0} Coins</span></p><p class="text-lg"><span class="font-semibold text-gray-300">Status:</span> <span class="${sc} font-bold">${s}</span></p><button class="mt-3 py-2 px-4 bg-green-600 hover:bg-green-700 text-white font-bold rounded-md">View Details</button></div>`;
                });
            } else { tournamentListDiv.innerHTML = `<div class="text-center p-8 border border-gray-700 rounded-xl bg-gray-900"><h2 class="text-2xl font-bold mb-2 text-green-400">No ESPORTS Events</h2><p class="text-gray-400">New tournaments will be announced soon!</p></div>`; }
        }

        window.buyPlayer = async (playerId, price) => {
            if (!currentUserData) return showModal("User data not loaded.");
            if (currentUserData.balance < price) return showModal("You do not have enough coins.");
            if (currentUserData.squad && currentUserData.squad.includes(playerId)) return showModal("This player is already in your squad.");
            const newBalance = currentUserData.balance - price;
            const newSquad = [...(currentUserData.squad || []), playerId];
            try { await update(ref(db, 'users/' + currentUserData.uid), { balance: newBalance, squad: newSquad }); showModal("Player purchased successfully!"); } 
            catch (error) { showModal("Failed to purchase player: " + error.message); }
        };

        window.sellPlayer = async (playerId, sellPrice) => {
            if (!currentUserData) return showModal("User data not loaded.");
            if (!currentUserData.squad || !currentUserData.squad.includes(playerId)) return showModal("This player is not in your squad.");
            if (currentUserData.squad.length <= 5) return showModal("You must have at least 5 players in your squad to play a match.");
            const newBalance = currentUserData.balance + sellPrice;
            const newSquad = currentUserData.squad.filter(id => id !== playerId);
            try { await update(ref(db, 'users/' + currentUserData.uid), { balance: newBalance, squad: newSquad }); showModal("Player sold successfully!"); } 
            catch (error) { showModal("Failed to sell player: " + error.message); }
        };

        window.buyPack = async (packId, coinsPrice, gemsPrice) => {
            if (!currentUserData) return showModal("User data not loaded.");
            
            // Check if user has enough currency
            if (coinsPrice > 0 && currentUserData.balance < coinsPrice) {
                return showModal("You don't have enough coins to buy this pack.");
            }
            if (gemsPrice > 0 && currentUserData.gems < gemsPrice) {
                return showModal("You don't have enough gems to buy this pack.");
            }
            
            // Deduct currency
            const updates = {};
            if (coinsPrice > 0) updates.balance = currentUserData.balance - coinsPrice;
            if (gemsPrice > 0) updates.gems = currentUserData.gems - gemsPrice;
            
            try {
                await update(ref(db, 'users/' + currentUserData.uid), updates);
                openPack(packId);
            } catch (error) {
                showModal("Failed to purchase pack: " + error.message);
            }
        };

        async function openPack(packId) {
            const playersRef = ref(db, 'players');
            const snapshot = await get(playersRef);
            if (!snapshot.exists()) return;
            
            const allPlayers = snapshot.val();
            const playerIds = Object.keys(allPlayers);
            
            // Filter players by rarity based on pack type
            let filteredPlayers = [];
            if (packId === 'bronze_pack') {
                filteredPlayers = playerIds.filter(id => allPlayers[id].rarity === 'bronze' || !allPlayers[id].rarity);
            } else if (packId === 'silver_pack') {
                filteredPlayers = playerIds.filter(id => allPlayers[id].rarity === 'silver' || allPlayers[id].rarity === 'bronze');
            } else if (packId === 'gold_pack') {
                filteredPlayers = playerIds.filter(id => allPlayers[id].rarity === 'gold' || allPlayers[id].rarity === 'silver');
            } else if (packId === 'premium_pack') {
                filteredPlayers = playerIds; // All players
            }
            
            // Select random players
            const selectedPlayers = [];
            const numPlayers = packId === 'premium_pack' ? 5 : 3;
            
            for (let i = 0; i < numPlayers; i++) {
                if (filteredPlayers.length === 0) break;
                const randomIndex = Math.floor(Math.random() * filteredPlayers.length);
                const playerId = filteredPlayers[randomIndex];
                selectedPlayers.push({ id: playerId, ...allPlayers[playerId] });
                filteredPlayers.splice(randomIndex, 1);
            }
            
            // Show pack opening modal
            const packContainer = document.getElementById('pack-opening-container');
            packContainer.innerHTML = '';
            
            selectedPlayers.forEach(player => {
                const rarity = player.rarity || "bronze";
                const rarityClass = rarity === "bronze" ? "bronze" : 
                                   rarity === "silver" ? "silver" : 
                                   rarity === "gold" ? "gold" : "special";
                
                packContainer.innerHTML += `
                    <div class="pack-card p-4 text-center shadow-lg ${rarityClass} pack-shake">
                        <img src="${player.imageUrl}" alt="${player.name}" class="w-32 h-32 object-cover rounded-full mx-auto mb-3 border-2 border-gray-600 card-reveal">
                        <h4 class="font-bold text-lg text-white">${player.name}</h4>
                        <p class="text-sm text-gray-400">${player.position}</p>
                        <p class="text-xl font-bold text-green-400 mt-2">${player.rating}</p>
                        <p class="text-xs text-gray-500 mt-1">${rarity.toUpperCase()}</p>
                    </div>`;
            });
            
            playSound(packOpenSound);
            packOpeningModal.classList.remove('hidden');
            
            // Add players to user's squad
            const newSquad = [...(currentUserData.squad || [])];
            selectedPlayers.forEach(player => {
                if (!newSquad.includes(player.id)) {
                    newSquad.push(player.id);
                }
            });
            
            await update(ref(db, 'users/' + currentUserData.uid), { squad: newSquad });
        }

        document.getElementById('edit-club-name').addEventListener('click', () => {
            if (!currentUserData) return;
            const newClubName = prompt("Enter your new Club Name:", currentUserData.clubName);
            if (newClubName && newClubName.trim() !== "") {
                update(ref(db, 'users/' + currentUserData.uid), { clubName: newClubName.trim() })
                    .then(() => showModal("Club name changed successfully."))
                    .catch((error) => showModal("Error: " + error.message));
            }
        });
        
        document.getElementById('user-avatar-container').addEventListener('click', () => {
            document.getElementById('logo-upload').click();
        });

        document.getElementById('logo-upload').addEventListener('change', async (e) => {
            const file = e.target.files[0];
            if (!file) return;
            showModal('Uploading Logo...');
            const formData = new FormData();
            formData.append('image', file);
            try {
                const response = await fetch(`https://api.imgbb.com/1/upload?key=${IMGBB_API_KEY}`, { method: 'POST', body: formData });
                const result = await response.json();
                if(result.success) { await update(ref(db, 'users/' + currentUserData.uid), { avatarUrl: result.data.url }); showModal('Logo updated successfully!'); } 
                else { throw new Error(result.error.message); }
            } catch (error) { showModal(`Upload failed: ${error.message}`); }
        });
        
        strategyButtons.forEach(button => {
            button.addEventListener('click', async (e) => {
                if (!currentMatchId || !currentUserData) return;
                const targetButton = e.currentTarget;
                const newStrategy = targetButton.getAttribute('data-strategy');
                if(newStrategy === currentLocalStrategy) return;
                currentLocalStrategy = newStrategy; 
                strategyButtons.forEach(btn => btn.classList.remove('border-2', 'border-yellow-400', 'ring-2', 'ring-yellow-400'));
                targetButton.classList.add('border-2', 'border-yellow-400', 'ring-2', 'ring-yellow-400');
                const matchSnapshot = await get(ref(db, `matches/${currentMatchId}`));
                if (!matchSnapshot.exists()) return;
                const matchData = matchSnapshot.val();
                let strategyPath = currentUserData.uid === matchData.teamA.uid ? 'teamAStrategy' : (currentUserData.uid === matchData.teamB.uid ? 'teamBStrategy' : null);
                if(!strategyPath) return;
                await update(ref(db, `matches/${currentMatchId}`), { [strategyPath]: newStrategy });
                let seconds = matchData.startTime ? Math.floor((Date.now() - matchData.startTime) / 1000) : 0;
                push(ref(db, `matches/${currentMatchId}/events`), { time: `${seconds}'`, text: `üîÑ ${currentUserData.clubName} changed strategy to ${newStrategy}.` });
            });
        });

        const cancelMatchmakingBtn = document.getElementById('cancel-matchmaking-btn');

        async function getPlayerNamesBySquad(squadIds) {
            if (!squadIds || squadIds.length === 0) return [];
            const playerPromises = squadIds.map(playerId => get(ref(db, 'players/' + playerId)));
            const playerSnapshots = await Promise.all(playerPromises);
            return playerSnapshots.map(snap => snap.exists() ? snap.val().name : null).filter(name => name);
        }

        findMatchBtn.addEventListener('click', async () => {
            if (!currentUserData || !currentUserData.uid) return showModal("Your data is still loading. Please wait a moment.");
            if (!currentUserData.squad || currentUserData.squad.length < 5) return showModal("You must have at least 5 players in your squad to play a match.");
            document.getElementById('match-initial-screen').classList.add('hidden');
            document.getElementById('matchmaking-screen').classList.remove('hidden');
            pauseMainMenuMusic();
            const matchmakingRef = ref(db, 'matchmaking');
            const snapshot = await get(matchmakingRef);
            let opponent = null;
            if(snapshot.exists()){ snapshot.forEach(child => { if(!opponent && child.key !== currentUserData.uid) opponent = { uid: child.key, ...child.val() }; }); }
            if(opponent){
                const matchId = push(ref(db, 'matches')).key;
                currentMatchId = matchId;
                const opponentUserSnap = await get(ref(db, `users/${opponent.uid}`));
                const opponentSquad = opponentUserSnap.exists() ? (opponentUserSnap.val().squad || []) : [];
                const matchData = {
                    teamA: { uid: opponent.uid, clubName: opponent.clubName, teamPower: opponent.teamPower, squad: opponentSquad },
                    teamB: { uid: currentUserData.uid, clubName: currentUserData.clubName, teamPower: teamPower, squad: currentUserData.squad },
                    score: { teamA: 0, teamB: 0 }, status: 'starting', startTime: serverTimestamp(), events: {},
                    teamAStrategy: 'Balanced', teamBStrategy: 'Balanced'
                };
                const updates = {};
                updates[`/matches/${matchId}`] = matchData;
                updates[`/users/${opponent.uid}/currentMatch`] = matchId;
                updates[`/users/${currentUserData.uid}/currentMatch`] = matchId;
                updates[`/matchmaking/${opponent.uid}`] = null;
                updates[`/matchmaking/${currentUserData.uid}`] = null;
                await update(ref(db), updates);
            } else {
                await set(ref(db, `matchmaking/${currentUserData.uid}`), { clubName: currentUserData.clubName, teamPower: teamPower, timestamp: serverTimestamp() });
            }
        });

        singlePlayerBtn.addEventListener('click', async () => {
            if (!currentUserData || !currentUserData.uid) return showModal("Your data is still loading. Please wait a moment.");
            if (!currentUserData.squad || currentUserData.squad.length < 5) return showModal("You must have at least 5 players in your squad to play a match.");
            
            // Create a single player match against AI
            const matchId = push(ref(db, 'matches')).key;
            currentMatchId = matchId;
            
            // Generate AI opponent with similar team power
            const aiTeamPower = Math.max(teamPower - 5 + Math.floor(Math.random() * 10), 10);
            const aiClubName = "AI Team " + Math.floor(Math.random() * 1000);
            
            const matchData = {
                teamA: { uid: "ai_opponent", clubName: aiClubName, teamPower: aiTeamPower, squad: [] },
                teamB: { uid: currentUserData.uid, clubName: currentUserData.clubName, teamPower: teamPower, squad: currentUserData.squad },
                score: { teamA: 0, teamB: 0 }, status: 'starting', startTime: serverTimestamp(), events: {},
                teamAStrategy: 'Balanced', teamBStrategy: 'Balanced',
                isSinglePlayer: true
            };
            
            const updates = {};
            updates[`/matches/${matchId}`] = matchData;
            updates[`/users/${currentUserData.uid}/currentMatch`] = matchId;
            await update(ref(db), updates);
        });

        cancelMatchmakingBtn.addEventListener('click', async () => {
            if (!currentUserData || !currentUserData.uid) return;
            await remove(ref(db, `matchmaking/${currentUserData.uid}`));
            document.getElementById('matchmaking-screen').classList.add('hidden');
            document.getElementById('match-initial-screen').classList.remove('hidden');
            pauseMatchMusic();
            playMainMenuMusic();
        });

        function listenForMatch(uid) {
            const userMatchRef = ref(db, `users/${uid}/currentMatch`);
            if(matchListener) matchListener(); 
            matchListener = onValue(userMatchRef, (snapshot) => {
                const matchId = snapshot.val();
                if(matchId){
                    currentMatchId = matchId;
                    navigateToView('match-view'); 
                    startMatch(matchId);
                } else {
                    currentMatchId = null;
                    if(timerInterval) clearInterval(timerInterval);
                    if(matchSimulationInterval) clearInterval(matchSimulationInterval);
                    if(opponentStatusListener) opponentStatusListener();
                    if(reactionListener) reactionListener();
                    pauseMatchMusic();
                    if(!document.getElementById('match-view').classList.contains('hidden')) { navigateToView('home-view'); } 
                    else { playMainMenuMusic(); }
                    document.getElementById('match-simulation-screen').classList.add('hidden');
                    document.getElementById('matchmaking-screen').classList.add('hidden');
                    document.getElementById('match-initial-screen').classList.remove('hidden');
                }
            });
        }
        
        async function handleWalkover(matchId, disconnectedOpponentUid) {
            if (!currentUserData) return;
            if(matchListener) { matchListener(); matchListener = null; }
            if(opponentStatusListener) { opponentStatusListener(); opponentStatusListener = null; }
            if(timerInterval) clearInterval(timerInterval);
            if(matchSimulationInterval) clearInterval(matchSimulationInterval);
            if(reactionListener) reactionListener();
            
            showModal(`Opponent Disconnected! You win the match by walkover. Rewards have been added.`);
            
            const updates = {};
            const winnerData = currentUserData; 
            
            updates[`/users/${winnerData.uid}/points`] = (winnerData.points || 0) + 10;
            updates[`/users/${winnerData.uid}/wins`] = (winnerData.wins || 0) + 1;
            updates[`/users/${winnerData.uid}/balance`] = (winnerData.balance || 0) + 500;
            await updatePlayerStatsAfterMatch(winnerData.uid, "win");

            const leaverRef = ref(db, `users/${disconnectedOpponentUid}`);
            const leaverSnap = await get(leaverRef);
            if(leaverSnap.exists()){
                const leaverData = leaverSnap.val();
                updates[`/users/${disconnectedOpponentUid}/balance`] = (leaverData.balance || 0) + 50;
                await updatePlayerStatsAfterMatch(disconnectedOpponentUid, "loss");
            }

            updates[`/users/${winnerData.uid}/currentMatch`] = null;
            updates[`/users/${disconnectedOpponentUid}/currentMatch`] = null;
            updates[`/matches/${matchId}`] = null;
            
            await update(ref(db), updates);
        }

        async function startMatch(matchId) {
            document.getElementById('matchmaking-screen').classList.add('hidden');
            document.getElementById('match-initial-screen').classList.add('hidden');
            document.getElementById('match-simulation-screen').classList.remove('hidden');
            document.getElementById('live-commentary').innerHTML = '';
            pauseMainMenuMusic();
            
            const matchRef = ref(db, `matches/${matchId}`);
            const initialSnap = await get(matchRef);
            if (!initialSnap.exists()) return;
            const initialMatchData = initialSnap.val();
            
            // Only set up opponent status listener if it's not a single player match
            if (!initialMatchData.isSinglePlayer) {
                const opponent = initialMatchData.teamA.uid === currentUserData.uid ? initialMatchData.teamB : initialMatchData.teamA;
                const opponentStatusRef = ref(db, `/status/${opponent.uid}`);
                if (opponentStatusListener) opponentStatusListener();
                opponentStatusListener = onValue(opponentStatusRef, (snapshot) => {
                    if (!snapshot.exists() || snapshot.val().state === 'offline') {
                        handleWalkover(matchId, opponent.uid);
                    }
                });
            }

            const teamA_PlayerNames = await getPlayerNamesBySquad(initialMatchData.teamA.squad);
            const teamB_PlayerNames = await getPlayerNamesBySquad(initialMatchData.teamB.squad);

            if(matchListener) matchListener(); 
            
            matchListener = onValue(matchRef, (snapshot) => {
                const matchData = snapshot.val();
                if(!matchData) { playMainMenuMusic(); return; }
                document.getElementById('teamA-name').textContent = matchData.teamA.clubName;
                document.getElementById('teamB-name').textContent = matchData.teamB.clubName;
                document.getElementById('teamA-score').textContent = matchData.score.teamA;
                document.getElementById('teamB-score').textContent = matchData.score.teamB;
                
                isLocalPlayerTeamA = currentUserData.uid === matchData.teamA.uid;
                currentLocalStrategy = isLocalPlayerTeamA ? matchData.teamAStrategy : matchData.teamBStrategy;
                
                strategyButtons.forEach(btn => {
                    btn.classList.remove('border-2', 'border-yellow-400', 'ring-2', 'ring-yellow-400');
                    if (btn.getAttribute('data-strategy') === currentLocalStrategy) {
                        btn.classList.add('border-2', 'border-yellow-400', 'ring-2', 'ring-yellow-400');
                    }
                });

                if(timerInterval) clearInterval(timerInterval);
                const matchDuration = 90; 
                const timerDisplay = document.getElementById('match-timer');
                
                if (matchData.status === 'ongoing' && matchData.startTime) {
                    if (matchData.teamA.uid !== currentUserData.uid) { playMatchMusic(); }
                    const matchStartTimestamp = matchData.startTime;
                    timerInterval = setInterval(() => {
                        const elapsedSeconds = Math.floor((Date.now() - matchStartTimestamp) / 1000);
                        const remaining = matchDuration - elapsedSeconds;
                        if (remaining <= 0) { clearInterval(timerInterval); timerDisplay.textContent = '00:00'; } 
                        else { timerDisplay.textContent = `${Math.floor(remaining / 60).toString().padStart(2, '0')}:${(remaining % 60).toString().padStart(2, '0')}`; }
                    }, 1000);
                } else if (matchData.status === 'completed') { timerDisplay.textContent = '00:00 (FT)'; } 
                else { timerDisplay.textContent = '01:30'; }

                if(currentUserData && matchData.status === 'starting' && matchData.teamA.uid === currentUserData.uid){
                     runMatchSimulation(matchId, matchData, teamA_PlayerNames, teamB_PlayerNames);
                }
            });
            
            const commentaryRef = ref(db, `matches/${matchId}/events`);
            onChildAdded(commentaryRef, (snapshot) => {
                const event = snapshot.val();
                const commentaryBox = document.getElementById('live-commentary');
                commentaryBox.innerHTML += `<p class="mb-2 text-sm">${event.time}: ${event.text}</p>`;
                commentaryBox.scrollTop = commentaryBox.scrollHeight;
                
                // Play goal sound if it's a goal event
                if (event.text.includes('GOAL') || event.text.includes('Golazo') || event.text.includes('scores')) {
                    playSound(goalSound);
                }
            });
            
            const reactionRef = ref(db, `matches/${matchId}/reactions`);
            if(reactionListener) reactionListener();
            reactionListener = onChildAdded(reactionRef, (snapshot) => {
                const { emoji, senderId } = snapshot.val();
                if(senderId !== currentUserData.uid) {
                    displayReaction(emoji);
                }
            });
        }

        function getRandomItem(arr) { return arr[Math.floor(Math.random() * arr.length)]; }
        function getRandomCommentary(type = 'default', teamName = '', attacker = '', defender = '') {
            let filtered = ALL_COMMENTARIES;
            if (type === 'goal') filtered = ALL_COMMENTARIES.filter(c => c.includes('GOAL')||c.includes('Golazo')||c.includes('bulges'));
            else if (type === 'chance') filtered = ALL_COMMENTARIES.filter(c => c.includes('chance')||c.includes('close')||c.includes('shoots'));
            else if (type === 'save' || type === 'tackle') filtered = ALL_COMMENTARIES.filter(c => c.includes('save')||c.includes('tackle')||c.includes('keeper'));
            else filtered = ALL_COMMENTARIES.filter(c => !c.includes('GOAL') && !c.includes('$PLAYER') && !c.includes('chance') && !c.includes('save'));
            if(filtered.length === 0) return `Action in the midfield.`;
            let c = getRandomItem(filtered);
            return c.replace(/\$PLAYER/g, attacker||teamName).replace(/\$ASSIST/g, getRandomItem([attacker, teamName])||attacker).replace(/\$ATTACKER/g, attacker||teamName).replace(/\$DEFENDER/g, defender||teamName).replace(/\$TEAM/g, teamName);
        }

        async function updatePlayerStatsAfterMatch(uid, result) {
            const userRef = ref(db, `users/${uid}`);
            const snapshot = await get(userRef);
            if (!snapshot.exists()) return;

            const userData = snapshot.val();
            const updates = {};

            let xpGained = 0;
            if (result === 'win') xpGained = XP_PER_WIN;
            else if (result === 'draw') xpGained = XP_PER_DRAW;
            else if (result === 'loss') xpGained = XP_PER_LOSS;
            
            updates.xp = (userData.xp || 0) + xpGained;

            let currentMatchesPlayed = (userData.matchesPlayedThisLevel || 0) + 1;
            let currentMatchesNeeded = userData.matchesNeededForLevelUp || BASE_MATCHES_FOR_LEVEL_UP;
            let currentLevel = userData.level || 1;

            if (currentMatchesPlayed >= currentMatchesNeeded) {
                currentLevel++;
                updates.level = currentLevel;
                updates.matchesPlayedThisLevel = 0;
                updates.matchesNeededForLevelUp = BASE_MATCHES_FOR_LEVEL_UP * currentLevel;
                
                if(uid === currentUserData.uid) {
                    showModal(`üéâ Congratulations! You have reached Level ${currentLevel}!`);
                }
            } else {
                updates.matchesPlayedThisLevel = currentMatchesPlayed;
            }

            // Award training points based on match result
            let trainingPointsGained = 0;
            if (result === 'win') trainingPointsGained = 5;
            else if (result === 'draw') trainingPointsGained = 3;
            else if (result === 'loss') trainingPointsGained = 1;
            
            updates.trainingPoints = (userData.trainingPoints || 0) + trainingPointsGained;

            await update(userRef, updates);
        }

        async function runMatchSimulation(matchId, initialMatchData, teamA_Players, teamB_Players){
            if (!currentUserData) return;
            if(matchSimulationInterval) clearInterval(matchSimulationInterval);
            playMatchMusic(); 
            await update(ref(db, `matches/${matchId}`), { status: 'ongoing', startTime: serverTimestamp() });
            
            let seconds = 0;
            const matchDuration = 90; const attackBonus = 0.2; const defenseBonus = 0.2;
            function getOffenseModifier(s) { if(s==='Attack')return 1+attackBonus; if(s==='Defense')return 1-attackBonus; return 1.0; }
            function getDefenseModifier(s) { if(s==='Defense')return 1+defenseBonus; if(s==='Attack')return 1-defenseBonus; return 1.0; }

            matchSimulationInterval = setInterval(async () => {
                seconds += 1;
                const matchSnapshot = await get(ref(db, `matches/${matchId}`));
                if (!matchSnapshot.exists()) { clearInterval(matchSimulationInterval); return; }
                let matchData = matchSnapshot.val();
                let scoreUpdated = false;

                if (seconds % 10 === 0 && seconds <= matchDuration) {
                    const pA = matchData.teamA.teamPower, pB = matchData.teamB.teamPower;
                    const totalP = pA + pB; const baseC = 0.45; let eventText = "";
                    const sA = matchData.teamAStrategy || 'Balanced', sB = matchData.teamBStrategy || 'Balanced';
                    const offA = (pA / totalP) * baseC * getOffenseModifier(sA);
                    
                    if (Math.random() < offA) {
                        const defB = (pB / totalP) * getDefenseModifier(sB);
                        if(Math.random() > defB){
                            matchData.score.teamA++; scoreUpdated = true;
                            const scorer = getRandomItem(teamA_Players) || matchData.teamA.clubName;
                            eventText = getRandomCommentary('goal', matchData.teamA.clubName, scorer, getRandomItem(teamA_Players.filter(p => p !== scorer)));
                        } else { eventText = getRandomCommentary('save', matchData.teamB.clubName, getRandomItem(teamA_Players), getRandomItem(teamB_Players)); }
                    } else {
                        const offB = (pB / totalP) * baseC * getOffenseModifier(sB);
                        if(Math.random() < offB){
                            const defA = (pA / totalP) * getDefenseModifier(sA);
                            if(Math.random() > defA){
                                matchData.score.teamB++; scoreUpdated = true;
                                const scorer = getRandomItem(teamB_Players) || matchData.teamB.clubName;
                                eventText = getRandomCommentary('goal', matchData.teamB.clubName, scorer, getRandomItem(teamB_Players.filter(p => p !== scorer)));
                            } else { eventText = getRandomCommentary('save', matchData.teamA.clubName, getRandomItem(teamB_Players), getRandomItem(teamA_Players)); }
                        } else { eventText = getRandomCommentary('midfield'); }
                    }
                    await push(ref(db, `matches/${matchId}/events`), { time: `${seconds}'`, text: eventText });
                    if(scoreUpdated) await update(ref(db, `matches/${matchId}/score`), matchData.score);
                }

                if (seconds >= matchDuration) {
                    clearInterval(matchSimulationInterval);
                    if(opponentStatusListener) opponentStatusListener();
                    if(reactionListener) reactionListener();

                    let resultText = "The match ended in a draw!", winnerUid = null, loserUid = null;
                    if(matchData.score.teamA > matchData.score.teamB){
                        winnerUid = matchData.teamA.uid; loserUid = matchData.teamB.uid;
                        resultText = `${matchData.teamA.clubName} wins the match!`;
                    } else if (matchData.score.teamB > matchData.score.teamA){
                        winnerUid = matchData.teamB.uid; loserUid = matchData.teamA.uid;
                        resultText = `${matchData.teamB.clubName} wins the match!`;
                    }

                    await push(ref(db, `matches/${matchId}/events`), { time: 'Final', text: `üèÅ ${resultText}` });
                    await update(ref(db, `matches/${matchId}`), { status: 'completed' });
                    
                    const updates = {};
                    if(winnerUid && loserUid){
                        await updatePlayerStatsAfterMatch(winnerUid, "win");
                        await updatePlayerStatsAfterMatch(loserUid, "loss");
                    } else { // Draw
                        await updatePlayerStatsAfterMatch(matchData.teamA.uid, "draw");
                        await updatePlayerStatsAfterMatch(matchData.teamB.uid, "draw");
                    }
                    
                    if(winnerUid) {
                         const winnerSnap = await get(ref(db, `users/${winnerUid}`));
                         if(winnerSnap.exists()) { const d = winnerSnap.val(); updates[`/users/${winnerUid}/points`] = (d.points||0)+10; updates[`/users/${winnerUid}/wins`]=(d.wins||0)+1; updates[`/users/${winnerUid}/balance`]=(d.balance||0)+500; }
                    }
                    if(loserUid) {
                         const loserSnap = await get(ref(db, `users/${loserUid}`));
                         if(loserSnap.exists()) { const d = loserSnap.val(); updates[`/users/${loserUid}/balance`]=(d.balance||0)+100; }
                    }
                    
                    updates[`/users/${matchData.teamA.uid}/currentMatch`] = null;
                    updates[`/users/${matchData.teamB.uid}/currentMatch`] = null;
                    updates[`/matches/${matchId}`] = null;
                    
                    await update(ref(db), updates);
                    pauseMatchMusic(); playMainMenuMusic(); 
                }
            }, 1000);
        }
        
        const chatForm = document.getElementById('chat-form');
        const chatInput = document.getElementById('chat-input');
        const chatMessages = document.getElementById('chat-messages');

        if (chatForm) {
            chatForm.addEventListener('submit', async (e) => {
                e.preventDefault();
                if (!currentUserData || !chatInput.value.trim()) return;
                const messageText = chatInput.value.trim();
                chatInput.value = '';
                try { await push(ref(db, 'globalChat'), { uid: currentUserData.uid, clubName: currentUserData.clubName, message: messageText, timestamp: serverTimestamp() }); } 
                catch (error) { showModal("Failed to send message: " + error.message); }
            });
        }

        let chatListener = null;
        function loadChatMessages() {
            if (chatListener) return;
            chatMessages.innerHTML = '';
            const chatRef = ref(db, 'globalChat');
            chatListener = onChildAdded(chatRef, (snapshot) => {
                const msgData = snapshot.val(); if (!msgData) return;
                const isMe = msgData.uid === currentUserData.uid;
                const alignClass = isMe ? 'message-me' : 'message-other';
                const sender = isMe ? 'You' : msgData.clubName;
                const msgEl = document.createElement('div');
                msgEl.className = `chat-message ${alignClass}`;
                msgEl.innerHTML = `<span class="font-bold">${sender}:</span> ${msgData.message}`;
                chatMessages.appendChild(msgEl);
                chatMessages.scrollTop = chatMessages.scrollHeight;
            });
        }
        
        // --- SEASON PASS LOGIC ---
        const missionsTab = document.getElementById('missions-tab');
        const rewardsTab = document.getElementById('rewards-tab');
        const missionsContent = document.getElementById('missions-content');
        const rewardsContent = document.getElementById('rewards-content');

        missionsTab.addEventListener('click', () => {
            missionsTab.classList.add('active');
            rewardsTab.classList.remove('active');
            missionsContent.classList.remove('hidden');
            rewardsContent.classList.add('hidden');
        });

        rewardsTab.addEventListener('click', () => {
            rewardsTab.classList.add('active');
            missionsTab.classList.remove('active');
            rewardsContent.classList.remove('hidden');
            missionsContent.classList.add('hidden');
        });

        async function loadSeasonPassData() {
            if (!currentUserData) return;

            const sp = currentUserData.seasonPass || { level: 1, xp: 0, premium: false };
            const seasonConfigSnap = await get(ref(db, 'seasonPass/config'));
            if (!seasonConfigSnap.exists()) return;
            const config = seasonConfigSnap.val();
            
            // Update UI
            document.getElementById('sp-current-level').textContent = sp.level;
            document.getElementById('sp-current-xp').textContent = sp.xp;
            document.getElementById('sp-needed-xp').textContent = config.xpPerLevel || 100;
            const progressPercentage = (sp.xp / (config.xpPerLevel || 100)) * 100;
            document.getElementById('season-pass-progress-fill').style.width = `${progressPercentage}%`;
            
            if (sp.premium) {
                buyPremiumPassBtn.textContent = 'Premium Activated';
                buyPremiumPassBtn.disabled = true;
            } else {
                buyPremiumPassBtn.textContent = 'Premium Pass (99 BDT)';
                buyPremiumPassBtn.disabled = false;
            }

            // Load Missions
            loadMissions(config.missions);
            // Load Rewards
            loadRewards(config.rewards, sp);
        }

        function loadMissions(missions) {
            const dailyList = document.getElementById('daily-missions-list');
            const weeklyList = document.getElementById('weekly-missions-list');
            const seasonalList = document.getElementById('seasonal-missions-list');
            dailyList.innerHTML = weeklyList.innerHTML = seasonalList.innerHTML = ''; // Clear lists

            for(const missionId in missions) {
                const mission = missions[missionId];
                const missionHtml = `<div class="mission-card p-4 flex justify-between items-center">
                    <div>
                        <p class="font-semibold text-white">${mission.description}</p>
                        <p class="text-sm text-gray-400">Reward: ${mission.xpReward} XP</p>
                    </div>
                    <button class="py-2 px-4 bg-gray-600 text-white font-bold rounded-md cursor-not-allowed" disabled>Claim</button>
                </div>`;

                if (mission.type === 'daily') dailyList.innerHTML += missionHtml;
                else if (mission.type === 'weekly') weeklyList.innerHTML += missionHtml;
                else if (mission.type === 'seasonal') seasonalList.innerHTML += missionHtml;
            }
             if(!dailyList.innerHTML) dailyList.innerHTML = `<p class="text-gray-500 text-center">No daily missions available.</p>`;
             if(!weeklyList.innerHTML) weeklyList.innerHTML = `<p class="text-gray-500 text-center">No weekly missions available.</p>`;
             if(!seasonalList.innerHTML) seasonalList.innerHTML = `<p class="text-gray-500 text-center">No seasonal missions available.</p>`;
        }
        
        function loadRewards(rewards, userSP) {
            const rewardsList = document.getElementById('rewards-track-list');
            rewardsList.innerHTML = '';
            
            for(const level in rewards) {
                const levelRewards = rewards[level];
                
                const freeRewardHtml = levelRewards.free ? `<div class="reward-item p-3 w-1/2 text-center ${userSP.level >= level ? 'border-green-400' : 'border-gray-600 opacity-60'}">
                    <p class="font-bold">${levelRewards.free.name}</p><p class="text-sm text-gray-300">Free</p>
                    </div>` : `<div class="w-1/2 p-3 text-center text-gray-600">--</div>`;
                
                const premiumRewardHtml = levelRewards.premium ? `<div class="reward-item p-3 w-1/2 text-center ${userSP.premium ? (userSP.level >= level ? 'border-purple-400' : 'border-gray-600 opacity-60') : 'border-gray-600 opacity-40'}">
                    <p class="font-bold text-purple-300">${levelRewards.premium.name}</p><p class="text-sm text-purple-400">Premium</p>
                    </div>` : `<div class="w-1/2 p-3 text-center text-gray-600">--</div>`;

                rewardsList.innerHTML += `
                    <div class="flex items-center gap-4">
                        <div class="w-16 h-16 flex items-center justify-center bg-gray-800 rounded-full font-bold text-xl ${userSP.level >= level ? 'text-purple-400 border-2 border-purple-400' : 'text-gray-500'}">
                           ${level}
                        </div>
                        <div class="flex-grow flex gap-2">
                           ${freeRewardHtml}
                           ${premiumRewardHtml}
                        </div>
                    </div>`;
            }
        }

        buyPremiumPassBtn.addEventListener('click', () => {
            paymentModal.classList.remove('hidden');
        });
        paymentCloseBtn.addEventListener('click', () => {
            paymentModal.classList.add('hidden');
        });
        paymentForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            if (!currentUserData) return showModal("User data not loaded.");
            
            const tnxIdInput = document.getElementById('transaction-id-input');
            const tnxId = tnxIdInput.value.trim();
            if (!tnxId) return showModal("Please enter a valid Transaction ID.");

            const transactionData = {
                transactionId: tnxId,
                userId: currentUserData.uid,
                clubName: currentUserData.clubName,
                amount: 99,
                timestamp: serverTimestamp(),
                status: 'pending_verification' // Status for manual check
            };
            
            try {
                await push(ref(db, 'premiumPassTransactions'), transactionData);
                tnxIdInput.value = '';
                paymentModal.classList.add('hidden');
                showModal('Transaction submitted! Your premium pass will be activated after manual verification. Thank you!');
            } catch (error) {
                showModal("Failed to submit transaction: " + error.message);
            }
        });
        
        // --- EMOJI REACTION LOGIC ---
        const emojiToggleBtn = document.getElementById('emoji-toggle-btn');
        const emojiPanel = document.getElementById('emoji-panel');
        const emojis = document.querySelectorAll('.emoji');
        const reactionDisplayArea = document.getElementById('reaction-display-area');

        emojiToggleBtn.addEventListener('click', () => {
            emojiPanel.classList.toggle('hidden');
        });

        emojis.forEach(emoji => {
            emoji.addEventListener('click', async () => {
                if (!currentMatchId || !currentUserData) return;
                const emojiToSend = emoji.getAttribute('data-emoji');
                
                displayReaction(emojiToSend); // Show locally immediately
                emojiPanel.classList.add('hidden');
                
                // Send to opponent
                const reactionRef = ref(db, `matches/${currentMatchId}/reactions`);
                await push(reactionRef, { emoji: emojiToSend, senderId: currentUserData.uid });
            });
        });

        function displayReaction(emoji) {
            const reactionEl = document.createElement('div');
            reactionEl.className = 'reaction-display';
            reactionEl.textContent = emoji;
            reactionDisplayArea.appendChild(reactionEl);
            
            // Clean up the element after the animation
            setTimeout(() => {
                reactionEl.remove();
            }, 2000);
        }

        // --- NEW FEATURES IMPLEMENTATION ---

        // Training System
        trainingBtn.addEventListener('click', () => {
            if (!currentUserData) return;
            openTrainingModal();
        });

        trainingCloseBtn.addEventListener('click', () => {
            trainingModal.classList.add('hidden');
        });

        async function openTrainingModal() {
            if (!currentUserData || !currentUserData.squad) return;
            
            const trainingPoints = currentUserData.trainingPoints || 0;
            document.getElementById('training-points').textContent = trainingPoints;
            
            const playerList = document.getElementById('training-player-list');
            playerList.innerHTML = '';
            
            const playerPromises = currentUserData.squad.map(playerId => get(ref(db, 'players/' + playerId)));
            const playerSnapshots = await Promise.all(playerPromises);
            
            playerSnapshots.forEach((playerSnap, index) => {
                if (playerSnap.exists()) {
                    const playerData = playerSnap.val();
                    const playerId = currentUserData.squad[index];
                    const attributes = playerData.attributes || { pace: 50, shooting: 50, passing: 50, dribbling: 50, defending: 50, physical: 50 };
                    
                    playerList.innerHTML += `
                        <div class="player-card p-4 flex flex-col md:flex-row justify-between items-center">
                            <div class="flex items-center mb-4 md:mb-0">
                                <img src="${playerData.imageUrl}" alt="${playerData.name}" class="w-16 h-16 object-cover rounded-full mr-4 border-2 border-gray-600">
                                <div>
                                    <h4 class="font-bold text-lg text-white">${playerData.name}</h4>
                                    <p class="text-sm text-gray-400">${playerData.position}</p>
                                </div>
                            </div>
                            <div class="grid grid-cols-2 md:grid-cols-3 gap-2 w-full md:w-auto">
                                <div class="text-center">
                                    <div class="text-xs text-gray-400">Pace</div>
                                    <div class="attribute-bar"><div class="attribute-fill pace-fill" style="width: ${attributes.pace}%"></div></div>
                                    <button class="train-btn mt-1 px-2 py-1 bg-blue-600 hover:bg-blue-700 text-white text-xs rounded disabled:bg-gray-600 disabled:cursor-not-allowed" data-player="${playerId}" data-attribute="pace" ${trainingPoints < 1 ? 'disabled' : ''}>+</button>
                                </div>
                                <div class="text-center">
                                    <div class="text-xs text-gray-400">Shooting</div>
                                    <div class="attribute-bar"><div class="attribute-fill shooting-fill" style="width: ${attributes.shooting}%"></div></div>
                                    <button class="train-btn mt-1 px-2 py-1 bg-red-600 hover:bg-red-700 text-white text-xs rounded disabled:bg-gray-600 disabled:cursor-not-allowed" data-player="${playerId}" data-attribute="shooting" ${trainingPoints < 1 ? 'disabled' : ''}>+</button>
                                </div>
                                <div class="text-center">
                                    <div class="text-xs text-gray-400">Passing</div>
                                    <div class="attribute-bar"><div class="attribute-fill passing-fill" style="width: ${attributes.passing}%"></div></div>
                                    <button class="train-btn mt-1 px-2 py-1 bg-blue-600 hover:bg-blue-700 text-white text-xs rounded disabled:bg-gray-600 disabled:cursor-not-allowed" data-player="${playerId}" data-attribute="passing" ${trainingPoints < 1 ? 'disabled' : ''}>+</button>
                                </div>
                            </div>
                        </div>`;
                }
            });
            
            // Add event listeners to training buttons
            document.querySelectorAll('.train-btn').forEach(button => {
                button.addEventListener('click', async (e) => {
                    const playerId = e.target.getAttribute('data-player');
                    const attribute = e.target.getAttribute('data-attribute');
                    await trainPlayer(playerId, attribute);
                });
            });
            
            trainingModal.classList.remove('hidden');
        }

        async function trainPlayer(playerId, attribute) {
            if (!currentUserData) return;
            
            const trainingPoints = currentUserData.trainingPoints || 0;
            if (trainingPoints < 1) {
                showModal("You don't have enough training points!");
                return;
            }
            
            // Get player data
            const playerRef = ref(db, 'players/' + playerId);
            const playerSnap = await get(playerRef);
            if (!playerSnap.exists()) return;
            
            const playerData = playerSnap.val();
            const attributes = playerData.attributes || { pace: 50, shooting: 50, passing: 50, dribbling: 50, defending: 50, physical: 50 };
            
            // Increase attribute (max 99)
            if (attributes[attribute] < 99) {
                attributes[attribute] += 1;
                
                // Update player and user data
                await update(playerRef, { attributes: attributes });
                await update(ref(db, 'users/' + currentUserData.uid), { 
                    trainingPoints: trainingPoints - 1 
                });
                
                showModal(`${playerData.name}'s ${attribute} increased to ${attributes[attribute]}!`);
                openTrainingModal(); // Refresh the modal
            } else {
                showModal(`${playerData.name}'s ${attribute} is already at maximum!`);
            }
        }

        // Formation System
        formationBtn.addEventListener('click', () => {
            if (!currentUserData) return;
            openFormationModal();
        });

        formationCloseBtn.addEventListener('click', () => {
            formationModal.classList.add('hidden');
        });

        formationCancelBtn.addEventListener('click', () => {
            formationModal.classList.add('hidden');
        });

        formationSaveBtn.addEventListener('click', async () => {
            const selectedFormation = document.querySelector('.formation-option.selected');
            if (!selectedFormation) {
                showModal("Please select a formation!");
                return;
            }
            
            const formation = selectedFormation.getAttribute('data-formation');
            await update(ref(db, 'users/' + currentUserData.uid), { formation: formation });
            showModal(`Formation changed to ${formation}!`);
            formationModal.classList.add('hidden');
        });

        function openFormationModal() {
            // Set current formation as selected
            const currentFormation = currentUserData.formation || "4-4-2";
            document.querySelectorAll('.formation-option').forEach(option => {
                option.classList.remove('selected');
                if (option.getAttribute('data-formation') === currentFormation) {
                    option.classList.add('selected');
                }
            });
            
            // Calculate team chemistry
            calculateTeamChemistry();
            
            formationModal.classList.remove('hidden');
        }

        // Add event listeners to formation options
        document.querySelectorAll('.formation-option').forEach(option => {
            option.addEventListener('click', () => {
                document.querySelectorAll('.formation-option').forEach(opt => opt.classList.remove('selected'));
                option.classList.add('selected');
                calculateTeamChemistry();
            });
        });

        async function calculateTeamChemistry() {
            if (!currentUserData || !currentUserData.squad) return;
            
            let chemistry = 0;
            const playerPromises = currentUserData.squad.map(playerId => get(ref(db, 'players/' + playerId)));
            const playerSnapshots = await Promise.all(playerPromises);
            
            // Simple chemistry calculation based on player positions matching formation requirements
            // In a real game, this would be more complex
            playerSnapshots.forEach(playerSnap => {
                if (playerSnap.exists()) {
                    const playerData = playerSnap.val();
                    // Add some chemistry for each player (this is a simplified version)
                    chemistry += 15;
                }
            });
            
            // Cap at 100%
            chemistry = Math.min(chemistry, 100);
            
            document.getElementById('chemistry-bar').style.width = `${chemistry}%`;
            document.getElementById('chemistry-value').textContent = `${chemistry}%`;
        }

        // Store Tabs
        playersTab.addEventListener('click', () => {
            playersTab.classList.add('active');
            packsTab.classList.remove('active');
            storeItems.classList.remove('hidden');
            storePacks.classList.add('hidden');
        });

        packsTab.addEventListener('click', () => {
            packsTab.classList.add('active');
            playersTab.classList.remove('active');
            storePacks.classList.remove('hidden');
            storeItems.classList.add('hidden');
        });

        // Pack Opening Modal Controls
        packCloseBtn.addEventListener('click', () => {
            packOpeningModal.classList.add('hidden');
        });

        packOpenAgainBtn.addEventListener('click', () => {
            packOpeningModal.classList.add('hidden');
            navigateToView('store-view');
        });

        packDoneBtn.addEventListener('click', () => {
            packOpeningModal.classList.add('hidden');
        });

        // Daily Login System
        dailyLoginCloseBtn.addEventListener('click', () => {
            dailyLoginModal.classList.add('hidden');
        });

        dailyLoginClaimBtn.addEventListener('click', async () => {
            await claimDailyLoginReward();
            dailyLoginModal.classList.add('hidden');
        });

        async function checkDailyLogin(uid) {
            const userRef = ref(db, 'users/' + uid);
            const userSnap = await get(userRef);
            if (!userSnap.exists()) return;
            
            const userData = userSnap.val();
            const today = new Date().toDateString();
            const lastLogin = userData.lastLoginDate;
            let streak = userData.dailyLoginStreak || 1;
            
            // Check if user already logged in today
            if (lastLogin === today) return;
            
            // Check if streak continues (logged in yesterday)
            const yesterday = new Date();
            yesterday.setDate(yesterday.getDate() - 1);
            const yesterdayStr = yesterday.toDateString();
            
            if (lastLogin === yesterdayStr) {
                streak += 1;
            } else {
                streak = 1; // Reset streak
            }
            
            // Cap streak at 7 days
            if (streak > 7) streak = 7;
            
            // Show daily login modal
            showDailyLoginModal(streak);
            
            // Update user data
            await update(userRef, {
                lastLoginDate: today,
                dailyLoginStreak: streak
            });
        }

        function showDailyLoginModal(day) {
            document.getElementById('login-day').textContent = day;
            
            const rewards = [
                { day: 1, reward: "500 Coins" },
                { day: 2, reward: "10 Gems" },
                { day: 3, reward: "Bronze Pack" },
                { day: 4, reward: "1000 Coins" },
                { day: 5, reward: "20 Gems" },
                { day: 6, reward: "Silver Pack" },
                { day: 7, reward: "Gold Pack" }
            ];
            
            const todayReward = rewards[day - 1];
            document.getElementById('daily-reward-content').textContent = todayReward.reward;
            
            dailyLoginModal.classList.remove('hidden');
        }

        async function claimDailyLoginReward() {
            if (!currentUserData) return;
            
            const day = currentUserData.dailyLoginStreak || 1;
            const updates = {};
            
            switch(day) {
                case 1:
                    updates.balance = (currentUserData.balance || 0) + 500;
                    break;
                case 2:
                    updates.gems = (currentUserData.gems || 0) + 10;
                    break;
                case 3:
                    // Add bronze pack logic
                    break;
                case 4:
                    updates.balance = (currentUserData.balance || 0) + 1000;
                    break;
                case 5:
                    updates.gems = (currentUserData.gems || 0) + 20;
                    break;
                case 6:
                    // Add silver pack logic
                    break;
                case 7:
                    // Add gold pack logic
                    break;
            }
            
            await update(ref(db, 'users/' + currentUserData.uid), updates);
            showModal(`Daily login reward claimed: ${getRewardDescription(day)}`);
        }

        function getRewardDescription(day) {
            const rewards = [
                "500 Coins",
                "10 Gems",
                "Bronze Pack",
                "1000 Coins",
                "20 Gems",
                "Silver Pack",
                "Gold Pack"
            ];
            
            return rewards[day - 1] || "Unknown Reward";
        }

        // Add sound effects to buttons
        document.querySelectorAll('.interactive-button').forEach(button => {
            button.addEventListener('click', () => {
                playSound(buttonSound);
            });
        });

        navLinks.forEach(link => {
            link.addEventListener('click', (e) => {
                e.preventDefault();
                const targetId = link.getAttribute('href').substring(1);
                if(targetId === 'home') { navigateToView('home-view'); } 
                else { navigateToView(targetId + '-view'); }
            });
        });
        
        document.addEventListener('DOMContentLoaded', () => {
            const balancedBtn = document.querySelector('#in-match-strategy-control [data-strategy="Balanced"]');
            if(balancedBtn) balancedBtn.classList.add('border-2', 'border-yellow-400', 'ring-2', 'ring-yellow-400');
            if (!auth.currentUser) {} else { navigateToView('home-view'); }
        });
        
        document.addEventListener('click', () => {
             if (mainMenuAudio.paused && currentMatchId === null) { playMainMenuMusic(); }
        }, { once: true }); 

    </script>
</body>
</html>
